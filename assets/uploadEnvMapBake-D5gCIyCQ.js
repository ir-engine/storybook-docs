var D=Object.defineProperty;var $=(r,e,t)=>e in r?D(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var a=(r,e,t)=>($(r,typeof e!="symbol"?e+"":e,t),t);import{W as I,R as U,S as w,p as T,C as _,q as R,V as q}from"./three.module-D2RMN07C.js";import{d as A,h as G,s as v,b as c,p as E}from"./index-_wFD3GG2.js";import{c as k,b as B}from"./VideoComponent-TZ9Icu9Q.js";import{E as i,K as m,L as N,N as X,z as h}from"./EditorServices-BJKHmurs.js";import{S as z}from"./ScenePreviewCamera-C6tUz1E8.js";import{g as p}from"./ActionFunctions-CxzuxLxN.js";import"./index-CBqU2yxZ.js";import{u as x}from"./assetFunctions-Bvb93VNm.js";class F{constructor(e,t,n){a(this,"width");a(this,"height");a(this,"renderer");a(this,"cubeCamera");a(this,"cubeRenderTarget");a(this,"sceneToRender");a(this,"update",e=>{const t=this.renderer.autoClear;this.renderer.autoClear=!0,this.cubeCamera.position.copy(e);const n=this.renderer.outputColorSpace;return this.renderer.outputColorSpace=w,this.cubeCamera.update(this.renderer,this.sceneToRender),this.renderer.outputColorSpace=n,this.renderer.autoClear=t,this.cubeRenderTarget});this.width=n,this.height=n,this.sceneToRender=t,this.renderer=e,this.cubeCamera=null;const o=this.renderer.getContext(),s=Math.min(n,o.getParameter(o.MAX_CUBE_MAP_TEXTURE_SIZE));this.cubeRenderTarget=new I(s,{format:U,colorSpace:w,magFilter:T,minFilter:T}),this.cubeCamera=new _(.1,1e3,this.cubeRenderTarget)}dispose(){this.cubeRenderTarget.dispose()}}const K=A([z,h]),V=r=>{if(r)return c(r,h).position;let e;if(e=K()[0],e){const t=c(e,h);if(t!=null&&t.position)return t.position}return new q(0,2,5)},re=async r=>{const e=r===p(i).rootEntity;e&&(G(r,m)||v(r,m,{resolution:1024}));const t=c(r,m),n=V(e?void 0:r),o=c(E.instance.viewerEntity,N).renderer,s=new R,u=new F(o,s,t.resolution).update(n);e&&(s.environment=u.texture);const g=k(o,u.texture,t.resolution,t.resolution),l=await B(g);if(!l)return null;const P=c(r,X),S=p(i),f=S.sceneName,j=S.projectName,L=e?`${f}.envmap.ktx2`:`${f}-${P.replace(" ","-")}.ktx2`,M=p(i).scenePath.split("/").slice(0,-1).join("/"),y=(await x(j,[new File([l],L)],[M]).promises[0])[0],d=new URL(y);d.hash="",d.search="",v(r,m,{envMapOrigin:d.href})},C=1024,ne=async r=>{const e=c(E.instance.viewerEntity,N).renderer,n=new F(e,new R,C).update(r);return await k(e,n.texture,C,C)},oe=async(r,e)=>{const t=await B(e);if(!t)return null;const n=p(i),o=n.sceneName,s=n.projectName,b=`${o}-${r.replace(" ","-")}.ktx2`,u=p(i).scenePath.split("/").slice(0,-1).join("/");return(await x(s,[new File([t],b)],[u]).promises[0])[0]};export{oe as a,ne as b,re as u};
