var T=Object.defineProperty;var P=(i,e,t)=>e in i?T(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var d=(i,e,t)=>(P(i,typeof e!="symbol"?e+"":e,t),t),g=(i,e,t)=>{if(!e.has(i))throw TypeError("Cannot "+t)};var c=(i,e,t)=>(g(i,e,"read from private field"),t?t.call(i):e.get(i)),E=(i,e,t)=>{if(e.has(i))throw TypeError("Cannot add the same private member more than once");e instanceof WeakSet?e.add(i):e.set(i,t)};var M=(i,e,t)=>(g(i,e,"access private method"),t);import{r as U}from"./index-CBqU2yxZ.js";import{d as S,a as O,P as Q,g as q,b as v,h as D}from"./index-_wFD3GG2.js";import{i as V,g as f}from"./ActionFunctions-CxzuxLxN.js";import{g as x,s as b,S as C,M as A}from"./EditorServices-BJKHmurs.js";import{A as m,M as L,u as F}from"./MediaComponent-BbvQujMt.js";import{V as N,a as p}from"./VideoComponent-TZ9Icu9Q.js";import{P as R}from"./PositionalAudioComponent-CGM_4wyN.js";var a,w,k;const l=class l{constructor(){E(this,w);d(this,"bufferMap",{});d(this,"loadBuffer",async e=>{const[t]=await x(e);return t});E(this,a,[]);d(this,"play",async(e,t=f(m).notificationVolume)=>{if(await Promise.resolve(),!c(this,a).length)return;if(!this.bufferMap[e]){const[o]=await x(e);o&&(this.bufferMap[e]=o)}const u=f(m).audioContext.createBufferSource();u.buffer=this.bufferMap[e];const r=c(this,a).find(o=>o.paused)??c(this,a)[0];r.volume=f(m).masterVolume*t,r.src!==e&&(r.src=e),r.currentTime=0,u.start(),u.connect(f(m).audioContext.destination)});V&&M(this,w,k).call(this)}};a=new WeakMap,w=new WeakSet,k=function(){if(!c(this,a).length)for(let e=0;e<20;e++){const t=document.createElement("audio");t.crossOrigin="anonymous",t.loop=!1,c(this,a).push(t)}},d(l,"instance",new l),d(l,"SOUNDS",{notification:"/sfx/notification.mp3",message:"/sfx/message.mp3",alert:"/sfx/alert.mp3",ui:"/sfx/ui.mp3"});let h=l;globalThis.AudioEffectPlayer=h;const B=S([L]);S([p]);S([R]);const j=()=>{var e,t,u,r;for(const o of B.enter()){const s=q(o,L);b(o,C.PLAY,()=>s.paused.set(!1)),b(o,C.PAUSE,()=>s.paused.set(!0)),b(o,C.RESET,()=>{s.paused.set(!s.autoplay.value);let n=s.seekTime.value;n==0?n=1e-6:n=0,s.seekTime.set(n)})}const i=f(N).queue;for(const o of p.uniqueVideoEntities){const s=v(o,p).videoMeshEntity,n=(t=(e=v(s,A))==null?void 0:e.material)==null?void 0:t.map;if(n!=null&&n.isVideoTexture){const y=n.image;if("requestVideoFrameCallback"in y===!1||y.readyState<y.HAVE_CURRENT_DATA)continue;i.addPriority(o,1)}}i.update();for(const o of i.priorityEntities){if(!D(o,p))continue;const s=v(o,p).videoMeshEntity,n=(r=(u=v(s,A))==null?void 0:u.material)==null?void 0:r.map;n!=null&&n.isVideoTexture&&(n.needsUpdate=!0)}},G=()=>(V&&(U.useEffect(()=>{const i=()=>{const t=f(m).audioContext;t.state==="suspended"&&t.resume()},e=()=>{i(),window.removeEventListener("pointerup",e),window.removeEventListener("keypress",e),window.removeEventListener("touchend",e),window.removeEventListener("pointerup",e),window.removeEventListener("touchend",e)};return window.addEventListener("pointerup",e),window.addEventListener("keypress",e),window.addEventListener("touchend",e),window.addEventListener("pointerup",e),window.addEventListener("touchend",e),()=>{for(const t of Object.values(h.SOUNDS))delete h.instance.bufferMap[t]}},[]),F()),null);O({uuid:"ee.engine.MediaSystem",insert:{before:Q},execute:j,reactor:G});export{h as A};
