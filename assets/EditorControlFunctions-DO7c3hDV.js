import{V as T,k as Y,Q as J,E as te}from"./three.module-D2RMN07C.js";import{c as de,S as Q,e as ye,f as oe,U as l,a as xe,P as Se,v as se,s as De,r as ge,o as ce,b as u,B as F,C as q,t as k,u as X}from"./index-_wFD3GG2.js";import{aU as Ee,aV as Ce,L as je,a9 as K,aW as Ue,a7 as U,a8 as b,aX as be,a4 as Oe,E as G,q as V,z as S,aY as we,p as Z,H as le,aj as fe,ad as Te,_ as ve,Z as Ne}from"./EditorServices-BJKHmurs.js";import{a as z,u as Pe,g as O,E as Me,s as Re,b as M,c as pe,e as w,f as Be}from"./ActionFunctions-CxzuxLxN.js";import{R as A,r as ue}from"./index-CBqU2yxZ.js";import{M as Ae}from"./MathLerpFunctions-CYXVD2J2.js";const Le={Center:"Center",FirstSelected:"FirstSelected",BoundingBox:"BoundingBox",BoundingBoxBottom:"BoundingBoxBottom",Origin:"Origin"},re={translate:"translate",rotate:"rotate",scale:"scale"};new T(1,0,0),new T(0,1,0),new T(0,0,1),new T(1,1,0),new T(0,1,1),new T(1,0,1),new T(1,1,1);const Fe={Disabled:"Disabled",Grid:"Grid"},$={world:"world",local:"local"},ie=z({name:"PostProcessingEffectState",initial:{}}),me=de({name:"PostProcessingComponent",jsonID:"EE_postprocessing",schema:Q.Object({enabled:Q.Bool(!1),effects:Q.Record(Q.String(),Ee)}),reactor:()=>{const n=ye(),t=Ce(n);return t?A.createElement(Ge,{entity:n,rendererEntity:t}):null}}),Ge=n=>{const{entity:t,rendererEntity:e}=n,o=oe(t,me),s=Pe(ie).keys,r=oe(e,je),c=r.effects,i=r.effectComposer.value,a=r.scene.value;return o.enabled.value?A.createElement(A.Fragment,null,s.map(p=>{var h;const m=O(ie)[p];return m?A.createElement(ue.Suspense,{key:p},A.createElement(Me,null,A.createElement(m.reactor,{isActive:(h=o.effects[p])==null?void 0:h.isActive,rendererEntity:e,effectData:o.effects,effects:c,composer:i,scene:a}))):null})):null},We={Simple:"Simple",Advanced:"Advanced"};var Qe=(n=>(n[n.DRAG=0]="DRAG",n[n.CLICK=1]="CLICK",n))(Qe||{});const he=z({name:"EditorHelperState",initial:()=>({editorMode:We.Simple,transformMode:re.translate,transformModeOnCancel:re.translate,transformSpace:$.local,transformPivot:Le.Center,gridSnap:Fe.Grid,translationSnap:.5,rotationSnap:10,scaleSnap:.1,placementMode:0}),extension:Re(["snapMode","translationSnap","rotationSnap","scaleSnap"])}),ae=de({name:"SelectTagComponent"}),_e=z({name:"MaterialSelectionState",initial:{selectedMaterial:null}}),j=z({name:"SelectionState",initial:{selectedEntities:[]},updateSelection:n=>{M(_e).selectedMaterial.set(null),M(j).merge({selectedEntities:n})},getSelectedEntities:()=>O(j).selectedEntities.map(l.getEntityByUUID),useSelectedEntities:()=>pe(M(j).selectedEntities).value.map(l.getEntityByUUID)}),Ye=()=>{const n=pe(M(j).selectedEntities);return ue.useEffect(()=>{const t=[...n.value].map(l.getEntityByUUID);for(const e of t)se(e)&&De(e,ae);return()=>{for(const e of t)se(e)&&ge(e,ae)}},[n.length]),null};xe({uuid:"ee.engine.EditorSelectionReceptorSystem",insert:{before:Se},reactor:Ye});const R=new Y,L=new T,v=n=>{const t={};for(const e of n){const o=u(e,K);t[o]??(t[o]=[]),t[o].push(e)}return t},P=(n,t)=>{var e;return(e=n.nodes)==null?void 0:e.find(o=>{var s;return((s=o.extensions)==null?void 0:s[l.jsonID])===t})},ee=(n,t)=>{var o,s;const e=(o=n.nodes)==null?void 0:o.findIndex(r=>{var c;return((c=r.extensions)==null?void 0:c[l.jsonID])===t});if(!(e===void 0||e<0))return(s=n.nodes)==null?void 0:s.find(r=>{var c;return(c=r.children)==null?void 0:c.includes(e)})},ke=(n,t)=>{var i;const e=t.jsonID;if(!e)return!1;const o=ce(n,K),s=ce(n,l);if(!o||!s)return!1;const r=O(Ue)[o],c=P(r,s);return((i=c==null?void 0:c.extensions)==null?void 0:i[e])!==void 0},Xe=(n,t,e,o=void 0)=>{var c;const s=t.jsonID;if(!s)return;const r=v(n);for(const[i,a]of Object.entries(r)){const p=U.cloneCurrentSnapshot(i);for(const m of a){const h=u(m,l),d=P(p.data,h);d&&(e?d.extensions[s]={...F(q.get(s)),...o}:(c=d.extensions)==null||delete c[s])}w(b.createSnapshot(p))}},Ze=(n,t)=>{const e=v(n);for(const[o,s]of Object.entries(e)){const r=U.cloneCurrentSnapshot(o);for(const c of s){const i=u(c,l),a=P(r.data,i);a&&(a.name=t)}w(b.createSnapshot(r))}},ze=(n,t,e)=>{const o=v(n);for(const[s,r]of Object.entries(o)){const c=U.cloneCurrentSnapshot(s);for(const i of r){const a=u(i,l),p=P(c.data,a);p&&(typeof e=="string"?p.extensions[t.jsonID]=e:Object.entries(e).map(([m,h])=>{const{result:d,finalProp:I}=Be(p.extensions[t.jsonID],m);d[I]=h}))}w(b.createSnapshot(c))}},He=(n,t,e)=>{for(let o=0;o<n.length;o++){if(typeof n[o]!="string")return;const r=be(t);if(!r)return;const c=e[o]??e[0];Object.entries(c).map(([i,a])=>{if(!r)throw new Error("Updating properties on undefined material");![void 0,null].includes(a)&&![void 0,null].includes(r[i])&&typeof r[i]=="object"&&typeof r[i].set=="function"?r[i].set(a):r[i]=a}),r.needsUpdate=!0}},Ve=(n=[],t=[],e=O(G).rootEntity,o)=>{var r,c;const s=v([e]);((r=t.find(i=>i.name===l.jsonID))==null?void 0:r.props.uuid)??k();for(const[i,a]of Object.entries(s))if(O(Oe)[i]){const p=U.cloneCurrentSnapshot(i),m={};for(const I of t)m[I.name]={...F(q.get(I.name)),...I.props};const h=[Te,ve,Ne,me];let d=!1;for(const I of h)if(m[I.jsonID]){const f=(c=p.data.nodes)==null?void 0:c.findIndex(g=>{var x;return((x=g.extensions)==null?void 0:x[I.jsonID])!==void 0});typeof f=="number"&&f>-1&&p.data.nodes!==void 0&&(p.data.nodes[f].extensions[I.jsonID]=m[I.jsonID],d=!0)}d?w(b.createSnapshot(p)):Ie(n,e,o)}},Ie=(n=[],t=O(G).rootEntity,e)=>{var c,i,a;const o=v([t]),s=((c=n.find(p=>p.name===l.jsonID))==null?void 0:c.props.uuid)??k(),r=Object.keys(o)[0];for(const[p,m]of Object.entries(o)){const h="New Object",d=U.cloneCurrentSnapshot(p),I=d.data.nodes.length,f={};for(const x of n)f[x.name]={...F(q.get(x.name)),...x.props};f[l.jsonID]||(f[l.jsonID]=s),f[V.jsonID]||(f[V.jsonID]=!0);const g={name:h,extensions:f};if(d.data.nodes.push(g),f[S.jsonID]){const x={...F(S),...f[S.jsonID]},y=R.compose(new T().copy(x.position),new J().copy(x.rotation),new T().copy(x.scale));delete f[S.jsonID],y.equals(Ae)||(g.matrix=y.toArray())}if(t===O(G).rootEntity){let y=d.data.scenes[0].nodes.length;if(typeof e=="number"){const N=u(e,l),C=(i=d.data.nodes)==null?void 0:i.findIndex(E=>{var D;return((D=E.extensions)==null?void 0:D[l.jsonID])===N});typeof C=="number"&&C>-1&&(y=d.data.scenes[0].nodes.indexOf(C))}d.data.scenes[0].nodes.splice(y,0,I)}else{const x=u(t,l),y=P(d.data,x);if(!y)continue;y.children||(y.children=[]);let N=0;if(typeof e=="number"){const C=u(e,l),E=(a=d.data.nodes)==null?void 0:a.findIndex(D=>{var B;return((B=D.extensions)==null?void 0:B[l.jsonID])===C});typeof E=="number"&&E>-1&&(N=y.children.indexOf(E))}y.children.splice(N,0,I)}w(b.createSnapshot(d))}return{entityUUID:s,sceneID:r}},Je=n=>{const t=v(n);for(const[e,o]of Object.entries(t)){const s=we(o),r=U.cloneCurrentSnapshot(e),c=i=>{const a=u(i,l),p=r.data.nodes.findIndex(g=>{var x;return((x=g.extensions)==null?void 0:x[l.jsonID])===a}),m=r.data.nodes[p],h=[];if(m.children)for(const g of m.children){const y=r.data.nodes[g].extensions[l.jsonID],N=c(l.getEntityByUUID(y));h.push(N)}const d=JSON.parse(JSON.stringify(m)),I=k();return d.extensions[l.jsonID]=I,h.length&&(d.children=h),r.data.nodes.push(d),r.data.nodes.length-1};for(const i of s){const a=u(i,l),p=r.data.nodes.findIndex(d=>{var I;return((I=d.extensions)==null?void 0:I[l.jsonID])===a}),m=c(i),h=r.data.scenes.findIndex(d=>d.nodes.includes(p));if(h>-1)r.data.scenes[h].nodes.push(m);else{const d=u(i,Z).parentEntity;if(!d)throw new Error("Root entity must have a parent");const I=u(d,l),f=ee(r.data,I);if(!f)throw new Error("Parent node not found");f.children||(f.children=[]),f.children.push(m)}}w(b.createSnapshot(r))}},qe=(n,t,e=O(he).transformSpace,o)=>{for(let s=0;s<n.length;s++){const r=n[s],c=t[s]??t[0],i=u(r,S);if(e===$.local)o?i.position.add(c):i.position.copy(c);else{const a=u(r,Z),p=a.parentEntity?u(a.parentEntity,S):i;L.set(0,0,0),o&&L.setFromMatrixPosition(i.matrixWorld),L.add(c);const m=p.matrixWorld;R.copy(m).invert(),L.applyMatrix4(R),i.position.copy(L)}X(r,S,{position:i.position}),le(r,a=>{fe(a),S.dirtyTransforms[a]=!0})}},_=new J,Ke=new J,$e=(n,t,e=O(he).transformSpace)=>{for(let o=0;o<n.length;o++){const s=n[o];_.copy(t[o]??t[0]);const r=new te().setFromQuaternion(_,"YXZ"),c=u(s,S);if(e===$.local)c.rotation.copy(_);else{const i=u(s,Z),p=(i.parentEntity?u(i.parentEntity,S):c).matrixWorld,h=Ke.setFromRotationMatrix(p).invert().multiply(_);r.copy(new te().setFromQuaternion(h,"YXZ")),c.rotation.copy(h)}X(s,S,{rotation:c.rotation}),le(s,i=>{fe(i),S.dirtyTransforms[i]=!0})}},en=(n,t,e,o)=>{const s=new Y().makeTranslation(-o.x,-o.y,-o.z),r=new Y().makeTranslation(o.x,o.y,o.z),c=new Y().makeRotationAxis(t,e);for(const i of n){const a=u(i,S),p=u(i,Z),m=p.parentEntity?u(p.parentEntity,S):a;R.copy(a.matrixWorld).premultiply(s).premultiply(c).premultiply(r).premultiply(R.copy(m.matrixWorld).invert()).decompose(a.position,a.rotation,a.scale),X(i,S,{rotation:a.rotation})}},nn=(n,t,e=!1)=>{for(let o=0;o<n.length;o++){const s=n[o],r=t[o]??t[0],c=u(s,S);e?c.scale.copy(r):c.scale.multiply(r),c.scale.set(c.scale.x===0?Number.EPSILON:c.scale.x,c.scale.y===0?Number.EPSILON:c.scale.y,c.scale.z===0?Number.EPSILON:c.scale.z),X(s,S,{scale:c.scale})}},tn=(n,t,e=O(G).rootEntity)=>{var i,a,p,m,h;const o=v(n),s=u(e,K),r=[],c=u(e,l);for(const[d,I]of Object.entries(o)){const f=U.cloneCurrentSnapshot(d);for(const g of I){if(g===e)continue;const x=u(g,l),y=f.data.nodes.findIndex(E=>{var D;return((D=E.extensions)==null?void 0:D[l.jsonID])===x});if(f.data.scenes[0].nodes.includes(y))f.data.scenes[0].nodes.splice(f.data.scenes[0].nodes.indexOf(y),1);else{const E=ee(f.data,x);if(!E)continue;const D=E.children.indexOf(y);E.children.splice(D,1),(i=E.children)!=null&&i.length||delete E.children}const C=P(f.data,x);if(C){const E=u(e,S),D=u(g,S);C.matrix=R.copy(D.matrixWorld).premultiply(E.matrixWorld.clone().invert()).toArray()}if(s===d)if(e===O(G).rootEntity)if(t){const D=f.data.nodes.findIndex(H=>{var W;return((W=H.extensions)==null?void 0:W[l.jsonID])===u(t,l)});f.data.scenes[0].nodes.splice(D,0,y);const B=structuredClone((a=f.data.nodes)==null?void 0:a[y]);(p=f.data.nodes)==null||p.splice(y,1),(m=f.data.nodes)==null||m.splice(D,0,B)}else f.data.scenes[0].nodes.push(y),(h=f.data.nodes)==null||h.push(f.data.nodes[y]);else{const D=P(f.data,c);if(D)if(D.children||(D.children=[]),t){const B=D.children.findIndex(H=>H===f.data.nodes.find(W=>{var ne;return((ne=W.extensions)==null?void 0:ne[l.jsonID])===u(t,l)}));D.children.splice(B,0,y)}else D.children.push(y)}else C&&r.push(C)}w(b.createSnapshot(f))}if(!Object.keys(o).includes(s)){const d=U.cloneCurrentSnapshot(s);for(const I of r){const f=d.data.nodes.push(I)-1;d.data.scenes[0].nodes.push(f);const g=P(d.data,c);if(g.children||(g.children=[]),t){const x=g.children.findIndex(y=>y===d.data.nodes.find(N=>{var C;return((C=N.extensions)==null?void 0:C[l.jsonID])===u(t,l)}));g.children.splice(x,0,f)}else g.children.push(f)}w(b.createSnapshot(d))}},on=n=>{const t=v(n);for(const[e,o]of Object.entries(t)){const s=U.cloneCurrentSnapshot(e),r={name:"New Group",extensions:{[l.jsonID]:k(),[S.jsonID]:F(S),[V.jsonID]:!0}};r.extensions[l.jsonID];const c=s.data.nodes.push(r)-1;for(const i of o){const a=u(i,l),p=s.data.nodes.findIndex(d=>{var I;return((I=d.extensions)==null?void 0:I[l.jsonID])===a});if(s.data.scenes[0].nodes.includes(p))s.data.scenes[0].nodes.splice(s.data.scenes[0].nodes.indexOf(p),1);else{const d=ee(s.data,a);if(!d)continue;const I=d.children.indexOf(p);d.children.splice(I,1)}const h=s.data.nodes[c];h.children||(h.children=[]),h.children.push(p)}s.data.scenes[0].nodes.push(c),w(b.createSnapshot(s))}},sn=n=>{M(j).selectedEntities.set([]);const t=v(n);for(const[e,o]of Object.entries(t)){const s=new Set(o.map(a=>u(a,l))),r=U.cloneCurrentSnapshot(e),c=r.data,i=cn(r.data,s);rn(c,i),dn(c),w(b.createSnapshot(r))}},cn=(n,t)=>{const e=new Set,o=s=>{var c;e.add(s),(c=n.nodes[s].children)==null||c.forEach(o)};return n.nodes.forEach((s,r)=>{var i;const c=(i=s.extensions)==null?void 0:i[l.jsonID];t.has(c)&&o(r)}),e},rn=(n,t)=>{for(let e=n.nodes.length-1;e>=0;e--)t.has(e)&&(an(n,e),n.nodes[e]=null)},an=(n,t)=>{n.nodes.forEach(e=>{e&&e.children&&(e.children=e.children.filter(o=>o!==t))}),n.scenes[0].nodes=n.scenes[0].nodes.filter(e=>e!==t)},dn=n=>{let t=0;const e=new Map;n.nodes=n.nodes.filter((o,s)=>o===null?(t++,!1):(e.set(s,s-t),!0)),ln(n,e)},ln=(n,t)=>{n.nodes.forEach(e=>{e.children&&(e.children=e.children.map(o=>t.get(o)))}),n.scenes[0].nodes=n.scenes[0].nodes.map(e=>t.get(e))},fn=n=>{const t=M(j).selectedEntities.value;if(n.length===t.length){let e=!0;for(let o=0;o<n.length;o++)if(!t.includes(n[o])){e=!1;break}if(e)return}j.updateSelection(n)},pn=n=>{const t=M(j).selectedEntities.value.slice(0);for(let e=0;e<n.length;e++){const o=n[e],s=t.indexOf(o);s>-1?t.splice(s,1):t.push(o)}j.updateSelection(t)},un=n=>{const t=M(j).selectedEntities.value.slice(0);for(let e=0;e<n.length;e++){const o=n[e];t.includes(o)||t.push(o)}j.updateSelection(n)},mn=n=>{const t=v(n);for(const e of Object.keys(t)){const o=U.cloneCurrentSnapshot(e);for(const s of n){const r=u(s,l),c=P(o.data,r);if(!c)continue;const i=u(s,S),a=i.position,p=i.rotation,m=i.scale,h=R.compose(a,p,m);c.matrix=h.toArray()}w(b.createSnapshot(o))}},gn={addOrRemoveComponent:Xe,hasComponentInAuthoringLayer:ke,modifyProperty:ze,modifyName:Ze,modifyMaterial:He,createObjectFromSceneElement:Ie,duplicateObject:Je,positionObject:qe,rotateObject:$e,rotateAround:en,scaleObject:nn,reparentObject:tn,groupObjects:on,removeObject:sn,addToSelection:un,replaceSelection:fn,toggleSelection:pn,commitTransformSave:mn,overwriteLookdevObject:Ve};export{gn as E,Qe as P,j as S,$ as T,he as a,ie as b};
