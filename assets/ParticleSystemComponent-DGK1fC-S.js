import{r as Se}from"./index-CBqU2yxZ.js";import{V as b,s as ve,t as Xt,l as we,u as et,i as Pt,v as Vt,w as nt,Q as j,O as Un,k as Qn,M as _e,I as xe,x as ie,y as Kn,U as jn,z as oe,F as ei,G as me,a as Le,H as zt,B as Ln,e as pe,J as ti,T as ni,g as ii,E as ri,K as ai,X as oi,Y as si,Z as ui,_ as li}from"./three.module-D2RMN07C.js";import{a as ci,m as F,c as wt,b as $t,e as di,N as Ht,g as hi,n as tt}from"./ActionFunctions-CxzuxLxN.js";import{S as p,c as fi,e as mi,f as vi,i as pi,b as yi,l as gi,s as We,t as Si,U as xi,m as wi}from"./index-_wFD3GG2.js";import{A as Ot}from"./AssetType-LSGL9ANY.js";import{a4 as Rn,a5 as Oi,u as en,a6 as bi,e as Ni,a7 as _i,a8 as Mi,n as In,o as Fn,A as bt,q as ki,N as Bi,p as Ti,a9 as Pi,z as Vi}from"./EditorServices-BJKHmurs.js";import{g as zi,a as Ei,m as Ai}from"./meshUtils-uAuBfJNJ.js";function Ci(i,t){var e=i==null?null:typeof Symbol<"u"&&i[Symbol.iterator]||i["@@iterator"];if(e!=null){var n,r,a,o,l=[],c=!0,d=!1;try{if(a=(e=e.call(i)).next,t!==0)for(;!(c=(n=a.call(e)).done)&&(l.push(n.value),l.length!==t);c=!0);}catch(y){d=!0,r=y}finally{try{if(!c&&e.return!=null&&(o=e.return(),Object(o)!==o))return}finally{if(d)throw r}}return l}}function Et(){Et=function(){return t};var i,t={},e=Object.prototype,n=e.hasOwnProperty,r=Object.defineProperty||function(f,h,v){f[h]=v.value},a=typeof Symbol=="function"?Symbol:{},o=a.iterator||"@@iterator",l=a.asyncIterator||"@@asyncIterator",c=a.toStringTag||"@@toStringTag";function d(f,h,v){return Object.defineProperty(f,h,{value:v,enumerable:!0,configurable:!0,writable:!0}),f[h]}try{d({},"")}catch{d=function(h,v,z){return h[v]=z}}function y(f,h,v,z){var O=h&&h.prototype instanceof R?h:R,I=Object.create(O.prototype),X=new re(z||[]);return r(I,"_invoke",{value:D(f,v,X)}),I}function w(f,h,v){try{return{type:"normal",arg:f.call(h,v)}}catch(z){return{type:"throw",arg:z}}}t.wrap=y;var m="suspendedStart",M="suspendedYield",g="executing",B="completed",T={};function R(){}function J(){}function P(){}var C={};d(C,o,function(){return this});var G=Object.getPrototypeOf,A=G&&G(G(ue([])));A&&A!==e&&n.call(A,o)&&(C=A);var V=P.prototype=R.prototype=Object.create(C);function E(f){["next","throw","return"].forEach(function(h){d(f,h,function(v){return this._invoke(h,v)})})}function x(f,h){function v(O,I,X,Y){var H=w(f[O],f,I);if(H.type!=="throw"){var ae=H.arg,te=ae.value;return te&&typeof te=="object"&&n.call(te,"__await")?h.resolve(te.__await).then(function(ne){v("next",ne,X,Y)},function(ne){v("throw",ne,X,Y)}):h.resolve(te).then(function(ne){ae.value=ne,X(ae)},function(ne){return v("throw",ne,X,Y)})}Y(H.arg)}var z;r(this,"_invoke",{value:function(O,I){function X(){return new h(function(Y,H){v(O,I,Y,H)})}return z=z?z.then(X,X):X()}})}function D(f,h,v){var z=m;return function(O,I){if(z===g)throw new Error("Generator is already running");if(z===B){if(O==="throw")throw I;return{value:i,done:!0}}for(v.method=O,v.arg=I;;){var X=v.delegate;if(X){var Y=q(X,v);if(Y){if(Y===T)continue;return Y}}if(v.method==="next")v.sent=v._sent=v.arg;else if(v.method==="throw"){if(z===m)throw z=B,v.arg;v.dispatchException(v.arg)}else v.method==="return"&&v.abrupt("return",v.arg);z=g;var H=w(f,h,v);if(H.type==="normal"){if(z=v.done?B:M,H.arg===T)continue;return{value:H.arg,done:v.done}}H.type==="throw"&&(z=B,v.method="throw",v.arg=H.arg)}}}function q(f,h){var v=h.method,z=f.iterator[v];if(z===i)return h.delegate=null,v==="throw"&&f.iterator.return&&(h.method="return",h.arg=i,q(f,h),h.method==="throw")||v!=="return"&&(h.method="throw",h.arg=new TypeError("The iterator does not provide a '"+v+"' method")),T;var O=w(z,f.iterator,h.arg);if(O.type==="throw")return h.method="throw",h.arg=O.arg,h.delegate=null,T;var I=O.arg;return I?I.done?(h[f.resultName]=I.value,h.next=f.nextLoc,h.method!=="return"&&(h.method="next",h.arg=i),h.delegate=null,T):I:(h.method="throw",h.arg=new TypeError("iterator result is not an object"),h.delegate=null,T)}function Q(f){var h={tryLoc:f[0]};1 in f&&(h.catchLoc=f[1]),2 in f&&(h.finallyLoc=f[2],h.afterLoc=f[3]),this.tryEntries.push(h)}function W(f){var h=f.completion||{};h.type="normal",delete h.arg,f.completion=h}function re(f){this.tryEntries=[{tryLoc:"root"}],f.forEach(Q,this),this.reset(!0)}function ue(f){if(f||f===""){var h=f[o];if(h)return h.call(f);if(typeof f.next=="function")return f;if(!isNaN(f.length)){var v=-1,z=function O(){for(;++v<f.length;)if(n.call(f,v))return O.value=f[v],O.done=!1,O;return O.value=i,O.done=!0,O};return z.next=z}}throw new TypeError(typeof f+" is not iterable")}return J.prototype=P,r(V,"constructor",{value:P,configurable:!0}),r(P,"constructor",{value:J,configurable:!0}),J.displayName=d(P,c,"GeneratorFunction"),t.isGeneratorFunction=function(f){var h=typeof f=="function"&&f.constructor;return!!h&&(h===J||(h.displayName||h.name)==="GeneratorFunction")},t.mark=function(f){return Object.setPrototypeOf?Object.setPrototypeOf(f,P):(f.__proto__=P,d(f,c,"GeneratorFunction")),f.prototype=Object.create(V),f},t.awrap=function(f){return{__await:f}},E(x.prototype),d(x.prototype,l,function(){return this}),t.AsyncIterator=x,t.async=function(f,h,v,z,O){O===void 0&&(O=Promise);var I=new x(y(f,h,v,z),O);return t.isGeneratorFunction(h)?I:I.next().then(function(X){return X.done?X.value:I.next()})},E(V),d(V,c,"Generator"),d(V,o,function(){return this}),d(V,"toString",function(){return"[object Generator]"}),t.keys=function(f){var h=Object(f),v=[];for(var z in h)v.push(z);return v.reverse(),function O(){for(;v.length;){var I=v.pop();if(I in h)return O.value=I,O.done=!1,O}return O.done=!0,O}},t.values=ue,re.prototype={constructor:re,reset:function(f){if(this.prev=0,this.next=0,this.sent=this._sent=i,this.done=!1,this.delegate=null,this.method="next",this.arg=i,this.tryEntries.forEach(W),!f)for(var h in this)h.charAt(0)==="t"&&n.call(this,h)&&!isNaN(+h.slice(1))&&(this[h]=i)},stop:function(){this.done=!0;var f=this.tryEntries[0].completion;if(f.type==="throw")throw f.arg;return this.rval},dispatchException:function(f){if(this.done)throw f;var h=this;function v(H,ae){return I.type="throw",I.arg=f,h.next=H,ae&&(h.method="next",h.arg=i),!!ae}for(var z=this.tryEntries.length-1;z>=0;--z){var O=this.tryEntries[z],I=O.completion;if(O.tryLoc==="root")return v("end");if(O.tryLoc<=this.prev){var X=n.call(O,"catchLoc"),Y=n.call(O,"finallyLoc");if(X&&Y){if(this.prev<O.catchLoc)return v(O.catchLoc,!0);if(this.prev<O.finallyLoc)return v(O.finallyLoc)}else if(X){if(this.prev<O.catchLoc)return v(O.catchLoc,!0)}else{if(!Y)throw new Error("try statement without catch or finally");if(this.prev<O.finallyLoc)return v(O.finallyLoc)}}}},abrupt:function(f,h){for(var v=this.tryEntries.length-1;v>=0;--v){var z=this.tryEntries[v];if(z.tryLoc<=this.prev&&n.call(z,"finallyLoc")&&this.prev<z.finallyLoc){var O=z;break}}O&&(f==="break"||f==="continue")&&O.tryLoc<=h&&h<=O.finallyLoc&&(O=null);var I=O?O.completion:{};return I.type=f,I.arg=h,O?(this.method="next",this.next=O.finallyLoc,T):this.complete(I)},complete:function(f,h){if(f.type==="throw")throw f.arg;return f.type==="break"||f.type==="continue"?this.next=f.arg:f.type==="return"?(this.rval=this.arg=f.arg,this.method="return",this.next="end"):f.type==="normal"&&h&&(this.next=h),T},finish:function(f){for(var h=this.tryEntries.length-1;h>=0;--h){var v=this.tryEntries[h];if(v.finallyLoc===f)return this.complete(v.completion,v.afterLoc),W(v),T}},catch:function(f){for(var h=this.tryEntries.length-1;h>=0;--h){var v=this.tryEntries[h];if(v.tryLoc===f){var z=v.completion;if(z.type==="throw"){var O=z.arg;W(v)}return O}}throw new Error("illegal catch attempt")},delegateYield:function(f,h,v){return this.delegate={iterator:ue(f),resultName:h,nextLoc:v},this.method==="next"&&(this.arg=i),T}},t}function be(i){"@babel/helpers - typeof";return be=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},be(i)}function N(i,t){if(!(i instanceof t))throw new TypeError("Cannot call a class as a function")}function tn(i,t){for(var e=0;e<t.length;e++){var n=t[e];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(i,Gn(n.key),n)}}function _(i,t,e){return t&&tn(i.prototype,t),e&&tn(i,e),Object.defineProperty(i,"prototype",{writable:!1}),i}function s(i,t,e){return t=Gn(t),t in i?Object.defineProperty(i,t,{value:e,enumerable:!0,configurable:!0,writable:!0}):i[t]=e,i}function Me(i,t){if(typeof t!="function"&&t!==null)throw new TypeError("Super expression must either be null or a function");i.prototype=Object.create(t&&t.prototype,{constructor:{value:i,writable:!0,configurable:!0}}),Object.defineProperty(i,"prototype",{writable:!1}),t&&At(i,t)}function it(i){return it=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},it(i)}function At(i,t){return At=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(n,r){return n.__proto__=r,n},At(i,t)}function Ji(){if(typeof Reflect>"u"||!Reflect.construct||Reflect.construct.sham)return!1;if(typeof Proxy=="function")return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch{return!1}}function U(i){if(i===void 0)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return i}function Ui(i,t){if(t&&(typeof t=="object"||typeof t=="function"))return t;if(t!==void 0)throw new TypeError("Derived constructors may only return object or undefined");return U(i)}function ke(i){var t=Ji();return function(){var n=it(i),r;if(t){var a=it(this).constructor;r=Reflect.construct(n,arguments,a)}else r=n.apply(this,arguments);return Ui(this,r)}}function Oe(i,t){return Li(i)||Ci(i,t)||Dn(i,t)||Ri()}function Li(i){if(Array.isArray(i))return i}function Dn(i,t){if(i){if(typeof i=="string")return nn(i,t);var e=Object.prototype.toString.call(i).slice(8,-1);if(e==="Object"&&i.constructor&&(e=i.constructor.name),e==="Map"||e==="Set")return Array.from(i);if(e==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(e))return nn(i,t)}}function nn(i,t){(t==null||t>i.length)&&(t=i.length);for(var e=0,n=new Array(t);e<t;e++)n[e]=i[e];return n}function Ri(){throw new TypeError(`Invalid attempt to destructure non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}function rn(i,t){var e=typeof Symbol<"u"&&i[Symbol.iterator]||i["@@iterator"];if(!e){if(Array.isArray(i)||(e=Dn(i))||t){e&&(i=e);var n=0,r=function(){};return{s:r,n:function(){return n>=i.length?{done:!0}:{done:!1,value:i[n++]}},e:function(c){throw c},f:r}}throw new TypeError(`Invalid attempt to iterate non-iterable instance.
In order to be iterable, non-array objects must have a [Symbol.iterator]() method.`)}var a=!0,o=!1,l;return{s:function(){e=e.call(i)},n:function(){var c=e.next();return a=c.done,c},e:function(c){o=!0,l=c},f:function(){try{!a&&e.return!=null&&e.return()}finally{if(o)throw l}}}}function Ii(i,t){if(typeof i!="object"||i===null)return i;var e=i[Symbol.toPrimitive];if(e!==void 0){var n=e.call(i,t||"default");if(typeof n!="object")return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(i)}function Gn(i){var t=Ii(i,"string");return typeof t=="symbol"?t:String(t)}var Fi=function(i){Me(e,i);var t=ke(e);function e(n){var r;return N(this,e),r=t.call(this),s(U(r),"type","ParticleEmitter"),s(U(r),"system",void 0),r.system=n,r}return _(e,[{key:"clone",value:function(){var r=this.system.clone();return r.emitter.copy(this,!0),r.emitter}},{key:"dispose",value:function(){}},{key:"extractFromCache",value:function(r){var a=[];for(var o in r){var l=r[o];delete l.metadata,a.push(l)}return a}},{key:"toJSON",value:function(r){var a=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},o=r===void 0||typeof r=="string",l={};o&&(r={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},l.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});var c={};if(c.uuid=this.uuid,c.type=this.type,this.name!==""&&(c.name=this.name),this.castShadow===!0&&(c.castShadow=!0),this.receiveShadow===!0&&(c.receiveShadow=!0),this.visible===!1&&(c.visible=!1),this.frustumCulled===!1&&(c.frustumCulled=!1),this.renderOrder!==0&&(c.renderOrder=this.renderOrder),JSON.stringify(this.userData)!=="{}"&&(c.userData=this.userData),c.layers=this.layers.mask,c.matrix=this.matrix.toArray(),this.matrixAutoUpdate===!1&&(c.matrixAutoUpdate=!1),this.system!==null&&(c.ps=this.system.toJSON(r,a)),this.children.length>0){c.children=[];for(var d=0;d<this.children.length;d++)this.children[d].type!=="ParticleSystemPreview"&&c.children.push(this.children[d].toJSON(r).object)}if(o){var y=this.extractFromCache(r.geometries),w=this.extractFromCache(r.materials),m=this.extractFromCache(r.textures),M=this.extractFromCache(r.images);y.length>0&&(l.geometries=y),w.length>0&&(l.materials=w),m.length>0&&(l.textures=m),M.length>0&&(l.images=M)}return l.object=c,l}}]),e}(Un),Nt=function(){function i(t){N(this,i),s(this,"data",void 0),s(this,"next",void 0),s(this,"prev",void 0),this.data=t,this.next=null,this.prev=null}return _(i,[{key:"hasPrev",value:function(){return this.prev!==null}},{key:"hasNext",value:function(){return this.next!==null}}]),i}(),Di=function(){function i(){N(this,i),s(this,"length",void 0),s(this,"head",void 0),s(this,"tail",void 0),this.length=0,this.head=this.tail=null}return _(i,[{key:"isEmpty",value:function(){return this.head===null}},{key:"clear",value:function(){this.length=0,this.head=this.tail=null}},{key:"front",value:function(){return this.head===null?null:this.head.data}},{key:"back",value:function(){return this.tail===null?null:this.tail.data}},{key:"dequeue",value:function(){if(this.head){var e=this.head.data;return this.head=this.head.next,this.head?this.head.prev=null:this.tail=null,this.length--,e}}},{key:"pop",value:function(){if(this.tail){var e=this.tail.data;return this.tail=this.tail.prev,this.tail?this.tail.next=null:this.head=null,this.length--,e}}},{key:"queue",value:function(e){var n=new Nt(e);this.tail||(this.tail=n),this.head&&(this.head.prev=n,n.next=this.head),this.head=n,this.length++}},{key:"push",value:function(e){var n=new Nt(e);this.head||(this.head=n),this.tail&&(this.tail.next=n,n.prev=this.tail),this.tail=n,this.length++}},{key:"insertBefore",value:function(e,n){var r=new Nt(n);r.next=e,r.prev=e.prev,r.prev!==null&&(r.prev.next=r),r.next.prev=r,e==this.head&&(this.head=r),this.length++}},{key:"remove",value:function(e){if(!(this.head===null||this.tail===null)){var n=this.head;for(e===this.head.data&&(this.head=this.head.next),e===this.tail.data&&(this.tail=this.tail.prev);n.next!==null&&n.data!==e;)n=n.next;n.data===e&&(n.prev!==null&&(n.prev.next=n.next),n.next!==null&&(n.next.prev=n.prev),this.length--)}}},{key:"values",value:Et().mark(function t(){var e;return Et().wrap(function(r){for(;;)switch(r.prev=r.next){case 0:e=this.head;case 1:if(e===null){r.next=7;break}return r.next=4,e.data;case 4:e=e.next,r.next=1;break;case 7:case"end":return r.stop()}},t,this)})}]),i}(),Ct=function(){function i(){N(this,i),s(this,"parentMatrix",void 0),s(this,"startSpeed",0),s(this,"startColor",new ve),s(this,"startSize",1),s(this,"position",new b),s(this,"velocity",new b),s(this,"age",0),s(this,"life",1),s(this,"size",1),s(this,"angularVelocity",void 0),s(this,"rotation",0),s(this,"color",new ve),s(this,"uvTile",0)}return _(i,[{key:"died",get:function(){return this.age>=this.life}}]),i}(),Gi=_(function i(t,e,n){N(this,i),this.position=t,this.size=e,this.color=n}),Jt=function(){function i(){N(this,i),s(this,"parentMatrix",void 0),s(this,"startSpeed",0),s(this,"startColor",new ve),s(this,"startSize",1),s(this,"position",new b),s(this,"localPosition",void 0),s(this,"velocity",new b),s(this,"age",0),s(this,"life",1),s(this,"size",1),s(this,"length",100),s(this,"color",new ve),s(this,"previous",new Di),s(this,"uvTile",0)}return _(i,[{key:"update",value:function(){for(this.age<=this.life?this.previous.push(new Gi(this.position.clone(),this.size,this.color.clone())):this.previous.length>0&&this.previous.dequeue();this.previous.length>this.length;)this.previous.dequeue()}},{key:"died",get:function(){return this.age>=this.life}},{key:"reset",value:function(){this.previous.clear()}}]),i}(),Ut=function(){function i(t,e,n,r){N(this,i),s(this,"p",void 0),this.p=[t,e,n,r]}return _(i,[{key:"genValue",value:function(e){var n=e*e,r=e*e*e,a=1-e,o=a*a,l=o*a;return this.p[0]*l+this.p[1]*o*e*3+this.p[2]*a*n*3+this.p[3]*r}},{key:"derivativeCoefficients",value:function(e){for(var n=[],r=e,a=r.length-1;a>0;a--){for(var o=[],l=0;l<a;l++){var c=a*(r[l+1]-r[l]);o.push(c)}n.push(o),r=o}return n}},{key:"getSlope",value:function(e){var n=this.derivativeCoefficients(this.p)[0],r=1-e,a=r*r,o=r*e*2,l=e*e;return a*n[0]+o*n[1]+l*n[2]}},{key:"controlCurve",value:function(e,n){this.p[1]=e/3+this.p[0],this.p[2]=this.p[3]-n/3}},{key:"hull",value:function(e){var n=this.p,r=[],a,o=0,l=0,c=0,d=[];for(d[o++]=n[0],d[o++]=n[1],d[o++]=n[2],d[o++]=n[3];n.length>1;){for(r=[],l=0,c=n.length-1;l<c;l++)a=e*n[l]+(1-e)*n[l+1],d[o++]=a,r.push(a);n=r}return d}},{key:"split",value:function(e){var n=this.hull(e),r={left:new i(n[0],n[4],n[7],n[9]),right:new i(n[9],n[8],n[6],n[3]),span:n};return r}},{key:"clone",value:function(){return new i(this.p[0],this.p[1],this.p[2],this.p[3])}},{key:"toJSON",value:function(){return{p0:this.p[0],p1:this.p[1],p2:this.p[2],p3:this.p[3]}}}],[{key:"fromJSON",value:function(e){return new i(e.p0,e.p1,e.p2,e.p3)}}]),i}(),Re=function(t){return{r:t.x,g:t.y,b:t.z,a:t.w}},Ie=function(t){return new ve(t.r,t.g,t.b,t.a)},qi=function(t,e){switch(e){case"Vector3":return new b(t.x,t.y,t.z);case"Vector4":return new ve(t.x,t.y,t.z,t.w);case"Color":return new b(t.r,t.g,t.b);case"Number":return t;default:return t}},Xi=function(t,e){switch(e){case"Vector3":return{x:t.x,y:t.y,z:t.z};case"Vector4":return{x:t.x,y:t.y,z:t.z,w:t.w};case"Color":return{r:t.x,g:t.y,b:t.z};case"Number":return t;default:return t}},$i=function(){function i(t,e){N(this,i),s(this,"type",void 0),this.a=t,this.b=e,this.type="value"}return _(i,[{key:"genColor",value:function(e){var n=Math.random();return e.copy(this.a).lerp(this.b,n)}},{key:"toJSON",value:function(){return{type:"RandomColor",a:Re(this.a),b:Re(this.b)}}},{key:"clone",value:function(){return new i(this.a.clone(),this.b.clone())}}],[{key:"fromJSON",value:function(e){return new i(Ie(e.a),Ie(e.b))}}]),i}(),Lt=function(){function i(t,e){N(this,i),s(this,"type",void 0),this.a=t,this.b=e,this.type="value"}return _(i,[{key:"genColor",value:function(e,n){return e.copy(this.a).lerp(this.b,Math.random())}},{key:"toJSON",value:function(){return{type:"ColorRange",a:Re(this.a),b:Re(this.b)}}},{key:"clone",value:function(){return new i(this.a.clone(),this.b.clone())}}],[{key:"fromJSON",value:function(e){return new i(Ie(e.a),Ie(e.b))}}]),i}(),Ze=function(){function i(t,e){N(this,i),s(this,"keys",void 0),s(this,"type",void 0),s(this,"subType",void 0),this.subType=e,this.type="function",this.keys=t}return _(i,[{key:"findKey",value:function(e){for(var n=0,r=0,a=this.keys.length-1;r+1<a;)if(n=Math.floor((r+a)/2),e<this.getStartX(n))a=n-1;else if(e>this.getEndX(n))r=n+1;else return n;for(var o=r;o<=a;o++)if(e>=this.getStartX(o)&&e<=this.getEndX(o))return o;return-1}},{key:"getStartX",value:function(e){return this.keys[e][1]}},{key:"getEndX",value:function(e){return e+1<this.keys.length?this.keys[e+1][1]:1}},{key:"genValue",value:function(e,n){var r=this.findKey(n);return this.subType==="Number"?r===-1?this.keys[0][0]:r+1>=this.keys.length?this.keys[this.keys.length-1][0]:(this.keys[r+1][0]-this.keys[r][0])*((n-this.getStartX(r))/(this.getEndX(r)-this.getStartX(r)))+this.keys[r][0]:r===-1?e.copy(this.keys[0][0]):r+1>=this.keys.length?e.copy(this.keys[this.keys.length-1][0]):e.copy(this.keys[r][0]).lerp(this.keys[r+1][0],(n-this.getStartX(r))/(this.getEndX(r)-this.getStartX(r)))}},{key:"toJSON",value:function(){var e=this;return this.keys[0][0].constructor.name,{type:"CLinearFunction",subType:this.subType,keys:this.keys.map(function(n){var r=Oe(n,2),a=r[0],o=r[1];return{value:Xi(a,e.subType),pos:o}})}}},{key:"clone",value:function(){return this.subType==="Number"?new i(this.keys.map(function(e){var n=Oe(e,2),r=n[0],a=n[1];return[r,a]}),this.subType):new i(this.keys.map(function(e){var n=Oe(e,2),r=n[0],a=n[1];return[r.clone(),a]}),this.subType)}}],[{key:"fromJSON",value:function(e){return new i(e.keys.map(function(n){return[qi(n.value,e.subType),n.pos]}),e.subType)}}]),i}(),Qe=new b,Rt=function(){function i(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[[new b(0,0,0),0],[new b(1,1,1),0]],e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:[[1,0],[1,1]];N(this,i),s(this,"type",void 0),s(this,"color",void 0),s(this,"alpha",void 0),this.type="function",this.color=new Ze(t,"Color"),this.alpha=new Ze(e,"Number")}return _(i,[{key:"genColor",value:function(e,n){return this.color.genValue(Qe,n),e.set(Qe.x,Qe.y,Qe.z,this.alpha.genValue(1,n))}},{key:"toJSON",value:function(){return{type:"Gradient",color:this.color.toJSON(),alpha:this.alpha.toJSON()}}},{key:"clone",value:function(){var e=new i;return e.alpha=this.alpha.clone(),e.color=this.color.clone(),e}}],[{key:"fromJSON",value:function(e){if(e.functions){var n=e.functions.map(function(a){return[Lt.fromJSON(a.function).a,a.start]});return e.functions.length>0&&n.push([Lt.fromJSON(e.functions[e.functions.length-1].function).b,1]),new i(n.map(function(a){return[new b(a[0].x,a[0].y,a[0].z),a[1]]}),n.map(function(a){return[a[0].w,a[1]]}))}else{var r=new i;return r.alpha=Ze.fromJSON(e.alpha),r.color=Ze.fromJSON(e.color),r}}}]),i}(),_t=new ve,Hi=function(){function i(t,e){N(this,i),s(this,"gradient1",void 0),s(this,"gradient2",void 0),s(this,"type",void 0),this.type="memorizedFunction",this.gradient1=t,this.gradient2=e}return _(i,[{key:"startGen",value:function(e){e.rand=Math.random()}},{key:"genColor",value:function(e,n,r){return this.gradient1.genColor(e,n),this.gradient2.genColor(_t,n),r&&r.rand?e.lerp(_t,r.rand):e.lerp(_t,Math.random()),e}},{key:"toJSON",value:function(){return{type:"RandomColorBetweenGradient",gradient1:this.gradient1.toJSON(),gradient2:this.gradient2.toJSON()}}},{key:"clone",value:function(){return new i(this.gradient1.clone(),this.gradient2.clone())}}],[{key:"fromJSON",value:function(e){return new i(Rt.fromJSON(e.gradient1),Rt.fromJSON(e.gradient2))}}]),i}(),It=function(){function i(t){N(this,i),s(this,"type",void 0),this.color=t,this.type="value"}return _(i,[{key:"genColor",value:function(e){return e.copy(this.color)}},{key:"toJSON",value:function(){return{type:"ConstantColor",color:Re(this.color)}}},{key:"clone",value:function(){return new i(this.color.clone())}}],[{key:"fromJSON",value:function(e){return new i(Ie(e.color))}}]),i}();function Yt(i){switch(i.type){case"ConstantColor":return It.fromJSON(i);case"ColorRange":return Lt.fromJSON(i);case"RandomColor":return $i.fromJSON(i);case"Gradient":return Rt.fromJSON(i);case"RandomColorBetweenGradient":return Hi.fromJSON(i);default:return new It(new ve(1,1,1,1))}}var $=function(){function i(t){N(this,i),s(this,"type",void 0),this.value=t,this.type="value"}return _(i,[{key:"genValue",value:function(){return this.value}},{key:"toJSON",value:function(){return{type:"ConstantValue",value:this.value}}},{key:"clone",value:function(){return new i(this.value)}}],[{key:"fromJSON",value:function(e){return new i(e.value)}}]),i}(),Ne=function(){function i(t,e){N(this,i),s(this,"type",void 0),this.a=t,this.b=e,this.type="value"}return _(i,[{key:"genValue",value:function(){return _e.lerp(this.a,this.b,Math.random())}},{key:"toJSON",value:function(){return{type:"IntervalValue",a:this.a,b:this.b}}},{key:"clone",value:function(){return new i(this.a,this.b)}}],[{key:"fromJSON",value:function(e){return new i(e.a,e.b)}}]),i}(),Yi=function(){function i(){N(this,i),s(this,"functions",void 0),this.functions=new Array}return _(i,[{key:"findFunction",value:function(e){for(var n=0,r=0,a=this.functions.length-1;r+1<a;)if(n=Math.floor((r+a)/2),e<this.getStartX(n))a=n-1;else if(e>this.getEndX(n))r=n+1;else return n;for(var o=r;o<=a;o++)if(e>=this.functions[o][1]&&e<=this.getEndX(o))return o;return-1}},{key:"getStartX",value:function(e){return this.functions[e][1]}},{key:"setStartX",value:function(e,n){e>0&&(this.functions[e][1]=n)}},{key:"getEndX",value:function(e){return e+1<this.functions.length?this.functions[e+1][1]:1}},{key:"setEndX",value:function(e,n){e+1<this.functions.length&&(this.functions[e+1][1]=n)}},{key:"insertFunction",value:function(e,n){var r=this.findFunction(e);this.functions.splice(r+1,0,[n,e])}},{key:"removeFunction",value:function(e){return this.functions.splice(e,1)[0][0]}},{key:"getFunction",value:function(e){return this.functions[e][0]}},{key:"setFunction",value:function(e,n){this.functions[e][0]=n}},{key:"numOfFunctions",get:function(){return this.functions.length}}]),i}(),Ft=function(i){Me(e,i);var t=ke(e);function e(){var n,r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:[[new Ut(0,.3333333333333333,.6666666666666666,1),0]];return N(this,e),n=t.call(this),s(U(n),"type",void 0),n.type="function",n.functions=r,n}return _(e,[{key:"genValue",value:function(){var r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0,a=this.findFunction(r);return a===-1?0:this.functions[a][0].genValue((r-this.getStartX(a))/(this.getEndX(a)-this.getStartX(a)))}},{key:"toSVG",value:function(r,a){if(a<1)return"";for(var o=["M",0,this.functions[0][0].p[0]].join(" "),l=1/a;l<=1;l+=1/a)o=[o,"L",l*r,this.genValue(l)].join(" ");return o}},{key:"toJSON",value:function(){return{type:"PiecewiseBezier",functions:this.functions.map(function(r){var a=Oe(r,2),o=a[0],l=a[1];return{function:o.toJSON(),start:l}})}}},{key:"clone",value:function(){return new e(this.functions.map(function(r){var a=Oe(r,2),o=a[0],l=a[1];return[o.clone(),l]}))}}],[{key:"fromJSON",value:function(r){return new e(r.functions.map(function(a){return[Ut.fromJSON(a.function),a.start]}))}}]),e}(Yi);function L(i){switch(i.type){case"ConstantValue":return $.fromJSON(i);case"IntervalValue":return Ne.fromJSON(i);case"PiecewiseBezier":return Ft.fromJSON(i);default:return new $(0)}}var an=function(){function i(){N(this,i),s(this,"type",void 0),this.type="rotation"}return _(i,[{key:"genValue",value:function(e,n){var r,a,o,l,c,d;do r=Math.random()*2-1,a=Math.random()*2-1,o=r*r+a*a;while(o>1);do l=Math.random()*2-1,c=Math.random()*2-1,d=l*l+c*c;while(d>1);var y=Math.sqrt((1-o)/d);return e.set(r,a,y*l,y*c),e}},{key:"toJSON",value:function(){return{type:"RandomQuat"}}},{key:"clone",value:function(){return new i}}],[{key:"fromJSON",value:function(e){return new i}}]),i}(),qn=function(){function i(t,e){N(this,i),s(this,"type",void 0),this.axis=t,this.angle=e,this.type="rotation"}return _(i,[{key:"genValue",value:function(e,n){return e.setFromAxisAngle(this.axis,this.angle.genValue(n))}},{key:"toJSON",value:function(){return{type:"AxisAngle",axis:{x:this.axis.x,y:this.axis.y,z:this.axis.z},angle:this.angle.toJSON()}}},{key:"clone",value:function(){return new i(this.axis.clone(),this.angle.clone())}}],[{key:"fromJSON",value:function(e){return new i(new b(e.axis.x,e.axis.y,e.axis.z),L(e.angle))}}]),i}(),Wi=function(){function i(t,e,n,r){N(this,i),s(this,"type",void 0),s(this,"eular",void 0),this.angleX=t,this.angleY=e,this.angleZ=n,this.type="rotation",this.eular=new ri(0,0,0,r)}return _(i,[{key:"genValue",value:function(e,n){return this.eular.set(this.angleX.genValue(n),this.angleY.genValue(n),this.angleZ.genValue(n)),e.setFromEuler(this.eular)}},{key:"toJSON",value:function(){return{type:"Euler",angleX:this.angleX.toJSON(),angleY:this.angleY.toJSON(),angleZ:this.angleZ.toJSON(),eulerOrder:this.eular.order}}},{key:"clone",value:function(){return new i(this.angleX,this.angleY,this.angleZ,this.eular.order)}}],[{key:"fromJSON",value:function(e){return new i(L(e.angleX),L(e.angleY),L(e.angleZ),e.eulerOrder)}}]),i}();function Xn(i){switch(i.type){case"AxisAngle":return qn.fromJSON(i);case"Euler":return Wi.fromJSON(i);case"RandomQuat":return an.fromJSON(i);default:return new an}}function Zi(i){switch(i.type){case"ConstantValue":case"IntervalValue":case"PiecewiseBezier":return L(i);case"AxisAngle":case"RandomQuat":case"Euler":return Xn(i);default:return new $(0)}}var on=function(){function i(t){N(this,i),s(this,"type","ColorOverLife"),this.color=t}return _(i,[{key:"initialize",value:function(e){this.color.type==="memorizedFunction"&&(e.colorOverLifeMemory={},this.color.startGen(e.colorOverLifeMemory))}},{key:"update",value:function(e,n){this.color.type==="memorizedFunction"?this.color.genColor(e.color,e.age/e.life,e.colorOverLifeMemory):this.color.genColor(e.color,e.age/e.life),e.color.x*=e.startColor.x,e.color.y*=e.startColor.y,e.color.z*=e.startColor.z,e.color.w*=e.startColor.w}},{key:"frameUpdate",value:function(e){}},{key:"toJSON",value:function(){return{type:this.type,color:this.color.toJSON()}}},{key:"clone",value:function(){return new i(this.color.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new i(Yt(e.color))}}]),i}(),sn=function(){function i(t){N(this,i),s(this,"type","RotationOverLife"),s(this,"dynamic",void 0),this.angularVelocity=t,this.dynamic=!(t instanceof $||t instanceof Ne)}return _(i,[{key:"initialize",value:function(e){this.dynamic=!(this.angularVelocity instanceof $||this.angularVelocity instanceof Ne),!this.dynamic&&typeof e.rotation=="number"&&(e.angularVelocity=this.angularVelocity.genValue())}},{key:"update",value:function(e,n){this.dynamic?typeof e.rotation=="number"&&(e.rotation+=n*this.angularVelocity.genValue(e.age/e.life)):typeof e.rotation=="number"&&(e.rotation+=n*e.angularVelocity)}},{key:"toJSON",value:function(){return{type:this.type,angularVelocity:this.angularVelocity.toJSON()}}},{key:"frameUpdate",value:function(e){}},{key:"clone",value:function(){return new i(this.angularVelocity.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new i(L(e.angularVelocity))}}]),i}(),un=new j,ln=function(){function i(t,e){N(this,i),s(this,"type","Rotation3DOverLife"),s(this,"tempQuat",new j),this.angularVelocity=t,this.dynamic=e}return _(i,[{key:"initialize",value:function(e){!this.dynamic&&e instanceof Ct&&(e.angularVelocity=new j,this.angularVelocity.genValue(e.angularVelocity))}},{key:"update",value:function(e,n){this.dynamic?(this.angularVelocity.genValue(this.tempQuat,e.age/e.life),this.tempQuat.slerpQuaternions(un,this.tempQuat,n),e.rotation.multiply(this.tempQuat)):e instanceof Ct&&(this.tempQuat.slerpQuaternions(un,e.angularVelocity,n),e.rotation.multiply(this.tempQuat))}},{key:"toJSON",value:function(){return{type:this.type,angularVelocity:this.angularVelocity.toJSON(),dynamic:this.dynamic}}},{key:"frameUpdate",value:function(e){}},{key:"clone",value:function(){return new i(this.angularVelocity.clone(),this.dynamic)}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new i(Xn(e.angularVelocity),e.dynamic)}}]),i}(),cn=function(){function i(t,e,n){N(this,i),s(this,"type","ForceOverLife"),s(this,"_temp",new b),this.x=t,this.y=e,this.z=n}return _(i,[{key:"initialize",value:function(e){}},{key:"update",value:function(e,n){this._temp.set(this.x.genValue(e.age/e.life),this.y.genValue(e.age/e.life),this.z.genValue(e.age/e.life)),e.velocity.addScaledVector(this._temp,n)}},{key:"toJSON",value:function(){return{type:this.type,x:this.x.toJSON(),y:this.y.toJSON(),z:this.z.toJSON()}}},{key:"frameUpdate",value:function(e){}},{key:"clone",value:function(){return new i(this.x.clone(),this.y.clone(),this.z.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new i(L(e.x),L(e.y),L(e.z))}}]),i}(),dn=function(){function i(t){N(this,i),s(this,"type","SizeOverLife"),this.size=t}return _(i,[{key:"initialize",value:function(e){}},{key:"update",value:function(e){e.size=e.startSize*this.size.genValue(e.age/e.life)}},{key:"toJSON",value:function(){return{type:this.type,size:this.size.toJSON()}}},{key:"frameUpdate",value:function(e){}},{key:"clone",value:function(){return new i(this.size.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new i(L(e.size))}}]),i}(),hn=function(){function i(t){N(this,i),s(this,"type","SpeedOverLife"),this.speed=t}return _(i,[{key:"initialize",value:function(e){}},{key:"update",value:function(e){e.speedModifier=this.speed.genValue(e.age/e.life)}},{key:"toJSON",value:function(){return{type:this.type,speed:this.speed.toJSON()}}},{key:"frameUpdate",value:function(e){}},{key:"clone",value:function(){return new i(this.speed.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new i(L(e.speed))}}]),i}(),fn=function(){function i(t){N(this,i),s(this,"type","FrameOverLife"),this.frame=t}return _(i,[{key:"initialize",value:function(e){this.frame instanceof Ft||(e.uvTile=Math.floor(this.frame.genValue(0)+.001))}},{key:"update",value:function(e,n){this.frame instanceof Ft&&(e.uvTile=Math.floor(this.frame.genValue(e.age/e.life)+.001))}},{key:"frameUpdate",value:function(e){}},{key:"toJSON",value:function(){return{type:this.type,frame:this.frame.toJSON()}}},{key:"clone",value:function(){return new i(this.frame.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new i(L(e.frame))}}]),i}();new b(0,0,1);var mn=function(){function i(t){var e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:new b(0,1,0);N(this,i),s(this,"type","OrbitOverLife"),s(this,"rotation",void 0),s(this,"line",void 0),s(this,"temp",new b),this.orbitSpeed=t,this.axis=e,this.rotation=new j,this.line=new ti}return _(i,[{key:"initialize",value:function(e){}},{key:"update",value:function(e,n){this.line.set(new b(0,0,0),this.axis),this.line.closestPointToPoint(e.position,!1,this.temp),this.rotation.setFromAxisAngle(this.axis,this.orbitSpeed.genValue(e.age/e.life)*n),e.position.sub(this.temp),e.position.applyQuaternion(this.rotation),e.position.add(this.temp)}},{key:"frameUpdate",value:function(e){}},{key:"toJSON",value:function(){return{type:this.type,orbitSpeed:this.orbitSpeed.toJSON(),axis:[this.axis.x,this.axis.y,this.axis.z]}}},{key:"clone",value:function(){return new i(this.orbitSpeed.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new i(L(e.orbitSpeed),e.axis?new b(e.axis[0],e.axis[1],e.axis[2]):void 0)}}]),i}(),vn=function(){function i(t){N(this,i),s(this,"type","WidthOverLength"),this.width=t}return _(i,[{key:"initialize",value:function(e){}},{key:"update",value:function(e){if(e instanceof Jt)for(var n=e.previous.values(),r=0;r<e.previous.length;r++){var a=n.next();a.value.size=this.width.genValue((e.previous.length-r)/e.length)}}},{key:"frameUpdate",value:function(e){}},{key:"toJSON",value:function(){return{type:this.type,width:this.width.toJSON()}}},{key:"clone",value:function(){return new i(this.width.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new i(L(e.width))}}]),i}(),pn=function(){function i(t,e){N(this,i),s(this,"type","ApplyForce"),s(this,"magnitudeValue",void 0),this.direction=t,this.magnitude=e,this.magnitudeValue=this.magnitude.genValue()}return _(i,[{key:"initialize",value:function(e){}},{key:"update",value:function(e,n){e.velocity.addScaledVector(this.direction,this.magnitudeValue*n)}},{key:"frameUpdate",value:function(e){this.magnitudeValue=this.magnitude.genValue()}},{key:"toJSON",value:function(){return{type:this.type,direction:[this.direction.x,this.direction.y,this.direction.z],magnitude:this.magnitude.toJSON()}}},{key:"clone",value:function(){return new i(this.direction.clone(),this.magnitude.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){var n;return new i(new b(e.direction[0],e.direction[1],e.direction[2]),L((n=e.magnitude)!==null&&n!==void 0?n:e.force))}}]),i}(),yn=function(){function i(t,e){N(this,i),s(this,"type","GravityForce"),s(this,"temp",new b),this.center=t,this.magnitude=e}return _(i,[{key:"initialize",value:function(e){}},{key:"update",value:function(e,n){this.temp.copy(this.center).sub(e.position).normalize(),e.velocity.addScaledVector(this.temp,this.magnitude/e.position.distanceToSquared(this.center)*n)}},{key:"frameUpdate",value:function(e){}},{key:"toJSON",value:function(){return{type:this.type,center:[this.center.x,this.center.y,this.center.z],magnitude:this.magnitude}}},{key:"clone",value:function(){return new i(this.center.clone(),this.magnitude)}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new i(new b(e.center[0],e.center[1],e.center[2]),e.magnitude)}}]),i}();new b(0,0,1);var gn=function(){function i(t){N(this,i),s(this,"type","ChangeEmitDirection"),s(this,"_temp",new b),s(this,"_q",new j),this.angle=t}return _(i,[{key:"initialize",value:function(e){var n=e.velocity.length();n!=0&&(e.velocity.normalize(),e.velocity.x===0&&e.velocity.y===0?this._temp.set(0,e.velocity.z,0):this._temp.set(-e.velocity.y,e.velocity.x,0),this._q.setFromAxisAngle(this._temp.normalize(),this.angle.genValue()),this._temp.copy(e.velocity),e.velocity.applyQuaternion(this._q),this._q.setFromAxisAngle(this._temp,Math.random()*Math.PI*2),e.velocity.applyQuaternion(this._q),e.velocity.setLength(n))}},{key:"update",value:function(e,n){}},{key:"frameUpdate",value:function(e){}},{key:"toJSON",value:function(){return{type:this.type,angle:this.angle.toJSON()}}},{key:"clone",value:function(){return new i(this.angle)}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new i(L(e.angle))}}]),i}(),Qi=new b(1,1,1),Sn=new b(0,0,1),Ke=function(i){return i[i.Death=0]="Death",i[i.Birth=1]="Birth",i[i.Frame=2]="Frame",i}({}),xn=function(){function i(t,e,n){var r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:Ke.Frame,a=arguments.length>4&&arguments[4]!==void 0?arguments[4]:1;N(this,i),s(this,"type","EmitSubParticleSystem"),s(this,"q_",new j),s(this,"v_",new b),s(this,"v2_",new b),s(this,"subEmissions",new Array),this.particleSystem=t,this.useVelocityAsBasis=e,this.subParticleSystem=n,this.mode=r,this.emitProbability=a,this.subParticleSystem&&this.subParticleSystem.system&&(this.subParticleSystem.system.onlyUsedByOther=!0)}return _(i,[{key:"initialize",value:function(e){}},{key:"update",value:function(e,n){this.mode===Ke.Frame?this.emit(e,n):this.mode===Ke.Birth&&e.age===0?this.emit(e,n):this.mode===Ke.Death&&e.age+n>=e.life&&this.emit(e,n)}},{key:"emit",value:function(e,n){if(this.subParticleSystem&&!(Math.random()>this.emitProbability)){var r=new Qn;this.setMatrixFromParticle(r,e),this.subEmissions.push({burstIndex:0,burstWaveIndex:0,time:0,waitEmiting:0,matrix:r,travelDistance:0,particle:e})}}},{key:"frameUpdate",value:function(e){if(this.subParticleSystem)for(var n=0;n<this.subEmissions.length;n++)if(this.subEmissions[n].time>=this.subParticleSystem.system.duration)this.subEmissions[n]=this.subEmissions[this.subEmissions.length-1],this.subEmissions.length=this.subEmissions.length-1,n--;else{var r=this.subEmissions[n];r.particle&&r.particle.age<r.particle.life?this.setMatrixFromParticle(r.matrix,r.particle):r.particle=void 0,this.subParticleSystem.system.emit(e,r,r.matrix)}}},{key:"toJSON",value:function(){return{type:this.type,subParticleSystem:this.subParticleSystem?this.subParticleSystem.uuid:"",useVelocityAsBasis:this.useVelocityAsBasis,mode:this.mode,emitProbability:this.emitProbability}}},{key:"clone",value:function(){return new i(this.particleSystem,this.useVelocityAsBasis,this.subParticleSystem,this.mode,this.emitProbability)}},{key:"reset",value:function(){}},{key:"setMatrixFromParticle",value:function(e,n){var r;if(n.rotation===void 0||this.useVelocityAsBasis)if(n.velocity.x===0&&n.velocity.y===0&&(n.velocity.z===1||n.velocity.z===0))e.set(1,0,0,n.position.x,0,1,0,n.position.y,0,0,1,n.position.z,0,0,0,1);else{this.v_.copy(Sn).cross(n.velocity),this.v2_.copy(n.velocity).cross(this.v_);var a=this.v_.length(),o=this.v2_.length();e.set(this.v_.x/a,this.v2_.x/o,n.velocity.x,n.position.x,this.v_.y/a,this.v2_.y/o,n.velocity.y,n.position.y,this.v_.z/a,this.v2_.z/o,n.velocity.z,n.position.z,0,0,0,1)}else n.rotation instanceof j?r=n.rotation:(this.q_.setFromAxisAngle(Sn,n.rotation),r=this.q_),e.compose(n.position,r,Qi);this.particleSystem.worldSpace||e.multiplyMatrices(this.particleSystem.emitter.matrixWorld,e)}}],[{key:"fromJSON",value:function(e,n){return new i(n,e.useVelocityAsBasis,e.subParticleSystem,e.mode,e.emitProbability)}}]),i}(),Ki=.5*(Math.sqrt(3)-1),Ue=(3-Math.sqrt(3))/6,ji=1/3,le=1/6,er=(Math.sqrt(5)-1)/4,ee=(5-Math.sqrt(5))/20,K=new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]),Z=new Float32Array([0,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,1,0,1,1,1,0,1,-1,1,0,-1,1,1,0,-1,-1,-1,0,1,1,-1,0,1,-1,-1,0,-1,1,-1,0,-1,-1,1,1,0,1,1,1,0,-1,1,-1,0,1,1,-1,0,-1,-1,1,0,1,-1,1,0,-1,-1,-1,0,1,-1,-1,0,-1,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,0]),$n=function(){function i(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:Math.random;N(this,i),s(this,"p",void 0),s(this,"perm",void 0),s(this,"permMod12",void 0);var e=typeof t=="function"?t:nr(t);this.p=tr(e),this.perm=new Uint8Array(512),this.permMod12=new Uint8Array(512);for(var n=0;n<512;n++)this.perm[n]=this.p[n&255],this.permMod12[n]=this.perm[n]%12}return _(i,[{key:"noise2D",value:function(e,n){var r=this.permMod12,a=this.perm,o=0,l=0,c=0,d=(e+n)*Ki,y=Math.floor(e+d),w=Math.floor(n+d),m=(y+w)*Ue,M=y-m,g=w-m,B=e-M,T=n-g,R,J;B>T?(R=1,J=0):(R=0,J=1);var P=B-R+Ue,C=T-J+Ue,G=B-1+2*Ue,A=T-1+2*Ue,V=y&255,E=w&255,x=.5-B*B-T*T;if(x>=0){var D=r[V+a[E]]*3;x*=x,o=x*x*(K[D]*B+K[D+1]*T)}var q=.5-P*P-C*C;if(q>=0){var Q=r[V+R+a[E+J]]*3;q*=q,l=q*q*(K[Q]*P+K[Q+1]*C)}var W=.5-G*G-A*A;if(W>=0){var re=r[V+1+a[E+1]]*3;W*=W,c=W*W*(K[re]*G+K[re+1]*A)}return 70*(o+l+c)}},{key:"noise3D",value:function(e,n,r){var a=this.permMod12,o=this.perm,l,c,d,y,w=(e+n+r)*ji,m=Math.floor(e+w),M=Math.floor(n+w),g=Math.floor(r+w),B=(m+M+g)*le,T=m-B,R=M-B,J=g-B,P=e-T,C=n-R,G=r-J,A,V,E,x,D,q;P>=C?C>=G?(A=1,V=0,E=0,x=1,D=1,q=0):P>=G?(A=1,V=0,E=0,x=1,D=0,q=1):(A=0,V=0,E=1,x=1,D=0,q=1):C<G?(A=0,V=0,E=1,x=0,D=1,q=1):P<G?(A=0,V=1,E=0,x=0,D=1,q=1):(A=0,V=1,E=0,x=1,D=1,q=0);var Q=P-A+le,W=C-V+le,re=G-E+le,ue=P-x+2*le,f=C-D+2*le,h=G-q+2*le,v=P-1+3*le,z=C-1+3*le,O=G-1+3*le,I=m&255,X=M&255,Y=g&255,H=.6-P*P-C*C-G*G;if(H<0)l=0;else{var ae=a[I+o[X+o[Y]]]*3;H*=H,l=H*H*(K[ae]*P+K[ae+1]*C+K[ae+2]*G)}var te=.6-Q*Q-W*W-re*re;if(te<0)c=0;else{var ne=a[I+A+o[X+V+o[Y+E]]]*3;te*=te,c=te*te*(K[ne]*Q+K[ne+1]*W+K[ne+2]*re)}var he=.6-ue*ue-f*f-h*h;if(he<0)d=0;else{var ye=a[I+x+o[X+D+o[Y+q]]]*3;he*=he,d=he*he*(K[ye]*ue+K[ye+1]*f+K[ye+2]*h)}var fe=.6-v*v-z*z-O*O;if(fe<0)y=0;else{var ge=a[I+1+o[X+1+o[Y+1]]]*3;fe*=fe,y=fe*fe*(K[ge]*v+K[ge+1]*z+K[ge+2]*O)}return 32*(l+c+d+y)}},{key:"noise4D",value:function(e,n,r,a){var o=this.perm,l,c,d,y,w,m=(e+n+r+a)*er,M=Math.floor(e+m),g=Math.floor(n+m),B=Math.floor(r+m),T=Math.floor(a+m),R=(M+g+B+T)*ee,J=M-R,P=g-R,C=B-R,G=T-R,A=e-J,V=n-P,E=r-C,x=a-G,D=0,q=0,Q=0,W=0;A>V?D++:q++,A>E?D++:Q++,A>x?D++:W++,V>E?q++:Q++,V>x?q++:W++,E>x?Q++:W++;var re=D>=3?1:0,ue=q>=3?1:0,f=Q>=3?1:0,h=W>=3?1:0,v=D>=2?1:0,z=q>=2?1:0,O=Q>=2?1:0,I=W>=2?1:0,X=D>=1?1:0,Y=q>=1?1:0,H=Q>=1?1:0,ae=W>=1?1:0,te=A-re+ee,ne=V-ue+ee,he=E-f+ee,ye=x-h+ee,fe=A-v+2*ee,ge=V-z+2*ee,dt=E-O+2*ee,ht=x-I+2*ee,ft=A-X+3*ee,mt=V-Y+3*ee,vt=E-H+3*ee,pt=x-ae+3*ee,yt=A-1+4*ee,gt=V-1+4*ee,St=E-1+4*ee,xt=x-1+4*ee,Be=M&255,Te=g&255,Pe=B&255,Ve=T&255,ze=.6-A*A-V*V-E*E-x*x;if(ze<0)l=0;else{var qe=o[Be+o[Te+o[Pe+o[Ve]]]]%32*4;ze*=ze,l=ze*ze*(Z[qe]*A+Z[qe+1]*V+Z[qe+2]*E+Z[qe+3]*x)}var Ee=.6-te*te-ne*ne-he*he-ye*ye;if(Ee<0)c=0;else{var Xe=o[Be+re+o[Te+ue+o[Pe+f+o[Ve+h]]]]%32*4;Ee*=Ee,c=Ee*Ee*(Z[Xe]*te+Z[Xe+1]*ne+Z[Xe+2]*he+Z[Xe+3]*ye)}var Ae=.6-fe*fe-ge*ge-dt*dt-ht*ht;if(Ae<0)d=0;else{var $e=o[Be+v+o[Te+z+o[Pe+O+o[Ve+I]]]]%32*4;Ae*=Ae,d=Ae*Ae*(Z[$e]*fe+Z[$e+1]*ge+Z[$e+2]*dt+Z[$e+3]*ht)}var Ce=.6-ft*ft-mt*mt-vt*vt-pt*pt;if(Ce<0)y=0;else{var He=o[Be+X+o[Te+Y+o[Pe+H+o[Ve+ae]]]]%32*4;Ce*=Ce,y=Ce*Ce*(Z[He]*ft+Z[He+1]*mt+Z[He+2]*vt+Z[He+3]*pt)}var Je=.6-yt*yt-gt*gt-St*St-xt*xt;if(Je<0)w=0;else{var Ye=o[Be+1+o[Te+1+o[Pe+1+o[Ve+1]]]]%32*4;Je*=Je,w=Je*Je*(Z[Ye]*yt+Z[Ye+1]*gt+Z[Ye+2]*St+Z[Ye+3]*xt)}return 27*(l+c+d+y+w)}}]),i}();function tr(i){for(var t=new Uint8Array(256),e=0;e<256;e++)t[e]=e;for(var n=0;n<255;n++){var r=n+~~(i()*(256-n)),a=t[n];t[n]=t[r],t[r]=a}return t}function nr(i){var t=0,e=0,n=0,r=1,a=ir();return t=a(" "),e=a(" "),n=a(" "),t-=a(i),t<0&&(t+=1),e-=a(i),e<0&&(e+=1),n-=a(i),n<0&&(n+=1),function(){var o=2091639*t+r*23283064365386963e-26;return t=e,e=n,n=o-(r=o|0)}}function ir(){var i=4022871197;return function(t){t=t.toString();for(var e=0;e<t.length;e++){i+=t.charCodeAt(e);var n=.02519603282416938*i;i=n>>>0,n-=i,n*=i,i=n>>>0,n-=i,i+=n*4294967296}return(i>>>0)*23283064365386963e-26}}var wn=function(){function i(t,e,n,r){N(this,i),s(this,"type","TurbulenceField"),s(this,"generator",new $n),s(this,"timeOffset",new b),s(this,"temp",new b),s(this,"temp2",new b),this.scale=t,this.octaves=e,this.velocityMultiplier=n,this.timeScale=r,this.timeOffset.x=Math.random()/this.scale.x*this.timeScale.x,this.timeOffset.y=Math.random()/this.scale.y*this.timeScale.y,this.timeOffset.z=Math.random()/this.scale.z*this.timeScale.z}return _(i,[{key:"initialize",value:function(e){}},{key:"update",value:function(e,n){var r=e.position.x/this.scale.x,a=e.position.y/this.scale.y,o=e.position.z/this.scale.z;this.temp.set(0,0,0);for(var l=1,c=0;c<this.octaves;c++)this.temp2.set(this.generator.noise4D(r*l,a*l,o*l,this.timeOffset.x*l)/l,this.generator.noise4D(r*l,a*l,o*l,this.timeOffset.y*l)/l,this.generator.noise4D(r*l,a*l,o*l,this.timeOffset.z*l)/l),this.temp.add(this.temp2),l*=2;this.temp.multiply(this.velocityMultiplier),e.velocity.addScaledVector(this.temp,n)}},{key:"toJSON",value:function(){return{type:this.type,scale:[this.scale.x,this.scale.y,this.scale.z],octaves:this.octaves,velocityMultiplier:[this.velocityMultiplier.x,this.velocityMultiplier.y,this.velocityMultiplier.z],timeScale:[this.timeScale.x,this.timeScale.y,this.timeScale.z]}}},{key:"frameUpdate",value:function(e){this.timeOffset.x+=e*this.timeScale.x,this.timeOffset.y+=e*this.timeScale.y,this.timeOffset.z+=e*this.timeScale.z}},{key:"clone",value:function(){return new i(this.scale.clone(),this.octaves,this.velocityMultiplier.clone(),this.timeScale.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new i(new b(e.scale[0],e.scale[1],e.scale[2]),e.octaves,new b(e.velocityMultiplier[0],e.velocityMultiplier[1],e.velocityMultiplier[2]),new b(e.timeScale[0],e.timeScale[1],e.timeScale[2]))}}]),i}();function je(i,t){return Math.floor(Math.random()*(t-i))+i}var ce=[],Mt=new b,kt=new j,On=function(){function i(t,e){var n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:new $(1),r=arguments.length>3&&arguments[3]!==void 0?arguments[3]:new $(0);if(N(this,i),s(this,"type","Noise"),s(this,"duration",0),this.frequency=t,this.power=e,this.positionAmount=n,this.rotationAmount=r,ce.length===0)for(var a=0;a<100;a++)ce.push(new $n)}return _(i,[{key:"initialize",value:function(e){e.lastPosNoise=new b,typeof e.rotation=="number"?e.lastRotNoise=0:e.lastRotNoise=new j,e.generatorIndex=[je(0,100),je(0,100),je(0,100),je(0,100)]}},{key:"update",value:function(e,n){var r=this.frequency.genValue(e.age/e.life),a=this.power.genValue(e.age/e.life),o=this.positionAmount.genValue(e.age/e.life),l=this.rotationAmount.genValue(e.age/e.life);o>0&&e.lastPosNoise!==void 0&&(e.position.sub(e.lastPosNoise),Mt.set(ce[e.generatorIndex[0]].noise2D(0,e.age*r)*a*o,ce[e.generatorIndex[1]].noise2D(0,e.age*r)*a*o,ce[e.generatorIndex[2]].noise2D(0,e.age*r)*a*o),e.position.add(Mt),e.lastPosNoise.copy(Mt)),l>0&&e.lastRotNoise!==void 0&&(typeof e.rotation=="number"?(e.rotation-=e.lastRotNoise,e.rotation+=ce[e.generatorIndex[3]].noise2D(0,e.age*r)*Math.PI*a*l):(e.lastRotNoise.invert(),e.rotation.multiply(e.lastRotNoise),kt.set(ce[e.generatorIndex[0]].noise2D(0,e.age*r)*a*l,ce[e.generatorIndex[1]].noise2D(0,e.age*r)*a*l,ce[e.generatorIndex[2]].noise2D(0,e.age*r)*a*l,ce[e.generatorIndex[3]].noise2D(0,e.age*r)*a*l).normalize(),e.rotation.multiply(kt),e.lastRotNoise.copy(kt)))}},{key:"toJSON",value:function(){return{type:this.type,frequency:this.frequency.toJSON(),power:this.power.toJSON(),positionAmount:this.positionAmount.toJSON(),rotationAmount:this.rotationAmount.toJSON()}}},{key:"frameUpdate",value:function(e){this.duration+=e}},{key:"clone",value:function(){return new i(this.frequency.clone(),this.power.clone(),this.positionAmount.clone(),this.rotationAmount.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new i(L(e.frequency),L(e.power),L(e.positionAmount),L(e.rotationAmount))}}]),i}(),bn=function(){function i(){var t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0,e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:new b;N(this,i),s(this,"locations",[]),this.scaleX=t,this.scaleY=e,this.position=n}return _(i,[{key:"transform",value:function(e,n){e.x=this.locations[n%this.locations.length].x*this.scaleX+this.position.x,e.y=this.locations[n%this.locations.length].y*this.scaleY+this.position.y,e.z=this.position.z}},{key:"clone",value:function(){var e=new i(this.scaleX,this.scaleY,this.position.clone());return e.locations=this.locations.map(function(n){return n.clone()}),e}},{key:"toJSON",value:function(){return{scaleX:this.scaleX,scaleY:this.scaleY,position:this.position,locations:this.locations.map(function(e){return{x:e.x,y:e.y}})}}},{key:"fromImage",value:function(e,n){var r=document.createElement("canvas");r.width=e.width,r.height=e.height;var a=r.getContext("2d");if(a){a.drawImage(e,0,0);var o=a.getImageData(0,0,r.width,r.height,{colorSpace:"srgb"});r.remove(),this.locations.length=0;for(var l=0;l<o.height;l++)for(var c=0;c<o.width;c++)o.data[(l*o.width+c)*4+3]>n&&this.locations.push(new Le(c,o.height-l))}}}],[{key:"fromJSON",value:function(e){var n=new i(e.scaleX,e.scaleY,new b(e.position[0],e.position[1],e.position[2]));return n.locations=e.locations.map(function(r){return new Le(r.x,r.y)}),n}}]),i}();function rr(i){switch(i.type){case"TextureSequencer":return bn.fromJSON(i);default:return new bn}}var ar=function(){function i(t){N(this,i),s(this,"type","ApplySequences"),s(this,"sequencers",[]),s(this,"time",0),s(this,"index",0),s(this,"pCount",0),s(this,"delay",void 0),s(this,"tempV",new b),this.delay=t}return _(i,[{key:"initialize",value:function(e){e.id=this.pCount,e.dst=new b,e.begin=new b,e.inMotion=!1,this.pCount++}},{key:"reset",value:function(){this.time=0,this.index=0,this.pCount=0}},{key:"update",value:function(e,n){var r=this.sequencers[this.index],a=e.id*this.delay;this.time>=r[0].a+a&&this.time<=r[0].b+a?(e.inMotion||(e.inMotion=!0,e.begin.copy(e.position),r[1].transform(e.dst,e.id)),e.position.lerpVectors(e.begin,e.dst,i.BEZIER.genValue((this.time-r[0].a-a)/(r[0].b-r[0].a)))):this.time>r[0].b+a&&(e.inMotion=!1)}},{key:"frameUpdate",value:function(e){for(;this.index+1<this.sequencers.length&&this.time>=this.sequencers[this.index+1][0].a;)this.index++;this.time+=e}},{key:"appendSequencer",value:function(e,n){this.sequencers.push([e,n])}},{key:"toJSON",value:function(){return{type:this.type,delay:this.delay,sequencers:this.sequencers.map(function(e){var n=Oe(e,2),r=n[0],a=n[1];return{range:r.toJSON(),sequencer:a.toJSON()}})}}},{key:"clone",value:function(){var e=new i(this.delay);return e.sequencers=this.sequencers.map(function(n){return[n[0].clone(),n[1].clone()]}),e}}],[{key:"fromJSON",value:function(e){var n=new i(e.delay);return e.sequencers.forEach(function(r){n.sequencers.push([L(r.range),rr(r.sequencer)])}),n}}]),i}();s(ar,"BEZIER",new Ut(0,0,1,1));var Nn=function(){function i(t,e){N(this,i),s(this,"type","ColorBySpeed"),this.color=t,this.speedRange=e}return _(i,[{key:"initialize",value:function(e){this.color.type==="memorizedFunction"&&(e.colorOverLifeMemory={},this.color.startGen(e.colorOverLifeMemory))}},{key:"update",value:function(e,n){var r=(e.startSpeed-this.speedRange.a)/(this.speedRange.b-this.speedRange.a);this.color.type==="memorizedFunction"?this.color.genColor(e.color,r,e.colorOverLifeMemory):this.color.genColor(e.color,r),e.color.x*=e.startColor.x,e.color.y*=e.startColor.y,e.color.z*=e.startColor.z,e.color.w*=e.startColor.w}},{key:"frameUpdate",value:function(e){}},{key:"toJSON",value:function(){return{type:this.type,color:this.color.toJSON(),speedRange:this.speedRange.toJSON()}}},{key:"clone",value:function(){return new i(this.color.clone(),this.speedRange.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new i(Yt(e.color),Ne.fromJSON(e.speedRange))}}]),i}(),_n=function(){function i(t,e){N(this,i),s(this,"type","SizeBySpeed"),this.size=t,this.speedRange=e}return _(i,[{key:"initialize",value:function(e){}},{key:"update",value:function(e){var n=(e.startSpeed-this.speedRange.a)/(this.speedRange.b-this.speedRange.a);e.size=e.startSize*this.size.genValue(n)}},{key:"toJSON",value:function(){return{type:this.type,size:this.size.toJSON(),speedRange:this.speedRange.toJSON()}}},{key:"frameUpdate",value:function(e){}},{key:"clone",value:function(){return new i(this.size.clone(),this.speedRange.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new i(L(e.size),Ne.fromJSON(e.speedRange))}}]),i}(),Mn=function(){function i(t,e){N(this,i),s(this,"type","RotationBySpeed"),s(this,"tempQuat",new j),this.angularVelocity=t,this.speedRange=e}return _(i,[{key:"initialize",value:function(e){}},{key:"update",value:function(e,n){var r=(e.startSpeed-this.speedRange.a)/(this.speedRange.b-this.speedRange.a);e.rotation+=n*this.angularVelocity.genValue(r)}},{key:"toJSON",value:function(){return{type:this.type,angularVelocity:this.angularVelocity.toJSON(),speedRange:this.speedRange.toJSON()}}},{key:"frameUpdate",value:function(e){}},{key:"clone",value:function(){return new i(this.angularVelocity.clone(),this.speedRange.clone())}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new i(L(e.angularVelocity),Ne.fromJSON(e.speedRange))}}]),i}(),kn=function(){function i(t,e){N(this,i),s(this,"type","LimitSpeedOverLife"),this.speed=t,this.dampen=e}return _(i,[{key:"initialize",value:function(e){}},{key:"update",value:function(e,n){var r=e.velocity.length(),a=this.speed.genValue(e.age/e.life);if(r>a){var o=(r-a)/r;e.velocity.multiplyScalar(1-o*this.dampen*n*20)}}},{key:"toJSON",value:function(){return{type:this.type,speed:this.speed.toJSON(),dampen:this.dampen}}},{key:"frameUpdate",value:function(e){}},{key:"clone",value:function(){return new i(this.speed.clone(),this.dampen)}},{key:"reset",value:function(){}}],[{key:"fromJSON",value:function(e){return new i(L(e.speed),e.dampen)}}]),i}(),or={ApplyForce:{type:"ApplyForce",constructor:pn,params:[["direction","vec3"],["magnitude","value"]],loadJSON:pn.fromJSON},Noise:{type:"Noise",constructor:On,params:[["frequency","value"],["power","value"],["positionAmount","value"],["rotationAmount","value"]],loadJSON:On.fromJSON},TurbulenceField:{type:"TurbulenceField",constructor:wn,params:[["scale","vec3"],["octaves","number"],["velocityMultiplier","vec3"],["timeScale","vec3"]],loadJSON:wn.fromJSON},GravityForce:{type:"GravityForce",constructor:yn,params:[["center","vec3"],["magnitude","number"]],loadJSON:yn.fromJSON},ColorOverLife:{type:"ColorOverLife",constructor:on,params:[["color","colorFunc"]],loadJSON:on.fromJSON},RotationOverLife:{type:"RotationOverLife",constructor:sn,params:[["angularVelocity","valueFunc"]],loadJSON:sn.fromJSON},Rotation3DOverLife:{type:"Rotation3DOverLife",constructor:ln,params:[["angularVelocity","rotationFunc"],["dynamic","boolean"]],loadJSON:ln.fromJSON},SizeOverLife:{type:"SizeOverLife",constructor:dn,params:[["size","valueFunc"]],loadJSON:dn.fromJSON},ColorBySpeed:{type:"ColorBySpeed",constructor:Nn,params:[["color","colorFunc"],["speedRange","range"]],loadJSON:Nn.fromJSON},RotationBySpeed:{type:"RotationBySpeed",constructor:Mn,params:[["angularVelocity","valueFunc"],["speedRange","range"]],loadJSON:Mn.fromJSON},SizeBySpeed:{type:"SizeBySpeed",constructor:_n,params:[["size","valueFunc"],["speedRange","range"]],loadJSON:_n.fromJSON},SpeedOverLife:{type:"SpeedOverLife",constructor:hn,params:[["speed","valueFunc"]],loadJSON:hn.fromJSON},FrameOverLife:{type:"FrameOverLife",constructor:fn,params:[["frame","valueFunc"]],loadJSON:fn.fromJSON},ForceOverLife:{type:"ForceOverLife",constructor:cn,params:[["x","valueFunc"],["y","valueFunc"],["z","valueFunc"]],loadJSON:cn.fromJSON},OrbitOverLife:{type:"OrbitOverLife",constructor:mn,params:[["orbitSpeed","valueFunc"],["axis","vec3"]],loadJSON:mn.fromJSON},WidthOverLength:{type:"WidthOverLength",constructor:vn,params:[["width","valueFunc"]],loadJSON:vn.fromJSON},ChangeEmitDirection:{type:"ChangeEmitDirection",constructor:gn,params:[["angle","value"]],loadJSON:gn.fromJSON},EmitSubParticleSystem:{type:"EmitSubParticleSystem",constructor:xn,params:[["particleSystem","self"],["useVelocityAsBasis","boolean"],["subParticleSystem","particleSystem"],["mode","number"],["emitProbability","number"]],loadJSON:xn.fromJSON},LimitSpeedOverLife:{type:"LimitSpeedOverLife",constructor:kn,params:[["speed","valueFunc"],["dampen","number"]],loadJSON:kn.fromJSON}};function Hn(i,t){return or[i.type].loadJSON(i,t)}var se=function(i){return i[i.Random=0]="Random",i[i.Loop=1]="Loop",i[i.PingPong=2]="PingPong",i[i.Burst=3]="Burst",i}({});function Fe(i,t,e){var n;switch(se.Random===i&&(t=Math.random()),e>0?n=Math.floor(t/e)*e:n=t,i){case se.Loop:n=n%1;break;case se.PingPong:n=Math.abs(n%2-1);break}return n}var Bn=function(){function i(){var t,e,n,r,a,o,l,c=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};N(this,i),s(this,"type","cone"),s(this,"radius",void 0),s(this,"arc",void 0),s(this,"thickness",void 0),s(this,"angle",void 0),s(this,"mode",void 0),s(this,"spread",void 0),s(this,"speed",void 0),s(this,"currentValue",0),this.radius=(t=c.radius)!==null&&t!==void 0?t:10,this.arc=(e=c.arc)!==null&&e!==void 0?e:2*Math.PI,this.thickness=(n=c.thickness)!==null&&n!==void 0?n:1,this.angle=(r=c.angle)!==null&&r!==void 0?r:Math.PI/6,this.mode=(a=c.mode)!==null&&a!==void 0?a:se.Random,this.spread=(o=c.spread)!==null&&o!==void 0?o:0,this.speed=(l=c.speed)!==null&&l!==void 0?l:new $(1)}return _(i,[{key:"update",value:function(e,n){se.Random!=this.mode&&(this.currentValue+=this.speed.genValue(e.emissionState.time/e.duration)*n)}},{key:"initialize",value:function(e){var n=Fe(this.mode,this.currentValue,this.spread),r=_e.lerp(1-this.thickness,1,Math.random()),a=n*this.arc,o=Math.sqrt(r),l=Math.sin(a),c=Math.cos(a);e.position.x=o*c,e.position.y=o*l,e.position.z=0;var d=this.angle*o;e.velocity.set(0,0,Math.cos(d)).addScaledVector(e.position,Math.sin(d)).multiplyScalar(e.startSpeed),e.position.multiplyScalar(this.radius)}},{key:"toJSON",value:function(){return{type:"cone",radius:this.radius,arc:this.arc,thickness:this.thickness,angle:this.angle,mode:this.mode,spread:this.spread,speed:this.speed.toJSON()}}},{key:"clone",value:function(){return new i({radius:this.radius,arc:this.arc,thickness:this.thickness,angle:this.angle,mode:this.mode,speed:this.speed.clone(),spread:this.spread})}}],[{key:"fromJSON",value:function(e){return new i({radius:e.radius,arc:e.arc,thickness:e.thickness,angle:e.angle,mode:e.mode,speed:e.speed?L(e.speed):void 0,spread:e.spread})}}]),i}(),Tn=function(){function i(){var t,e,n,r,a,o,l=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};N(this,i),s(this,"type","circle"),s(this,"radius",void 0),s(this,"arc",void 0),s(this,"thickness",void 0),s(this,"mode",void 0),s(this,"spread",void 0),s(this,"speed",void 0),s(this,"currentValue",0),this.radius=(t=l.radius)!==null&&t!==void 0?t:10,this.arc=(e=l.arc)!==null&&e!==void 0?e:2*Math.PI,this.thickness=(n=l.thickness)!==null&&n!==void 0?n:1,this.mode=(r=l.mode)!==null&&r!==void 0?r:se.Random,this.spread=(a=l.spread)!==null&&a!==void 0?a:0,this.speed=(o=l.speed)!==null&&o!==void 0?o:new $(1)}return _(i,[{key:"update",value:function(e,n){this.currentValue+=this.speed.genValue(e.emissionState.time/e.duration)*n}},{key:"initialize",value:function(e){var n=Fe(this.mode,this.currentValue,this.spread),r=_e.lerp(1-this.thickness,1,Math.random()),a=n*this.arc;e.position.x=Math.cos(a),e.position.y=Math.sin(a),e.position.z=0,e.velocity.copy(e.position).multiplyScalar(e.startSpeed),e.position.multiplyScalar(this.radius*r)}},{key:"toJSON",value:function(){return{type:"circle",radius:this.radius,arc:this.arc,thickness:this.thickness,mode:this.mode,spread:this.spread,speed:this.speed.toJSON()}}},{key:"clone",value:function(){return new i({radius:this.radius,arc:this.arc,thickness:this.thickness,mode:this.mode,speed:this.speed.clone(),spread:this.spread})}}],[{key:"fromJSON",value:function(e){return new i({radius:e.radius,arc:e.arc,thickness:e.thickness,mode:e.mode,speed:e.speed?L(e.speed):void 0,spread:e.spread})}}]),i}(),Pn=function(){function i(){var t,e,n,r,a,o,l,c=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};N(this,i),s(this,"type","donut"),s(this,"radius",void 0),s(this,"donutRadius",void 0),s(this,"arc",void 0),s(this,"thickness",void 0),s(this,"mode",void 0),s(this,"spread",void 0),s(this,"speed",void 0),s(this,"currentValue",0),this.radius=(t=c.radius)!==null&&t!==void 0?t:10,this.arc=(e=c.arc)!==null&&e!==void 0?e:2*Math.PI,this.thickness=(n=c.thickness)!==null&&n!==void 0?n:1,this.donutRadius=(r=c.donutRadius)!==null&&r!==void 0?r:this.radius*.2,this.mode=(a=c.mode)!==null&&a!==void 0?a:se.Random,this.spread=(o=c.spread)!==null&&o!==void 0?o:0,this.speed=(l=c.speed)!==null&&l!==void 0?l:new $(1)}return _(i,[{key:"update",value:function(e,n){se.Random!=this.mode&&(this.currentValue+=this.speed.genValue(e.emissionState.time/e.duration)*n)}},{key:"initialize",value:function(e){var n=Fe(this.mode,this.currentValue,this.spread),r=Math.random(),a=_e.lerp(1-this.thickness,1,Math.random()),o=n*this.arc,l=r*Math.PI*2,c=Math.sin(o),d=Math.cos(o);e.position.x=this.radius*d,e.position.y=this.radius*c,e.position.z=0,e.velocity.z=this.donutRadius*a*Math.sin(l),e.velocity.x=this.donutRadius*a*Math.cos(l)*d,e.velocity.y=this.donutRadius*a*Math.cos(l)*c,e.position.add(e.velocity),e.velocity.normalize().multiplyScalar(e.startSpeed)}},{key:"toJSON",value:function(){return{type:"donut",radius:this.radius,arc:this.arc,thickness:this.thickness,donutRadius:this.donutRadius,mode:this.mode,spread:this.spread,speed:this.speed.toJSON()}}},{key:"clone",value:function(){return new i({radius:this.radius,arc:this.arc,thickness:this.thickness,donutRadius:this.donutRadius,mode:this.mode,speed:this.speed.clone(),spread:this.spread})}}],[{key:"fromJSON",value:function(e){return new i({radius:e.radius,arc:e.arc,thickness:e.thickness,donutRadius:e.donutRadius,mode:e.mode,speed:e.speed?L(e.speed):void 0,spread:e.spread})}}]),i}(),Vn=function(){function i(){N(this,i),s(this,"type","point")}return _(i,[{key:"update",value:function(e,n){}},{key:"initialize",value:function(e){var n=Math.random(),r=Math.random(),a=n*Math.PI*2,o=Math.acos(2*r-1),l=Math.cbrt(Math.random()),c=Math.sin(a),d=Math.cos(a),y=Math.sin(o),w=Math.cos(o);e.velocity.x=l*y*d,e.velocity.y=l*y*c,e.velocity.z=l*w,e.velocity.multiplyScalar(e.startSpeed),e.position.setScalar(0)}},{key:"toJSON",value:function(){return{type:"point"}}},{key:"clone",value:function(){return new i}}],[{key:"fromJSON",value:function(e){return new i}}]),i}(),Dt=function(){function i(){var t,e,n,r,a,o,l=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};N(this,i),s(this,"type","sphere"),s(this,"radius",void 0),s(this,"arc",void 0),s(this,"thickness",void 0),s(this,"mode",void 0),s(this,"spread",void 0),s(this,"speed",void 0),s(this,"currentValue",0),this.radius=(t=l.radius)!==null&&t!==void 0?t:10,this.arc=(e=l.arc)!==null&&e!==void 0?e:2*Math.PI,this.thickness=(n=l.thickness)!==null&&n!==void 0?n:1,this.mode=(r=l.mode)!==null&&r!==void 0?r:se.Random,this.spread=(a=l.spread)!==null&&a!==void 0?a:0,this.speed=(o=l.speed)!==null&&o!==void 0?o:new $(1)}return _(i,[{key:"update",value:function(e,n){se.Random!=this.mode&&(this.currentValue+=this.speed.genValue(e.emissionState.time/e.duration)*n)}},{key:"initialize",value:function(e){var n=Fe(this.mode,this.currentValue,this.spread),r=Math.random(),a=_e.lerp(1-this.thickness,1,Math.random()),o=n*this.arc,l=Math.acos(2*r-1),c=Math.sin(o),d=Math.cos(o),y=Math.sin(l),w=Math.cos(l);e.position.x=y*d,e.position.y=y*c,e.position.z=w,e.velocity.copy(e.position).multiplyScalar(e.startSpeed),e.position.multiplyScalar(this.radius*a)}},{key:"toJSON",value:function(){return{type:"sphere",radius:this.radius,arc:this.arc,thickness:this.thickness,mode:this.mode,spread:this.spread,speed:this.speed.toJSON()}}},{key:"clone",value:function(){return new i({radius:this.radius,arc:this.arc,thickness:this.thickness,mode:this.mode,speed:this.speed.clone(),spread:this.spread})}}],[{key:"fromJSON",value:function(e){return new i({radius:e.radius,arc:e.arc,thickness:e.thickness,mode:e.mode,speed:e.speed?L(e.speed):void 0,spread:e.spread})}}]),i}(),zn=function(){function i(){var t,e,n,r,a,o,l=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};N(this,i),s(this,"type","sphere"),s(this,"radius",void 0),s(this,"arc",void 0),s(this,"thickness",void 0),s(this,"mode",void 0),s(this,"spread",void 0),s(this,"speed",void 0),s(this,"currentValue",0),this.radius=(t=l.radius)!==null&&t!==void 0?t:10,this.arc=(e=l.arc)!==null&&e!==void 0?e:2*Math.PI,this.thickness=(n=l.thickness)!==null&&n!==void 0?n:1,this.mode=(r=l.mode)!==null&&r!==void 0?r:se.Random,this.spread=(a=l.spread)!==null&&a!==void 0?a:0,this.speed=(o=l.speed)!==null&&o!==void 0?o:new $(1)}return _(i,[{key:"update",value:function(e,n){se.Random!=this.mode&&(this.currentValue+=this.speed.genValue(e.emissionState.time/e.duration)*n)}},{key:"initialize",value:function(e){var n=Fe(this.mode,this.currentValue,this.spread),r=Math.random(),a=_e.lerp(1-this.thickness,1,Math.random()),o=n*this.arc,l=Math.acos(r),c=Math.sin(o),d=Math.cos(o),y=Math.sin(l),w=Math.cos(l);e.position.x=y*d,e.position.y=y*c,e.position.z=w,e.velocity.copy(e.position).multiplyScalar(e.startSpeed),e.position.multiplyScalar(this.radius*a)}},{key:"toJSON",value:function(){return{type:"hemisphere",radius:this.radius,arc:this.arc,thickness:this.thickness,mode:this.mode,spread:this.spread,speed:this.speed.toJSON()}}},{key:"clone",value:function(){return new i({radius:this.radius,arc:this.arc,thickness:this.thickness,mode:this.mode,speed:this.speed.clone(),spread:this.spread})}}],[{key:"fromJSON",value:function(e){return new i({radius:e.radius,arc:e.arc,thickness:e.thickness,mode:e.mode,speed:e.speed?L(e.speed):void 0,spread:e.spread})}}]),i}(),En=function(){function i(){var t,e,n,r,a=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};N(this,i),s(this,"type","grid"),s(this,"width",void 0),s(this,"height",void 0),s(this,"column",void 0),s(this,"row",void 0),this.width=(t=a.width)!==null&&t!==void 0?t:1,this.height=(e=a.height)!==null&&e!==void 0?e:1,this.column=(n=a.column)!==null&&n!==void 0?n:10,this.row=(r=a.row)!==null&&r!==void 0?r:10}return _(i,[{key:"initialize",value:function(e){var n=Math.floor(Math.random()*this.row),r=Math.floor(Math.random()*this.column);e.position.x=r*this.width/this.column-this.width/2,e.position.y=n*this.height/this.row-this.height/2,e.position.z=0,e.velocity.set(0,0,e.startSpeed)}},{key:"toJSON",value:function(){return{type:"grid",width:this.width,height:this.height,column:this.column,row:this.row}}},{key:"clone",value:function(){return new i({width:this.width,height:this.height,column:this.column,row:this.row})}},{key:"update",value:function(e,n){}}],[{key:"fromJSON",value:function(e){return new i(e)}}]),i}(),An=function(){function i(t){N(this,i),s(this,"type","mesh_surface"),s(this,"_triangleIndexToArea",[]),s(this,"_geometry",void 0),s(this,"_tempA",new b),s(this,"_tempB",new b),s(this,"_tempC",new b),t&&(this.geometry=t)}return _(i,[{key:"geometry",get:function(){return this._geometry},set:function(e){if(this._geometry=e,e!==void 0&&typeof e!="string"){var n=new ni;this._triangleIndexToArea.length=0;var r=0;if(e.getIndex()){var a=e.getIndex().array,o=a.length/3;this._triangleIndexToArea.push(0);for(var l=0;l<o;l++)n.setFromAttributeAndIndices(e.getAttribute("position"),a[l*3],a[l*3+1],a[l*3+2]),r+=n.getArea(),this._triangleIndexToArea.push(r);e.userData.triangleIndexToArea=this._triangleIndexToArea}}}},{key:"initialize",value:function(e){var n=this._geometry;if(!n||n.getIndex()===null){e.position.set(0,0,0),e.velocity.set(0,0,1).multiplyScalar(e.startSpeed);return}for(var r=this._triangleIndexToArea.length-1,a=0,o=r,l=Math.random()*this._triangleIndexToArea[r];a+1<o;){var c=Math.floor((a+o)/2);l<this._triangleIndexToArea[c]?o=c:a=c}var d=Math.random(),y=Math.random();d+y>1&&(d=1-d,y=1-y);var w=n.getIndex().array[a*3],m=n.getIndex().array[a*3+1],M=n.getIndex().array[a*3+2],g=n.getAttribute("position");this._tempA.fromBufferAttribute(g,w),this._tempB.fromBufferAttribute(g,m),this._tempC.fromBufferAttribute(g,M),this._tempB.sub(this._tempA),this._tempC.sub(this._tempA),this._tempA.addScaledVector(this._tempB,d).addScaledVector(this._tempC,y),e.position.copy(this._tempA),this._tempA.copy(this._tempB).cross(this._tempC).normalize(),e.velocity.copy(this._tempA).normalize().multiplyScalar(e.startSpeed)}},{key:"toJSON",value:function(){return{type:"mesh_surface",mesh:this._geometry?this._geometry.uuid:""}}},{key:"clone",value:function(){return new i(this._geometry)}},{key:"update",value:function(e,n){}}],[{key:"fromJSON",value:function(e,n){return new i(n.geometries[e.geometry])}}]),i}(),sr={circle:{type:"circle",params:[["radius","number"],["arc","radian"],["thickness","number"],["mode","emitterMode"],["spread","number"],["speed","valueFunc"]],constructor:Tn,loadJSON:Tn.fromJSON},cone:{type:"cone",params:[["radius","number"],["arc","radian"],["thickness","number"],["angle","radian"],["mode","emitterMode"],["spread","number"],["speed","valueFunc"]],constructor:Bn,loadJSON:Bn.fromJSON},donut:{type:"donut",params:[["radius","number"],["arc","radian"],["thickness","number"],["donutRadius","number"],["mode","emitterMode"],["spread","number"],["speed","valueFunc"]],constructor:Pn,loadJSON:Pn.fromJSON},point:{type:"point",params:[],constructor:Vn,loadJSON:Vn.fromJSON},sphere:{type:"sphere",params:[["radius","number"],["arc","radian"],["thickness","number"],["angle","radian"],["mode","emitterMode"],["spread","number"],["speed","valueFunc"]],constructor:Dt,loadJSON:Dt.fromJSON},hemisphere:{type:"hemisphere",params:[["radius","number"],["arc","radian"],["thickness","number"],["angle","radian"],["mode","emitterMode"],["spread","number"],["speed","valueFunc"]],constructor:zn,loadJSON:zn.fromJSON},grid:{type:"grid",params:[["width","number"],["height","number"],["rows","number"],["column","number"]],constructor:En,loadJSON:En.fromJSON},mesh_surface:{type:"mesh_surface",params:[["geometry","geometry"]],constructor:An,loadJSON:An.fromJSON}};function ur(i,t){return sr[i.type].loadJSON(i,t)}var S=function(i){return i[i.BillBoard=0]="BillBoard",i[i.StretchedBillBoard=1]="StretchedBillBoard",i[i.Mesh=2]="Mesh",i[i.Trail=3]="Trail",i[i.HorizontalBillBoard=4]="HorizontalBillBoard",i[i.VerticalBillBoard=5]="VerticalBillBoard",i}({}),Yn=function(i){Me(e,i);var t=ke(e);function e(n){var r;N(this,e),r=t.call(this),s(U(r),"type","VFXBatch"),s(U(r),"systems",void 0),s(U(r),"settings",void 0),s(U(r),"maxParticles",void 0),r.maxParticles=1e3,r.systems=new Set;var a=new et;a.mask=n.layers.mask;var o=n.material.clone();return o.defines={},Object.assign(o.defines,n.material.defines),r.settings={instancingGeometry:n.instancingGeometry,renderMode:n.renderMode,renderOrder:n.renderOrder,material:o,uTileCount:n.uTileCount,vTileCount:n.vTileCount,layers:a},r.frustumCulled=!1,r.renderOrder=r.settings.renderOrder,r}return _(e,[{key:"addSystem",value:function(r){this.systems.add(r)}},{key:"removeSystem",value:function(r){this.systems.delete(r)}}]),e}(ii),lr=new b(0,0,1),Bt=new j,cr=new b,dr=new b;new b;var Cn=60,hr=new Xt(1,1,1,1),fr=function(){function i(t){var e,n,r,a,o,l,c,d,y,w,m,M,g,B,T,R,J,P,C,G;if(N(this,i),s(this,"autoDestroy",void 0),s(this,"prewarm",void 0),s(this,"looping",void 0),s(this,"duration",void 0),s(this,"startLife",void 0),s(this,"startSpeed",void 0),s(this,"startRotation",void 0),s(this,"startSize",void 0),s(this,"startColor",void 0),s(this,"startTileIndex",void 0),s(this,"rendererEmitterSettings",void 0),s(this,"emissionOverTime",void 0),s(this,"emissionOverDistance",void 0),s(this,"emissionBursts",void 0),s(this,"onlyUsedByOther",void 0),s(this,"worldSpace",void 0),s(this,"particleNum",void 0),s(this,"paused",void 0),s(this,"particles",void 0),s(this,"emitterShape",void 0),s(this,"emitter",void 0),s(this,"rendererSettings",void 0),s(this,"neededToUpdateRender",void 0),s(this,"behaviors",void 0),s(this,"emissionState",void 0),s(this,"prewarmed",void 0),s(this,"emitEnded",void 0),s(this,"markForDestroy",void 0),s(this,"previousWorldPos",void 0),s(this,"temp",new b),s(this,"travelDistance",0),s(this,"normalMatrix",new we),s(this,"_renderer",void 0),s(this,"firstTimeUpdate",!0),this.autoDestroy=t.autoDestroy===void 0?!1:t.autoDestroy,this.duration=(e=t.duration)!==null&&e!==void 0?e:1,this.looping=t.looping===void 0?!0:t.looping,this.prewarm=t.prewarm===void 0?!1:t.prewarm,this.startLife=(n=t.startLife)!==null&&n!==void 0?n:new $(5),this.startSpeed=(r=t.startSpeed)!==null&&r!==void 0?r:new $(0),this.startRotation=(a=t.startRotation)!==null&&a!==void 0?a:new $(0),this.startSize=(o=t.startSize)!==null&&o!==void 0?o:new $(1),this.startColor=(l=t.startColor)!==null&&l!==void 0?l:new It(new ve(1,1,1,1)),this.emissionOverTime=(c=t.emissionOverTime)!==null&&c!==void 0?c:new $(10),this.emissionOverDistance=(d=t.emissionOverDistance)!==null&&d!==void 0?d:new $(0),this.emissionBursts=(y=t.emissionBursts)!==null&&y!==void 0?y:[],this.onlyUsedByOther=(w=t.onlyUsedByOther)!==null&&w!==void 0?w:!1,this.emitterShape=(m=t.shape)!==null&&m!==void 0?m:new Dt,this.behaviors=(M=t.behaviors)!==null&&M!==void 0?M:new Array,this.worldSpace=(g=t.worldSpace)!==null&&g!==void 0?g:!1,this.rendererEmitterSettings=(B=t.rendererEmitterSettings)!==null&&B!==void 0?B:{},t.renderMode===S.StretchedBillBoard){var A,V,E=this.rendererEmitterSettings;t.speedFactor!==void 0&&(E.speedFactor=t.speedFactor),E.speedFactor=(A=E.speedFactor)!==null&&A!==void 0?A:0,E.lengthFactor=(V=E.lengthFactor)!==null&&V!==void 0?V:0}this.rendererSettings={instancingGeometry:(T=t.instancingGeometry)!==null&&T!==void 0?T:hr,renderMode:(R=t.renderMode)!==null&&R!==void 0?R:S.BillBoard,renderOrder:(J=t.renderOrder)!==null&&J!==void 0?J:0,material:t.material,uTileCount:(P=t.uTileCount)!==null&&P!==void 0?P:1,vTileCount:(C=t.vTileCount)!==null&&C!==void 0?C:1,layers:(G=t.layers)!==null&&G!==void 0?G:new et},this.neededToUpdateRender=!0,this.particles=new Array,this.startTileIndex=t.startTileIndex||new $(0),this.emitter=new Fi(this),this.paused=!1,this.particleNum=0,this.emissionState={burstIndex:0,burstWaveIndex:0,time:0,waitEmiting:0,travelDistance:0},this.emitEnded=!1,this.markForDestroy=!1,this.prewarmed=!1}return _(i,[{key:"time",get:function(){return this.emissionState.time},set:function(e){this.emissionState.time=e}},{key:"layers",get:function(){return this.rendererSettings.layers}},{key:"texture",get:function(){return this.rendererSettings.material.map},set:function(e){this.rendererSettings.material.map=e,this.neededToUpdateRender=!0}},{key:"material",get:function(){return this.rendererSettings.material},set:function(e){this.rendererSettings.material=e,this.neededToUpdateRender=!0}},{key:"uTileCount",get:function(){return this.rendererSettings.uTileCount},set:function(e){this.rendererSettings.uTileCount=e,this.neededToUpdateRender=!0}},{key:"vTileCount",get:function(){return this.rendererSettings.vTileCount},set:function(e){this.rendererSettings.vTileCount=e,this.neededToUpdateRender=!0}},{key:"instancingGeometry",get:function(){return this.rendererSettings.instancingGeometry},set:function(e){this.restart(),this.particles.length=0,this.rendererSettings.instancingGeometry=e,this.neededToUpdateRender=!0}},{key:"renderMode",get:function(){return this.rendererSettings.renderMode},set:function(e){if((this.rendererSettings.renderMode!=S.Trail&&e===S.Trail||this.rendererSettings.renderMode==S.Trail&&e!==S.Trail)&&(this.restart(),this.particles.length=0),this.rendererSettings.renderMode!==e)switch(e){case S.Trail:this.rendererEmitterSettings={startLength:new $(30),followLocalOrigin:!1};break;case S.Mesh:this.rendererEmitterSettings={geometry:new Xt(1,1)},this.startRotation=new qn(new b(0,1,0),new $(0));break;case S.StretchedBillBoard:this.rendererEmitterSettings={speedFactor:0,lengthFactor:2},this.rendererSettings.renderMode===S.Mesh&&(this.startRotation=new $(0));break;case S.BillBoard:case S.VerticalBillBoard:case S.HorizontalBillBoard:this.rendererEmitterSettings={},this.rendererSettings.renderMode===S.Mesh&&(this.startRotation=new $(0));break}this.rendererSettings.renderMode=e,this.neededToUpdateRender=!0}},{key:"renderOrder",get:function(){return this.rendererSettings.renderOrder},set:function(e){this.rendererSettings.renderOrder=e,this.neededToUpdateRender=!0}},{key:"blending",get:function(){return this.rendererSettings.material.blending},set:function(e){this.rendererSettings.material.blending=e,this.neededToUpdateRender=!0}},{key:"pause",value:function(){this.paused=!0}},{key:"play",value:function(){this.paused=!1}},{key:"spawn",value:function(e,n,r){Bt.setFromRotationMatrix(r);var a=cr,o=Bt,l=dr;r.decompose(a,o,l);for(var c=0;c<e;c++){for(this.particleNum++;this.particles.length<this.particleNum;)this.rendererSettings.renderMode===S.Trail?this.particles.push(new Jt):this.particles.push(new Ct);var d=this.particles[this.particleNum-1];if(this.startColor.genColor(d.startColor,this.emissionState.time,{}),d.color.copy(d.startColor),d.startSpeed=this.startSpeed.genValue(n.time/this.duration),d.life=this.startLife.genValue(n.time/this.duration),d.age=0,d.startSize=this.startSize.genValue(n.time/this.duration),d.uvTile=Math.floor(this.startTileIndex.genValue()+.001),d.size=d.startSize,this.rendererSettings.renderMode===S.Mesh||this.rendererSettings.renderMode===S.BillBoard||this.rendererSettings.renderMode===S.VerticalBillBoard||this.rendererSettings.renderMode===S.HorizontalBillBoard||this.rendererSettings.renderMode===S.StretchedBillBoard){var y=d;this.rendererSettings.renderMode===S.Mesh?(y.rotation instanceof j||(y.rotation=new j),this.startRotation.type==="rotation"?this.startRotation.genValue(y.rotation,n.time/this.duration):y.rotation.setFromAxisAngle(lr,this.startRotation.genValue(n.time/this.duration))):this.startRotation.type==="rotation"?y.rotation=0:y.rotation=this.startRotation.genValue(n.time/this.duration)}else if(this.rendererSettings.renderMode===S.Trail){var w=d;w.length=this.rendererEmitterSettings.startLength.genValue(n.time/this.duration),w.reset()}if(this.emitterShape.initialize(d),this.rendererSettings.renderMode===S.Trail&&this.rendererEmitterSettings.followLocalOrigin){var m=d;m.localPosition=new b().copy(m.position)}this.worldSpace?(d.position.applyMatrix4(r),d.startSize=d.startSize*(Math.abs(l.x)+Math.abs(l.y)+Math.abs(l.z))/3,d.size=d.startSize,d.velocity.multiply(l).applyMatrix3(this.normalMatrix),d.rotation&&d.rotation instanceof j&&d.rotation.multiplyQuaternions(Bt,d.rotation)):this.onlyUsedByOther&&(d.parentMatrix=r);for(var M=0;M<this.behaviors.length;M++)this.behaviors[M].initialize(d)}}},{key:"endEmit",value:function(){this.emitEnded=!0,this.autoDestroy&&(this.markForDestroy=!0)}},{key:"dispose",value:function(){this._renderer&&this._renderer.deleteSystem(this),this.emitter.dispose(),this.emitter.parent&&this.emitter.parent.remove(this.emitter)}},{key:"restart",value:function(){this.paused=!1,this.particleNum=0,this.emissionState.burstIndex=0,this.emissionState.burstWaveIndex=0,this.emissionState.time=0,this.emissionState.waitEmiting=0,this.behaviors.forEach(function(e){e.reset()}),this.emitEnded=!1,this.markForDestroy=!1,this.prewarmed=!1}},{key:"update",value:function(e){if(!this.paused){for(var n=this.emitter;n.parent;)n=n.parent;if(n.type!=="Scene"){this.dispose();return}if(this.firstTimeUpdate&&(this.firstTimeUpdate=!1,this.emitter.updateWorldMatrix(!0,!1)),this.emitEnded&&this.particleNum===0){this.markForDestroy&&this.emitter.parent&&this.dispose();return}if(this.looping&&this.prewarm&&!this.prewarmed){this.prewarmed=!0;for(var r=0;r<this.duration*Cn;r++)this.update(1/Cn)}e>.1&&(e=.1),this.neededToUpdateRender&&(this._renderer&&this._renderer.updateSystem(this),this.neededToUpdateRender=!1),this.onlyUsedByOther||this.emit(e,this.emissionState,this.emitter.matrixWorld),this.emitterShape.update(this,e);for(var a=0;a<this.behaviors.length;a++){for(var o=0;o<this.particleNum;o++)this.particles[o].died||this.behaviors[a].update(this.particles[o],e);this.behaviors[a].frameUpdate(e)}for(var l=0;l<this.particleNum;l++){if(this.rendererEmitterSettings.followLocalOrigin&&this.particles[l].localPosition)this.particles[l].position.copy(this.particles[l].localPosition),this.particles[l].parentMatrix?this.particles[l].position.applyMatrix4(this.particles[l].parentMatrix):this.particles[l].position.applyMatrix4(this.emitter.matrixWorld);else{var c,d=(c=this.particles[l].speedModifier)!==null&&c!==void 0?c:1;this.particles[l].position.addScaledVector(this.particles[l].velocity,e*d)}this.particles[l].age+=e}if(this.rendererSettings.renderMode===S.Trail)for(var y=0;y<this.particleNum;y++){var w=this.particles[y];w.update()}for(var m=0;m<this.particleNum;m++){var M=this.particles[m];M.died&&(!(M instanceof Jt)||M.previous.length===0)&&(this.particles[m]=this.particles[this.particleNum-1],this.particles[this.particleNum-1]=M,this.particleNum--,m--)}}}},{key:"emit",value:function(e,n,r){n.time>this.duration&&(this.looping?(n.time-=this.duration,n.burstIndex=0,this.behaviors.forEach(function(d){d.reset()})):!this.emitEnded&&!this.onlyUsedByOther&&this.endEmit()),this.normalMatrix.getNormalMatrix(r);var a=Math.ceil(n.waitEmiting);for(this.spawn(a,n,r),n.waitEmiting-=a;n.burstIndex<this.emissionBursts.length&&this.emissionBursts[n.burstIndex].time<=n.time;){if(Math.random()<this.emissionBursts[n.burstIndex].probability){var o=this.emissionBursts[n.burstIndex].count.genValue(this.time);this.spawn(o,n,r)}n.burstIndex++}if(!this.emitEnded&&(n.waitEmiting+=e*this.emissionOverTime.genValue(n.time/this.duration),n.previousWorldPos!=null)){this.temp.set(r.elements[12],r.elements[13],r.elements[14]),n.travelDistance+=n.previousWorldPos.distanceTo(this.temp);var l=this.emissionOverDistance.genValue(n.time/this.duration);if(n.travelDistance*l>0){var c=Math.floor(n.travelDistance*l);n.travelDistance-=c/l,n.waitEmiting+=c}}n.previousWorldPos===void 0&&(n.previousWorldPos=new b),n.previousWorldPos.set(r.elements[12],r.elements[13],r.elements[14]),n.time+=e}},{key:"toJSON",value:function(e){var n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},r=e===void 0||typeof e=="string";if(r&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}}),e.materials[this.rendererSettings.material.uuid]=this.rendererSettings.material.toJSON(e),n.useUrlForImage&&this.texture.source!==void 0){var a=this.texture.source;e.images[a.uuid]={uuid:a.uuid,url:this.texture.image.url}}var o;this.renderMode===S.Trail?o={startLength:this.rendererEmitterSettings.startLength.toJSON(),followLocalOrigin:this.rendererEmitterSettings.followLocalOrigin}:this.renderMode===S.Mesh?o={}:this.renderMode===S.StretchedBillBoard?o={speedFactor:this.rendererEmitterSettings.speedFactor,lengthFactor:this.rendererEmitterSettings.lengthFactor}:o={};var l=this.rendererSettings.instancingGeometry;return e.geometries&&!e.geometries[l.uuid]&&(e.geometries[l.uuid]=l.toJSON()),{version:"2.0",autoDestroy:this.autoDestroy,looping:this.looping,prewarm:this.prewarm,duration:this.duration,shape:this.emitterShape.toJSON(),startLife:this.startLife.toJSON(),startSpeed:this.startSpeed.toJSON(),startRotation:this.startRotation.toJSON(),startSize:this.startSize.toJSON(),startColor:this.startColor.toJSON(),emissionOverTime:this.emissionOverTime.toJSON(),emissionOverDistance:this.emissionOverDistance.toJSON(),emissionBursts:this.emissionBursts.map(function(c){return{time:c.time,count:c.count.toJSON(),probability:c.probability,interval:c.interval,cycle:c.cycle}}),onlyUsedByOther:this.onlyUsedByOther,instancingGeometry:this.rendererSettings.instancingGeometry.uuid,renderOrder:this.renderOrder,renderMode:this.renderMode,rendererEmitterSettings:o,material:this.rendererSettings.material.uuid,layers:this.layers.mask,startTileIndex:this.startTileIndex.toJSON(),uTileCount:this.uTileCount,vTileCount:this.vTileCount,behaviors:this.behaviors.map(function(c){return c.toJSON()}),worldSpace:this.worldSpace}}},{key:"addBehavior",value:function(e){this.behaviors.push(e)}},{key:"getRendererSettings",value:function(){return this.rendererSettings}},{key:"clone",value:function(){var e=[],n=rn(this.emissionBursts),r;try{for(n.s();!(r=n.n()).done;){var a=r.value,o={};Object.assign(o,a),e.push(o)}}catch(M){n.e(M)}finally{n.f()}var l=[],c=rn(this.behaviors),d;try{for(c.s();!(d=c.n()).done;){var y=d.value;l.push(y.clone())}}catch(M){c.e(M)}finally{c.f()}var w;this.renderMode===S.Trail?w={startLength:this.rendererEmitterSettings.startLength.clone(),followLocalOrigin:this.rendererEmitterSettings.followLocalOrigin}:w={};var m=new et;return m.mask=this.layers.mask,new i({autoDestroy:this.autoDestroy,looping:this.looping,duration:this.duration,shape:this.emitterShape.clone(),startLife:this.startLife.clone(),startSpeed:this.startSpeed.clone(),startRotation:this.startRotation.clone(),startSize:this.startSize.clone(),startColor:this.startColor.clone(),emissionOverTime:this.emissionOverTime.clone(),emissionOverDistance:this.emissionOverDistance.clone(),emissionBursts:e,onlyUsedByOther:this.onlyUsedByOther,instancingGeometry:this.rendererSettings.instancingGeometry,renderMode:this.renderMode,renderOrder:this.renderOrder,rendererEmitterSettings:w,material:this.rendererSettings.material,startTileIndex:this.startTileIndex,uTileCount:this.uTileCount,vTileCount:this.vTileCount,behaviors:l,worldSpace:this.worldSpace,layers:m})}}],[{key:"fromJSON",value:function(e,n,r){var a,o,l=ur(e.shape,n),c;if(e.renderMode===S.Trail){var d=e.rendererEmitterSettings;c={startLength:d.startLength!=null?L(d.startLength):new $(30),followLocalOrigin:d.followLocalOrigin}}else e.renderMode===S.Mesh?c={}:e.renderMode===S.StretchedBillBoard?(c=e.rendererEmitterSettings,e.speedFactor!=null&&(c.speedFactor=e.speedFactor)):c={};var y=new et;e.layers&&(y.mask=e.layers);var w=new i({autoDestroy:e.autoDestroy,looping:e.looping,prewarm:e.prewarm,duration:e.duration,shape:l,startLife:L(e.startLife),startSpeed:L(e.startSpeed),startRotation:Zi(e.startRotation),startSize:L(e.startSize),startColor:Yt(e.startColor),emissionOverTime:L(e.emissionOverTime),emissionOverDistance:L(e.emissionOverDistance),emissionBursts:(a=e.emissionBursts)===null||a===void 0?void 0:a.map(function(m){return{time:m.time,count:typeof m.count=="number"?new $(m.count):L(m.count),probability:m.probability,interval:m.interval,cycle:m.cycle}}),onlyUsedByOther:e.onlyUsedByOther,instancingGeometry:n.geometries[e.instancingGeometry],renderMode:e.renderMode,rendererEmitterSettings:c,renderOrder:e.renderOrder,layers:y,material:e.material?n.materials[e.material]:e.texture?new Pt({map:n.textures[e.texture],transparent:(o=e.transparent)!==null&&o!==void 0?o:!0,blending:e.blending,side:Vt}):new Pt({color:16777215,transparent:!0,blending:nt,side:Vt}),startTileIndex:typeof e.startTileIndex=="number"?new $(e.startTileIndex):L(e.startTileIndex),uTileCount:e.uTileCount,vTileCount:e.vTileCount,behaviors:[],worldSpace:e.worldSpace});return w.behaviors=e.behaviors.map(function(m){var M=Hn(m,w);return M.type==="EmitSubParticleSystem"&&(r[m.subParticleSystem]=M),M}),w}}]),i}(),Tt=`

#include <common>
#include <uv_pars_fragment>
#include <color_pars_fragment>
#include <map_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>
#include <alphatest_pars_fragment>

void main() {

    #include <clipping_planes_fragment>
    
    vec3 outgoingLight = vec3( 0.0 );
    vec4 diffuseColor = vColor;
    
    #include <logdepthbuf_fragment>
    
    #ifdef USE_MAP
    diffuseColor *= texture2D( map, vMapUv);
    #endif
    
    #include <alphatest_fragment>

    outgoingLight = diffuseColor.rgb;
    
    #ifdef USE_COLOR_AS_ALPHA
    gl_FragColor = vec4( outgoingLight, diffuseColor.r );
    #else
    gl_FragColor = vec4( outgoingLight, diffuseColor.a );
    #endif
    
    
    #include <tonemapping_fragment>

}
`,mr=`
#define STANDARD
#ifdef PHYSICAL
#define IOR
#define SPECULAR
#endif
uniform vec3 diffuse;
uniform vec3 emissive;
uniform float roughness;
uniform float metalness;
uniform float opacity;
#ifdef IOR
uniform float ior;
#endif
#ifdef SPECULAR
uniform float specularIntensity;
uniform vec3 specularColor;
#ifdef USE_SPECULARINTENSITYMAP
uniform sampler2D specularIntensityMap;
#endif
#ifdef USE_SPECULARCOLORMAP
uniform sampler2D specularColorMap;
#endif
#endif
#ifdef USE_CLEARCOAT
uniform float clearcoat;
uniform float clearcoatRoughness;
#endif
#ifdef USE_IRIDESCENCE
uniform float iridescence;
uniform float iridescenceIOR;
uniform float iridescenceThicknessMinimum;
uniform float iridescenceThicknessMaximum;
#endif
#ifdef USE_SHEEN
uniform vec3 sheenColor;
uniform float sheenRoughness;
#ifdef USE_SHEENCOLORMAP
uniform sampler2D sheenColorMap;
#endif
#ifdef USE_SHEENROUGHNESSMAP
uniform sampler2D sheenRoughnessMap;
#endif
#endif

varying vec3 vViewPosition;
#include <common>
#include <packing>
#include <dithering_pars_fragment>
#include <color_pars_fragment>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <alphamap_pars_fragment>
#include <alphatest_pars_fragment>
#include <aomap_pars_fragment>
#include <lightmap_pars_fragment>
#include <emissivemap_pars_fragment>
#include <bsdfs>
#include <iridescence_fragment>
#include <cube_uv_reflection_fragment>
#include <envmap_common_pars_fragment>
#include <envmap_physical_pars_fragment>
#include <fog_pars_fragment>
#include <lights_pars_begin>
#include <normal_pars_fragment>
#include <lights_physical_pars_fragment>
#include <transmission_pars_fragment>
#include <shadowmap_pars_fragment>
#include <bumpmap_pars_fragment>
#include <normalmap_pars_fragment>
#include <clearcoat_pars_fragment>
#include <iridescence_pars_fragment>
#include <roughnessmap_pars_fragment>
#include <metalnessmap_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>

void main() {
    #include <clipping_planes_fragment>
    vec4 diffuseColor = vec4( diffuse, opacity );
    ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
    vec3 totalEmissiveRadiance = emissive;
    #include <logdepthbuf_fragment>
    #include <map_fragment>
    #include <color_fragment>
    #include <alphamap_fragment>
    #include <alphatest_fragment>
    #include <roughnessmap_fragment>
    #include <metalnessmap_fragment>
    #include <normal_fragment_begin>
    #include <normal_fragment_maps>
    #include <clearcoat_normal_fragment_begin>
    #include <clearcoat_normal_fragment_maps>
    #include <emissivemap_fragment>
    // accumulation
    #include <lights_physical_fragment>
    #include <lights_fragment_begin>
    #include <lights_fragment_maps>
    #include <lights_fragment_end>
    // modulation
    #include <aomap_fragment>
    vec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;
    vec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;
    #include <transmission_fragment>
    vec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;
    #ifdef USE_SHEEN
    // Sheen energy compensation approximation calculation can be found at the end of
        // https://drive.google.com/file/d/1T0D1VSyR4AllqIJTQAraEIzjlb5h4FKH/view?usp=sharing
        float sheenEnergyComp = 1.0 - 0.157 * max3( material.sheenColor );
        outgoingLight = outgoingLight * sheenEnergyComp + sheenSpecular;
    #endif
    #ifdef USE_CLEARCOAT
        float dotNVcc = saturate( dot( geometry.clearcoatNormal, geometry.viewDir ) );
        vec3 Fcc = F_Schlick( material.clearcoatF0, material.clearcoatF90, dotNVcc );
        outgoingLight = outgoingLight * ( 1.0 - material.clearcoat * Fcc ) + clearcoatSpecular * material.clearcoat;
    #endif
    #include <output_fragment>
    #include <tonemapping_fragment>
    #include <encodings_fragment>
    #include <fog_fragment>
    #include <premultiplied_alpha_fragment>
    #include <dithering_fragment>
}`,De=`

    #ifdef UV_TILE
        float col = mod(uvTile, tileCount.x);
        float row = (tileCount.y - floor(uvTile / tileCount.x) - 1.0);
        
        mat3 tileTransform = mat3(
          1.0 / tileCount.x, 0.0, 0.0,
          0.0, 1.0 / tileCount.y, 0.0, 
          col / tileCount.x, row / tileCount.y, 1.0);
    #else
        mat3 tileTransform = mat3(1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0);
    #endif

#if defined( USE_UV ) || defined( USE_ANISOTROPY )

vUv = (tileTransform *vec3( uv, 1 )).xy;

#endif
#ifdef USE_MAP

vMapUv = ( tileTransform * (mapTransform * vec3( MAP_UV, 1 ) )).xy;

#endif
#ifdef USE_ALPHAMAP

vAlphaMapUv = ( tileTransform * (alphaMapTransform * vec3( ALPHAMAP_UV, 1 ) )).xy;

#endif
#ifdef USE_LIGHTMAP

vLightMapUv = ( tileTransform * (lightMapTransform * vec3( LIGHTMAP_UV, 1 ) )).xy;

#endif
#ifdef USE_AOMAP

vAoMapUv = ( tileTransform * (aoMapTransform * vec3( AOMAP_UV, 1 ) )).xy;

#endif
#ifdef USE_BUMPMAP

vBumpMapUv = ( tileTransform * (bumpMapTransform * vec3( BUMPMAP_UV, 1 ) )).xy;

#endif
#ifdef USE_NORMALMAP

vNormalMapUv = ( tileTransform * (normalMapTransform * vec3( NORMALMAP_UV, 1 ) )).xy;

#endif
#ifdef USE_DISPLACEMENTMAP

vDisplacementMapUv = ( tileTransform * (displacementMapTransform * vec3( DISPLACEMENTMAP_UV, 1 ) )).xy;

#endif
#ifdef USE_EMISSIVEMAP

vEmissiveMapUv = ( tileTransform * (emissiveMapTransform * vec3( EMISSIVEMAP_UV, 1 ) )).xy;

#endif
#ifdef USE_METALNESSMAP

vMetalnessMapUv = ( tileTransform * (metalnessMapTransform * vec3( METALNESSMAP_UV, 1 ) )).xy;

#endif
#ifdef USE_ROUGHNESSMAP

vRoughnessMapUv = ( tileTransform * (roughnessMapTransform * vec3( ROUGHNESSMAP_UV, 1 ) )).xy;

#endif
#ifdef USE_ANISOTROPYMAP

vAnisotropyMapUv = ( tileTransform * (anisotropyMapTransform * vec3( ANISOTROPYMAP_UV, 1 ) )).xy;

#endif
#ifdef USE_CLEARCOATMAP

vClearcoatMapUv = ( tileTransform * (clearcoatMapTransform * vec3( CLEARCOATMAP_UV, 1 ) )).xy;

#endif
#ifdef USE_CLEARCOAT_NORMALMAP

vClearcoatNormalMapUv = ( tileTransform * (clearcoatNormalMapTransform * vec3( CLEARCOAT_NORMALMAP_UV, 1 ) )).xy;

#endif
#ifdef USE_CLEARCOAT_ROUGHNESSMAP

vClearcoatRoughnessMapUv = ( tileTransform * (clearcoatRoughnessMapTransform * vec3( CLEARCOAT_ROUGHNESSMAP_UV, 1 ) )).xy;

#endif
#ifdef USE_IRIDESCENCEMAP

vIridescenceMapUv = ( tileTransform * (iridescenceMapTransform * vec3( IRIDESCENCEMAP_UV, 1 ) )).xy;

#endif
#ifdef USE_IRIDESCENCE_THICKNESSMAP

vIridescenceThicknessMapUv = ( tileTransform * (iridescenceThicknessMapTransform * vec3( IRIDESCENCE_THICKNESSMAP_UV, 1 ) )).xy;

#endif
#ifdef USE_SHEEN_COLORMAP

vSheenColorMapUv = ( tileTransform * (sheenColorMapTransform * vec3( SHEEN_COLORMAP_UV, 1 ) )).xy;

#endif
#ifdef USE_SHEEN_ROUGHNESSMAP

vSheenRoughnessMapUv = ( tileTransform * (sheenRoughnessMapTransform * vec3( SHEEN_ROUGHNESSMAP_UV, 1 ) )).xy;

#endif
#ifdef USE_SPECULARMAP

vSpecularMapUv = ( tileTransform * (specularMapTransform * vec3( SPECULARMAP_UV, 1 ) )).xy;

#endif
#ifdef USE_SPECULAR_COLORMAP

vSpecularColorMapUv = ( tileTransform * (specularColorMapTransform * vec3( SPECULAR_COLORMAP_UV, 1 ) )).xy;

#endif
#ifdef USE_SPECULAR_INTENSITYMAP

vSpecularIntensityMapUv = ( tileTransform * (specularIntensityMapTransform * vec3( SPECULAR_INTENSITYMAP_UV, 1 ) )).xy;

#endif
#ifdef USE_TRANSMISSIONMAP

vTransmissionMapUv = ( tileTransform * transmissionMapTransform * vec3( TRANSMISSIONMAP_UV, 1 ) )).xy;

#endif
#ifdef USE_THICKNESSMAP

vThicknessMapUv = ( tileTransform * thicknessMapTransform * vec3( THICKNESSMAP_UV, 1 ) )).xy;

#endif
`,vr=`
#include <common>
#include <color_pars_vertex>
#include <uv_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>

attribute vec3 offset;
attribute float rotation;
attribute float size;
attribute float uvTile;

#ifdef UV_TILE
uniform vec2 tileCount;
#endif

void main() {

    `.concat(De,`
	
    vec2 alignedPosition = ( position.xy ) * size;
    
    vec2 rotatedPosition;
    rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;
    rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;
#ifdef HORIZONTAL
    vec4 mvPosition = modelMatrix * vec4( offset, 1.0 );
    mvPosition.x += rotatedPosition.x;
    mvPosition.z -= rotatedPosition.y;
    mvPosition = viewMatrix * mvPosition;
#elif defined(VERTICAL)
    vec4 mvPosition = modelMatrix * vec4( offset, 1.0 );
    mvPosition.y += rotatedPosition.y;
    mvPosition = viewMatrix * mvPosition;
    mvPosition.x += rotatedPosition.x;
#else
    vec4 mvPosition = modelViewMatrix * vec4( offset, 1.0 );
    mvPosition.xy += rotatedPosition;
#endif

	vColor = color;

	gl_Position = projectionMatrix * mvPosition;

	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>

}
`),pr=`
#include <common>
#include <uv_pars_vertex>
#include <color_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>

attribute vec3 offset;
attribute vec4 rotation;
attribute float size;
// attribute vec4 color;
attribute float uvTile;

#ifdef UV_TILE
uniform vec2 tileCount;
#endif

void main() {

    `.concat(De,`
    
    float x2 = rotation.x + rotation.x, y2 = rotation.y + rotation.y, z2 = rotation.z + rotation.z;
    float xx = rotation.x * x2, xy = rotation.x * y2, xz = rotation.x * z2;
    float yy = rotation.y * y2, yz = rotation.y * z2, zz = rotation.z * z2;
    float wx = rotation.w * x2, wy = rotation.w * y2, wz = rotation.w * z2;
    float sx = size, sy = size, sz = size;
    
    mat4 matrix = mat4(( 1.0 - ( yy + zz ) ) * sx, ( xy + wz ) * sx, ( xz - wy ) * sx, 0.0,  // 1. column
                      ( xy - wz ) * sy, ( 1.0 - ( xx + zz ) ) * sy, ( yz + wx ) * sy, 0.0,  // 2. column
                      ( xz + wy ) * sz, ( yz - wx ) * sz, ( 1.0 - ( xx + yy ) ) * sz, 0.0,  // 3. column
                      offset.x, offset.y, offset.z, 1.0);
    
    vec4 mvPosition = modelViewMatrix * (matrix * vec4( position, 1.0 ));

	vColor = color;

	gl_Position = projectionMatrix * mvPosition;

	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>

}
`),yr=`
#define STANDARD
varying vec3 vViewPosition;
#ifdef USE_TRANSMISSION
	varying vec3 vWorldPosition;
#endif
#include <common>
#include <uv_pars_vertex>

attribute vec3 offset;
attribute vec4 rotation;
attribute float size;
attribute float uvTile;

#ifdef UV_TILE
uniform vec2 tileCount;
#endif

#include <displacementmap_pars_vertex>
#include <color_pars_vertex>
#include <fog_pars_vertex>
#include <normal_pars_vertex>
#include <morphtarget_pars_vertex>
#include <skinning_pars_vertex>
#include <shadowmap_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>

void main() {
    `.concat(De,`

    float x2 = rotation.x + rotation.x, y2 = rotation.y + rotation.y, z2 = rotation.z + rotation.z;
    float xx = rotation.x * x2, xy = rotation.x * y2, xz = rotation.x * z2;
    float yy = rotation.y * y2, yz = rotation.y * z2, zz = rotation.z * z2;
    float wx = rotation.w * x2, wy = rotation.w * y2, wz = rotation.w * z2;
    float sx = size, sy = size, sz = size;

    mat4 particleMatrix = mat4(( 1.0 - ( yy + zz ) ) * sx, ( xy + wz ) * sx, ( xz - wy ) * sx, 0.0,  // 1. column
                      ( xy - wz ) * sy, ( 1.0 - ( xx + zz ) ) * sy, ( yz + wx ) * sy, 0.0,  // 2. column
                      ( xz + wy ) * sz, ( yz - wx ) * sz, ( 1.0 - ( xx + yy ) ) * sz, 0.0,  // 3. column
                      offset.x, offset.y, offset.z, 1.0);

	#include <color_vertex>
	#include <morphcolor_vertex>
	#include <beginnormal_vertex>
	#include <morphnormal_vertex>
	#include <skinbase_vertex>
	#include <skinnormal_vertex>

	// replace defaultnormal_vertex
	vec3 transformedNormal = objectNormal;
    mat3 m = mat3( particleMatrix );
    transformedNormal /= vec3( dot( m[ 0 ], m[ 0 ] ), dot( m[ 1 ], m[ 1 ] ), dot( m[ 2 ], m[ 2 ] ) );
    transformedNormal = m * transformedNormal;
    transformedNormal = normalMatrix * transformedNormal;
    #ifdef FLIP_SIDED
        transformedNormal = - transformedNormal;
    #endif
    #ifdef USE_TANGENT
        vec3 transformedTangent = ( modelViewMatrix * vec4( objectTangent, 0.0 ) ).xyz;
        #ifdef FLIP_SIDED
        transformedTangent = - transformedTangent;
        #endif
    #endif

	#include <normal_vertex>
	#include <begin_vertex>
	#include <morphtarget_vertex>
	#include <skinning_vertex>
	#include <displacementmap_vertex>

	// replace include <project_vertex>
  vec4 mvPosition = vec4( transformed, 1.0 );
  mvPosition = modelViewMatrix * (particleMatrix * mvPosition);
	gl_Position = projectionMatrix * mvPosition;

	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	
	vViewPosition = - mvPosition.xyz;
	
	#include <worldpos_vertex>
	#include <shadowmap_vertex>
	#include <fog_vertex>
#ifdef USE_TRANSMISSION
	vWorldPosition = worldPosition.xyz;
#endif
}
`),gr=`
#include <common>
#include <uv_pars_vertex>
#include <color_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <clipping_planes_pars_vertex>

attribute vec3 offset;
attribute float rotation;
attribute float size;
attribute vec4 velocity;
attribute float uvTile;

#ifdef UV_TILE
uniform vec2 tileCount;
#endif

uniform float speedFactor;

void main() {

    `.concat(De,`
    
    float lengthFactor = velocity.w;
#ifdef USE_SKEW
    vec4 mvPosition = modelViewMatrix * vec4( offset, 1.0 );
    vec3 viewVelocity = normalMatrix * velocity.xyz;

    vec3 scaledPos = vec3(position.xy * size, position.z);
    float vlength = length(viewVelocity);
    vec3 projVelocity =  dot(scaledPos, viewVelocity) * viewVelocity / vlength;
    mvPosition.xyz += scaledPos + projVelocity * (speedFactor / size + lengthFactor / vlength);
#else
    vec4 mvPosition = modelViewMatrix * vec4( offset, 1.0 );
    vec3 viewVelocity = normalMatrix * velocity.xyz;
    float vlength = length(viewVelocity); 
    mvPosition.xyz += position.y * normalize(cross(mvPosition.xyz, viewVelocity)) * size; // switch the cross to  match unity implementation
    mvPosition.xyz -= (position.x + 0.5) * viewVelocity * (1.0 + lengthFactor / vlength) * size; // minus position.x to match unity implementation
#endif
	vColor = color;
	gl_Position = projectionMatrix * mvPosition;
	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
}
`);function Gt(i){return i===0?"uv":"uv".concat(i)}new b(0,0,1);var Sr=function(i){Me(e,i);var t=ke(e);function e(n){var r;return N(this,e),r=t.call(this,n),s(U(r),"offsetBuffer",void 0),s(U(r),"rotationBuffer",void 0),s(U(r),"sizeBuffer",void 0),s(U(r),"colorBuffer",void 0),s(U(r),"uvTileBuffer",void 0),s(U(r),"velocityBuffer",void 0),s(U(r),"vector_",new b),s(U(r),"vector2_",new b),s(U(r),"vector3_",new b),s(U(r),"quaternion_",new j),s(U(r),"quaternion2_",new j),s(U(r),"quaternion3_",new j),s(U(r),"rotationMat_",new we),s(U(r),"rotationMat2_",new we),r.maxParticles=1e3,r.setupBuffers(),r.rebuildMaterial(),r}return _(e,[{key:"buildExpandableBuffers",value:function(){this.offsetBuffer=new xe(new Float32Array(this.maxParticles*3),3),this.offsetBuffer.setUsage(ie),this.geometry.setAttribute("offset",this.offsetBuffer),this.colorBuffer=new xe(new Float32Array(this.maxParticles*4),4),this.colorBuffer.setUsage(ie),this.geometry.setAttribute("color",this.colorBuffer),this.settings.renderMode===S.Mesh?(this.rotationBuffer=new xe(new Float32Array(this.maxParticles*4),4),this.rotationBuffer.setUsage(ie),this.geometry.setAttribute("rotation",this.rotationBuffer)):(this.settings.renderMode===S.BillBoard||this.settings.renderMode===S.HorizontalBillBoard||this.settings.renderMode===S.VerticalBillBoard||this.settings.renderMode===S.StretchedBillBoard)&&(this.rotationBuffer=new xe(new Float32Array(this.maxParticles),1),this.rotationBuffer.setUsage(ie),this.geometry.setAttribute("rotation",this.rotationBuffer)),this.sizeBuffer=new xe(new Float32Array(this.maxParticles),1),this.sizeBuffer.setUsage(ie),this.geometry.setAttribute("size",this.sizeBuffer),this.uvTileBuffer=new xe(new Float32Array(this.maxParticles),1),this.uvTileBuffer.setUsage(ie),this.geometry.setAttribute("uvTile",this.uvTileBuffer),this.settings.renderMode===S.StretchedBillBoard&&(this.velocityBuffer=new xe(new Float32Array(this.maxParticles*4),4),this.velocityBuffer.setUsage(ie),this.geometry.setAttribute("velocity",this.velocityBuffer))}},{key:"setupBuffers",value:function(){this.geometry&&this.geometry.dispose(),this.geometry=new Kn,this.geometry.setIndex(this.settings.instancingGeometry.getIndex()),this.settings.instancingGeometry.hasAttribute("normal")&&this.geometry.setAttribute("normal",this.settings.instancingGeometry.getAttribute("normal")),this.geometry.setAttribute("position",this.settings.instancingGeometry.getAttribute("position")),this.geometry.setAttribute("uv",this.settings.instancingGeometry.getAttribute("uv")),this.buildExpandableBuffers()}},{key:"expandBuffers",value:function(r){for(;r>=this.maxParticles;)this.maxParticles*=2;this.setupBuffers()}},{key:"rebuildMaterial",value:function(){this.layers.mask=this.settings.layers.mask;var r,a={};if(this.settings.material.type==="MeshStandardMaterial"||this.settings.material.type==="MeshPhysicalMaterial"){var o=this.settings.material;r=jn.merge([oe.common,oe.envmap,oe.aomap,oe.lightmap,oe.emissivemap,oe.bumpmap,oe.normalmap,oe.displacementmap,oe.roughnessmap,oe.metalnessmap,oe.fog,oe.lights,{emissive:{value:new ei(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}]),r.diffuse.value=o.color,r.opacity.value=o.opacity,r.emissive.value=o.emissive,r.roughness.value=o.roughness,r.metalness.value=o.metalness,o.envMap&&(r.envMap.value=o.envMap,r.envMapIntensity.value=o.envMapIntensity),o.normalMap&&(r.normalMap.value=o.normalMap,r.normalScale.value=o.normalScale),o.roughnessMap&&(r.roughnessMap.value=o.roughnessMap),o.metalnessMap&&(r.metalnessMap.value=o.metalnessMap),o.map&&(r.map=new me(o.map))}else r={},r.map=new me(this.settings.material.map);this.settings.material.alphaTest&&(a.USE_ALPHATEST="",r.alphaTest=new me(this.settings.material.alphaTest)),a.USE_UV="";var l=this.settings.uTileCount,c=this.settings.vTileCount;(l>1||c>1)&&(a.UV_TILE="",r.tileCount=new me(new Le(l,c))),this.settings.material.defines&&this.settings.material.defines.USE_COLOR_AS_ALPHA!==void 0&&(a.USE_COLOR_AS_ALPHA=""),this.settings.material.normalMap&&(a.USE_NORMALMAP="",a.NORMALMAP_UV=Gt(this.settings.material.normalMap.channel),r.normalMapTransform=new me(new we().copy(this.settings.material.normalMap.matrix))),this.settings.material.map&&(a.USE_MAP="",a.MAP_UV=Gt(this.settings.material.map.channel),r.mapTransform=new me(new we().copy(this.settings.material.map.matrix))),a.USE_COLOR_ALPHA="";var d=!1;if(this.settings.renderMode===S.BillBoard||this.settings.renderMode===S.VerticalBillBoard||this.settings.renderMode===S.HorizontalBillBoard||this.settings.renderMode===S.Mesh){var y,w;this.settings.renderMode===S.Mesh?this.settings.material.type==="MeshStandardMaterial"||this.settings.material.type==="MeshPhysicalMaterial"?(a.USE_COLOR="",y=yr,w=mr,d=!0):(y=pr,w=Tt):(y=vr,w=Tt),this.settings.renderMode===S.VerticalBillBoard?a.VERTICAL="":this.settings.renderMode===S.HorizontalBillBoard&&(a.HORIZONTAL=""),this.material=new zt({uniforms:r,defines:a,vertexShader:y,fragmentShader:w,transparent:this.settings.material.transparent,depthWrite:!this.settings.material.transparent,blending:this.settings.material.blending,side:this.settings.material.side,alphaTest:this.settings.material.alphaTest,lights:d})}else if(this.settings.renderMode===S.StretchedBillBoard)r.speedFactor=new me(1),this.material=new zt({uniforms:r,defines:a,vertexShader:gr,fragmentShader:Tt,transparent:this.settings.material.transparent,depthWrite:!this.settings.material.transparent,blending:this.settings.material.blending,side:this.settings.material.side,alphaTest:this.settings.material.alphaTest});else throw new Error("render mode unavailable")}},{key:"update",value:function(){var r=this,a=0,o=0;this.systems.forEach(function(l){o+=l.particleNum}),o>this.maxParticles&&this.expandBuffers(o),this.systems.forEach(function(l){var c=l.particles,d=l.particleNum,y=r.quaternion2_,w=r.vector2_,m=r.vector3_;l.emitter.matrixWorld.decompose(w,y,m),r.rotationMat_.setFromMatrix4(l.emitter.matrixWorld);for(var M=0;M<d;M++,a++){var g=c[M];if(r.settings.renderMode===S.Mesh){var B=void 0;if(l.worldSpace)B=g.rotation;else{var T=void 0;g.parentMatrix?T=r.quaternion3_.setFromRotationMatrix(g.parentMatrix):T=y,B=r.quaternion_,B.copy(g.rotation).multiply(T)}r.rotationBuffer.setXYZW(a,B.x,B.y,B.z,B.w)}else(r.settings.renderMode===S.StretchedBillBoard||r.settings.renderMode===S.VerticalBillBoard||r.settings.renderMode===S.HorizontalBillBoard||r.settings.renderMode===S.BillBoard)&&r.rotationBuffer.setX(a,g.rotation);var R=void 0;if(l.worldSpace?R=g.position:(R=r.vector_,g.parentMatrix?R.copy(g.position).applyMatrix4(g.parentMatrix):R.copy(g.position).applyMatrix4(l.emitter.matrixWorld)),r.offsetBuffer.setXYZ(a,R.x,R.y,R.z),r.colorBuffer.setXYZW(a,g.color.x,g.color.y,g.color.z,g.color.w),l.worldSpace||g.parentMatrix?r.sizeBuffer.setX(a,g.size):r.sizeBuffer.setX(a,g.size*(Math.abs(m.x)+Math.abs(m.y)+Math.abs(m.z))/3),r.uvTileBuffer.setX(a,g.uvTile),r.settings.renderMode===S.StretchedBillBoard&&r.velocityBuffer){var J=l.rendererEmitterSettings.speedFactor;J===0&&(J=.001);var P=l.rendererEmitterSettings.lengthFactor,C=void 0;l.worldSpace?C=g.velocity:(C=r.vector_,g.parentMatrix?(r.rotationMat2_.setFromMatrix4(g.parentMatrix),C.copy(g.velocity).applyMatrix3(r.rotationMat2_)):C.copy(g.velocity).applyMatrix3(r.rotationMat_)),r.velocityBuffer.setXYZW(a,C.x*J,C.y*J,C.z*J,P)}}}),this.geometry.instanceCount=a,a>0&&(this.offsetBuffer.updateRange.count=a*3,this.offsetBuffer.needsUpdate=!0,this.sizeBuffer.updateRange.count=a,this.sizeBuffer.needsUpdate=!0,this.colorBuffer.updateRange.count=a*4,this.colorBuffer.needsUpdate=!0,this.uvTileBuffer.updateRange.count=a,this.uvTileBuffer.needsUpdate=!0,this.settings.renderMode===S.StretchedBillBoard&&this.velocityBuffer&&(this.velocityBuffer.updateRange.count=a*4,this.velocityBuffer.needsUpdate=!0),this.settings.renderMode===S.Mesh?(this.rotationBuffer.updateRange.count=a*4,this.rotationBuffer.needsUpdate=!0):(this.settings.renderMode===S.StretchedBillBoard||this.settings.renderMode===S.HorizontalBillBoard||this.settings.renderMode===S.VerticalBillBoard||this.settings.renderMode===S.BillBoard)&&(this.rotationBuffer.updateRange.count=a,this.rotationBuffer.needsUpdate=!0))}},{key:"dispose",value:function(){this.geometry.dispose()}}]),e}(Yn),xr=`

#include <common>
#include <uv_pars_fragment>
#include <map_pars_fragment>
#include <fog_pars_fragment>
#include <logdepthbuf_pars_fragment>
#include <clipping_planes_pars_fragment>

uniform sampler2D alphaMap;
uniform float useAlphaMap;
uniform float visibility;
uniform float alphaTest;
uniform vec2 repeat;

varying vec4 vColor;
    
void main() {
    #include <clipping_planes_fragment>
    #include <logdepthbuf_fragment>

    vec4 c = vColor;
    
    #ifdef USE_MAP
    #ifdef USE_COLOR_AS_ALPHA
    vec4 tex = texture2D( map, vUv * repeat );
    c *= vec4(tex.rgb, tex.r);
    #else
    c *= texture2D( map, vUv * repeat );
    #endif
    #endif
    if( useAlphaMap == 1. ) c.a *= texture2D( alphaMap, vUv * repeat ).a;
    if( c.a < alphaTest ) discard;
    gl_FragColor = c;

    #include <fog_fragment>
    #include <tonemapping_fragment>
}`,wr=`
#include <common>
#include <uv_pars_vertex>
#include <color_pars_vertex>
#include <clipping_planes_pars_vertex>
#include <logdepthbuf_pars_vertex>
#include <fog_pars_vertex>

attribute vec3 previous;
attribute vec3 next;
attribute float side;
attribute float width;

uniform vec2 resolution;
uniform float lineWidth;
uniform float sizeAttenuation;
    
vec2 fix(vec4 i, float aspect) {
    vec2 res = i.xy / i.w;
    res.x *= aspect;
    return res;
}
    
void main() {

    `.concat(De,`
    
    float aspect = resolution.x / resolution.y;

    vColor = color;

    mat4 m = projectionMatrix * modelViewMatrix;
    vec4 finalPosition = m * vec4( position, 1.0 );
    vec4 prevPos = m * vec4( previous, 1.0 );
    vec4 nextPos = m * vec4( next, 1.0 );

    vec2 currentP = fix( finalPosition, aspect );
    vec2 prevP = fix( prevPos, aspect );
    vec2 nextP = fix( nextPos, aspect );

    float w = lineWidth * width;

    vec2 dir;
    if( nextP == currentP ) dir = normalize( currentP - prevP );
    else if( prevP == currentP ) dir = normalize( nextP - currentP );
    else {
        vec2 dir1 = normalize( currentP - prevP );
        vec2 dir2 = normalize( nextP - currentP );
        dir = normalize( dir1 + dir2 );

        vec2 perp = vec2( -dir1.y, dir1.x );
        vec2 miter = vec2( -dir.y, dir.x );
        //w = clamp( w / dot( miter, perp ), 0., 4., * lineWidth * width );

    }

    //vec2 normal = ( cross( vec3( dir, 0. ) vec3( 0., 0., 1. ) ) ).xy;
    vec4 normal = vec4( -dir.y, dir.x, 0., 1. );
    normal.xy *= .5 * w;
    normal *= projectionMatrix;
    if( sizeAttenuation == 0. ) {
        normal.xy *= finalPosition.w;
        normal.xy /= ( vec4( resolution, 0., 1. ) * projectionMatrix ).xy;
    }

    finalPosition.xy += normal.xy * side;

    gl_Position = finalPosition;

	#include <logdepthbuf_vertex>
	#include <clipping_planes_vertex>
	
    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );
    
	#include <fog_vertex>
}`);new b(0,0,1);var Or=function(i){Me(e,i);var t=ke(e);function e(n){var r;return N(this,e),r=t.call(this,n),s(U(r),"positionBuffer",void 0),s(U(r),"previousBuffer",void 0),s(U(r),"nextBuffer",void 0),s(U(r),"uvBuffer",void 0),s(U(r),"sideBuffer",void 0),s(U(r),"widthBuffer",void 0),s(U(r),"colorBuffer",void 0),s(U(r),"indexBuffer",void 0),s(U(r),"vector_",new b),s(U(r),"vector2_",new b),s(U(r),"vector3_",new b),s(U(r),"quaternion_",new j),r.maxParticles=1e4,r.setupBuffers(),r.rebuildMaterial(),r}return _(e,[{key:"setupBuffers",value:function(){this.geometry&&this.geometry.dispose(),this.geometry=new Ln,this.indexBuffer=new pe(new Uint32Array(this.maxParticles*6),1),this.indexBuffer.setUsage(ie),this.geometry.setIndex(this.indexBuffer),this.positionBuffer=new pe(new Float32Array(this.maxParticles*6),3),this.positionBuffer.setUsage(ie),this.geometry.setAttribute("position",this.positionBuffer),this.previousBuffer=new pe(new Float32Array(this.maxParticles*6),3),this.previousBuffer.setUsage(ie),this.geometry.setAttribute("previous",this.previousBuffer),this.nextBuffer=new pe(new Float32Array(this.maxParticles*6),3),this.nextBuffer.setUsage(ie),this.geometry.setAttribute("next",this.nextBuffer),this.widthBuffer=new pe(new Float32Array(this.maxParticles*2),1),this.widthBuffer.setUsage(ie),this.geometry.setAttribute("width",this.widthBuffer),this.sideBuffer=new pe(new Float32Array(this.maxParticles*2),1),this.sideBuffer.setUsage(ie),this.geometry.setAttribute("side",this.sideBuffer),this.uvBuffer=new pe(new Float32Array(this.maxParticles*4),2),this.uvBuffer.setUsage(ie),this.geometry.setAttribute("uv",this.uvBuffer),this.colorBuffer=new pe(new Float32Array(this.maxParticles*8),4),this.colorBuffer.setUsage(ie),this.geometry.setAttribute("color",this.colorBuffer)}},{key:"expandBuffers",value:function(r){for(;r>=this.maxParticles;)this.maxParticles*=2;this.setupBuffers()}},{key:"rebuildMaterial",value:function(){this.layers.mask=this.settings.layers.mask;var r={lineWidth:{value:1},map:{value:null},useMap:{value:0},alphaMap:{value:null},useAlphaMap:{value:0},resolution:{value:new Le(1,1)},sizeAttenuation:{value:1},visibility:{value:1},alphaTest:{value:0},repeat:{value:new Le(1,1)}},a={};if(a.USE_UV="",a.USE_COLOR_ALPHA="",this.settings.material.map&&(a.USE_MAP="",a.MAP_UV=Gt(this.settings.material.map.channel),r.map=new me(this.settings.material.map),r.mapTransform=new me(new we().copy(this.settings.material.map.matrix))),this.settings.material.defines&&this.settings.material.defines.USE_COLOR_AS_ALPHA!==void 0&&(a.USE_COLOR_AS_ALPHA=""),this.settings.renderMode===S.Trail)this.material=new zt({uniforms:r,defines:a,vertexShader:wr,fragmentShader:xr,transparent:this.settings.material.transparent,depthWrite:!this.settings.material.transparent,side:this.settings.material.side,blending:this.settings.material.blending||nt});else throw new Error("render mode unavailable")}},{key:"update",value:function(){var r=this,a=0,o=0,l=0;this.systems.forEach(function(c){for(var d=0;d<c.particleNum;d++)l+=c.particles[d].previous.length*2}),l>this.maxParticles&&this.expandBuffers(l),this.systems.forEach(function(c){var d=r.quaternion_,y=r.vector2_,w=r.vector3_;c.emitter.matrixWorld.decompose(y,d,w);for(var m=c.particles,M=c.particleNum,g=r.settings.uTileCount,B=r.settings.vTileCount,T=1/g,R=1/B,J=0;J<M;J++){var P=m[J],C=P.uvTile%B,G=Math.floor(P.uvTile/B+.001),A=P.previous.values(),V=A.next(),E=V.value,x=E;V.done||(V=A.next());var D=void 0;V.value!==void 0?D=V.value:D=x;for(var q=0;q<P.previous.length;q++,a+=2){if(r.positionBuffer.setXYZ(a,x.position.x,x.position.y,x.position.z),r.positionBuffer.setXYZ(a+1,x.position.x,x.position.y,x.position.z),c.worldSpace?(r.positionBuffer.setXYZ(a,x.position.x,x.position.y,x.position.z),r.positionBuffer.setXYZ(a+1,x.position.x,x.position.y,x.position.z)):(P.parentMatrix?r.vector_.copy(x.position).applyMatrix4(P.parentMatrix):r.vector_.copy(x.position).applyMatrix4(c.emitter.matrixWorld),r.positionBuffer.setXYZ(a,r.vector_.x,r.vector_.y,r.vector_.z),r.positionBuffer.setXYZ(a+1,r.vector_.x,r.vector_.y,r.vector_.z)),c.worldSpace?(r.previousBuffer.setXYZ(a,E.position.x,E.position.y,E.position.z),r.previousBuffer.setXYZ(a+1,E.position.x,E.position.y,E.position.z)):(P.parentMatrix?r.vector_.copy(E.position).applyMatrix4(P.parentMatrix):r.vector_.copy(E.position).applyMatrix4(c.emitter.matrixWorld),r.previousBuffer.setXYZ(a,r.vector_.x,r.vector_.y,r.vector_.z),r.previousBuffer.setXYZ(a+1,r.vector_.x,r.vector_.y,r.vector_.z)),c.worldSpace?(r.nextBuffer.setXYZ(a,D.position.x,D.position.y,D.position.z),r.nextBuffer.setXYZ(a+1,D.position.x,D.position.y,D.position.z)):(P.parentMatrix?r.vector_.copy(D.position).applyMatrix4(P.parentMatrix):r.vector_.copy(D.position).applyMatrix4(c.emitter.matrixWorld),r.nextBuffer.setXYZ(a,r.vector_.x,r.vector_.y,r.vector_.z),r.nextBuffer.setXYZ(a+1,r.vector_.x,r.vector_.y,r.vector_.z)),r.sideBuffer.setX(a,-1),r.sideBuffer.setX(a+1,1),c.worldSpace)r.widthBuffer.setX(a,x.size),r.widthBuffer.setX(a+1,x.size);else if(P.parentMatrix)r.widthBuffer.setX(a,x.size),r.widthBuffer.setX(a+1,x.size);else{var Q=(Math.abs(w.x)+Math.abs(w.y)+Math.abs(w.z))/3;r.widthBuffer.setX(a,x.size*Q),r.widthBuffer.setX(a+1,x.size*Q)}r.uvBuffer.setXY(a,(q/P.previous.length+C)*T,(B-G-1)*R),r.uvBuffer.setXY(a+1,(q/P.previous.length+C)*T,(B-G)*R),r.colorBuffer.setXYZW(a,x.color.x,x.color.y,x.color.z,x.color.w),r.colorBuffer.setXYZW(a+1,x.color.x,x.color.y,x.color.z,x.color.w),q+1<P.previous.length&&(r.indexBuffer.setX(o*3,a),r.indexBuffer.setX(o*3+1,a+1),r.indexBuffer.setX(o*3+2,a+2),o++,r.indexBuffer.setX(o*3,a+2),r.indexBuffer.setX(o*3+1,a+1),r.indexBuffer.setX(o*3+2,a+3),o++),E=x,x=D,V.done||(V=A.next(),V.value!==void 0&&(D=V.value))}}}),this.positionBuffer.updateRange.count=a*3,this.positionBuffer.needsUpdate=!0,this.previousBuffer.updateRange.count=a*3,this.previousBuffer.needsUpdate=!0,this.nextBuffer.updateRange.count=a*3,this.nextBuffer.needsUpdate=!0,this.sideBuffer.updateRange.count=a,this.sideBuffer.needsUpdate=!0,this.widthBuffer.updateRange.count=a,this.widthBuffer.needsUpdate=!0,this.uvBuffer.updateRange.count=a*2,this.uvBuffer.needsUpdate=!0,this.colorBuffer.updateRange.count=a*4,this.colorBuffer.needsUpdate=!0,this.indexBuffer.updateRange.count=o*3,this.indexBuffer.needsUpdate=!0,this.geometry.setDrawRange(0,o*3)}},{key:"dispose",value:function(){this.geometry.dispose()}}]),e}(Yn),br=function(i){Me(e,i);var t=ke(e);function e(){var n;return N(this,e),n=t.call(this),s(U(n),"batches",[]),s(U(n),"systemToBatchIndex",new Map),s(U(n),"type","BatchedRenderer"),n}return _(e,[{key:"addSystem",value:function(r){r._renderer=this;for(var a=r.getRendererSettings(),o=0;o<this.batches.length;o++)if(e.equals(this.batches[o].settings,a)){this.batches[o].addSystem(r),this.systemToBatchIndex.set(r,o);return}var l;switch(a.renderMode){case S.Trail:l=new Or(a);break;case S.Mesh:case S.BillBoard:case S.VerticalBillBoard:case S.HorizontalBillBoard:case S.StretchedBillBoard:l=new Sr(a);break}l.addSystem(r),this.batches.push(l),this.systemToBatchIndex.set(r,this.batches.length-1),this.add(l)}},{key:"deleteSystem",value:function(r){var a=this.systemToBatchIndex.get(r);a!=null&&(this.batches[a].removeSystem(r),this.systemToBatchIndex.delete(r))}},{key:"updateSystem",value:function(r){this.deleteSystem(r),this.addSystem(r)}},{key:"update",value:function(r){this.systemToBatchIndex.forEach(function(o,l){l.update(r)});for(var a=0;a<this.batches.length;a++)this.batches[a].update()}}],[{key:"equals",value:function(r,a){return r.material.side===a.material.side&&r.material.blending===a.material.blending&&r.material.transparent===a.material.transparent&&r.material.type===a.material.type&&r.material.alphaTest===a.material.alphaTest&&r.material.map===a.material.map&&r.renderMode===a.renderMode&&r.uTileCount===a.uTileCount&&r.vTileCount===a.vTileCount&&r.instancingGeometry===a.instancingGeometry&&r.renderOrder===a.renderOrder&&r.layers.mask===a.layers.mask}}]),e}(Un),u=function(i){return i[i.Number=0]="Number",i[i.Vec2=1]="Vec2",i[i.Vec3=2]="Vec3",i[i.Vec4=3]="Vec4",i[i.Boolean=4]="Boolean",i[i.AnyType=5]="AnyType",i[i.NullableAnyType=6]="NullableAnyType",i[i.EventStream=7]="EventStream",i}({}),Nr=_(function i(t,e,n,r){N(this,i),s(this,"input",void 0),s(this,"inputIndex",void 0),s(this,"output",void 0),s(this,"outputIndex",void 0),this.input=t,this.inputIndex=e,this.input.outputs[e].push(this),this.output=n,this.outputIndex=r,this.output.inputs[r]=this}),_r=function(){function i(){N(this,i),s(this,"visited",new Set),i.Instance=this}return _(i,[{key:"buildExecutionOrder",value:function(e,n){e.nodesInOrder.length=0,this.visited.clear();for(var r=0;r<e.outputNodes.length;r++){var a=e.outputNodes[r];a.inputs[0]!==void 0&&this._traverse(a,e,n)}e.compiled=!0}},{key:"_traverse",value:function(e,n,r){this.visited.add(e.id);for(var a=0;a<e.inputs.length;a++)if(e.inputs[a]instanceof Nr){var o=e.inputs[a].input;this.visited.has(o.id)||this._traverse(o,n,r)}else e.inputs[a];n.nodesInOrder.push(e)}}]),i}();s(_r,"Instance",void 0);var k=function(){function i(t){N(this,i),s(this,"name",void 0),s(this,"nodeTypeSignatures",[]),this.name=t}return _(i,[{key:"addSignature",value:function(e,n,r){this.nodeTypeSignatures.push({inputTypes:e,outputTypes:n,func:r})}}]),i}(),rt=new k("add");rt.addSignature([u.Number,u.Number],[u.Number],function(i,t,e,n){n[0]=e[0]+e[1]});rt.addSignature([u.Vec2,u.Vec2],[u.Vec2],function(i,t,e,n){n[0].addVectors(e[0],e[1])});rt.addSignature([u.Vec3,u.Vec3],[u.Vec3],function(i,t,e,n){n[0].addVectors(e[0],e[1])});rt.addSignature([u.Vec4,u.Vec4],[u.Vec4],function(i,t,e,n){n[0].addVectors(e[0],e[1])});var at=new k("sub");at.addSignature([u.Number,u.Number],[u.Number],function(i,t,e,n){n[0]=e[0]-e[1]});at.addSignature([u.Vec2,u.Vec2],[u.Vec2],function(i,t,e,n){n[0].subVectors(e[0],e[1])});at.addSignature([u.Vec3,u.Vec3],[u.Vec3],function(i,t,e,n){n[0].subVectors(e[0],e[1])});at.addSignature([u.Vec4,u.Vec4],[u.Vec4],function(i,t,e,n){n[0].subVectors(e[0],e[1])});var ot=new k("mul");ot.addSignature([u.Number,u.Number],[u.Number],function(i,t,e,n){n[0]=e[0]*e[1]});ot.addSignature([u.Vec2,u.Number],[u.Vec2],function(i,t,e,n){n[0].copy(e[0]).multiplyScalar(e[1])});ot.addSignature([u.Vec3,u.Number],[u.Vec3],function(i,t,e,n){n[0].copy(e[0]).multiplyScalar(e[1])});ot.addSignature([u.Vec4,u.Number],[u.Vec4],function(i,t,e,n){n[0].copy(e[0]).multiplyScalar(e[1])});var st=new k("div");st.addSignature([u.Number,u.Number],[u.Number],function(i,t,e,n){n[0]=e[0]/e[1]});st.addSignature([u.Vec2,u.Number],[u.Vec2],function(i,t,e,n){n[0].copy(e[0]).divideScalar(e[1])});st.addSignature([u.Vec3,u.Number],[u.Vec3],function(i,t,e,n){n[0].copy(e[0]).divideScalar(e[1])});st.addSignature([u.Vec4,u.Number],[u.Vec4],function(i,t,e,n){n[0].copy(e[0]).divideScalar(e[1])});var Mr=new k("sin");Mr.addSignature([u.Number],[u.Number],function(i,t,e,n){n[0]=Math.sin(e[0])});var kr=new k("cos");kr.addSignature([u.Number],[u.Number],function(i,t,e,n){n[0]=Math.cos(e[0])});var Br=new k("tan");Br.addSignature([u.Number],[u.Number],function(i,t,e,n){n[0]=Math.tan(e[0])});var Tr=new k("abs");Tr.addSignature([u.Number],[u.Number],function(i,t,e,n){n[0]=Math.abs(e[0])});var Pr=new k("min");Pr.addSignature([u.Number,u.Number],[u.Number],function(i,t,e,n){n[0]=Math.min(e[0],e[1])});var Vr=new k("max");Vr.addSignature([u.Number,u.Number],[u.Number],function(i,t,e,n){n[0]=Math.max(e[0],e[1])});var Wt=new k("dot");Wt.addSignature([u.Vec2,u.Vec2],[u.Number],function(i,t,e,n){n[0]=e[0].dot(e[1])});Wt.addSignature([u.Vec3,u.Vec3],[u.Number],function(i,t,e,n){n[0]=e[0].dot(e[1])});Wt.addSignature([u.Vec4,u.Vec4],[u.Number],function(i,t,e,n){n[0]=e[0].dot(e[1])});var zr=new k("cross");zr.addSignature([u.Vec3,u.Vec3],[u.Vec3],function(i,t,e,n){n[0].crossVectors(e[0],e[1])});var Zt=new k("length");Zt.addSignature([u.Vec2],[u.Number],function(i,t,e,n){n[0]=e[0].length()});Zt.addSignature([u.Vec3],[u.Number],function(i,t,e,n){n[0]=e[0].length()});Zt.addSignature([u.Vec4],[u.Number],function(i,t,e,n){n[0]=e[0].length()});var Qt=new k("lengthSq");Qt.addSignature([u.Vec2],[u.Number],function(i,t,e,n){n[0]=e[0].lengthSq()});Qt.addSignature([u.Vec3],[u.Number],function(i,t,e,n){n[0]=e[0].lengthSq()});Qt.addSignature([u.Vec4],[u.Number],function(i,t,e,n){n[0]=e[0].lengthSq()});var Kt=new k("normalize");Kt.addSignature([u.Vec2],[u.Vec2],function(i,t,e,n){n[0].copy(e[0]).normalize()});Kt.addSignature([u.Vec3],[u.Vec3],function(i,t,e,n){n[0].copy(e[0]).normalize()});Kt.addSignature([u.Vec4],[u.Vec4],function(i,t,e,n){n[0].copy(e[0]).normalize()});var Wn=new k("distance");Wn.addSignature([u.Vec2,u.Vec2],[u.Number],function(i,t,e,n){n[0]=e[0].distanceTo(e[1])});Wn.addSignature([u.Vec3,u.Vec3],[u.Number],function(i,t,e,n){n[0]=e[0].distanceTo(e[1])});var Er=new k("and");Er.addSignature([u.Boolean,u.Boolean],[u.Boolean],function(i,t,e,n){n[0]=e[0]&&e[1]});var Ar=new k("or");Ar.addSignature([u.Boolean,u.Boolean],[u.Boolean],function(i,t,e,n){n[0]=e[0]||e[1]});var Cr=new k("not");Cr.addSignature([u.Boolean],[u.Boolean],function(i,t,e,n){n[0]=!e[0]});var ut=new k("equal");ut.addSignature([u.Number,u.Number],[u.Boolean],function(i,t,e,n){n[0]=e[0]===e[1]});ut.addSignature([u.Vec2,u.Vec2],[u.Boolean],function(i,t,e,n){n[0]=e[0].equals(e[1])});ut.addSignature([u.Vec3,u.Vec3],[u.Boolean],function(i,t,e,n){n[0]=e[0].equals(e[1])});ut.addSignature([u.Vec4,u.Vec4],[u.Boolean],function(i,t,e,n){n[0]=e[0].equals(e[1])});var Jr=new k("lessThan");Jr.addSignature([u.Number,u.Number],[u.Boolean],function(i,t,e,n){n[0]=e[0]<e[1]});var Ur=new k("greaterThan");Ur.addSignature([u.Number,u.Number],[u.Boolean],function(i,t,e,n){n[0]=e[0]>e[1]});var Lr=new k("lessThanOrEqual");Lr.addSignature([u.Number,u.Number],[u.Boolean],function(i,t,e,n){n[0]=e[0]<=e[1]});var Rr=new k("greaterThanOrEqual");Rr.addSignature([u.Number,u.Number],[u.Boolean],function(i,t,e,n){n[0]=e[0]>=e[1]});var Ir=new k("if");Ir.addSignature([u.Boolean,u.AnyType,u.AnyType],[u.AnyType],function(i,t,e,n){n[0]=e[0]?e[1]:e[2]});var Fr=new k("number");Fr.addSignature([],[u.Number],function(i,t,e,n){n[0]=t.value});var Dr=new k("vec2");Dr.addSignature([u.Number,u.Number],[u.Vec2],function(i,t,e,n){n[0].x=e[0],n[0].y=e[1]});var Gr=new k("vec3");Gr.addSignature([u.Number,u.Number,u.Number],[u.Vec3],function(i,t,e,n){n[0].x=e[0],n[0].y=e[1],n[0].z=e[2]});var qr=new k("vec4");qr.addSignature([u.Number,u.Number,u.Number,u.Number],[u.Vec4],function(i,t,e,n){n[0].x=e[0],n[0].y=e[1],n[0].z=e[2],n[0].w=e[3]});var Xr=new k("splitVec2");Xr.addSignature([u.Vec2],[u.Number,u.Number],function(i,t,e,n){n[0]=e[0].x,n[1]=e[0].y});var $r=new k("splitVec3");$r.addSignature([u.Vec3],[u.Number,u.Number,u.Number],function(i,t,e,n){n[0]=e[0].x,n[1]=e[0].y,n[2]=e[0].z});var Hr=new k("splitVec4");Hr.addSignature([u.Vec4],[u.Number,u.Number,u.Number,u.Number],function(i,t,e,n){n[0]=e[0].x,n[1]=e[0].y,n[2]=e[0].z,n[3]=e[0].w});var Yr=new k("bool");Yr.addSignature([],[u.Boolean],function(i,t,e,n){n[0]=t.value});var Wr=new k("particleProperty");Wr.addSignature([u.NullableAnyType],[u.NullableAnyType],function(i,t,e,n){e[0]!==void 0&&(be(e[0])==="object"?i.particle[t.property].copy(e[0]):i.particle[t.property]=e[0]),i.particle[t.property]!==void 0&&(be(n[0])==="object"?n[0].copy(i.particle[t.property]):n[0]=i.particle[t.property])});var Zr=new k("emit");Zr.addSignature([u.EventStream],[],function(i,t,e,n){for(var r=e[0],a=0;a<r.length;a++)i.signal(a,r[a])});var Qr=new k("graphProperty");Qr.addSignature([u.NullableAnyType],[u.NullableAnyType],function(i,t,e,n){e[0]!==void 0&&(be(e[0])==="object"?i.graph[t.property].copy(e[0]):i.graph[t.property]=e[0]),i.graph[t.property]!==void 0&&(be(n[0])==="object"?n[0].copy(i.graph[t.property]):n[0]=i.graph[t.property])});var Kr=new k("startEvent");Kr.addSignature([],[u.EventStream],function(i,t,e,n){n[0]=[{type:"start"}]});var jr=new k("repeater");jr.addSignature([u.EventStream,u.Number],[u.EventStream],function(i,t,e,n){for(var r=e[0],a=e[1],o=[],l=0;l<r.length;l++)for(var c=0;c<a;c++)o.push(r[l]);n[0]=o});var ea=new k("time");ea.addSignature([],[u.Number],function(i,t,e,n){n[0]=i.emissionState.time});var ta=new k("delta");ta.addSignature([],[u.Number],function(i,t,e,n){n[0]=i.delta});var Ge=new k("output");Ge.addSignature([u.Number],[u.Number],function(i,t,e,n){n[0]=e[0]});Ge.addSignature([u.Vec2],[u.Vec2],function(i,t,e,n){n[0]=e[0]});Ge.addSignature([u.Vec3],[u.Vec3],function(i,t,e,n){n[0]=e[0]});Ge.addSignature([u.Vec4],[u.Vec4],function(i,t,e,n){n[0]=e[0]});Ge.addSignature([u.Boolean],[u.Boolean],function(i,t,e,n){n[0]=e[0]});var lt=new k("lerp");lt.addSignature([u.Number,u.Number,u.Number],[u.Number],function(i,t,e,n){n[0]=e[0]*(1-e[2])+e[1]*e[2]});lt.addSignature([u.Vec2,u.Vec2,u.Number],[u.Vec2],function(i,t,e,n){n[0].lerpVectors(e[0],e[1],e[2])});lt.addSignature([u.Vec3,u.Vec3,u.Number],[u.Vec3],function(i,t,e,n){n[0].lerpVectors(e[0],e[1],e[2])});lt.addSignature([u.Vec4,u.Vec4,u.Number],[u.Vec4],function(i,t,e,n){n[0].lerpVectors(e[0],e[1],e[2])});var na=function(t){return 1/Math.sqrt(2*Math.PI)*Math.exp(t*t*-.5)},ia=new k("normDistrib");ia.addSignature([u.Number],[u.Number],function(i,t,e,n){n[0]=na(e[0])});var ra=new k("normcdf");ra.addSignature([u.Number],[u.Number],function(i,t,e,n){var r=e[0],a=.254829592,o=-.284496736,l=1.421413741,c=-1.453152027,d=1.061405429,y=.3275911,w=1;r<0&&(w=-1),r=Math.abs(r)/Math.sqrt(2);var m=1/(1+y*r),M=1-((((d*m+c)*m+l)*m+o)*m+a)*m*Math.exp(-r*r);n[0]=.5*(1+w*M)});var aa=new k("normcdfInv"),Jn=function(t){var e=[2.515517,.802853,.010328],n=[1.432788,.189269,.001308];return t-((e[2]*t+e[1])*t+e[0])/(((n[2]*t+n[1])*t+n[0])*t+1)},de=function(t){return t<.5?-Jn(Math.sqrt(-2*Math.log(t))):Jn(Math.sqrt(-2*Math.log(1-t)))};aa.addSignature([u.Number],[u.Number],function(i,t,e,n){n[0]=de(e[0])});var oa=new k("clamp");oa.addSignature([u.Number,u.Number,u.Number],[u.Number],function(i,t,e,n){n[0]=Math.max(Math.min(e[0],e[2]),e[1])});var sa=new k("smoothstep");sa.addSignature([u.Number,u.Number,u.Number],[u.Number],function(i,t,e,n){var r=Math.max(Math.min(e[0],e[2]),e[1]);n[0]=r*r*(3-2*r)});var ct=new k("random");ct.addSignature([u.Number,u.Number],[u.Number],function(i,t,e,n){n[0]=Math.random()*(e[1]-e[0])+e[0]});ct.addSignature([u.Vec2,u.Vec2],[u.Vec2],function(i,t,e,n){var r=Math.random();n[0].lerpVectors(e[0],e[1],r)});ct.addSignature([u.Vec3,u.Vec3],[u.Vec3],function(i,t,e,n){var r=Math.random();n[0].lerpVectors(e[0],e[1],r)});ct.addSignature([u.Vec4,u.Vec4],[u.Vec4],function(i,t,e,n){var r=Math.random();n[0].lerpVectors(e[0],e[1],r)});var jt=new k("vrand");jt.addSignature([],[u.Vec2],function(i,t,e,n){var r=de(Math.random()),a=de(Math.random()),o=Math.sqrt(r*r+a*a);n[0].set(r/o,a/o)});jt.addSignature([],[u.Vec3],function(i,t,e,n){var r=de(Math.random()),a=de(Math.random()),o=de(Math.random()),l=Math.sqrt(r*r+a*a+o*o);n[0].set(r/l,a/l,o/l)});jt.addSignature([],[u.Vec4],function(i,t,e,n){var r=de(Math.random()),a=de(Math.random()),o=de(Math.random()),l=de(Math.random()),c=Math.sqrt(r*r+a*a+o*o+l*l);n[0].set(r/c,a/c,o/c,l/c)});var ua=new k("bsdf");ua.addSignature([u.Vec3,u.Vec3,u.Vec3,u.Number],[],function(i,t,e,n){});new b(0,0,1);new b;new b;new Xt(1,1,1,1);console.log("%c Particle system powered by three.quarks. https://quarks.art/","font-size: 16px; font-weight: bold;");const la=i=>{const t=$t(Zn);if(t.renderers[i].value){const e=t.renderers[i].get(Ht);return e.instanceCount++,e}else{const e=new br,n=gi();We(n,xi,Si()),We(n,ki),We(n,Bi,"Particle Renderer");const r=hi(Rn);We(n,Ti,{parentEntity:r[i]}),In(n,e),e.parent={type:"Scene",remove:()=>{},removeFromParent:()=>{}};const a={renderer:e,rendererEntity:n,instanceCount:1};return t.renderers[i].set(a),a}},ca=i=>{const t=$t(Zn);if(t.renderers[i].value){const e=t.renderers[i].get(Ht);if(e.instanceCount<=1){Fn(e.rendererEntity,e.renderer);for(const n of e.renderer.batches)n.geometry.dispose(),n.dispose();wi(e.rendererEntity),t.renderers[i].set(tt)}else e.instanceCount--}},Zn=ci({name:"ParticleState",initial:()=>({renderers:{}})}),wa={type:"point"},Oa={type:"sphere",radius:1},ba={type:"cone",radius:1,arc:.2,thickness:4,angle:30},Na={type:"donut",radius:1,arc:30,thickness:.5,angle:15},_a={type:"mesh_surface",mesh:"",geometry:new Ln},Ma={ConstantValue:{type:"ConstantValue",value:1},IntervalValue:{type:"IntervalValue",a:0,b:1},PiecewiseBezier:{type:"PiecewiseBezier",functions:[{function:{p0:0,p1:0,p2:1,p3:1},start:0}]}},ka={ConstantColor:{type:"ConstantColor",color:{r:1,g:1,b:1,a:1}},ColorRange:{type:"ColorRange",a:{r:1,g:1,b:1,a:1},b:{r:1,g:1,b:1,a:1}},RandomColor:{type:"RandomColor",a:{r:1,g:1,b:1,a:1},b:{r:1,g:1,b:1,a:1}},Gradient:{type:"Gradient",functions:[{function:{type:"ColorRange",a:{r:1,g:1,b:1,a:1},b:{r:1,g:1,b:1,a:1}},start:0}]}},Ba={AxisAngle:{type:"AxisAngle",axis:[0,1,0],angle:{type:"ConstantValue",value:0}},Euler:{type:"Euler",angleX:{type:"ConstantValue",value:0},angleY:{type:"ConstantValue",value:0},angleZ:{type:"ConstantValue",value:0}},RandomQuat:{type:"RandomQuat"}},Ta={ApplySequences:{type:"ApplySequences",delay:0,sequencers:[]},ApplyForce:{type:"ApplyForce",direction:[0,1,0],magnitude:{type:"ConstantValue",value:1}},Noise:{type:"Noise",frequency:[1,1,1],power:[1,1,1]},TurbulenceField:{type:"TurbulenceField",scale:[1,1,1],octaves:3,velocityMultiplier:[1,1,1],timeScale:[1,1,1]},GravityForce:{type:"GravityForce",center:[0,0,0],magnitude:1},ColorOverLife:{type:"ColorOverLife",color:{type:"ConstantColor",color:{r:1,g:1,b:1,a:1}}},RotationOverLife:{type:"RotationOverLife",angularVelocity:{type:"ConstantValue",value:.15},dynamic:!1},Rotation3DOverLife:{type:"Rotation3DOverLife",angularVelocity:{type:"RandomQuat"},dynamic:!1},SizeOverLife:{type:"SizeOverLife",size:{type:"ConstantValue",value:0}},SpeedOverLife:{type:"SpeedOverLife",speed:{type:"ConstantValue",value:1}},FrameOverLife:{type:"FrameOverLife",frame:{type:"ConstantValue",value:0}},ForceOverLife:{type:"ForceOverLife",x:{type:"ConstantValue",value:0},y:{type:"ConstantValue",value:1},z:{type:"ConstantValue",value:0}},OrbitOverLife:{type:"OrbitOverLife",orbitSpeed:{type:"ConstantValue",value:0},axis:[0,1,0]},WidthOverLength:{type:"WidthOverLength",width:{type:"ConstantValue",value:1}},ChangeEmitDirection:{type:"ChangeEmitDirection",angle:{type:"ConstantValue",value:1.4}},EmitSubParticleSystem:{type:"EmitSubParticleSystem",subParticleSystem:"",useVelocityAsBasis:!1}};F.shape({version:F.string,autoDestroy:F.boolean,looping:F.boolean,duration:F.number,shape:F.shape({type:F.string,radius:F.number.optional(),arc:F.number.optional(),thickness:F.number.optional(),angle:F.number.optional(),mesh:F.string.optional()}),startLife:F.object,startSpeed:F.object,startRotation:F.object,startSize:F.object,startColor:F.object,emissionOverTime:F.object,emissionOverDistance:F.object,onlyUsedByOther:F.boolean,rendererEmitterSettings:F.shape({startLength:F.object.optional(),followLocalOrigin:F.boolean.optional()}).optional(),renderMode:F.natural,speedFactor:F.number,texture:F.string,instancingGeometry:F.object.optional(),startTileIndex:F.natural,uTileCount:F.natural,vTileCount:F.natural,blending:F.natural,behaviors:F.arrayOf(F.any),worldSpace:F.boolean});const da=p.LiteralUnion([ai,oi,nt,si,ui,li],nt),ha=p.Object({version:p.String("1.0"),autoDestroy:p.Bool(!1),looping:p.Bool(!0),prewarm:p.Bool(!1),material:p.String(""),transparent:p.Optional(p.Bool()),duration:p.Number(5),shape:p.Object({type:p.String("point"),mesh:p.Optional(p.String()),geometry:p.Optional(p.String())}),startLife:p.Object({type:p.String("IntervalValue"),a:p.Number(1),b:p.Number(2)}),startSpeed:p.Object({type:p.String("IntervalValue"),a:p.Number(.1),b:p.Number(5)}),startRotation:p.Object({type:p.String("IntervalValue"),a:p.Number(0),b:p.Number(300)}),startSize:p.Object({type:p.String("IntervalValue"),a:p.Number(.025),b:p.Number(.45)}),startColor:p.Object({type:p.String("ConstantColor"),color:p.Object({r:p.Number(1),g:p.Number(1),b:p.Number(1),a:p.Number(.1)})}),emissionOverTime:p.Object({type:p.String("ConstantValue"),value:p.Number(400)}),emissionOverDistance:p.Object({type:p.String("ConstantValue"),value:p.Number(0)}),emissionBursts:p.Array(p.Object({time:p.Number(),count:p.Number(),cycle:p.Number(),interval:p.Number(),probability:p.Number()})),onlyUsedByOther:p.Bool(!1),rendererEmitterSettings:p.Object({startLength:p.Object({type:p.String("ConstantValue"),value:p.Number(1)}),followLocalOrigin:p.Bool(!0)}),renderMode:p.Enum(S,S.BillBoard),texture:p.String("/static/editor/dot.png"),instancingGeometry:p.String(""),startTileIndex:p.Object({type:p.String("ConstantValue"),value:p.Number(0)}),uTileCount:p.Number(1),vTileCount:p.Number(1),blending:da,behaviors:p.Array(p.Type()),worldSpace:p.Bool(!0)}),fa=fi({name:"ParticleSystemComponent",jsonID:"EE_particle_system",schema:p.Object({systemParameters:ha,behaviorParameters:p.Array(p.Type()),behaviors:p.Optional(p.Array(p.Type())),system:p.Type(),_loadIndex:p.Number(0),_refresh:p.Number(0)}),onSet:(i,t,e)=>{e!=null&&e.systemParameters&&t.systemParameters.set({...JSON.parse(JSON.stringify(t.systemParameters.value)),...e.systemParameters}),e!=null&&e.behaviorParameters&&t.behaviorParameters.set(JSON.parse(JSON.stringify(e.behaviorParameters))),(e!=null&&e.systemParameters||e!=null&&e.behaviorParameters)&&t._refresh.set((t._refresh.value+1)%1e3)},toJSON:i=>({systemParameters:JSON.parse(JSON.stringify(i.systemParameters)),behaviorParameters:JSON.parse(JSON.stringify(i.behaviorParameters))}),reactor:function(){var w;const i=mi(),t=vi(i,fa),e=wt({textures:{},geometries:{},materials:{}}),n=(w=pi(i,Pi))==null?void 0:w.value,r=wt($t(Rn))[n??""].value,a=Oi.useSceneLoaded(r),o=wt(!1),[l]=en(t.value.systemParameters.instancingGeometry,i,m=>{e.geometries.nested(m).set(tt)}),[c]=en(t.value.systemParameters.shape.mesh,i,m=>{e.geometries.nested(m).set(tt)}),[d]=bi(t.value.systemParameters.texture,i,m=>{e.textures.nested(m).set(tt),y.map=null}),[y]=Ni(Pt,i,{color:16777215,transparent:t.value.systemParameters.transparent??!0,blending:t.value.systemParameters.blending,side:Vt});return Se.useEffect(()=>{if(!a||o.value)return;const m=_i.cloneCurrentSnapshot(n);di(Mi.createSnapshot(m)),o.set(!0)},[a]),Se.useEffect(()=>{t.systemParameters.material.set("dud"),e.materials.nested("dud").set(y)},[]),Se.useEffect(()=>{if(!l||!l.scene)return;const m=l.scene,M=zi(m);if(M){const g=M.geometry.clone(),B=qt(M);g.scale(B.x,B.y,B.z),g&&e.geometries.nested(t.value.systemParameters.instancingGeometry).set(g)}},[l]),Se.useEffect(()=>{if(!c||!c.scene)return;const m=c.scene,M=Ei(m);if(M){const g=M.map(T=>{const R=T.geometry.clone(),J=qt(T);return R.scale(J.x,J.y,J.z),R}),B=Ai(g);B&&(t.systemParameters.shape.geometry.set(t.value.systemParameters.shape.mesh),e.geometries.nested(t.value.systemParameters.shape.mesh).set(B))}},[c]),Se.useEffect(()=>{d&&(e.textures.nested(t.value.systemParameters.texture).set(d),y.map=d,y.needsUpdate=!0)},[d]),Se.useEffect(()=>{if(!t._loadIndex.value)return;const m=t.get(Ht),g=la(n).renderer,B=JSON.parse(JSON.stringify(m.systemParameters)),T=fr.fromJSON(B,e.value,{});g.addSystem(T);const R=m.behaviorParameters.map(C=>{const G=Hn(C,T);return T.addBehavior(G),G});t.behaviors.set(R);const J=T.emitter;J.userData._refresh=m._refresh,In(i,J),J.parent=g;const P=yi(i,Vi);return J.matrix=P.matrix,t.system.set(T),()=>{const C=g.systemToBatchIndex.get(T);if(typeof C<"u"){g.deleteSystem(T),g.children.splice(C,1);const[G]=g.batches.splice(C,1);G.dispose(),g.systemToBatchIndex.clear();for(let A=0;A<g.batches.length;A++)for(const V of g.batches[A].systems)g.systemToBatchIndex.set(V,A)}Fn(i,J),T.dispose(),J.dispose(),ca(n)}},[t._loadIndex]),Se.useEffect(()=>{const m=t.value,M=m.systemParameters.shape.type==="mesh_surface"&&bt.getAssetClass(m.systemParameters.shape.mesh??"")===Ot.Model,g=m.systemParameters.instancingGeometry&&bt.getAssetClass(m.systemParameters.instancingGeometry)===Ot.Model,B=m.systemParameters.texture&&bt.getAssetClass(m.systemParameters.texture)===Ot.Image;(M&&c||!M)&&(g&&l||!g)&&(B&&d||!B)&&t._loadIndex.set(t._loadIndex.value+1)},[l,c,d,t._refresh]),null}});function qt(i){const t=i.scale.clone();return i.parent&&t.multiply(qt(i.parent)),t}export{Ta as B,ka as C,Na as D,_a as M,fa as P,Ba as R,Oa as S,Ma as V,S as a,wa as b,ba as c,Zn as d};
