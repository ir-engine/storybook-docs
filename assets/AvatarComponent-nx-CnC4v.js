var ka=Object.defineProperty;var Va=(r,e,t)=>e in r?ka(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var h=(r,e,t)=>Va(r,typeof e!="symbol"?e+"":e,t);import{u as Et,i as fe,aN as Ha,aO as Fa,a as W,am as Wa,d as $a,e as Gr,h as lr,b as ja,c as Ga,m as ur,N as hr,g as Xa}from"./WebRTCTransportFunctions-mB_FREj1.js";import{r as V,R as ue}from"./index-DPzuYzxM.js";import{c as Gt,_ as Ka,g as D,s as A,d as X,S as y,u as xt,a as ye,f as Xr,j as Kr,$ as qa,y as Ya,i as be,b as Xt,U as ie,n as ne,x as Pt,E as qr,h as ve,l as it,r as we,I as Kt,m as fr,k as Qa,P as Ja,q as ht,B as Yr,e as dr,Y as Za,z as en,V as Qr}from"./UUIDComponent-GqVY2Xw8.js";import{aD as tn,aE as rn,aF as ge,q as an,aG as nn,az as sn,au as Jr,a1 as mr,O as ft,T as Z,D as Nt,aH as qt,a as De,I as Te,N as Be,aI as on,aJ as Zr,aK as cn,aL as ln,p as un,B as dt,aM as pr,aN as hn,aO as vr,aP as fn,s as dn,aQ as gr,aR as mn,ae as pn,aS as vn,aT as gn,b as Le,X as yn,a3 as Yt,U as Lt,G as bn,aU as et,aV as yr,$ as Qt,R as En,x as xn,av as wn}from"./resourceLoaderHooks-CRL4d032.js";import{d as Ye,$ as st,h as br,i as Er,D as Tn,P as xr,a0 as Sn,a1 as ea,a2 as Rn,a3 as _e,m as Mn,g as Ln,R as Cn,a as te,z as An,a4 as wr,q as In,a5 as On,a6 as _n,M as Ct,a7 as At,a8 as Dn}from"./three.module-BizNiMhn.js";import{c as Pn}from"./client-CcmnHNO9.js";import"./ShadowComponent-DnhO6zHH.js";const ta=V.createContext(void 0),ra=()=>Et(V.useContext(ta));function mt(r,e,t,a=0){var n;a++,r=r.shadowRoot||r;for(let i=r.firstElementChild;i;i=i.nextElementSibling){if(i.assignedSlot)continue;const s=(n=i.assignedElements)==null?void 0:n.call(i,{flatten:!0});if(s)for(const l of s)e.call(t,l,a)&&mt(i,e,t,a);e.call(t,i,a)&&mt(i,e,t,a)}}class Qe{constructor(){h(this,"left",0);h(this,"top",0);h(this,"width",0);h(this,"height",0)}copy(e){return this.top=e.top,this.left=e.left,this.width=e.width,this.height=e.height,this}}class Se{constructor(){h(this,"left",0);h(this,"top",0);h(this,"right",0);h(this,"bottom",0)}copy(e){return this.top=e.top,this.left=e.left,this.right=e.right,this.bottom=e.bottom,this}}function Jt(r,e=new Qe,t){const a=r.ownerDocument,n=a.documentElement,i=a.body;if(r===n)return zn(a,e);if(t===r){e.left=0,e.top=0,e.width=r.offsetWidth,e.height=r.offsetHeight;return}const s=r.ownerDocument.defaultView;let l=r,c,o=l.offsetParent,u=s.getComputedStyle(l,null),f=l.offsetTop,d=l.offsetLeft;for(o&&t&&(o.contains(t)||o.contains(t.getRootNode().host))&&o!==t&&(Jt(t,e,o),d-=e.left,f-=e.top);(l=l.parentElement)&&l!==i&&l!==n&&l!==t&&u.position!=="fixed";)c=s.getComputedStyle(l,null),f-=l.scrollTop,d-=l.scrollLeft,l===o&&(f+=l.offsetTop,d+=l.offsetLeft,f+=parseFloat(c.borderTopWidth)||0,d+=parseFloat(c.borderLeftWidth)||0,o=l.offsetParent),u=c;return u.position==="fixed"&&(f+=Math.max(n.scrollTop,i.scrollTop),d+=Math.max(n.scrollLeft,i.scrollLeft)),e.left=d,e.top=f,e.width=r.offsetWidth,e.height=r.offsetHeight,e}function Nn(r,e){if(r.offsetParent===null){e.left=e.right=e.top=e.bottom=0;return}let t=getComputedStyle(r);e.left=parseFloat(t.marginLeft)||0,e.right=parseFloat(t.marginRight)||0,e.top=parseFloat(t.marginTop)||0,e.bottom=parseFloat(t.marginBottom)||0}function Un(r,e){let t=getComputedStyle(r);e.left=parseFloat(t.borderLeftWidth)||0,e.right=parseFloat(t.borderRightWidth)||0,e.top=parseFloat(t.borderTopWidth)||0,e.bottom=parseFloat(t.borderBottomWidth)||0}function Bn(r,e){let t=getComputedStyle(r);e.left=parseFloat(t.paddingLeft)||0,e.right=parseFloat(t.paddingRight)||0,e.top=parseFloat(t.paddingTop)||0,e.bottom=parseFloat(t.paddingBottom)||0}function zn(r,e){const t=r.documentElement,a=r.body,n=getComputedStyle(t),i=getComputedStyle(a);return e.top=a.offsetTop+parseFloat(n.marginTop)||0+parseFloat(i.marginTop)||0,e.left=a.offsetLeft+parseFloat(n.marginLeft)||0+parseFloat(i.marginLeft)||0,e.width=Math.max(Math.max(a.scrollWidth,t.scrollWidth),Math.max(a.offsetWidth,t.offsetWidth),Math.max(a.clientWidth,t.clientWidth)),e.height=Math.max(Math.max(a.scrollHeight,t.scrollHeight),Math.max(a.offsetHeight,t.offsetHeight),Math.max(a.clientHeight,t.clientHeight)),e}function kn(r){const e=document.createElement("div");e.innerHTML=r;const t=e.firstElementChild;return e.removeChild(t),t}const aa=function(r,e){const t=document.createElement("a");t.download=e,t.href=window.URL.createObjectURL(r),t.dataset.downloadurl=["application/octet-stream",t.download,t.href].join(":"),t.click()},Vn=new Ye,Hn=new Ye;function Fn(r,e,t,a,n=new Ye){const i=r.transform,s=r.transformOrigin;if(i.indexOf("matrix(")==0){n.identity();const m=i.substring(7,i.length-1).split(", ").map(parseFloat);n.elements[0]=m[0],n.elements[1]=m[1],n.elements[4]=m[2],n.elements[5]=m[3],n.elements[12]=m[4],n.elements[13]=m[5]}else if(i.indexOf("matrix3d(")==0){const m=i.substring(9,i.length-1).split(", ").map(parseFloat);n.fromArray(m)}else return null;n.elements[0]===0&&(n.elements[0]=1e-15),n.elements[5]===0&&(n.elements[5]=1e-15),n.elements[10]===0&&(n.elements[10]=1e-15),n.elements[12]*=a,n.elements[13]*=a*-1;const l=s.split(" ").map(parseFloat),c=(l[0]-e/2)*a,o=(l[1]-t/2)*a*-1,u=l[2]||0,f=Vn.identity().makeTranslation(-c,-o,-u),d=Hn.identity().makeTranslation(c,o,u);for(const m of n.elements)if(isNaN(m))return null;return n.premultiply(d).multiply(f)}var Re=[],Wn=function(){return Re.some(function(r){return r.activeTargets.length>0})},$n=function(){return Re.some(function(r){return r.skippedTargets.length>0})},Tr="ResizeObserver loop completed with undelivered notifications.",jn=function(){var r;typeof ErrorEvent=="function"?r=new ErrorEvent("error",{message:Tr}):(r=document.createEvent("Event"),r.initEvent("error",!1,!1),r.message=Tr),window.dispatchEvent(r)},Xe;(function(r){r.BORDER_BOX="border-box",r.CONTENT_BOX="content-box",r.DEVICE_PIXEL_CONTENT_BOX="device-pixel-content-box"})(Xe||(Xe={}));var Me=function(r){return Object.freeze(r)},Gn=function(){function r(e,t){this.inlineSize=e,this.blockSize=t,Me(this)}return r}(),na=function(){function r(e,t,a,n){return this.x=e,this.y=t,this.width=a,this.height=n,this.top=this.y,this.left=this.x,this.bottom=this.top+this.height,this.right=this.left+this.width,Me(this)}return r.prototype.toJSON=function(){var e=this,t=e.x,a=e.y,n=e.top,i=e.right,s=e.bottom,l=e.left,c=e.width,o=e.height;return{x:t,y:a,top:n,right:i,bottom:s,left:l,width:c,height:o}},r.fromRect=function(e){return new r(e.x,e.y,e.width,e.height)},r}(),Zt=function(r){return r instanceof SVGElement&&"getBBox"in r},ia=function(r){if(Zt(r)){var e=r.getBBox(),t=e.width,a=e.height;return!t&&!a}var n=r,i=n.offsetWidth,s=n.offsetHeight;return!(i||s||r.getClientRects().length)},Sr=function(r){var e;if(r instanceof Element)return!0;var t=(e=r==null?void 0:r.ownerDocument)===null||e===void 0?void 0:e.defaultView;return!!(t&&r instanceof t.Element)},Xn=function(r){switch(r.tagName){case"INPUT":if(r.type!=="image")break;case"VIDEO":case"AUDIO":case"EMBED":case"OBJECT":case"CANVAS":case"IFRAME":case"IMG":return!0}return!1},je=typeof window<"u"?window:{},tt=new WeakMap,Rr=/auto|scroll/,Kn=/^tb|vertical/,qn=/msie|trident/i.test(je.navigator&&je.navigator.userAgent),ce=function(r){return parseFloat(r||"0")},Pe=function(r,e,t){return r===void 0&&(r=0),e===void 0&&(e=0),t===void 0&&(t=!1),new Gn((t?e:r)||0,(t?r:e)||0)},Mr=Me({devicePixelContentBoxSize:Pe(),borderBoxSize:Pe(),contentBoxSize:Pe(),contentRect:new na(0,0,0,0)}),sa=function(r,e){if(e===void 0&&(e=!1),tt.has(r)&&!e)return tt.get(r);if(ia(r))return tt.set(r,Mr),Mr;var t=getComputedStyle(r),a=Zt(r)&&r.ownerSVGElement&&r.getBBox(),n=!qn&&t.boxSizing==="border-box",i=Kn.test(t.writingMode||""),s=!a&&Rr.test(t.overflowY||""),l=!a&&Rr.test(t.overflowX||""),c=a?0:ce(t.paddingTop),o=a?0:ce(t.paddingRight),u=a?0:ce(t.paddingBottom),f=a?0:ce(t.paddingLeft),d=a?0:ce(t.borderTopWidth),m=a?0:ce(t.borderRightWidth),b=a?0:ce(t.borderBottomWidth),p=a?0:ce(t.borderLeftWidth),x=f+o,w=c+u,S=p+m,C=d+b,R=l?r.offsetHeight-C-r.clientHeight:0,M=s?r.offsetWidth-S-r.clientWidth:0,T=n?x+S:0,L=n?w+C:0,v=a?a.width:ce(t.width)-T-M,z=a?a.height:ce(t.height)-L-R,P=v+x+M+S,re=z+w+R+C,O=Me({devicePixelContentBoxSize:Pe(Math.round(v*devicePixelRatio),Math.round(z*devicePixelRatio),i),borderBoxSize:Pe(P,re,i),contentBoxSize:Pe(v,z,i),contentRect:new na(f,c,v,z)});return tt.set(r,O),O},oa=function(r,e,t){var a=sa(r,t),n=a.borderBoxSize,i=a.contentBoxSize,s=a.devicePixelContentBoxSize;switch(e){case Xe.DEVICE_PIXEL_CONTENT_BOX:return s;case Xe.BORDER_BOX:return n;default:return i}},Yn=function(){function r(e){var t=sa(e);this.target=e,this.contentRect=t.contentRect,this.borderBoxSize=Me([t.borderBoxSize]),this.contentBoxSize=Me([t.contentBoxSize]),this.devicePixelContentBoxSize=Me([t.devicePixelContentBoxSize])}return r}(),ca=function(r){if(ia(r))return 1/0;for(var e=0,t=r.parentNode;t;)e+=1,t=t.parentNode;return e},Qn=function(){var r=1/0,e=[];Re.forEach(function(s){if(s.activeTargets.length!==0){var l=[];s.activeTargets.forEach(function(o){var u=new Yn(o.target),f=ca(o.target);l.push(u),o.lastReportedSize=oa(o.target,o.observedBox),f<r&&(r=f)}),e.push(function(){s.callback.call(s.observer,l,s.observer)}),s.activeTargets.splice(0,s.activeTargets.length)}});for(var t=0,a=e;t<a.length;t++){var n=a[t];n()}return r},Lr=function(r){Re.forEach(function(t){t.activeTargets.splice(0,t.activeTargets.length),t.skippedTargets.splice(0,t.skippedTargets.length),t.observationTargets.forEach(function(n){n.isActive()&&(ca(n.target)>r?t.activeTargets.push(n):t.skippedTargets.push(n))})})},Jn=function(){var r=0;for(Lr(r);Wn();)r=Qn(),Lr(r);return $n()&&jn(),r>0},It,la=[],Zn=function(){return la.splice(0).forEach(function(r){return r()})},ei=function(r){if(!It){var e=0,t=document.createTextNode(""),a={characterData:!0};new MutationObserver(function(){return Zn()}).observe(t,a),It=function(){t.textContent="".concat(e?e--:e++)}}la.push(r),It()},ti=function(r){ei(function(){requestAnimationFrame(r)})},ot=0,ri=function(){return!!ot},ai=250,ni={attributes:!0,characterData:!0,childList:!0,subtree:!0},Cr=["resize","load","transitionend","animationend","animationstart","animationiteration","keyup","keydown","mouseup","mousedown","mouseover","mouseout","blur","focus"],Ar=function(r){return r===void 0&&(r=0),Date.now()+r},Ot=!1,ii=function(){function r(){var e=this;this.stopped=!0,this.listener=function(){return e.schedule()}}return r.prototype.run=function(e){var t=this;if(e===void 0&&(e=ai),!Ot){Ot=!0;var a=Ar(e);ti(function(){var n=!1;try{n=Jn()}finally{if(Ot=!1,e=a-Ar(),!ri())return;n?t.run(1e3):e>0?t.run(e):t.start()}})}},r.prototype.schedule=function(){this.stop(),this.run()},r.prototype.observe=function(){var e=this,t=function(){return e.observer&&e.observer.observe(document.body,ni)};document.body?t():je.addEventListener("DOMContentLoaded",t)},r.prototype.start=function(){var e=this;this.stopped&&(this.stopped=!1,this.observer=new MutationObserver(this.listener),this.observe(),Cr.forEach(function(t){return je.addEventListener(t,e.listener,!0)}))},r.prototype.stop=function(){var e=this;this.stopped||(this.observer&&this.observer.disconnect(),Cr.forEach(function(t){return je.removeEventListener(t,e.listener,!0)}),this.stopped=!0)},r}(),Ut=new ii,Ir=function(r){!ot&&r>0&&Ut.start(),ot+=r,!ot&&Ut.stop()},si=function(r){return!Zt(r)&&!Xn(r)&&getComputedStyle(r).display==="inline"},oi=function(){function r(e,t){this.target=e,this.observedBox=t||Xe.CONTENT_BOX,this.lastReportedSize={inlineSize:0,blockSize:0}}return r.prototype.isActive=function(){var e=oa(this.target,this.observedBox,!0);return si(this.target)&&(this.lastReportedSize=e),this.lastReportedSize.inlineSize!==e.inlineSize||this.lastReportedSize.blockSize!==e.blockSize},r}(),ci=function(){function r(e,t){this.activeTargets=[],this.skippedTargets=[],this.observationTargets=[],this.observer=e,this.callback=t}return r}(),rt=new WeakMap,Or=function(r,e){for(var t=0;t<r.length;t+=1)if(r[t].target===e)return t;return-1},at=function(){function r(){}return r.connect=function(e,t){var a=new ci(e,t);rt.set(e,a)},r.observe=function(e,t,a){var n=rt.get(e),i=n.observationTargets.length===0;Or(n.observationTargets,t)<0&&(i&&Re.push(n),n.observationTargets.push(new oi(t,a&&a.box)),Ir(1),Ut.schedule())},r.unobserve=function(e,t){var a=rt.get(e),n=Or(a.observationTargets,t),i=a.observationTargets.length===1;n>=0&&(i&&Re.splice(Re.indexOf(a),1),a.observationTargets.splice(n,1),Ir(-1))},r.disconnect=function(e){var t=this,a=rt.get(e);a.observationTargets.slice().forEach(function(n){return t.unobserve(e,n.target)}),a.activeTargets.splice(0,a.activeTargets.length)},r}(),li=function(){function r(e){if(arguments.length===0)throw new TypeError("Failed to construct 'ResizeObserver': 1 argument required, but only 0 present.");if(typeof e!="function")throw new TypeError("Failed to construct 'ResizeObserver': The callback provided as parameter 1 is not a function.");at.connect(this,e)}return r.prototype.observe=function(e,t){if(arguments.length===0)throw new TypeError("Failed to execute 'observe' on 'ResizeObserver': 1 argument required, but only 0 present.");if(!Sr(e))throw new TypeError("Failed to execute 'observe' on 'ResizeObserver': parameter 1 is not of type 'Element");at.observe(this,e,t)},r.prototype.unobserve=function(e){if(arguments.length===0)throw new TypeError("Failed to execute 'unobserve' on 'ResizeObserver': 1 argument required, but only 0 present.");if(!Sr(e))throw new TypeError("Failed to execute 'unobserve' on 'ResizeObserver': parameter 1 is not of type 'Element");at.unobserve(this,e)},r.prototype.disconnect=function(){at.disconnect(this)},r.toString=function(){return"function ResizeObserver () { [polyfill code] }"},r}();class er{constructor(e,t,a){h(this,"isMediaElement",!1);h(this,"isVideoElement",!1);h(this,"isCanvasElement",!1);h(this,"desiredPseudoState",{hover:!1,active:!1,focus:!1,target:!1});h(this,"needsRefresh",!0);h(this,"needsRemoval",!1);h(this,"parentLayer");h(this,"childLayers",[]);h(this,"allStateHashes",new Set);h(this,"previousDOMStateKey");h(this,"desiredDOMStateKey");h(this,"currentDOMStateKey");h(this,"lastSVGUrl");h(this,"domMetrics",{bounds:new Qe,padding:new Se,margin:new Se,border:new Se});if(this.manager=e,this.element=t,this.eventCallback=a,!e)throw new Error("WebLayerManager must be initialized");E.layers.set(t,this),t.setAttribute(E.LAYER_ATTRIBUTE,""),this.parentLayer=E.getClosestLayer(this.element,!1),this.isVideoElement=t.nodeName==="VIDEO",this.isMediaElement=this.isVideoElement||t.nodeName==="IMG"||t.nodeName==="CANVAS",this.eventCallback("layercreated",{target:t})}setNeedsRefresh(e=!1){if(this.needsRefresh=!0,e)for(const t of this.childLayers)t.setNeedsRefresh(e)}set pixelRatio(e){typeof e=="number"?this.element.setAttribute(E.PIXEL_RATIO_ATTRIBUTE,e.toString()):this.element.removeAttribute(E.PIXEL_RATIO_ATTRIBUTE)}get pixelRatio(){const e=this.element.getAttribute(E.PIXEL_RATIO_ATTRIBUTE);return e?parseFloat(e):null}get computedPixelRatio(){var e;return this.pixelRatio??((e=this.parentLayer)==null?void 0:e.computedPixelRatio)??1.5}get previousDOMState(){return this.previousDOMStateKey?this.manager.getLayerState(this.previousDOMStateKey):void 0}get desiredDOMState(){return this.desiredDOMStateKey?this.manager.getLayerState(this.desiredDOMStateKey):void 0}get currentDOMState(){return this.currentDOMStateKey?this.manager.getLayerState(this.currentDOMStateKey):void 0}get depth(){let e=0,t=this;for(;t.parentLayer;)t=t.parentLayer,e++;return e}get rootLayer(){let e=this;for(;e.parentLayer;)e=e.parentLayer;return e}traverseParentLayers(e){const t=this.parentLayer;t&&(t.traverseParentLayers(e),e(t))}traverseLayers(e){e(this),this.traverseChildLayers(e)}traverseChildLayers(e){for(const t of this.childLayers)t.traverseLayers(e)}update(){var a,n,i,s,l,c,o,u,f,d;if(this.desiredDOMStateKey!==this.currentDOMStateKey){const m=this.desiredDOMState;m&&(this.isMediaElement||(a=m.texture)!=null&&a.ktx2Url||(n=m.texture)!=null&&n.canvas||m.fullWidth*m.fullHeight===0)&&(this.currentDOMStateKey=this.desiredDOMStateKey)}const e=((s=(i=this.previousDOMState)==null?void 0:i.texture)==null?void 0:s.ktx2Url)??((c=(l=this.previousDOMState)==null?void 0:l.texture)==null?void 0:c.canvas),t=((u=(o=this.currentDOMState)==null?void 0:o.texture)==null?void 0:u.ktx2Url)??((d=(f=this.previousDOMState)==null?void 0:f.texture)==null?void 0:d.canvas);t&&e!==t&&this.eventCallback("layerpainted",{target:this.element}),this.previousDOMStateKey=this.currentDOMStateKey}async refresh(){this.needsRefresh=!1,this._updateParentAndChildLayers();const e=await this.manager.addToSerializeQueue(this);e.needsRasterize&&typeof e.stateKey=="string"&&e.svgUrl&&await this.manager.addToRasterizeQueue(e.stateKey,e.svgUrl)}_updateParentAndChildLayers(){const e=this.element,t=this.childLayers,a=t.slice(),n=this.parentLayer;this.parentLayer=E.getClosestLayer(this.element,!1),n!==this.parentLayer&&(this.parentLayer&&this.parentLayer.childLayers.push(this),this.eventCallback("layermoved",{target:e})),t.length=0,mt(e,this._tryConvertElementToWebLayer,this);for(const i of a)E.getClosestLayer(i.element,!1)||(i.needsRemoval=!0,t.push(i))}_tryConvertElementToWebLayer(e){if(this.needsRemoval)return!1;const t=e,a=getComputedStyle(t);if(t.hasAttribute(E.LAYER_ATTRIBUTE)||t.nodeName==="VIDEO"||a.transform!=="none"){let i=E.layers.get(t);return i||(i=new er(this.manager,t,this.eventCallback)),this.childLayers.push(i),!1}return!0}}const ui=self.ResizeObserver||li;function hi(r,e){if(document.contains(r))return r;const t=document.createElement("div");return t.id=r.id?"container-"+r.id:"",t.setAttribute(E.RENDERING_CONTAINER_ATTRIBUTE,""),t.style.visibility="hidden",t.style.pointerEvents="none",t.style.touchAction="none",t.attachShadow({mode:"open"}).appendChild(r),document.documentElement.appendChild(t),t}const g=class g{static get HOVER_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-hover"}static get ACTIVE_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-active"}static get FOCUS_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-focus"}static get TARGET_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-target"}static get LAYER_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-layer"}static get PIXEL_RATIO_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-pixel-ratio"}static get RENDERING_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering"}static get RENDERING_PARENT_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering-parent"}static get RENDERING_CONTAINER_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering-container"}static get RENDERING_INLINE_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering-inline"}static get RENDERING_DOCUMENT_ATTRIBUTE(){return this.ATTRIBUTE_PREFIX+"-rendering-document"}static getPsuedoAttributes(e){return`${e.hover?`${this.HOVER_ATTRIBUTE}="" `:" "}${e.focus?`${this.FOCUS_ATTRIBUTE}="" `:" "}${e.active?`${this.ACTIVE_ATTRIBUTE}="" `:" "}${e.target?`${this.TARGET_ATTRIBUTE}="" `:" "}`}static initRootNodeObservation(e){const t=e.ownerDocument,a=e.getRootNode(),n="head"in a?a.head:a;if(this.rootNodeObservers.get(a))return;if(!this.containerStyleElement){const f=this.containerStyleElement=t.createElement("style");t.head.appendChild(f),f.innerHTML=`
        [${g.RENDERING_CONTAINER_ATTRIBUTE}] {
          all: initial;
          position: fixed;
          width: 100%;
          height: 100%;
          top: 0px;
        }
      `}const i=`
    a {
      color: blue;
      text-decoration: underline;
    }

    :host > [${g.LAYER_ATTRIBUTE}] {
      display: flow-root;
    }

    [${g.RENDERING_DOCUMENT_ATTRIBUTE}] * {
      transform: none !important;
    }

    [${g.RENDERING_ATTRIBUTE}], [${g.RENDERING_ATTRIBUTE}] * {
      visibility: visible !important;
      /* the following is a hack for Safari; 
      without some kind of css filter active, 
      any box-shadow effect will fail to rasterize properly */
      filter: opacity(1);
    }
    
    [${g.RENDERING_ATTRIBUTE}] [${g.LAYER_ATTRIBUTE}], [${g.RENDERING_ATTRIBUTE}] [${g.LAYER_ATTRIBUTE}] * {
      visibility: hidden !important;
    }

    [${g.RENDERING_ATTRIBUTE}] {
      position: relative !important;
      top: 0 !important;
      left: 0 !important;
      float: left !important; /* prevent margin-collapse in SVG foreign-element for Webkit */
      box-sizing:border-box;
      min-width:var(--x-width);
      min-height:var(--x-height);
    }

    [${g.RENDERING_PARENT_ATTRIBUTE}] {
      transform: none !important;
      left: 0 !important;
      top: 0 !important;
      margin: 0 !important;
      border:0 !important;
      border-radius:0 !important;
      width: 100% !important;
      height:100% !important;
      padding:0 !important;
      visibility:hidden !important;
      filter:none !important;
    }
    
    [${g.RENDERING_PARENT_ATTRIBUTE}]::before, [${g.RENDERING_PARENT_ATTRIBUTE}]::after {
      content:none !important;
      box-shadow:none !important;
    }
    `,s=t.createElement("style");if(s.textContent=i,n.append(s),a===t){let f="";const d=()=>{if(f!=window.location.hash&&window.location.hash)try{this.targetElement=a.querySelector(window.location.hash)}catch{}f=window.location.hash};window.addEventListener("hashchange",d,!1),d(),window.addEventListener("focusin",m=>{this.focusElement=m.target},!1),window.addEventListener("focusout",m=>{this.focusElement=null},!1),window.addEventListener("load",m=>{l()})}const l=()=>{for(const[f,d]of this.layers)d.needsRefresh=!0},c=f=>{const d=f.nodeName.toUpperCase();o.indexOf(d)!==-1&&f.addEventListener("load",l)},o=["STYLE","LINK"],u=new MutationObserver(f=>{for(const d of f){o.indexOf(d.target.nodeName.toUpperCase())!==-1&&(l(),this.embeddedStyles.delete(d.target));for(const m of d.addedNodes)c(m)}});u.observe(t,{childList:!0,attributes:!0,characterData:!0,subtree:!0,attributeOldValue:!0,characterDataOldValue:!0}),this.rootNodeObservers.set(a,u)}static setLayerNeedsRefresh(e){e.needsRefresh=!0}static createLayerTree(e,t,a){if(g.getClosestLayer(e))throw new Error("A root WebLayer for the given element already exists");const n=hi(e);g.initRootNodeObservation(e);const i=new MutationObserver(g._handleMutations);this.mutationObservers.set(e,i),this.startMutationObserver(e);const s=new ui(c=>{for(const o of c){const u=this.getClosestLayer(o.target);u.traverseLayers(g.setLayerNeedsRefresh),u.traverseParentLayers(g.setLayerNeedsRefresh)}});s.observe(e),this.resizeObservers.set(e,s),e.addEventListener("input",this._triggerRefresh,{capture:!0}),e.addEventListener("keydown",this._triggerRefresh,{capture:!0}),e.addEventListener("submit",this._triggerRefresh,{capture:!0}),e.addEventListener("change",this._triggerRefresh,{capture:!0}),e.addEventListener("focus",this._triggerRefresh,{capture:!0}),e.addEventListener("blur",this._triggerRefresh,{capture:!0}),e.addEventListener("transitionend",this._triggerRefresh,{capture:!0});const l=new er(t.manager,e,a);return this.rootLayers.set(e,l),n}static disposeLayer(e){this.rootLayers.has(e.element)&&(this.rootLayers.delete(e.element),this.mutationObservers.get(e.element).disconnect(),this.mutationObservers.delete(e.element),this.resizeObservers.get(e.element).disconnect(),this.resizeObservers.delete(e.element),e.element.removeEventListener("input",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("keydown",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("submit",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("change",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("focus",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("blur",this._triggerRefresh,{capture:!0}),e.element.removeEventListener("transitionend",this._triggerRefresh,{capture:!0}))}static getClosestLayer(e,t=!0){const a=t?e:e.parentElement,n=a==null?void 0:a.closest(`[${g.LAYER_ATTRIBUTE}]`);if(!n){const i=(e==null?void 0:e.getRootNode()).host;if(i)return this.getClosestLayer(i,t)}return this.layers.get(n)}static pauseMutationObservers(){const e=g.mutationObservers.values();for(const t of e)g._handleMutations(t.takeRecords()),t.disconnect()}static resumeMutationObservers(){for(const[e]of g.mutationObservers)this.startMutationObserver(e)}static startMutationObserver(e){g.mutationObservers.get(e).observe(e,{attributes:!0,childList:!0,subtree:!0,characterData:!0,characterDataOldValue:!0,attributeOldValue:!0})}static arrayBufferToBase64(e){let t="";const a=e.byteLength;for(let n=0;n<a;n++)t+=String.fromCharCode(e[n]);return window.btoa(t)}static attributeCSS(e,t){return t?`[${e}]=${t}`:`[${e}]`}static attributeHTML(e,t){return t?`${e}="${t}"`:`${e}=""`}static updateInputAttributes(e){e.matches("input")&&this._updateInputAttribute(e);for(const t of e.getElementsByTagName("input"))this._updateInputAttribute(t)}static _updateInputAttribute(e){e.hasAttribute("checked")?e.checked||e.removeAttribute("checked"):e.checked&&e.setAttribute("checked",""),e.getAttribute("value")!==e.value&&e.setAttribute("value",e.value)}static isBlankImage(e){return!new Uint32Array(e.buffer).some(a=>a!==0)}};h(g,"ATTRIBUTE_PREFIX","xr"),h(g,"serializer",fe?new XMLSerializer:null),h(g,"textEncoder",fe?new TextEncoder:null),h(g,"rootLayers",new Map),h(g,"layers",new Map),h(g,"focusElement",null),h(g,"activeElement",null),h(g,"targetElement",null),h(g,"mutationObservers",new Map),h(g,"resizeObservers",new Map),h(g,"rootNodeObservers",new Map),h(g,"containerStyleElement"),h(g,"dataURLMap",new Map),h(g,"embeddedCSSMap",new Map),h(g,"embeddedStyles",new Map),h(g,"fontStyles",new Map),h(g,"_handleMutations",e=>{var t;for(const a of e){if(a.type==="attributes"&&a.target.getAttribute(a.attributeName)===a.oldValue)continue;if(a.type==="characterData"){const s=a.target;if(s.data===a.oldValue)continue;if(((t=s.parentElement)==null?void 0:t.tagName.toLowerCase())==="style"){const l=s.parentElement;l.getRootNode(),g.embeddedStyles.delete(l)}}const n=a.target.nodeType===Node.ELEMENT_NODE?a.target:a.target.parentElement;if(!n)continue;const i=g.getClosestLayer(n);if(i){if(a.type==="attributes"&&a.attributeName==="class"){const s=a.oldValue?a.oldValue:"",l=a.target.className;if(s===l)continue}i.parentLayer?i.parentLayer.traverseChildLayers(g.setLayerNeedsRefresh):i.traverseLayers(g.setLayerNeedsRefresh)}}}),h(g,"_triggerRefresh",async e=>{const t=g.getClosestLayer(e.target);t&&(t.parentLayer?t.parentLayer.traverseChildLayers(g.setLayerNeedsRefresh):t.traverseLayers(g.setLayerNeedsRefresh))});let E=g;const Bt=Symbol("ON_BEFORE_UPDATE"),_t=new te;function fi(r){const e=r.attributes.uv;for(let t=0;t<e.count;t++)e.setY(t,1-e.getY(t));return r}const xe=class xe extends st{constructor(t,a){super();h(this,"_camera");h(this,"_webLayer");h(this,"_localZ",0);h(this,"_viewZ",0);h(this,"_renderZ",0);h(this,"_mediaSrc");h(this,"_mediaTexture");h(this,"textures",new Set);h(this,"_previousTexture");h(this,"_textureMap",new Map);h(this,"contentMesh");h(this,"_boundsMesh");h(this,"cursor",new st);h(this,"depthMaterial",new Ln({depthPacking:Cn,alphaTest:.001}));h(this,"domLayout",new st);h(this,"domSize",new te(1,1,1));h(this,"bounds",new Qe);h(this,"margin",new Se);h(this,"childWebLayers",[]);h(this,"shouldApplyDOMLayout","auto");this.element=t,this.container=a,this.name=t.id,this._webLayer=E.getClosestLayer(t),t.layer=this;const n=this.element.getAttribute("xr-apply-dom-layout");n&&(this.shouldApplyDOMLayout=n);const i=this._webLayer.isMediaElement?xe.GEOMETRY:xe.FLIPPED_GEOMETRY;this.contentMesh=new br(i,new Er({side:Tn,depthWrite:!1,transparent:!0,alphaTest:.001,opacity:1,toneMapped:!1})),this._boundsMesh=new br(i,new Er({visible:!1,opacity:0})),this.add(this.contentMesh),this.add(this._boundsMesh),this.cursor.visible=!1,this.matrixAutoUpdate=!0,this.contentMesh.matrixAutoUpdate=!0,this.contentMesh.visible=!1,this.contentMesh.customDepthMaterial=this.depthMaterial,this.contentMesh.onBeforeRender=(s,l,c)=>{this._camera=c},this._boundsMesh.matrixAutoUpdate=!0,this.container.options.manager.layersByElement.set(this.element,this),this.container.options.manager.layersByMesh.set(this.contentMesh,this)}static shouldApplyDOMLayout(t){const a=t.shouldApplyDOMLayout;if(a==="always"||a===!0)return!0;if(a==="never"||a===!1)return!1;if(a==="auto"&&t.parentWebLayer&&t.parent===t.parentWebLayer)return!0;if(a==="once")return t.shouldApplyDOMLayout=!1,!0}get allStateHashes(){return this._webLayer.allStateHashes}get domState(){return this._webLayer.currentDOMState}get texture(){var i,s,l;const t=this.container.manager,a=this._webLayer;if(a.isMediaElement){const c=this.element;let o=this._mediaTexture;return(!o||o.image&&c.src!==o.image.src)&&(o&&o.dispose(),o=a.isVideoElement?new Sn(c):a.isCanvasElement?new ea(c):new Rn().load(c.src),o.wrapS=_e,o.wrapT=_e,o.minFilter=Mn,t.textureEncoding&&(o.colorSpace=t.textureEncoding),this._mediaTexture=o),o}const n=(s=(i=this._webLayer.currentDOMState)==null?void 0:i.texture)==null?void 0:s.hash;if(n){this._textureMap.has(n)||this._textureMap.set(n,{});const c=t.getTexture(n),o=this._textureMap.get(n);return c.compressedTexture&&!o.compressedTexture&&((l=o.canvasTexture)==null||l.dispose(),o.canvasTexture=void 0,o.compressedTexture=c.compressedTexture.clone(),o.compressedTexture.needsUpdate=!0),c.canvasTexture&&!o.canvasTexture&&(o.canvasTexture=c.canvasTexture.clone(),o.canvasTexture.needsUpdate=!0),o.compressedTexture??o.canvasTexture}}get desiredPseudoStates(){return this._webLayer.desiredPseudoState}get pseudoStates(){var t;return(t=this._webLayer.currentDOMState)==null?void 0:t.pseudo}get depth(){return this._webLayer.depth}get index(){return this.parentWebLayer?this.parentWebLayer.childWebLayers.indexOf(this):0}get needsRefresh(){return this._webLayer.needsRefresh}setNeedsRefresh(t=!0){this._webLayer.setNeedsRefresh(t)}get needsRemoval(){return this._webLayer.needsRemoval}get parentWebLayer(){return this._webLayer.parentLayer&&this.container.manager.layersByElement.get(this._webLayer.parentLayer.element)}async refresh(t=!1){var n;const a=[];a.push(this._webLayer.refresh()),this.childWebLayers.length=0;for(const i of this._webLayer.childLayers){const s=this.container.manager.layersByElement.get((n=E.getClosestLayer(i.element))==null?void 0:n.element);s&&(this.childWebLayers.push(s),t&&a.push(s.refresh(t)))}return Promise.all(a).then(()=>{})}updateLayout(){if(this._updateDOMLayout(),this._camera){this._localZ=Math.abs(_t.setFromMatrixPosition(this.matrix).z+_t.setFromMatrixPosition(this.contentMesh.matrix).z),this._viewZ=Math.abs(this.contentMesh.getWorldPosition(_t).applyMatrix4(this._camera.matrixWorldInverse).z);let t=this.parentWebLayer?this.parentWebLayer._renderZ:this._viewZ;this._localZ<.001?this._renderZ=t:this._renderZ=this._viewZ,this.contentMesh.renderOrder=(this.container.options.renderOrderOffset||0)+(1-Math.log(this._renderZ+1)/Math.log(this._camera.far+1))+(this.depth+this.index*.001)*1e-7}}updateContent(){if(this.parentWebLayer&&!this.parentWebLayer.domLayout)return;const t=this.contentMesh,a=this.texture,n=t.material;if(a&&n.map!==a){const l=this.contentMesh.scale,c=Math.abs(l.x*this.scale.x/l.y*this.scale.y),o=this.domSize.x/this.domSize.y;Math.abs(o-c)<1e3&&(n.map=a,this.depthMaterial.map=a,n.needsUpdate=!0,this.depthMaterial.needsUpdate=!0)}const i=t.material,s=i.opacity<.005;s?t.visible=!1:i.map&&(t.visible=!0),this.needsRemoval&&s&&(this.parent&&this.parent.remove(this),this.dispose()),this._refreshMediaBounds()}[Bt](){}onBeforeApplyLayout(){}_doUpdate(){var t,a;this[Bt](),this.updateContent(),this.updateLayout(),this.onBeforeApplyLayout(),xe.shouldApplyDOMLayout(this)&&(this.position.copy(this.domLayout.position),this.quaternion.copy(this.domLayout.quaternion),this.scale.copy(this.domLayout.scale)),this.contentMesh.position.set(0,0,0),this.contentMesh.scale.copy(this.domSize),this.contentMesh.quaternion.set(0,0,0,1),this._boundsMesh.position.set(0,0,0),this._boundsMesh.scale.copy(this.domSize),this._boundsMesh.quaternion.set(0,0,0,1),this.needsRefresh&&this.container.options.autoRefresh!==!1&&this.refresh(),this._previousTexture!==this.texture&&(this.texture&&this.container.manager.renderer&&this.container.manager.renderer.initTexture(this.texture),this._previousTexture=this.texture,(a=(t=this.container.options).onLayerPaint)==null||a.call(t,this)),this._webLayer.update(),this.container.manager.scheduleTasksIfNeeded()}get pixelRatio(){return this._webLayer.pixelRatio}set pixelRatio(t){this._webLayer.pixelRatio=t}get computedPixelRatio(){return this._webLayer.computedPixelRatio}update(t=!1){t?this.traverseLayersPreOrder(this._doUpdate):this._doUpdate()}querySelector(t){var n;const a=this.element.querySelector(t)||((n=this.element.shadowRoot)==null?void 0:n.querySelector(t));if(a)return this.container.manager.layersByElement.get(a)}querySelectorAll(t){var n;const a=this.element.querySelectorAll(t)||((n=this.element.shadowRoot)==null?void 0:n.querySelectorAll(t));return Array.from(a).map(i=>this.container.manager.layersByElement.get(i)).filter(i=>i)}traverseLayerAncestors(t){const a=this.parentWebLayer;a&&(a.traverseLayerAncestors(t),t.call(this,a))}traverseLayersPreOrder(t){if(t.call(this,this)===!1)return!1;for(const a of this.childWebLayers)if(a.traverseLayersPreOrder(t)===!1)return!1;return!0}traverseLayersPostOrder(t){for(const a of this.childWebLayers)if(a.traverseLayersPostOrder(t)===!1)return!1;return t.call(this,this)||!0}dispose(){E.disposeLayer(this._webLayer);for(const t of this.textures)t.dispose();for(const t of this.childWebLayers)t.dispose()}_refreshMediaBounds(){if(this._webLayer.isMediaElement){const t=this._webLayer.isVideoElement,a=this.domState;if(!a)return;const n=this.element,i=this.texture,s=getComputedStyle(this.element),{objectFit:l}=s,{width:c,height:o}=this.bounds.copy(a.bounds),u=t?n.videoWidth:n.naturalWidth,f=t?n.videoHeight:n.naturalHeight,d=u/f,m=c/o;switch(i.center.set(.5,.5),l){case"none":i.repeat.set(c/u,o/f).clampScalar(0,1);break;case"contain":case"scale-down":if(i.repeat.set(1,1),m>d){const b=this.bounds.height*d||0;this.bounds.left+=(this.bounds.width-b)/2,this.bounds.width=b}else{const b=this.bounds.width/d||0;this.bounds.top+=(this.bounds.height-b)/2,this.bounds.height=b}break;case"cover":if(i.repeat.set(c/u,o/f),m<d){const b=this.bounds.height*d||0;this.bounds.left+=(this.bounds.width-b)/2,this.bounds.width=b}else{const b=this.bounds.width/d||0;this.bounds.top+=(this.bounds.height-b)/2,this.bounds.height=b}break;default:case"fill":i.repeat.set(1,1);break}a.bounds.copy(this.bounds)}}_updateDOMLayout(){if(this.needsRemoval)return;const t=this._webLayer.currentDOMState;if(!t)return;const{bounds:a,margin:n,cssTransform:i}=t,s=this._webLayer.isMediaElement;this.domLayout.position.set(0,0,0),this.domLayout.scale.set(1,1,1),this.domLayout.quaternion.set(0,0,0,1);const l=this.bounds.copy(a),c=this.margin.copy(n),o=l.width,u=l.height,f=s?0:c.left,d=s?0:c.right,m=s?0:c.top,b=s?0:c.bottom,p=o+f+d,x=u+m+b,w=1/this.container.manager.pixelsPerMeter;this.domSize.set(Math.max(w*p,1e-5),Math.max(w*x,1e-5),1);const S=this.parentWebLayer;if(!S)return;const C=S.bounds,R=S.margin,M=C.width+R.left+R.right,T=C.height+R.bottom+R.top,L=-M/2+R.left,v=T/2-R.top;this.domLayout.position.set(w*(L+p/2+l.left-f),w*(v-x/2-l.top+m),0),i&&(this.domLayout.updateMatrix(),this.domLayout.matrix.multiply(i),this.domLayout.matrix.decompose(this.domLayout.position,this.domLayout.quaternion,this.domLayout.scale))}};h(xe,"GEOMETRY",new xr(1,1,2,2)),h(xe,"FLIPPED_GEOMETRY",fi(new xr(1,1,2,2)));let zt=xe;var _r={},di=function(r,e,t,a,n){var i=new Worker(_r[e]||(_r[e]=URL.createObjectURL(new Blob([r+';addEventListener("error",function(e){e=e.error;postMessage({$e$:[e.message,e.code,e.stack]})})'],{type:"text/javascript"}))));return i.onmessage=function(s){var l=s.data,c=l.$e$;if(c){var o=new Error(c[0]);o.code=c[1],o.stack=c[2],n(o,null)}else n(null,l)},i.postMessage(t,a),i},U=Uint8Array,$=Uint16Array,Ve=Uint32Array,He=new U([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Fe=new U([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),Ke=new U([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),ua=function(r,e){for(var t=new $(31),a=0;a<31;++a)t[a]=e+=1<<r[a-1];for(var n=new Ve(t[30]),a=1;a<30;++a)for(var i=t[a];i<t[a+1];++i)n[i]=i-t[a]<<5|a;return[t,n]},ha=ua(He,2),tr=ha[0],pt=ha[1];tr[28]=258,pt[258]=28;var fa=ua(Fe,0),da=fa[0],kt=fa[1],qe=new $(32768);for(var I=0;I<32768;++I){var me=(I&43690)>>>1|(I&21845)<<1;me=(me&52428)>>>2|(me&13107)<<2,me=(me&61680)>>>4|(me&3855)<<4,qe[I]=((me&65280)>>>8|(me&255)<<8)>>>1}var ee=function(r,e,t){for(var a=r.length,n=0,i=new $(e);n<a;++n)r[n]&&++i[r[n]-1];var s=new $(e);for(n=0;n<e;++n)s[n]=s[n-1]+i[n-1]<<1;var l;if(t){l=new $(1<<e);var c=15-e;for(n=0;n<a;++n)if(r[n])for(var o=n<<4|r[n],u=e-r[n],f=s[r[n]-1]++<<u,d=f|(1<<u)-1;f<=d;++f)l[qe[f]>>>c]=o}else for(l=new $(a),n=0;n<a;++n)r[n]&&(l[n]=qe[s[r[n]-1]++]>>>15-r[n]);return l},de=new U(288);for(var I=0;I<144;++I)de[I]=8;for(var I=144;I<256;++I)de[I]=9;for(var I=256;I<280;++I)de[I]=7;for(var I=280;I<288;++I)de[I]=8;var ze=new U(32);for(var I=0;I<32;++I)ze[I]=5;var ma=ee(de,9,0),pa=ee(de,9,1),va=ee(ze,5,0),ga=ee(ze,5,1),ct=function(r){for(var e=r[0],t=1;t<r.length;++t)r[t]>e&&(e=r[t]);return e},J=function(r,e,t){var a=e/8|0;return(r[a]|r[a+1]<<8)>>(e&7)&t},lt=function(r,e){var t=e/8|0;return(r[t]|r[t+1]<<8|r[t+2]<<16)>>(e&7)},Je=function(r){return(r+7)/8|0},wt=function(r,e,t){(e==null||e<0)&&(e=0),(t==null||t>r.length)&&(t=r.length);var a=new(r.BYTES_PER_ELEMENT==2?$:r.BYTES_PER_ELEMENT==4?Ve:U)(t-e);return a.set(r.subarray(e,t)),a},ya=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],k=function(r,e,t){var a=new Error(e||ya[r]);if(a.code=r,Error.captureStackTrace&&Error.captureStackTrace(a,k),!t)throw a;return a},Tt=function(r,e,t){var a=r.length;if(!a||t&&t.f&&!t.l)return e||new U(0);var n=!e||t,i=!t||t.i;t||(t={}),e||(e=new U(a*3));var s=function(Ze){var $e=e.length;if(Ze>$e){var Ce=new U(Math.max($e*2,Ze));Ce.set(e),e=Ce}},l=t.f||0,c=t.p||0,o=t.b||0,u=t.l,f=t.d,d=t.m,m=t.n,b=a*8;do{if(!u){l=J(r,c,1);var p=J(r,c+1,3);if(c+=3,p)if(p==1)u=pa,f=ga,d=9,m=5;else if(p==2){var C=J(r,c,31)+257,R=J(r,c+10,15)+4,M=C+J(r,c+5,31)+1;c+=14;for(var T=new U(M),L=new U(19),v=0;v<R;++v)L[Ke[v]]=J(r,c+v*3,7);c+=R*3;for(var z=ct(L),P=(1<<z)-1,re=ee(L,z,1),v=0;v<M;){var O=re[J(r,c,P)];c+=O&15;var x=O>>>4;if(x<16)T[v++]=x;else{var j=0,B=0;for(x==16?(B=3+J(r,c,3),c+=2,j=T[v-1]):x==17?(B=3+J(r,c,7),c+=3):x==18&&(B=11+J(r,c,127),c+=7);B--;)T[v++]=j}}var H=T.subarray(0,C),_=T.subarray(C);d=ct(H),m=ct(_),u=ee(H,d,1),f=ee(_,m,1)}else k(1);else{var x=Je(c)+4,w=r[x-4]|r[x-3]<<8,S=x+w;if(S>a){i&&k(0);break}n&&s(o+w),e.set(r.subarray(x,S),o),t.b=o+=w,t.p=c=S*8,t.f=l;continue}if(c>b){i&&k(0);break}}n&&s(o+131072);for(var N=(1<<d)-1,K=(1<<m)-1,Q=c;;Q=c){var j=u[lt(r,c)&N],se=j>>>4;if(c+=j&15,c>b){i&&k(0);break}if(j||k(2),se<256)e[o++]=se;else if(se==256){Q=c,u=null;break}else{var q=se-254;if(se>264){var v=se-257,ae=He[v];q=J(r,c,(1<<ae)-1)+tr[v],c+=ae}var oe=f[lt(r,c)&K],G=oe>>>4;oe||k(3),c+=oe&15;var _=da[G];if(G>3){var ae=Fe[G];_+=lt(r,c)&(1<<ae)-1,c+=ae}if(c>b){i&&k(0);break}n&&s(o+131072);for(var F=o+q;o<F;o+=4)e[o]=e[o-_],e[o+1]=e[o+1-_],e[o+2]=e[o+2-_],e[o+3]=e[o+3-_];o=F}}t.l=u,t.p=Q,t.b=o,t.f=l,u&&(l=1,t.m=d,t.d=f,t.n=m)}while(!l);return o==e.length?e:wt(e,0,o)},le=function(r,e,t){t<<=e&7;var a=e/8|0;r[a]|=t,r[a+1]|=t>>>8},Ie=function(r,e,t){t<<=e&7;var a=e/8|0;r[a]|=t,r[a+1]|=t>>>8,r[a+2]|=t>>>16},ut=function(r,e){for(var t=[],a=0;a<r.length;++a)r[a]&&t.push({s:a,f:r[a]});var n=t.length,i=t.slice();if(!n)return[St,0];if(n==1){var s=new U(t[0].s+1);return s[t[0].s]=1,[s,1]}t.sort(function(M,T){return M.f-T.f}),t.push({s:-1,f:25001});var l=t[0],c=t[1],o=0,u=1,f=2;for(t[0]={s:-1,f:l.f+c.f,l,r:c};u!=n-1;)l=t[t[o].f<t[f].f?o++:f++],c=t[o!=u&&t[o].f<t[f].f?o++:f++],t[u++]={s:-1,f:l.f+c.f,l,r:c};for(var d=i[0].s,a=1;a<n;++a)i[a].s>d&&(d=i[a].s);var m=new $(d+1),b=vt(t[u-1],m,0);if(b>e){var a=0,p=0,x=b-e,w=1<<x;for(i.sort(function(T,L){return m[L.s]-m[T.s]||T.f-L.f});a<n;++a){var S=i[a].s;if(m[S]>e)p+=w-(1<<b-m[S]),m[S]=e;else break}for(p>>>=x;p>0;){var C=i[a].s;m[C]<e?p-=1<<e-m[C]++-1:++a}for(;a>=0&&p;--a){var R=i[a].s;m[R]==e&&(--m[R],++p)}b=e}return[new U(m),b]},vt=function(r,e,t){return r.s==-1?Math.max(vt(r.l,e,t+1),vt(r.r,e,t+1)):e[r.s]=t},Vt=function(r){for(var e=r.length;e&&!r[--e];);for(var t=new $(++e),a=0,n=r[0],i=1,s=function(c){t[a++]=c},l=1;l<=e;++l)if(r[l]==n&&l!=e)++i;else{if(!n&&i>2){for(;i>138;i-=138)s(32754);i>2&&(s(i>10?i-11<<5|28690:i-3<<5|12305),i=0)}else if(i>3){for(s(n),--i;i>6;i-=6)s(8304);i>2&&(s(i-3<<5|8208),i=0)}for(;i--;)s(n);i=1,n=r[l]}return[t.subarray(0,a),e]},Oe=function(r,e){for(var t=0,a=0;a<e.length;++a)t+=r[a]*e[a];return t},gt=function(r,e,t){var a=t.length,n=Je(e+2);r[n]=a&255,r[n+1]=a>>>8,r[n+2]=r[n]^255,r[n+3]=r[n+1]^255;for(var i=0;i<a;++i)r[n+i+4]=t[i];return(n+4+a)*8},Ht=function(r,e,t,a,n,i,s,l,c,o,u){le(e,u++,t),++n[256];for(var f=ut(n,15),d=f[0],m=f[1],b=ut(i,15),p=b[0],x=b[1],w=Vt(d),S=w[0],C=w[1],R=Vt(p),M=R[0],T=R[1],L=new $(19),v=0;v<S.length;++v)L[S[v]&31]++;for(var v=0;v<M.length;++v)L[M[v]&31]++;for(var z=ut(L,7),P=z[0],re=z[1],O=19;O>4&&!P[Ke[O-1]];--O);var j=o+5<<3,B=Oe(n,de)+Oe(i,ze)+s,H=Oe(n,d)+Oe(i,p)+s+14+3*O+Oe(L,P)+(2*L[16]+3*L[17]+7*L[18]);if(j<=B&&j<=H)return gt(e,u,r.subarray(c,c+o));var _,N,K,Q;if(le(e,u,1+(H<B)),u+=2,H<B){_=ee(d,m,0),N=d,K=ee(p,x,0),Q=p;var se=ee(P,re,0);le(e,u,C-257),le(e,u+5,T-1),le(e,u+10,O-4),u+=14;for(var v=0;v<O;++v)le(e,u+3*v,P[Ke[v]]);u+=3*O;for(var q=[S,M],ae=0;ae<2;++ae)for(var oe=q[ae],v=0;v<oe.length;++v){var G=oe[v]&31;le(e,u,se[G]),u+=P[G],G>15&&(le(e,u,oe[v]>>>5&127),u+=oe[v]>>>12)}}else _=ma,N=de,K=va,Q=ze;for(var v=0;v<l;++v)if(a[v]>255){var G=a[v]>>>18&31;Ie(e,u,_[G+257]),u+=N[G+257],G>7&&(le(e,u,a[v]>>>23&31),u+=He[G]);var F=a[v]&31;Ie(e,u,K[F]),u+=Q[F],F>3&&(Ie(e,u,a[v]>>>5&8191),u+=Fe[F])}else Ie(e,u,_[a[v]]),u+=N[a[v]];return Ie(e,u,_[256]),u+N[256]},ba=new Ve([65540,131080,131088,131104,262176,1048704,1048832,2114560,2117632]),St=new U(0),Ea=function(r,e,t,a,n,i){var s=r.length,l=new U(a+s+5*(1+Math.ceil(s/7e3))+n),c=l.subarray(a,l.length-n),o=0;if(!e||s<8)for(var u=0;u<=s;u+=65535){var f=u+65535;f>=s&&(c[o>>3]=i),o=gt(c,o+1,r.subarray(u,f))}else{for(var d=ba[e-1],m=d>>>13,b=d&8191,p=(1<<t)-1,x=new $(32768),w=new $(p+1),S=Math.ceil(t/3),C=2*S,R=function(Mt){return(r[Mt]^r[Mt+1]<<S^r[Mt+2]<<C)&p},M=new Ve(25e3),T=new $(288),L=new $(32),v=0,z=0,u=0,P=0,re=0,O=0;u<s;++u){var j=R(u),B=u&32767,H=w[j];if(x[B]=H,w[j]=B,re<=u){var _=s-u;if((v>7e3||P>24576)&&_>423){o=Ht(r,c,0,M,T,L,z,P,O,u-O,o),P=v=z=0,O=u;for(var N=0;N<286;++N)T[N]=0;for(var N=0;N<30;++N)L[N]=0}var K=2,Q=0,se=b,q=B-H&32767;if(_>2&&j==R(u-q))for(var ae=Math.min(m,_)-1,oe=Math.min(32767,u),G=Math.min(258,_);q<=oe&&--se&&B!=H;){if(r[u+K]==r[u+K-q]){for(var F=0;F<G&&r[u+F]==r[u+F-q];++F);if(F>K){if(K=F,Q=q,F>ae)break;for(var Ze=Math.min(q,F-2),$e=0,N=0;N<Ze;++N){var Ce=u-q+N+32768&32767,za=x[Ce],sr=Ce-za+32768&32767;sr>$e&&($e=sr,H=Ce)}}}B=H,H=x[B],q+=B-H+32768&32767}if(Q){M[P++]=268435456|pt[K]<<18|kt[Q];var or=pt[K]&31,cr=kt[Q]&31;z+=He[or]+Fe[cr],++T[257+or],++L[cr],re=u+K,++v}else M[P++]=r[u],++T[r[u]]}}o=Ht(r,c,i,M,T,L,z,P,O,u-O,o),!i&&o&7&&(o=gt(c,o+1,St))}return wt(l,0,a+Je(o)+n)},xa=function(){for(var r=new Int32Array(256),e=0;e<256;++e){for(var t=e,a=9;--a;)t=(t&1&&-306674912)^t>>>1;r[e]=t}return r}(),wa=function(){var r=-1;return{p:function(e){for(var t=r,a=0;a<e.length;++a)t=xa[t&255^e[a]]^t>>>8;r=t},d:function(){return~r}}},rr=function(r,e,t,a,n){return Ea(r,e.level==null?6:e.level,e.mem==null?Math.ceil(Math.max(8,Math.min(13,Math.log(r.length)))*1.5):12+e.mem,t,a,!n)},mi=function(r,e){var t={};for(var a in r)t[a]=r[a];for(var a in e)t[a]=e[a];return t},Dr=function(r,e,t){for(var a=r(),n=r.toString(),i=n.slice(n.indexOf("[")+1,n.lastIndexOf("]")).replace(/\s+/g,"").split(","),s=0;s<a.length;++s){var l=a[s],c=i[s];if(typeof l=="function"){e+=";"+c+"=";var o=l.toString();if(l.prototype)if(o.indexOf("[native code]")!=-1){var u=o.indexOf(" ",8)+1;e+=o.slice(u,o.indexOf("(",u))}else{e+=o;for(var f in l.prototype)e+=";"+c+".prototype."+f+"="+l.prototype[f].toString()}else e+=o}else t[c]=l}return[e,t]},nt=[],pi=function(r){var e=[];for(var t in r)r[t].buffer&&e.push((r[t]=new r[t].constructor(r[t])).buffer);return e},vi=function(r,e,t,a){var n;if(!nt[t]){for(var i="",s={},l=r.length-1,c=0;c<l;++c)n=Dr(r[c],i,s),i=n[0],s=n[1];nt[t]=Dr(r[l],i,s)}var o=mi({},nt[t][1]);return di(nt[t][0]+";onmessage=function(e){for(var k in e.data)self[k]=e.data[k];onmessage="+e.toString()+"}",t,o,pi(o),a)},ar=function(){return[U,$,Ve,He,Fe,Ke,tr,da,pa,ga,qe,ya,ee,ct,J,lt,Je,wt,k,Tt,Ca,We,nr]},gi=function(){return[U,$,Ve,He,Fe,Ke,pt,kt,ma,de,va,ze,qe,ba,St,ee,le,Ie,ut,vt,Vt,Oe,gt,Ht,Je,wt,Ea,rr,xi,We]},yi=function(){return[Ta,Ma,yt,wa,xa]},bi=function(){return[Sa,Ra]},Ei=function(){return[La]},We=function(r){return postMessage(r,[r.buffer])},nr=function(r){return r&&r.size&&new U(r.size)},Rt=function(r,e,t,a,n,i){var s=vi(t,a,n,function(l,c){s.terminate(),i(l,c)});return s.postMessage([r,e],e.consume?[r.buffer]:[]),function(){s.terminate()}},yt=function(r,e,t){for(;t;++e)r[e]=t,t>>>=8},Ta=function(r,e){var t=e.filename;if(r[0]=31,r[1]=139,r[2]=8,r[8]=e.level<2?4:e.level==9?2:0,r[9]=3,e.mtime!=0&&yt(r,4,Math.floor(new Date(e.mtime||Date.now())/1e3)),t){r[3]=8;for(var a=0;a<=t.length;++a)r[a+10]=t.charCodeAt(a)}},Sa=function(r){(r[0]!=31||r[1]!=139||r[2]!=8)&&k(6,"invalid gzip data");var e=r[3],t=10;e&4&&(t+=r[10]|(r[11]<<8)+2);for(var a=(e>>3&1)+(e>>4&1);a>0;a-=!r[t++]);return t+(e&2)},Ra=function(r){var e=r.length;return(r[e-4]|r[e-3]<<8|r[e-2]<<16|r[e-1]<<24)>>>0},Ma=function(r){return 10+(r.filename&&r.filename.length+1||0)},La=function(r){((r[0]&15)!=8||r[0]>>>4>7||(r[0]<<8|r[1])%31)&&k(6,"invalid zlib data"),r[1]&32&&k(6,"invalid zlib data: preset dictionaries not supported")};function xi(r,e){return rr(r,e||{},0,0)}function wi(r,e,t){return t||(t=e,e={}),typeof t!="function"&&k(7),Rt(r,e,[ar],function(a){return We(Ca(a.data[0],nr(a.data[1])))},1,t)}function Ca(r,e){return Tt(r,e)}function Pr(r,e,t){return t||(t=e,e={}),typeof t!="function"&&k(7),Rt(r,e,[gi,yi,function(){return[Nr]}],function(a){return We(Nr(a.data[0],a.data[1]))},2,t)}function Nr(r,e){e||(e={});var t=wa(),a=r.length;t.p(r);var n=rr(r,e,Ma(e),8),i=n.length;return Ta(n,e),yt(n,i-8,t.d()),yt(n,i-4,a),n}function Ti(r,e,t){return t||(t=e,e={}),typeof t!="function"&&k(7),Rt(r,e,[ar,bi,function(){return[Ur]}],function(a){return We(Ur(a.data[0]))},3,t)}function Ur(r,e){return Tt(r.subarray(Sa(r),-8),e||new U(Ra(r)))}function Si(r,e,t){return t||(t=e,e={}),typeof t!="function"&&k(7),Rt(r,e,[ar,Ei,function(){return[Br]}],function(a){return We(Br(a.data[0],nr(a.data[1])))},5,t)}function Br(r,e){return Tt((La(r),r.subarray(2,-4)),e)}function zr(r,e,t){return t||(t=e,e={}),typeof t!="function"&&k(7),r[0]==31&&r[1]==139&&r[2]==8?Ti(r,e,t):(r[0]&15)!=8||r[0]>>4>7||(r[0]<<8|r[1])%31?wi(r,e,t):Si(r,e,t)}var Ri=typeof TextDecoder<"u"&&new TextDecoder,Mi=0;try{Ri.decode(St,{stream:!0}),Mi=1}catch{}const Aa=new Array(255);for(let r=0;r<=255;++r){const e=r.toString(16).padStart(2,"0");Aa[r]=e}function Li(r){const e=r.length;let t="";for(let a=0;a<e;++a)t+=Aa[r[a]];return t}function Ft(r){return Li(new Uint8Array(r))}const Ci=/(@import\s+["']([^"']+)["']|url\((?!['"]?(?:data):)['"]?([^'"\)]+)['"]?\))/gi;async function Ai(r){if(E.embeddedCSSMap.has(r))return E.embeddedCSSMap.get(r);const e=await fetch(r,{mode:"no-cors",headers:{accept:"text/css"}}),t=await ir(r,await e.text());return E.embeddedCSSMap.set(r,t),E.embeddedCSSMap.get(r)}async function ir(r,e){const t=[];e=e.replaceAll(":hover",E.attributeCSS(E.HOVER_ATTRIBUTE)),e=e.replaceAll(":active",E.attributeCSS(E.ACTIVE_ATTRIBUTE)),e=e.replaceAll(":focus",E.attributeCSS(E.FOCUS_ATTRIBUTE)),e=e.replaceAll(":target",E.attributeCSS(E.TARGET_ATTRIBUTE));const a=e.matchAll(Ci);for(const n of a){const s=!!n[2]?"type/css":void 0,l=n[2]||n[3];t.push(Ia(new URL(l,r).href,s).then(c=>{e=e.replace(l,c)}))}return await Promise.all(t),e}async function Ia(r,e){if(r.startsWith("data"))return r;if(E.dataURLMap.has(r))return E.dataURLMap.get(r);const t=new Promise(async a=>{const n=await fetch(r,e?{headers:{accept:e}}:void 0),i=n.headers.get("content-type");if(i=="text/css"){const s=await ir(r,await n.text());E.embeddedCSSMap.set(r,s),a("data:"+i+";base64,"+window.btoa(s))}else{const s=new Uint8Array(await n.arrayBuffer());a("data:"+i+";base64,"+E.arrayBufferToBase64(s))}});return E.dataURLMap.set(r,t),t}function Ii(r){return r.replace(/[\x00-\x08\x0B\x0C\x0E-\x1F]/g,"")}function Oa(r){return r.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function Oi(r){return r.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function Ne(r,e){return" "+r+'="'+Oa(e)+'"'}function _i(r,e){return!r.hasAttribute("xmlns")&&(e||r.namespaceURI!==r.parentElement.namespaceURI)?' xmlns="'+r.namespaceURI+'"':""}async function _a(r,e){let t=[];for(const a of r.childNodes)t.push(Da(a,e));return Promise.all(t).then(a=>a.join(""))}async function Di(r,e){const t=r.tagName.toLowerCase();let a="<"+t;a+=_i(r,e.depth===0);const n=_a(r,e);for(const i of r.attributes)i.name==="src"?r.nodeName==="IMG"?a+=Ne(i.name,await Ia(i.value)):a+=Ne("data-src",i.value):a+=Ne(i.name,i.value);return r.childNodes.length>0?(e.depth++,a+=">",a+=await n,a+="</"+t+">",e.depth--):a+="/>",a}function Pi(r){const e=r.nodeValue||"";return Oi(e)}function Ni(r){return"<![CDATA["+r.nodeValue+"]]>"}async function Da(r,e){var a;const t=(a=e.replacer)==null?void 0:a.call(e,e.target,r);if(typeof t=="string")return t;if(r.nodeName==="#document"||r.nodeName==="#document-fragment")return _a(r,e);if(r.tagName)return Di(r,e);if(r.nodeName==="#text")return Pi(r);if(r.nodeName!=="#comment"){if(r.nodeName==="#cdata-section")return Ni(r)}return""}async function Ui(r,e=Bi){return Ii(await Da(r,{depth:0,target:r,replacer:e}))}const Bi=(r,e)=>{var l;if(r===e||e.nodeType!==Node.ELEMENT_NODE)return;const t=e,a=(l=t.tagName)==null?void 0:l.toLowerCase(),n=getComputedStyle(t),i=n.display==="inline"||n.display==="inline-block";if(a==="style"||a==="link")return"";if(i)return;const s=E.layers.get(t);if(s){s.manager.updateDOMMetrics(s);const c=s.domMetrics.bounds;let o="";const u=`box-sizing:border-box;max-width:${c.width}px;max-height:${c.height}px;min-width:${c.width}px;min-height:${c.height}px;visibility:hidden`;let f=!1;for(const m of s.element.attributes)m.name!=="src"&&(m.name=="style"?(o+=Ne(m.name,m.value+";"+u),f=!0):o+=Ne(m.name,m.value));f||(o+=Ne("style",u));const d=t.tagName.toLowerCase();return`<${d} ${o}></${d}>`}};function zi(r,e,t,a,n){const i=[],s=[];r.manager.updateDOMMetrics(r);const l=r.domMetrics;let c=r.element.parentElement;c||(c=document.documentElement);do{let o=c.tagName.toLowerCase(),u=" ",f="";for(const b of c.attributes){const p=Oa(b.value);if(b.name==="style"){f=p;continue}u+=`${b.name}="${p}" `}const d="<"+o+(o==="html"?` ${E.RENDERING_DOCUMENT_ATTRIBUTE}="" xmlns="http://www.w3.org/1999/xhtml"
                    style="${ki(a/e,n/t)} --x-width:${l.bounds.width}px; --x-height:${l.bounds.height}px; ${f} width:${e}px; height:${t}px;" `:` style="${f}" ${E.RENDERING_PARENT_ATTRIBUTE}="" `)+u+" >";i.unshift(d);const m="</"+o+">";if(s.push(m),o=="html")break}while(c=c!==document.documentElement?c.parentElement||document.documentElement:null);return[i.join(""),s.join("")]}function ki(r,e){if(Vi.test(navigator.userAgent)){const a=Math.max(r,e);return`zoom:${a}; transform: scale(${r/a},${e/a}); transform-origin: top left; `}return`transform: scale(${r},${e}); transform-origin: top left; `}const Vi=/^((?!chrome|android).)*safari/i;async function Hi(r){const e=r.getRootNode(),t=E.embeddedStyles,a=Array.from(e.querySelectorAll("style, link[type='text/css'], link[rel='stylesheet']")),n=r.getRootNode()instanceof ShadowRoot,i=[];for(const s of a)t.has(s)||t.set(s,new Promise(l=>{s.tagName.toLowerCase()==="style"?l(ir(window.location.href,s.textContent||"")):l(Ai(s.href))}).then(async l=>{const c=RegExp(/@font-face[^{]*{([^{}]|{[^{}]*})*}/gi),o=l.match(c);if(n&&o)for(const f of o){if(E.fontStyles.has(f))continue;const d=document.createElement("style");d.innerHTML=f,document.head.appendChild(d),E.fontStyles.set(f,d),t.set(d,Promise.resolve({serialized:"",hash:""}))}const u=fe?await crypto.subtle.digest("SHA-1",E.textEncoder.encode(l)):new ArrayBuffer(0);return{serialized:l,hash:Ft(u)}})),i.push(t.get(s));return Promise.all(i)}const Fi=(r,e=!0,t={})=>{const a=`globalThis.process = ${JSON.stringify(process)};
`.concat(e?`import '${r}';`:`importScripts('${r}')`),n=new Blob([a],{type:"text/javascript"}),i=URL.createObjectURL(n);return new Worker(i,{type:e?"module":"classic",...t})},Wi=fe?new URL(""+new URL("KTX2Worker.bundle-BgVYbVNo.js",import.meta.url).href,import.meta.url).href:"";var Pa=(r=>(r[r.UASTCLevelFastest=0]="UASTCLevelFastest",r[r.UASTCLevelFaster=1]="UASTCLevelFaster",r[r.UASTCLevelDefault=2]="UASTCLevelDefault",r[r.UASTCLevelSlower=3]="UASTCLevelSlower",r[r.UASTCLevelVerySlow=4]="UASTCLevelVerySlow",r[r.UASTCLevelMask=15]="UASTCLevelMask",r[r.UASTCFavorUASTCError=8]="UASTCFavorUASTCError",r[r.UASTCFavorBC7Error=16]="UASTCFavorBC7Error",r[r.UASTCETC1FasterHints=64]="UASTCETC1FasterHints",r[r.UASTCETC1FastestHints=128]="UASTCETC1FastestHints",r[r.UASTCETC1DisableFlipAndIndividual=256]="UASTCETC1DisableFlipAndIndividual",r[r.UASTCFavorSimplerModes=512]="UASTCFavorSimplerModes",r))(Pa||{});class $i{constructor(){h(this,"pool",new tn(1));this.pool.setWorkerCreator(()=>Fi(Wi,!1,{name:"KTX2 Encoder"}))}setWorkerLimit(e){this.pool.setWorkerLimit(e)}async encode(e,t){const a=await this.pool.postMessage({image:e,options:t},[e.data.buffer]);if(a.data.error)throw new Error(a.data.error);if(!a.data.texture||a.data.texture.byteLength===0)throw new Error("Encoding failed");return a.data.texture}}const ji=new Ye;class Gi extends rn{constructor(t){super(t,{indexedDB:globalThis.indexedDB,IDBKeyRange:globalThis.IDBKeyRange});h(this,"states");h(this,"textures");this.version(3).stores({states:"&hash",textures:"&hash, timestamp"})}}function Xi(r){return 1<<31-Math.clz32(r)}function kr(r){return Xi((r-1)*2)}class Ki{constructor(e="ethereal-web-store"){h(this,"MINIMUM_RENDER_ATTEMPTS",3);h(this,"MAX_SERIALIZE_TASK_COUNT",10);h(this,"MAX_RASTERIZE_TASK_COUNT",5);h(this,"tasksPending",!1);h(this,"serializePendingCount",0);h(this,"rasterizePendingCount",0);h(this,"WebRenderer",E);h(this,"autosave",!0);h(this,"autosaveDelay",10*1e3);h(this,"_autosaveTimer");h(this,"pixelsPerMeter",1e3);h(this,"store");h(this,"serializeQueue",[]);h(this,"rasterizeQueue",[]);h(this,"optimizeQueue",[]);h(this,"ktx2Encoder",new $i);h(this,"_unsavedTextureData",new Map);h(this,"_stateData",new Map);h(this,"_textureData",new Map);h(this,"_imagePool",[]);h(this,"_packr",new Ha({structuredClone:!0}));h(this,"_unpackr",new Fa({structuredClone:!0}));h(this,"_statesRequestedFromStore",new Set);h(this,"_texturesRequestedFromStore",new Set);h(this,"_runTasks",()=>{const e=this.serializeQueue,t=this.rasterizeQueue;for(;e.length>0&&this.serializePendingCount<this.MAX_SERIALIZE_TASK_COUNT;){this.serializePendingCount++;const{layer:a,resolve:n}=e.shift();this.serialize(a).then(i=>{this.serializePendingCount--,n(i)})}for(;t.length>0&&this.rasterizePendingCount<this.MAX_RASTERIZE_TASK_COUNT;){this.rasterizePendingCount++;const{hash:a,svgUrl:n,resolve:i}=t.shift();this.rasterize(a,n).finally(()=>{this.rasterizePendingCount--,i(void 0),this._autosaveTimer&&clearTimeout(this._autosaveTimer),this.autosave&&this._unsavedTextureData.size&&(this._autosaveTimer=setTimeout(()=>{this.saveStore()},this.autosaveDelay/this._unsavedTextureData.size))})}this.tasksPending=!1});h(this,"prerasterized",!1);this.store=new Gi(e)}get pixelPerUnit(){return this.pixelsPerMeter}saveStore(){const e=Array.from(this._stateData.entries()).filter(([a,n])=>typeof a=="string").map(([a,n])=>{var i;return{hash:a,textureHash:(i=n.texture)==null?void 0:i.hash}}),t=Array.from(this._unsavedTextureData.values());return this._unsavedTextureData.clear(),this.loadIntoStore({stateData:e,textureData:t})}async importCache(e){try{const a=await(await fetch(e)).arrayBuffer(),n=await new Promise((s,l)=>{zr(new Uint8Array(a),{consume:!0},(c,o)=>{if(c)return l(c);s(o)})}),i=this._unpackr.unpack(n);return i.textureData=i.textureData.filter(s=>s&&s.hash&&s.texture),console.log(`Importing weblayer cache data from ${e} with `+i.stateData.length+" states and "+i.textureData.length+" textures"),console.log(i),this.loadIntoStore(i)}catch(t){console.warn("Failed to import cache",t)}}getActiveStateHashes(){return Array.from(this._stateData.keys()).filter(e=>typeof e=="string")}async exportCache(e=this.getActiveStateHashes()){const t=await this.store.states.bulkGet(e);let a=await this.store.textures.bulkGet(t.map(s=>s.textureHash).filter(s=>typeof s=="string"));a=a.filter(s=>s&&typeof s.hash=="string"&&s.texture);const n={stateData:t,textureData:a},i=this._packr.pack(n);return new Promise((s,l)=>{Pr(new Uint8Array(i),{consume:!0},(c,o)=>{if(c)return l(c);s(new Blob([o.buffer]))})})}async downloadCache(){await this.saveStore();const e=await this.exportCache(),t=location.pathname.split("/").filter(a=>a);aa(e,"web."+location.host+"."+(t[t.length-1]??"")+".cache")}async loadIntoStore(e){for(const t of e.textureData){const a=this._textureData.get(t.hash)||{hash:t.hash,ktx2Url:void 0};!a.ktx2Url&&t.texture&&(a.ktx2Url=URL.createObjectURL(new Blob([t.texture],{type:"image/ktx2"})))}for(const t of e.stateData){const a=this.getLayerState(t.hash);if(!a.texture&&t.textureHash){const n=this._textureData.get(t.textureHash);a.texture=n}}return Promise.all([this.store.states.bulkPut(e.stateData),this.store.textures.bulkPut(e.textureData)])}getLayerState(e){let t=this._stateData.get(e);return t||(t={cssTransform:void 0,bounds:new Qe,margin:new Se,padding:new Se,border:new Se,fullWidth:0,fullHeight:0,renderAttempts:0,textureWidth:32,textureHeight:32,pixelRatio:1,texture:void 0,pseudo:{hover:!1,active:!1,focus:!1,target:!1}},this._stateData.set(e,t)),t}getTextureState(e){let t=this._textureData.get(e);return t||(t={hash:e,canvas:void 0,ktx2Url:void 0},this._textureData.set(e,t)),t}async requestStoredData(e){const t=this.getLayerState(e);if(typeof e!="string")return t;if(!this._statesRequestedFromStore.has(e)){this._statesRequestedFromStore.add(e);const n=await this.store.states.get(e);n!=null&&n.textureHash&&(t.texture=this.getTextureState(n.textureHash))}const a=t.texture;if(a&&a.hash&&!a.canvas&&!a.ktx2Url&&!this._texturesRequestedFromStore.has(a==null?void 0:a.hash)){this._texturesRequestedFromStore.add(a.hash);const n=await this.store.textures.get(a.hash);if(n!=null&&n.texture&&!a.canvas){const i=await new Promise((s,l)=>{zr(n.texture,{consume:!0},(c,o)=>{if(c)return l(c);s(o)})});a.canvas||(a.ktx2Url=URL.createObjectURL(new Blob([i.buffer],{type:"image/ktx2"})))}}return t}async compressTexture(e){const t=this._textureData.get(e),a=t==null?void 0:t.canvas;if(!a)throw new Error("Missing texture canvas");if(this.ktx2Encoder.pool.limit===0)return;const n=this.getImageData(a);let i;try{i=await this.ktx2Encoder.encode(n,{srgb:!0,uastc:!0,uastcFlags:Pa.UASTCLevelFastest})}catch(c){console.error(`KTX2 encoding failed for image (${a.width}, ${a.height}) `,c),this.ktx2Encoder.pool.dispose();return}const s=this._unsavedTextureData.get(e)||{hash:e,timestamp:Date.now(),texture:void 0};t.ktx2Url=URL.createObjectURL(new Blob([i],{type:"image/ktx2"}));const l=await new Promise((c,o)=>{Pr(new Uint8Array(i),{consume:!0},(u,f)=>{if(u)return o(u);c(f)})});s.texture=l,this._unsavedTextureData.set(e,s)}scheduleTasksIfNeeded(){this.tasksPending||this.serializeQueue.length===0&&this.rasterizeQueue.length===0||(this.tasksPending=!0,setTimeout(this._runTasks,1))}addToSerializeQueue(e){const t=this.serializeQueue.find(i=>i.layer===e);if(t)return t.promise;let a;const n=new Promise(i=>{a=i});return this.serializeQueue.push({layer:e,resolve:a,promise:n}),n}updateDOMMetrics(e){var a;const t=e.domMetrics;Jt(e.element,t.bounds,(a=e.parentLayer)==null?void 0:a.element),Nn(e.element,t.margin),Bn(e.element,t.padding),Un(e.element,t.border)}async serialize(e){var L;this.updateDOMMetrics(e);const t=e.element,a=e.domMetrics,{top:n,left:i,width:s,height:l}=a.bounds,{top:c,left:o,bottom:u,right:f}=a.margin,d=s+Math.max(o,0)+Math.max(f,0),m=l+Math.max(c,0)+Math.max(u,0),b=e.computedPixelRatio,p=Math.max(kr(d*b),32),x=Math.max(kr(m*b),32),w={};let S;const C=getComputedStyle(t),R=C.transform;let M=null;if(R&&R!=="none"){const v=1/this.pixelsPerMeter;M=Fn(C,s,l,v,ji)}if(e.isMediaElement)w.stateKey=t;else{const v=E.attributeHTML(E.LAYER_ATTRIBUTE,""),z=C.display==="inline";E.updateInputAttributes(t);const P=zi(e,d,m,p,x),re=await Hi(t);let O=await Ui(t);O=O.replace(v,`${v} ${E.RENDERING_ATTRIBUTE}="" ${z?`${E.RENDERING_INLINE_ATTRIBUTE}="" `:" "} `+E.getPsuedoAttributes(e.desiredPseudoState));const j=[...re.map(_=>_.hash),P[0],O,P[1]].join(`
`),B=fe?await crypto.subtle.digest("SHA-1",E.textEncoder.encode(j)):new ArrayBuffer(0),H=Ft(B)+"?w="+d+";h="+m+";tw="+p+";th="+x;w.stateKey=H,S='<svg width="'+p+'" height="'+x+`" xmlns="http://www.w3.org/2000/svg"><defs><style type="text/css"><![CDATA[
`+re.map(_=>_.serialized).join(`
`)+']]></style></defs><foreignObject x="0" y="0" width="'+p+'" height="'+x+'">'+P[0]+O+P[1]+"</foreignObject></svg>"}const T=await this.requestStoredData(w.stateKey);return T.cssTransform=M==null?void 0:M.clone(),T.bounds.left=i,T.bounds.top=n,T.bounds.width=s,T.bounds.height=l,T.margin.left=o,T.margin.top=c,T.margin.right=f,T.margin.bottom=u,T.fullWidth=d,T.fullHeight=m,T.pixelRatio=b,T.textureWidth=p,T.textureHeight=x,e.desiredDOMStateKey=w.stateKey,typeof w.stateKey=="string"&&e.allStateHashes.add(w.stateKey),w.needsRasterize=!e.isMediaElement&&d*m>0&&!((L=T.texture)!=null&&L.hash),w.svgUrl=w.needsRasterize&&S?"data:image/svg+xml;utf8,"+encodeURIComponent(S):void 0,e.lastSVGUrl=w.svgUrl,w}async rasterize(e,t){var S;const a=this.getLayerState(e),n=this._imagePool.pop()||new Image,{fullWidth:i,fullHeight:s,textureWidth:l,textureHeight:c,pixelRatio:o}=a;if(await new Promise((C,R)=>{n.onload=()=>{C()},n.onerror=M=>{R(M)},n.width=l,n.height=c,n.src=t}),!n.complete||n.currentSrc!==t)throw new Error("Rasterization Failed");await n.decode();const u=i*o,f=s*o,d=await this.rasterizeToCanvas(n,u,f,30,30),m=this.getImageData(d),b=await crypto.subtle.digest("SHA-1",m.data),p=Ft(b)+"?w="+l+";h="+c;((S=a.texture)==null?void 0:S.hash)!==p&&(a.renderAttempts=0),a.renderAttempts++,a.texture=this.getTextureState(p);const w=a.texture.canvas||a.texture.ktx2Url;if(!(a.renderAttempts>this.MINIMUM_RENDER_ATTEMPTS&&w)&&(setTimeout(()=>this.addToRasterizeQueue(e,t),(500+.1*1e3)*2^a.renderAttempts),!a.texture.canvas)){a.texture.canvas=await this.rasterizeToCanvas(n,u,f,l,c);try{await this.compressTexture(p)}finally{this._imagePool.push(n)}}}async rasterizeToCanvas(e,t,a,n,i,s){s=s||document.createElement("canvas"),s.width=n,s.height=i;const l=s.getContext("2d");return l.imageSmoothingEnabled=!0,l.imageSmoothingQuality="high",l.drawImage(e,0,0,n,i),s}getImageData(e){return e.getContext("2d").getImageData(0,0,e.width,e.height)}addToRasterizeQueue(e,t){const a=this.rasterizeQueue.find(s=>s.hash===e);if(a)return a.promise;let n;const i=new Promise(s=>{n=s});return this.rasterizeQueue.push({hash:e,svgUrl:t,resolve:n,promise:i}),i}optimizeImageData(e){}addToOptimizeQueue(e){}}const pe=class pe extends Ki{constructor(){super(...arguments);h(this,"renderer");h(this,"textureEncoding",An);h(this,"ktx2Loader");h(this,"texturesByHash",new Map);h(this,"layersByElement",new WeakMap);h(this,"layersByMesh",new WeakMap);h(this,"_compressedTexturePromise",new Map);h(this,"_canvasTexturePromise",new Map)}static initialize(t,a){pe.instance=new pe,pe.instance.renderer=t,pe.instance.ktx2Loader=a,pe.instance.ktx2Encoder.setWorkerLimit(1)}getTexture(t){const a=this.getTextureState(t);return this.texturesByHash.has(t)||this.texturesByHash.set(t,{}),this._loadCompressedTextureIfNecessary(a),this._loadCanvasTextureIfNecessary(a),this.texturesByHash.get(t)}_loadCompressedTextureIfNecessary(t){const a=t.ktx2Url;a&&(this._compressedTexturePromise.has(t.hash)||new Promise(n=>{this._compressedTexturePromise.set(t.hash,n),this.ktx2Loader.load(a,i=>{i.wrapS=_e,i.wrapT=_e,i.minFilter=wr,i.colorSpace=this.textureEncoding,this.texturesByHash.get(t.hash).compressedTexture=i,n(void 0)},()=>{},n)}))}_loadCanvasTextureIfNecessary(t){var i;const a=this.texturesByHash.get(t.hash);if(a.compressedTexture){(i=a.canvasTexture)==null||i.dispose(),a.canvasTexture=void 0;return}const n=t.canvas;if(n&&!a.canvasTexture&&!a.compressedTexture){const s=new ea(n);s.wrapS=_e,s.wrapT=_e,s.minFilter=wr,s.colorSpace=this.textureEncoding,s.flipY=!1,a.canvasTexture=s}}};h(pe,"instance");let Ue=pe;const Vr=new te,Hr=new te,qi=new Qe;class Yi extends st{constructor(t,a={}){super();h(this,"containerElement");h(this,"options");h(this,"rootLayer");h(this,"raycaster",new In);h(this,"_interactionRays",[]);h(this,"_hitIntersections",[]);h(this,"_previousHoverLayers",new Set);h(this,"_contentMeshes",[]);h(this,"_prepareHitTest",t=>{t.desiredPseudoStates.hover&&this._previousHoverLayers.add(t),t.cursor.visible=!1,t.desiredPseudoStates.hover=!1,t.contentMesh.visible&&this._contentMeshes.push(t.contentMesh)});a.manager||(a.manager=Ue.instance),this.options=a;const n=typeof t=="string"?kn(t):t;this.containerElement=E.createLayerTree(n,a,(i,{target:s})=>{var l,c,o,u;if(i==="layercreated"){const f=s.layer||new zt(s,this);s===n?(f[Bt]=()=>this._updateInteractions(),this.rootLayer=f,this.add(f)):(l=f.parentWebLayer)==null||l.add(f),(o=(c=this.options).onLayerCreate)==null||o.call(c,f)}else if(i==="layermoved"){const f=this.options.manager.layersByElement.get(s);(u=f.parentWebLayer)==null||u.add(f)}}),this.containerElement.container=this,this.refresh(),this.update()}get manager(){return this.options.manager}get interactionRays(){return this._interactionRays}set interactionRays(t){this._interactionRays=t}async updateUntilReady(){const t=setInterval(()=>{this.update()},20);this.rootLayer.setNeedsRefresh(!0),await this.rootLayer.refresh(!0),clearInterval(t)}update(){this.rootLayer.update(!0)}refresh(){this.rootLayer.refresh(!0)}querySelector(t){return this.rootLayer.querySelector(t)}get contentMesh(){return this.rootLayer.contentMesh}_intersectionSort(t,a){const n=t.object.parent,i=a.object.parent;return n.depth!==i.depth?i.depth-n.depth:i.index-n.index}_updateInteractions(){const t=this._previousHoverLayers;t.clear(),this._contentMeshes.length=0,this.rootLayer.traverseLayersPreOrder(this._prepareHitTest);for(const a of this._interactionRays){"isObject3D"in a&&a.isObject3D?this.raycaster.ray.set(a.getWorldPosition(Vr),a.getWorldDirection(Hr).negate()):this.raycaster.ray.copy(a),this._hitIntersections.length=0;const n=this.raycaster.intersectObjects(this._contentMeshes,!1,this._hitIntersections);n.sort(this._intersectionSort);const i=n[0];if(i){const s=i.object.parent;s.cursor.position.copy(i.point),s.cursor.visible=!0,s.desiredPseudoStates.hover=!0,t.has(s)||s.setNeedsRefresh()}}for(const a of t)a.desiredPseudoStates.hover||a.setNeedsRefresh()}hitTest(t){const a=this.raycaster,n=this._hitIntersections,i=this.options.manager.layersByMesh;"isObject3D"in t&&t.isObject3D?this.raycaster.ray.set(t.getWorldPosition(Vr),t.getWorldDirection(Hr).negate()):this.raycaster.ray.copy(t),n.length=0,a.intersectObject(this,!0,n),n.sort(this._intersectionSort);for(const s of n){const l=i.get(s.object);if(!l)continue;const c=l.bounds,o=l.margin,u=c.width+o.left+o.right,f=c.height+o.top+o.bottom;if(u*f===0)continue;let d=l.element;const m=s.uv.x*u-o.left,b=s.uv.y*f-o.top;return mt(l.element,p=>{if(!d.contains(p))return!1;const x=Jt(p,qi,l.element),{left:w,top:S,width:C,height:R}=x,M=w+C,T=S+R;return m>w&&m<M&&b>S&&b<T?(d=p,!0):!1}),{layer:l,intersection:s,target:d}}}destroy(){this.containerElement.remove(),this.removeFromParent(),this.rootLayer.dispose()}async downloadCache(t){await this.manager.saveStore();const a=new Set;this.rootLayer.traverseLayersPreOrder(i=>{if(!(t&&!t(i)))for(const s of i.allStateHashes)a.add(s)});const n=await this.manager.exportCache(Array.from(a));aa(n,"web."+this.rootLayer.element.id+".cache")}}function Qi(r,e=null,t={interactable:!0},a=Gt()){if(!fe)throw new Error("XRUI is not supported in nodejs");const n=document.createElement("div");if(n.style.position="fixed",n.id="xrui-"+r.name,Pn(n).render(ue.createElement(Ka.Provider,{value:a},ue.createElement(ta.Provider,{value:e},ue.createElement(r,null)))),!Ue.instance){const c=W(ge).viewerEntity,o=D(c,an),u=W(nn).ktx2Loader;Ue.initialize(o.renderer,u)}const s=new Yi(n,{manager:Ue.instance});s.raycaster.layers.enableAll();const l=new On;return l.name=n.id,l.add(s),l.preserveChildren=!0,sn(s,mr.UI),Jr.setLayer(a,mr.UI),A(a,ft,l),A(a,Z),A(a,Nt),A(a,qt,s),A(a,De,!0),t.interactable&&A(a,Te,{highlight:!1,grow:!0}),{entity:a,state:e,container:s}}const Ji=(r,e,t=!0,a=10,n=30,i=10,s=10)=>{const l=Gt();return Qi(()=>Zi({borderRadiusPx:a,contentVerticalPadPx:i,contentHorizontalPadPx:s}),Wa({interactMessage:e}),{interactable:t},l)},Zi=r=>{const e=ra(),t=ue.useRef(null);return fe?ue.createElement("div",{className:"modal",ref:t},e.interactMessage.value&&e.interactMessage.value!==""?e.interactMessage.value:"",ue.createElement("link",{href:"https://fonts.googleapis.com/css?family=Lato:400",rel:"stylesheet",type:"text/css"}),ue.createElement("style",null,`
        .modal {
          display: flex;
          justify-content: center;
          align-items: center;
          font-size: 50px;
          color: #e7e7e7;
          font-family: sans-serif;
          font-weight: 400;
          border: 4px solid #e7e7e7;
          border-radius: ${r.borderRadiusPx}px;
          padding-top: ${r.contentVerticalPadPx}px;
          padding-bottom: ${r.contentVerticalPadPx}px;
          padding-left: ${r.contentHorizontalPadPx}px;
          padding-right: ${r.contentHorizontalPadPx}px;
          margin: 60px;
          width: fit-content;
          height: fit-content;
          min-width: 50px;
          min-height: 50px;
          text-align: center;
          vertical-align: center;
        }
      `)):ue.createElement(ue.Fragment,null)};function es(r,e,t=!0,a=10,n=30,i=10,s=10){const l=Ji(r,e,t,a,n,i,s),c=D(r,Be);return A(l.entity,Be,"interact-ui-"+e+"-"+c),D(l.entity,qt).rootLayer.traverseLayersPreOrder(f=>{const d=f.contentMesh.material;d.transparent=!0}),D(l.entity,Z).scale.setScalar(1),l}new Ye;new _n;const ts=$a({name:"InteractableState",initial:()=>({available:[]})}),Na=new Map,ke={none:0,on:1,off:2},bt={proximity:0,hover:1},Wt=new te,rs=r=>{const e=D(r,Z);if(Wt.copy(e.position),ve(r,Y)){const t=D(r,Y);Wt.y+=t.avatarHeight}},Ee=new te,as=new te,ns=r=>{const e=Y.getSelfAvatarEntity()??W(ge).viewerEntity,t=ne(r,he);if(!e||!t||t.uiEntity==be)return;const a=ne(t.uiEntity,qt),n=ne(t.uiEntity,Z);if(!a||!n)return;const i=ne(r,dt);rs(e);const s=ve(t.uiEntity,De);if(s)if(i&&Zr(r),i&&i.box&&!i.box.isEmpty()){const p=i.box.getCenter(Ee),x=i.box.getSize(as);x.y||(x.y=1);const w=pr(.01,W(it).deltaSeconds);n.position.x=p.x,n.position.z=p.z,n.position.y=Ct.lerp(n.position.y,p.y+.7*x.y,w);const S=D(W(ge).viewerEntity,Z);n.rotation.copy(S.rotation)}else{Z.getWorldPosition(r,Ee);const p=pr(.01,W(it).deltaSeconds);n.position.x=Ee.x,n.position.z=Ee.z,n.position.y=Ct.lerp(n.position.y,Ee.y+.5,p);const x=D(W(ge).viewerEntity,Z);n.rotation.copy(x.rotation)}const l=Wt.distanceToSquared(n.position);s&&n.scale.setScalar(Ct.clamp(l*.01,1,5));const c=Na.get(r);let o=!1;const u=hn(t.uiEntity);let f=!1;if(u){if(t.uiVisibilityOverride===ke.none){if(t.uiActivationType===bt.proximity){let p=t.activationDistance;p*=p,o=l<p}if(!o&&(t.uiActivationType===bt.hover||t.clickInteract)){const p=ne(r,Te);p&&(f=p.inputSources.length>0,o=f)}}else o=t.uiVisibilityOverride!==ke.off;Pt(r,he).canInteract.set(o)}const d=Pt(r,he),m=f||r===W(ts).available[0];d.highlighted.value!==m&&d.highlighted.set(m),c.state==="OUT"&&o&&(c.setState("IN"),A(t.uiEntity,De)),c.state==="IN"&&!o&&c.setState("OUT");const b=W(it).deltaSeconds;c.update(b,p=>{p===0&&we(t.uiEntity,De),a.rootLayer.traverseLayersPreOrder(x=>{const w=x.contentMesh.material;w.opacity=p})})},is=r=>{const e=D(r,he);if(!e.label||e.label===""||e.uiEntity!=be)return;const t=es(r,e.label,e.uiInteractable).entity,a=D(t,Z),n=ne(r,dt);n&&n.box&&!n.box.isEmpty()?(Zr(r),n.box.getCenter(a.position)):(Z.getWorldPosition(r,Ee),a.position.copy(Ee)),Pt(r,he).uiEntity.set(t),A(t,qr,{parentEntity:W(ge).originEntity}),A(t,cn,{referenceEntities:[r,W(ge).viewerEntity],computeFunction:()=>ns(r)});const i=ln(.25);return i.setState("OUT"),Na.set(r,i),t},he=X({name:"InteractableComponent",jsonID:"EE_interactable",schema:y.Object({canInteract:y.Bool({default:!1,serialized:!1}),uiInteractable:y.Bool({default:!0,serialized:!1}),uiEntity:y.Entity({serialized:!1}),label:y.String({default:"E"}),uiVisibilityOverride:y.Enum(ke,{$comment:"A number enum, where: 0 represents 'none', 1 represents 'on', 2 represents 'off'",default:ke.none,serialized:!1}),uiActivationType:y.Enum(bt,{$comment:"A number enum, where: 0 represents 'proximity', 1 represents 'hover'",default:bt.proximity}),activationDistance:y.Number({default:2}),clickInteract:y.Bool({default:!1}),highlighted:y.Bool({default:!1,serialized:!1}),callbacks:y.Array(y.Object({callbackID:y.String(),target:y.EntityID()}))}),reactor:()=>{if(!fe)return null;const r=xt(),e=ye(r,he),t=Gr(Xr).isEditing,a=ra();return Kr(()=>(A(r,Nt),A(r,vr),A(r,dt),A(r,Te),()=>{we(r,Nt),we(r,vr),we(r,dt),we(r,Te)}),[]),Te.useExecuteWithInput(()=>{var i;const n=Te.getButtons(r);e.clickInteract.value&&(i=n.Interact)!=null&&i.up&&!n.Interact.dragging&&ss(r)},on.After,!0),V.useEffect(()=>{const n=qa(r);if(!t.value)return is(n),()=>{const i=Ya(r,he);if(!i)return;const s=i.uiEntity.value;s&&(i.uiEntity.set(be),Xt(s))}},[t.value]),V.useEffect(()=>{var i,s;const n=((i=e.label)==null?void 0:i.value)??"";(s=a.interactMessage)==null||s.set(n)},[e.label]),null}}),ss=r=>{var t;const e=D(r,he);for(const a of e.callbacks){if(a.target&&!ie.getEntityFromSameSourceByID(r,a.target))continue;const n=a.target?ie.getEntityFromSameSourceByID(r,a.target):r;if(n&&a.callbackID){const i=ne(n,un);if(!i)continue;(t=i.get(a.callbackID))==null||t(r,n)}}},os=y.LiteralUnion(["none","left","right"]),Ge=X({name:"GrabbableComponent",jsonID:"EE_grabbable",toJSON:()=>!0,grabbableCallbackName:"grabCallback",reactor:function(){const r=xt(),e=Kt(r,Ua),t=ye(r,he);return V.useEffect(()=>{fe&&dn(r,Ge.grabbableCallbackName,(a,n)=>cs(a))},[]),V.useEffect(()=>{t.uiVisibilityOverride.set(e?ke.off:ke.none)},[e,!!t]),null},grab:(r,e,t=W(fn).preferredHand)=>{!r||!ve(r,Dt)||!ve(e,Ge)||D(r,Dt)[t]||lr($t.setGrabbedObject({entityUUID:ie.get(e),grabberEntityUUID:ie.get(r),grabbed:!0,attachmentPoint:t}))},drop:(r,e)=>{!r||!ve(r,Dt)||!ve(e,Ge)||lr($t.setGrabbedObject({entityUUID:ie.get(e),grabberEntityUUID:ie.get(r),grabbed:!1}))}}),cs=r=>{const e=gr.nonCapturedInputSources(),t=Y.getSelfAvatarEntity();for(const a of e){const n=D(a,gr);ve(r,Ua)?Ge.drop(t,r):Ge.grab(t,r,n.source.handedness==="left"?"left":"right")}},Ua=X({name:"GrabbedComponent",schema:y.Object({attachmentPoint:os,grabberEntity:y.Entity()})}),Dt=X({name:"GrabberComponent",schema:y.Object({left:y.Entity(),right:y.Entity()})});class $t{}h($t,"setGrabbedObject",ja({type:"ee.engine.grabbable.SET_GRABBED_OBJECT",entityUUID:fr,grabbed:ur.boolean,attachmentPoint:ur.literals("left","right").optional(),grabberEntityUUID:fr,$cache:!0,$topic:Ga.world}));const Fr=r=>{var e,t;return!!((t=(e=r.options)==null?void 0:e.metadata)!=null&&t.$isTexture)},ls=({name:r,jsonID:e,uniforms:t,onApply:a,update:n,reactor:i})=>{const s=X({name:r,jsonID:e,schema:t,reactor:({entity:l})=>{const c=ye(l,mn).material.value,o=ye(l,s).get(hr),u=Object.fromEntries(Object.entries(t.properties).filter(([d,m])=>Fr(m)).map(([d,m])=>[d,new At(null)])),f=Et(()=>Object.fromEntries(Object.entries(o).map(([d,m])=>Fr(t.properties[d])?[d,new At(null)]:[d,new At(m!==null&&typeof m=="object"&&"index"in m?null:m)]))).get(hr);for(const d in u){const m=o[d],[b]=pn(typeof m=="string"?m:"",l);u[d].value=b}return V.useEffect(()=>{const d=(m,b)=>{for(const p in f)m.uniforms[p]=f[p];a(m,b)};return vn(c,d),()=>{gn(c,d)}},[c]),Qa(()=>{const d=ne(l,s);if(d){n&&n(d,W(it).deltaSeconds);for(const m in f)f[m].value=m in u?u[m].value:d[m]}},{before:Ja,uuid:us(r,l)}),i?ue.createElement(i,{entity:l}):null}});return s},us=(r,e)=>r+"MaterialPluginUpdateSystem"+e,hs=`
			#define BOX_PROJECTED_ENV_MAP

			#if defined( USE_ENVMAP ) || defined( DISTANCE ) || defined ( USE_SHADOWMAP )

				vec4 worldPosition = modelMatrix * vec4( transformed, 1.0 );

				#ifdef BOX_PROJECTED_ENV_MAP

					vWorldPosition = worldPosition.xyz;

				#endif

			#endif
			`,fs=`
#ifdef USE_ENVMAP

#define BOX_PROJECTED_ENV_MAP

	#ifdef BOX_PROJECTED_ENV_MAP

		uniform vec3 cubeMapSize;
		uniform vec3 cubeMapPos;
		varying vec3 vWorldPosition;

		vec3 parallaxCorrectNormal( vec3 v, vec3 cubeSize, vec3 cubePos ) {

			vec3 nDir = normalize( v );
			vec3 rbmax = ( .5 * cubeSize + cubePos - vWorldPosition ) / nDir;
			vec3 rbmin = ( -.5 * cubeSize + cubePos - vWorldPosition ) / nDir;

			vec3 rbminmax;
			rbminmax.x = ( nDir.x > 0. ) ? rbmax.x : rbmin.x;
			rbminmax.y = ( nDir.y > 0. ) ? rbmax.y : rbmin.y;
			rbminmax.z = ( nDir.z > 0. ) ? rbmax.z : rbmin.z;

			float correction = min( min( rbminmax.x, rbminmax.y ), rbminmax.z );
			vec3 boxIntersection = vWorldPosition + nDir * correction;

			return boxIntersection - cubePos;
		}

	#endif

	vec3 getIBLIrradiance( const in vec3 normal ) {

		#ifdef ENVMAP_TYPE_CUBE_UV

			vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );

      #ifdef BOX_PROJECTED_ENV_MAP

      worldNormal = parallaxCorrectNormal( worldNormal, cubeMapSize, cubeMapPos );

      #endif

			worldNormal.x *= -1.;
			vec4 envMapColor = textureCubeUV( envMap, worldNormal, 1.0 );

			return PI * envMapColor.rgb * envMapIntensity;

		#else

			return vec3( 0.0 );

		#endif

	}

	vec3 getIBLRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness ) {

		#ifdef ENVMAP_TYPE_CUBE_UV

			vec3 reflectVec = reflect( - viewDir, normal );

			// Mixing the reflection with the normal is more accurate and keeps rough objects from gathering light from behind their tangent plane.
			reflectVec = normalize( mix( reflectVec, normal, roughness * roughness) );

			reflectVec = inverseTransformDirection( reflectVec, viewMatrix );

      #ifdef BOX_PROJECTED_ENV_MAP
        reflectVec = parallaxCorrectNormal( reflectVec, cubeMapSize, cubeMapPos );
      #endif

      reflectVec.x *= -1.;
			vec4 envMapColor = textureCubeUV( envMap, reflectVec, roughness );

			return envMapColor.rgb * envMapIntensity;

		#else

			return vec3( 0.0 );

		#endif

	}

	#ifdef USE_ANISOTROPY

		vec3 getIBLAnisotropyRadiance( const in vec3 viewDir, const in vec3 normal, const in float roughness, const in vec3 bitangent, const in float anisotropy ) {

			#ifdef ENVMAP_TYPE_CUBE_UV

			  // https://google.github.io/filament/Filament.md.html#lighting/imagebasedlights/anisotropy
				vec3 bentNormal = cross( bitangent, viewDir );
				bentNormal = normalize( cross( bentNormal, bitangent ) );
				bentNormal = normalize( mix( bentNormal, normal, pow2( pow2( 1.0 - anisotropy * ( 1.0 - roughness ) ) ) ) );

				return getIBLRadiance( viewDir, bentNormal, roughness );

			#else

				return vec3( 0.0 );

			#endif

		}

	#endif

#endif
`,ds=`

	#ifdef USE_ENVMAP

	uniform float reflectivity;

	#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( LAMBERT )

		#define ENV_WORLDPOS

	#endif

	#ifdef ENV_WORLDPOS

		varying vec3 vWorldPosition;
		uniform float refractionRatio;
	#else
		varying vec3 vReflect;
	#endif
  
  #define BOX_PROJECTED_ENV_MAP

  #ifdef BOX_PROJECTED_ENV_MAP

    uniform vec3 cubeMapSize;
    uniform vec3 cubeMapPos;

		vec3 parallaxCorrectNormal( vec3 v, vec3 cubeSize, vec3 cubePos ) {

			vec3 nDir = normalize( v );
			vec3 rbmax = ( .5 * cubeSize + cubePos - vWorldPosition ) / nDir;
			vec3 rbmin = ( -.5 * cubeSize + cubePos - vWorldPosition ) / nDir;

			vec3 rbminmax;
			rbminmax.x = ( nDir.x > 0. ) ? rbmax.x : rbmin.x;
			rbminmax.y = ( nDir.y > 0. ) ? rbmax.y : rbmin.y;
			rbminmax.z = ( nDir.z > 0. ) ? rbmax.z : rbmin.z;

			float correction = min( min( rbminmax.x, rbminmax.y ), rbminmax.z );
			vec3 boxIntersection = vWorldPosition + nDir * correction;

			return boxIntersection - cubePos;
		}
  #endif

#endif
`,ms=`

#ifdef USE_ENVMAP

	#ifdef ENV_WORLDPOS

		vec3 cameraToFrag;

		if ( isOrthographic ) {

			cameraToFrag = normalize( vec3( - viewMatrix[ 0 ][ 2 ], - viewMatrix[ 1 ][ 2 ], - viewMatrix[ 2 ][ 2 ] ) );

		} else {

			cameraToFrag = normalize( vWorldPosition - cameraPosition );

		}

		// Transforming Normal Vectors with the Inverse Transformation
		vec3 worldNormal = inverseTransformDirection( normal, viewMatrix );

		#ifdef ENVMAP_MODE_REFLECTION

			vec3 reflectVec = reflect( cameraToFrag, worldNormal );

		#else

			vec3 reflectVec = refract( cameraToFrag, worldNormal, refractionRatio );

		#endif

	#else

		vec3 reflectVec = vReflect;

	#endif
  
  #ifdef BOX_PROJECTED_ENV_MAP
  	reflectVec = parallaxCorrectNormal( reflectVec, cubeMapSize, cubeMapPos );
  #endif

	#ifdef ENVMAP_TYPE_CUBE

		reflectVec.x *= -1.;
		vec4 envColor = textureCube( envMap, vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );

	#elif defined( ENVMAP_TYPE_CUBE_UV )

		vec4 envColor = textureCubeUV( envMap, reflectVec, 1.0 );

	#else

		vec4 envColor = vec4( 0.0 );

	#endif

	outgoingLight += envColor.xyz * specularStrength * reflectivity;


#endif
`,Wr={Skybox:"Skybox",Bake:"Bake",Cubemap:"Cubemap",Equirectangular:"Equirectangular",Color:"Color",None:"None"},Ls=X({name:"EnvMapComponent",jsonID:"EE_envmap",schema:y.Object({type:y.LiteralUnion(Object.values(Wr),{default:Wr.Skybox}),envMapSourceColor:Le.Color("#8080FF"),envMapSourceURL:y.String(),envMapCubemapURL:y.String(),envMapSourceEntityUUID:y.EntityID(),envMapIntensity:y.Number({default:1})}),errors:["MISSING_FILE"]});ls({name:"BoxProjectionPlugin",jsonID:"IR_envmap_box_projection",uniforms:y.Object({cubeMapSize:Le.Vec3(),cubeMapPos:Le.Vec3()}),onApply:r=>{const e=r.shaderType,t=e==="MeshStandardMaterial"||e==="MeshPhysicalMaterial";(t||e==="MeshLambertMaterial"||e==="MeshPhongMaterial")&&(t?(r.vertexShader.startsWith("varying vec3 vWorldPosition")||(r.vertexShader=`varying vec3 vWorldPosition;
`+r.vertexShader),r.vertexShader=r.vertexShader.replace("#include <worldpos_vertex>",hs),r.fragmentShader=r.fragmentShader.replace("#include <envmap_physical_pars_fragment>",fs)):(r.fragmentShader=r.fragmentShader.replace("#include <envmap_pars_fragment>",ds),r.fragmentShader=r.fragmentShader.replace("#include <envmap_fragment>",ms)))}});const jt=.25,Ae=X({name:"AvatarControllerComponent",schema:y.Object({cameraEntity:y.Entity(),movementCaptured:y.Array(y.Entity()),isJumping:y.Bool(),isWalking:y.Bool(),isInAir:y.Bool(),verticalVelocity:y.Number(),gamepadJumpActive:y.Bool(),gamepadLocalInput:Le.Vec3(),gamepadWorldMovement:Le.Vec3()}),captureMovement(r,e){const t=D(r,Ae);t.movementCaptured.indexOf(e)===-1&&t.movementCaptured.push(e)},releaseMovement(r,e){const t=D(r,Ae),a=t.movementCaptured.indexOf(e);a!==-1&&t.movementCaptured.splice(a,1)},reactor:()=>{var c;const r=xt(),e=ht(r,Y),t=ye(r,Ae),a=yn.useCameraAttachedToAvatar(),n=ye(Yr.instance.cameraEntity,Yt),i=Lt.useWorld(r),s=ht(r,bn),l=Kt(t.cameraEntity.value,yr);return Kr(()=>{t.cameraEntity.set(W(ge).viewerEntity||be)},[]),V.useEffect(()=>{s&&(s.progress.value!==100?Ae.captureMovement(r,r):Ae.releaseMovement(r,r))},[(c=s==null?void 0:s.progress)==null?void 0:c.value]),V.useEffect(()=>{if(i)return Lt.createCharacterController(i,r,{}),i.cameraAttachedRigidbodyEntity=r,()=>{i.cameraAttachedRigidbodyEntity=be,Lt.removeCharacterController(i,r)}},[i]),V.useEffect(()=>{if(!e)return;const o=t.cameraEntity.value;if(o&&dr(o)&&ve(o,et)){const u=D(o,et);u.firstPersonOffset.set(0,e.eyeHeight.value,jt),u.thirdPersonOffset.set(0,e.eyeHeight.value,0)}},[e==null?void 0:e.avatarHeight,n.near]),V.useEffect(()=>{if(!e||a||!l)return;const o=D(r,Ae),u=D(o.cameraEntity,yr);return A(o.cameraEntity,et,{targetEntity:r,phi:u.phi,theta:u.theta,firstPersonOffset:new te(0,e.eyeHeight.value,jt),thirdPersonOffset:new te(0,e.eyeHeight.value,0)}),()=>{dr(o.cameraEntity)&&we(o.cameraEntity,et)}},[a,e,l]),null}}),Ba=X({name:"AvatarColliderComponent",schema:y.Object({colliderEntity:y.Entity()}),reactor({entity:r}){V.useEffect(()=>{const e=ne(r,Ba);return()=>{e!=null&&e.colliderEntity&&Xt(e.colliderEntity)}},[])}}),$r=X({name:"HelperComponent"});function ps(r,e,t,a=Qt.NodeHelper,n="helper"){const i=Et(be),s=ht(r,Be),l=ht(i.value,Z);return V.useEffect(()=>{if(!t)return;const c=vs(r,e,a),o=D(c,ft),u=o.children[0];return i.set(c),A(r,$r),typeof o.update=="function"&&o.update(),()=>{u?(u.material.dispose(),u.geometry.dispose()):o.dispose&&o.dispose(),we(r,$r),i.set(be),Xt(c)}},[t]),V.useEffect(()=>{i.value&&A(i.value,Be,`${(s==null?void 0:s.value)??r}-${n}`)},[i.value,s,t]),V.useEffect(()=>{if(!i.value||!l)return;const c=ne(i.value,ft);c&&typeof c.update=="function"&&c.update()},[l,i.value,t]),i.value}function vs(r,e,t=Qt.NodeHelper,a="-helper"){const n=Gt(),i=D(r,Be),s=e();return s.preserveChildren=!0,A(n,qr,{parentEntity:r}),A(n,Z),A(n,ft,s),A(n,Jr,t),A(n,De,!0),A(n,Be,`${i??r}-${a}`),A(n,Te,{grow:!0}),n}X({name:"AvatarHeadDecapComponent"});X({name:"AvatarIKTargetComponent",storage:{blendWeight:Za(Float64Array)},reactor:function(){const r=xt(),e=Et(Xa(En).avatarDebug);return ps(r,()=>new Dn(.125),e.value,Qt.AvatarHelper),null},getTargetEntity:(r,e)=>ie.getEntityByUUID(ie.join({entitySourceID:r,entityID:e}))});new te;X({name:"IKMatricesComponent",schema:y.Object({local:Le.Mat4(),world:Le.Mat4()})});X({name:"AvatarIKComponent"});const jr=.125,gs=r=>{const e=ne(r,Ba);if(!e)return;const t=e.colliderEntity,a=D(Yr.instance.cameraEntity,Yt),n=jt+a.near,s=D(r,Y).avatarHeight*.5;A(t,Z,{position:new te(0,s+jr,0),scale:new te(n,s-n-jr,n)})},Y=X({name:"AvatarComponent",schema:y.Object({avatarHeight:y.Number(),torsoLength:y.Number(),upperLegLength:y.Number(),lowerLegLength:y.Number(),footHeight:y.Number(),hipsHeight:y.Number(),armLength:y.Number(),footGap:y.Number(),footAngle:y.Number(),eyeHeight:y.Number()}),entityID:"avatar",getSelfSourceID(){return W(Xr).userID},getSelfAvatarUUID(){return ie.join({entitySourceID:Y.getSelfSourceID(),entityID:Y.entityID})},getUserAvatarEntity(r){return ys().find(e=>D(e,Qr).ownerId===r)},getSelfAvatarEntity(){return ie.getEntityByUUID(Y.getSelfAvatarUUID())},useSelfAvatarEntity(){return ie.useEntityByUUID(Y.getSelfAvatarUUID())},reactor:({entity:r})=>{const e=ye(W(ge).viewerEntity,Yt),t=ye(r,Y),a=Gr(xn),n=Y.useSelfAvatarEntity(),i=Kt(n,De);return V.useEffect(()=>{gs(r)},[t==null?void 0:t.avatarHeight,e.near]),V.useEffect(()=>{n!==be&&i!==a.isAvatarVisible.value&&wn(n,a.isAvatarVisible.value)},[i,n,a.isAvatarVisible]),null}}),ys=en([Qr,Y]);export{Y as A,Wr as E,he as I,$i as K,Pa as U,bt as X,ke as a,Ae as b,Ls as c};
