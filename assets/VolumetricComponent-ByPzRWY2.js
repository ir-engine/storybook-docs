var Vt=Object.defineProperty;var Gt=(r,t,e)=>t in r?Vt(r,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):r[t]=e;var je=(r,t,e)=>(Gt(r,typeof t!="symbol"?t+"":t,e),e);import{r as _}from"./index-CBqU2yxZ.js";import{c as Ae,S as f,b as he,e as Fe,f as be,i as lt,g as oe,s as ye,n as mt,p as Qe,H as dt,E as Xe,r as ke,h as Me,G as jt,o as ze,I as Ht}from"./index-_wFD3GG2.js";import{g as $,b as St,N as ne,i as Wt,j as Ke,n as Xt}from"./ActionFunctions-CxzuxLxN.js";import{bl as zt,bm as re,aq as Lt,o as gt,ab as Ze,L as et,n as tt,bn as Kt,at as _e,as as At,ar as ae,bo as qt,bp as $t}from"./EditorServices-BJKHmurs.js";import{A as Se,b as te,P as de,a as rt,c as Dt,g as Et}from"./MediaComponent-BbvQujMt.js";import{B as Pe,e as Rt,U as at,ap as ge,z as ht,H as Ce,ah as pt,p as Le,S as ot,i as Ut,t as Yt,g as nt,ai as Jt,V as Qt,a as le,an as wt,h as Pt,l as Zt,aq as er,ak as tr}from"./three.module-D2RMN07C.js";import{i as Ne}from"./XRState-BS8ja_cl.js";import{a as rr}from"./AssetType-LSGL9ANY.js";import{g as _t}from"./meshUtils-uAuBfJNJ.js";const ar=(r,t)=>{_.useEffect(()=>{var s,i;if(!r)return;let e=-1;const o=((s=r.requestVideoFrameCallback)==null?void 0:s.bind(r))??requestAnimationFrame,a=((i=r.cancelVideoFrameCallback)==null?void 0:i.bind(r))??cancelAnimationFrame,n=(l,y)=>{const p=(y==null?void 0:y.mediaTime)??r.currentTime;t(p,y),e=o(n)};return e=o(n),console.log({frameId:e}),()=>a(e)},[r])};class Ct{constructor(){this.decoderPath="",this.decoderPending=null,this.worker=null,this.lastRequest=0,this.callbacks={},this.defaultAttributes=[{name:"position",numComponents:"3"},{name:"normal",numComponents:"3"},{name:"color",numComponents:"4"},{name:"uv",numComponents:"2"}]}setDecoderPath(t){return this.decoderPath=t,this}load(t,e,o,a){this.decoderPending||this.preload(),this.decoderPending.then(()=>{const n=this.lastRequest++;this.worker.postMessage({request:n,url:t,byteStart:e,byteEnd:o}),this.callbacks[n]={onLoad:a}})}preload(){if(this.decoderPending)return this.decoderPending;let t=this,e=this.callbacks,o="corto.js";return this.decoderPending=this._loadLibrary(o,"text").then(a=>{a=URL.createObjectURL(new Blob([a])),this.worker=new Worker(a),this.worker.onmessage=function(n){var s=n.data;if(!e[s.request])return;const i=e[s.request],l=t._createGeometry(s.geometry);i.onLoad(l),delete e[s.request]}}),this.decoderPending}dispose(){return this.worker&&(this.worker.terminate(),this.worker=null),this}_createGeometry(t){if(!t)return null;var e=new Pe;t.index&&e.setIndex(new Rt(t.index,1));for(let o=0;o<this.defaultAttributes.length;o++){let a=this.defaultAttributes[o];if(!t[a.name])continue;let n=t[a.name];e.setAttribute(a.name,new Rt(n,a.numComponents))}return e}_loadLibrary(t,e){var o=new zt(this.manager);return o.setPath(this.decoderPath),o.setResponseType(e),new Promise((a,n)=>{o.load(t,a,void 0,n)})}}const ie=Ae({name:"UVOLDissolveComponent",schema:f.Object({currentTime:f.Number(0),duration:f.Number(2)}),createDissolveMaterial(r,t="#include <clipping_planes_pars_vertex>",e="#include <fog_vertex>",o="#include <clipping_planes_pars_fragment>",a="#include <opaque_fragment>"){const n=r.material,s="isShaderMaterial"in n,i=s?n.uniforms.map.value:n.map;r.geometry.boundingBox||r.geometry.computeBoundingBox();const l=r.geometry.boundingBox.min.y,p=r.geometry.boundingBox.max.y-l;let R={progress:{value:0},loadedHeight:{value:0},jitterWidth:{value:.1*p},repeat:{value:i.repeat},offset:{value:i.offset},origin_texture:{value:i}},E="",h="";if(s)E=n.vertexShader,h=n.fragmentShader,R=at.merge([n.uniforms,R]);else{const N=ge.basic;E=N.vertexShader,h=N.fragmentShader,Object.keys(N.uniforms).forEach(L=>{n[L]&&(R[L]=N.uniforms[L])})}R=at.merge([ht.lights,R]);let m=`
varying vec2 vUv;
varying float positionY;`;typeof t=="string"&&(m=t+m);let d=`
vUv = uv;
positionY = position.y;`;typeof e=="string"&&(d=e+d);let v=`
varying vec2 vUv;
varying float positionY;
uniform float loadedHeight;
uniform vec2 repeat;
uniform vec2 offset;
uniform sampler2D origin_texture;
uniform float jitterWidth;
uniform float progress;

vec4 sRGBToLinear( in vec4 value ) {
  return vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.a );
}`;typeof o=="string"&&(v=o+v);let A=`
float offset2 = positionY - loadedHeight;

vec2 transformedUV = vUv*repeat + offset;
vec4 textureColor = texture2D(origin_texture, transformedUV);

float jitterDelta = (rand(gl_FragCoord.xy) - 0.5) * 200.0; // [-100, 100]
float localJitter = jitterWidth * (100.0 + jitterDelta) / 100.0;

float lowerOffset = loadedHeight - localJitter;
float upperOffset = loadedHeight + localJitter;

float randomR = (sin(progress) * 0.5) + 0.5;
float randomG = .5;
float randomB = (cos(progress) * 0.5) + 0.5;

if (positionY < lowerOffset) {
  ${"isVideoTexture"in i?"gl_FragColor = sRGBToLinear(textureColor);":"gl_FragColor = textureColor;"}
} else if (positionY > upperOffset) {
  discard;
} else {
  gl_FragColor.r = randomR;
  gl_FragColor.g = randomG;
  gl_FragColor.b = randomB;
}`;typeof a=="string"&&(A=a+A),E=E.replace(t,m),E=E.replace(e,d),h=h.replace(o,v),h=h.replace(a,A);const D=new Ce({uniforms:R,vertexShader:E,fragmentShader:h,lights:!0,fog:!1,transparent:n.transparent});return D.needsUpdate=!0,D.visible=n.visible,D},updateDissolveEffect(r,t,e){const o=he(r,ie);if(!o||!t.material.uniforms.progress)return!0;o.currentTime+=e,t.geometry.boundingBox||t.geometry.computeBoundingBox();const a=t.geometry.boundingBox.min.y,n=t.geometry.boundingBox.max.y,s=o.duration,i=Math.min(n,Math.max(a,a+(n-a)*(o.currentTime/s)));return t.material.uniforms.loadedHeight.value=i,t.material.uniforms.progress.value=o.currentTime/s,o.currentTime>=s}}),or=(r,t,e)=>new Promise((o,a)=>{$(re).cortoLoader.load(r,t,e,n=>{o(n)})}),qe=Ae({name:"UVOL1Component",schema:f.Object({manifestPath:f.String(""),data:f.Object({maxVertices:f.Number(),maxTriangles:f.Number(),frameData:f.Array(f.Object({frameNumber:f.Number(),keyframeNumber:f.Number(),startBytePosition:f.Number(),vertices:f.Number(),faces:f.Number(),meshLength:f.Number()})),frameRate:f.Number()},{}),firstGeometryFrameLoaded:f.Bool(!1),loadingEffectStarted:f.Bool(!1),loadingEffectEnded:f.Bool(!1)}),onSet:(r,t,e)=>{e&&(e.manifestPath&&t.manifestPath.set(e.manifestPath),e.data&&t.data.set(e.data))},reactor:nr});function nr(){const r=Fe(),t=be(r,it),e=be(r,qe),o=lt(r,Ze),a=oe(r,te).value,n=$(Se).audioContext,s=a.element,i=_.useMemo(()=>new Map,[]),l=Kt?10:90,y=_.useMemo(()=>{const v=a.element,c=new pt(v);return c.generateMipmaps=!1,c.minFilter=Le,c.magFilter=Le,c.isVideoTexture=!0,c.update=()=>{},c.colorSpace=ot,c},[]),p=_.useMemo(()=>{const v=new Ut({color:16777215});return v.map=y,v},[]),R=_.useMemo(()=>new Yt(.001,.001),[]),E=_.useMemo(()=>new nt(R,p),[]),h=_.useRef(0),m=_.useRef(0);_.useEffect(()=>{if(!$(re).cortoLoader){const v=new Ct;v.setDecoderPath($(Lt).publicDomain+"/loader_decoders/"),v.preload(),St(re).cortoLoader.set(v)}return t.useLoadingEffect.value&&ye(r,ie),s.src=e.manifestPath.value.replace(".manifest",".mp4"),s.load(),s.addEventListener("ended",function v(){t.ended.set(!0),s.removeEventListener("ended",v)}),t.currentTrackInfo.duration.set(e.data.frameData.length/e.data.frameRate.value),()=>{gt(r,E),y.dispose();const v=e.data.value.frameData.length;d(v),i.clear(),s.src=""}},[]),_.useEffect(()=>{o&&(o.cast.set(!0),o.receive.set(!0))},[o]),_.useEffect(()=>{e.loadingEffectStarted.value&&!e.loadingEffectEnded.value||t.autoplay.value&&t.initialBuffersLoaded.value&&st(n,s,t)},[t.autoplay,t.initialBuffersLoaded,e.loadingEffectEnded]),_.useEffect(()=>{if(t.paused.value||!t.initialBuffersLoaded.value){s.pause();return}E.material!==p&&(E.material=p,E.material.needsUpdate=!0),st(n,s,t)},[t.paused]),_.useEffect(()=>{if(!e.firstGeometryFrameLoaded.value)return;let v=-1;const c=()=>{if(s.buffered.length===0){clearTimeout(v),v=window.setTimeout(c,200);return}E.geometry=i.get(0),E.geometry.attributes.position.needsUpdate=!0,y.needsUpdate=!0,he(Qe.instance.viewerEntity,et).renderer.initTexture(y),t.useLoadingEffect.value&&(E.material=ie.createDissolveMaterial(E),E.material.needsUpdate=!0,e.loadingEffectStarted.set(!0)),tt(r,E)};c()},[e.firstGeometryFrameLoaded]),ar(s,(v,c)=>{if(!c)return;const A=N=>{if(E.material instanceof Ce&&!Me(r,ie)){const L=E.material;E.material=p,E.material.needsUpdate=!0,L.dispose()}t.currentTrackInfo.currentTime.set(N/e.data.frameRate.value),i.has(N)&&(E.geometry=i.get(N),E.geometry.attributes.position.needsUpdate=!0,y.needsUpdate=!0,he(Qe.instance.viewerEntity,et).renderer.initTexture(y)),d(N)},D=Math.round(c.mediaTime*e.data.value.frameRate);A(D)}),_.useEffect(()=>{s.playbackRate=t.currentTrackInfo.playbackRate.value},[t.currentTrackInfo.playbackRate]),mt(()=>{if($(re).cortoLoader===null)return;const v=$(Xe).deltaSeconds;if(e.loadingEffectStarted.value&&!e.loadingEffectEnded.value&&ie.updateDissolveEffect(r,E,v)){ke(r,ie),E.material=p,E.material.needsUpdate=!0,e.loadingEffectEnded.set(!0);return}const c=e.data.value.frameData.length;if(m.current===c-1)return;const A=l*2,D=i.size>=Math.max(l*2,90),N=i.size>=A*5;if(h.current==0&&!N){const L=Math.min(m.current+l-1,c-1);for(let U=m.current;U<=L;U++){const M=e.manifestPath.value.replace(".manifest",".drcs"),O=e.data.value.frameData[U].startBytePosition,j=O+e.data.value.frameData[U].meshLength;h.current+=1,or(M,O,j).then(K=>{if(!K)throw new Error("VDEBUG Entity ${entity} Invalid geometry frame: "+U.toString());K.boundingSphere=new Jt().set(new Qt,1/0),i.set(U,K),h.current-=1,U===0&&e.firstGeometryFrameLoaded.set(!0)}).catch(K=>{console.error("Error decoding corto frame: ",U,K),h.current-=1}),m.current=L}D&&!t.initialBuffersLoaded.value&&t.initialBuffersLoaded.set(!0)}},{with:dt});const d=v=>{for(const[c,A]of i.entries())c<v&&(A.dispose(),i.delete(c))};return null}var Re=(r=>(r[r.DRACO_WITH_COMPRESSED_TEXTURE=0]="DRACO_WITH_COMPRESSED_TEXTURE",r[r.GLB_WITH_COMPRESSED_TEXTURE=1]="GLB_WITH_COMPRESSED_TEXTURE",r[r.UNIFORM_SOLVE_WITH_COMPRESSED_TEXTURE=2]="UNIFORM_SOLVE_WITH_COMPRESSED_TEXTURE",r))(Re||{});const sr={mp3:".mp3",wav:".wav",draco:".drc",glb:".glb","uniform-solve":".glb",ktx2:".ktx2","astc/ktx2":".ktx2",video:".mp4"},ut={mp3:".mp3",wav:".wav",draco:".drc","uniform-solve":".glb",ktx2:".ktx2","astc/ktx2":".ktx2"};var C=(r=>(r[r.Corto=0]="Corto",r[r.Draco=1]="Draco",r[r.Unify=2]="Unify",r))(C||{});const ir={draco:1,"uniform-solve":2},F=6e3,ur={baseColor:"map",normal:"normalMap",metallicRoughness:"metallicRoughnessMap",emissive:"emissiveMap",occlusion:"aoMap"};class ct{constructor(){je(this,"bufferedRange");je(this,"pendingRange");je(this,"metrics");this.bufferedRange=[],this.pendingRange=[],this.metrics={totalFetchTime:0,totalPlayTime:0}}lowerBound(t,e,o="startTime"){const a=t.length;let n=0,s=a-1,i=-1;for(;n<=s;){const l=Math.floor((n+s)/2);t[l][o]<=e?(i=l,n=l+1):s=l-1}return i}upperBound(t,e,o="endTime"){const a=t.length;let n=0,s=a-1,i=-1;for(;n<=s;){const l=Math.floor((n+s)/2);t[l][o]>e?(i=l,s=l-1):n=l+1}return i}updateEndTime(t,e=!1){const o=e?this.pendingRange:this.bufferedRange,a=o.length;if(t<0||t>=a)return;let n=t+1;for(;n<a&&o[t].endTime>=o[n].startTime;)o[t].endTime=Math.max(o[t].endTime,o[n].endTime),e||(this.bufferedRange[t].fetchTime=this.bufferedRange[t].fetchTime+this.bufferedRange[n].fetchTime),n++;o.splice(t+1,n-1-t)}addBufferedRange(t,e,o){this.removePendingRange(t,e),this.addRange(t,e,o,!1)}addPendingRange(t,e){this.removeBufferedRange(t,e),this.addRange(t,e,0,!0)}addRange(t,e,o,a){const n=a?this.pendingRange:this.bufferedRange;if(t>=e)return;a||(this.metrics.totalFetchTime+=o,this.metrics.totalPlayTime+=e-t);const s=n.length,i=this.lowerBound(n,t);if(i===-1){n.unshift({startTime:t,endTime:e}),a||(n[0].fetchTime=o),this.updateEndTime(0);return}if(t>n[i].endTime){i===s-1?(n.push({startTime:t,endTime:e}),a||(n[s].fetchTime=o)):(n.splice(i+1,0,{startTime:t,endTime:e}),a||(n[i+1].fetchTime=o),this.updateEndTime(i+1));return}e<=n[i].endTime||(n[i].endTime=Math.max(n[i].endTime,e),a||(n[i].fetchTime+=o),this.updateEndTime(i))}removeBufferedRange(t,e){this.removeRange(t,e,!1)}removePendingRange(t,e){this.removeRange(t,e,!0)}removeRange(t,e,o){const a=o?this.pendingRange:this.bufferedRange;if(a.length===0||t>=e||e<=a[0].startTime||t>=a[a.length-1].endTime)return;t=Math.max(t,a[0].startTime),e=Math.min(e,a[a.length-1].endTime);let n=this.lowerBound(a,t,"startTime");if(n===-1)return;a[n].endTime<=t&&n++;let s=this.upperBound(a,e,"startTime");if(s===-1?s=a.length-1:s--,!(n>s))if(n<s){const i=a[s].endTime-a[s].startTime,l=o?0:a[s].fetchTime;e<a[s].endTime?(a[s].startTime=e,o||(a[s].fetchTime=l*(a[s].endTime-a[s].startTime)/i)):a.splice(s,1),a.splice(n+1,s-n-1);const y=a[n].endTime-a[n].startTime,p=o?0:a[n].fetchTime;a[n].startTime<t?(a[n].endTime=t,o||(a[n].fetchTime=p*(a[n].endTime-a[n].startTime)/y)):(a.splice(n,1),s--)}else{let i=n;const l=a[i].endTime-a[i].startTime,y=o?0:a[i].fetchTime,p=a[i].endTime;e<p&&(a.splice(i+1,0,{startTime:e,endTime:p}),o||(a[i+1].fetchTime=y*(a[i+1].endTime-a[i+1].startTime)/l)),a[i].startTime<t?(a[i].endTime=t,o||(a[i].fetchTime=y*(a[i].endTime-a[i].startTime)/l)):(a.splice(i,1),i--)}}getInterSectionDurationInternal(t,e,o){if(t.length===0||e>=o||o<=t[0].startTime||e>=t[t.length-1].endTime)return 0;e=Math.max(e,t[0].startTime),o=Math.min(o,t[t.length-1].endTime);const a=this.lowerBound(t,e,"startTime");let n=this.upperBound(t,o,"startTime");n===-1?n=t.length-1:n--;let s=0;for(let i=a;i<=n;i++)s+=Math.min(t[i].endTime,o)-Math.max(t[i].startTime,e);return s}getIntersectionDuration(t,e){const o=this.getInterSectionDurationInternal(this.bufferedRange,t,e),a=this.getInterSectionDurationInternal(this.pendingRange,t,e),n=e-t-o-a;return{bufferedDuration:o,pendingDuration:a,missingDuration:n}}getNextMissing(t){let e=t;if(this.bufferedRange.length===0&&this.pendingRange.length===0)return e;if(this.bufferedRange.length===0){const o=this.lowerBound(this.pendingRange,e,"startTime");return o===-1?e:this.pendingRange[o].endTime}else if(this.pendingRange.length===0){const o=this.lowerBound(this.bufferedRange,e,"startTime");return o===-1?e:this.bufferedRange[o].endTime}for(;;){const o=Math.max(this.bufferedRange.length>0?this.bufferedRange[this.bufferedRange.length-1].endTime:0,this.pendingRange.length>0?this.pendingRange[this.pendingRange.length-1].endTime:0);if(e>=o)return o;const a=this.lowerBound(this.bufferedRange,e,"startTime");if(a===-1)return e;const n=this.lowerBound(this.pendingRange,this.bufferedRange[a].endTime,"startTime");if(n===-1)return this.bufferedRange[a].endTime;if(this.pendingRange[n].endTime<=this.bufferedRange[a].endTime)return this.bufferedRange[a].endTime;e=this.pendingRange[n].endTime}}getBufferedUntil(t){const e=this.lowerBound(this.bufferedRange,t,"startTime");return e===-1?t:this.bufferedRange[e].endTime}getMetrics(){return this.metrics}resetMetrics(){this.metrics.totalFetchTime=0,this.metrics.totalPlayTime=0}}const vt=r=>{const t=r.attributes;let e=0;for(const o in t){const a=t[o];e+=a.array.byteLength}return e},fr=r=>{let t=vt(r.geometry);if(r.geometry.morphAttributes)for(const e in r.geometry.morphAttributes)r.geometry.morphAttributes[e].map(o=>{t+=o.array.byteLength});return t},cr=r=>{let t=0;return r.image&&r.mipmaps.map(e=>{t+=e.data.byteLength}),t},$e=[];let He=0;const lr=6,Nt=()=>{if(He>=lr||$e.length===0)return;const r=$e.shift();r&&(He++,dr(r.url,r.byteStart,r.byteEnd).then(t=>{r.resolve(t)}).catch(t=>{r.reject(t)}).finally(()=>{He--,He===0&&$e.length>0&&Nt()}))},mr=(r,t,e)=>new Promise((o,a)=>{$e.push({url:r,byteStart:t,byteEnd:e,resolve:o,reject:a}),Nt()}),dr=(r,t,e)=>{if(!$(re).cortoLoader)throw new Error("loadCorto:CORTOLoader is not available");return new Promise((o,a)=>{$(re).cortoLoader.load(r,t,e,n=>{n===null?a(`loadCorto:Failed to load Corto geometry frame from ${r} at bytes ${t} to ${e}`):o({geometry:n,memoryOccupied:vt(n)})})})},gr=r=>{const t=$(re).gltfLoader;if(!t)throw new Error("loadDraco:GLTFLoader is not available");const e=t.dracoLoader;if(!e)throw new Error("loadDraco:DracoLoader is not available");return new Promise((o,a)=>{const n=performance.now();e.load(r,s=>{o({geometry:s,fetchTime:performance.now()-n,memoryOccupied:vt(s)})},void 0,s=>{a(`loadDraco:Error loading draco geometry from ${r}: ${s.message}`)})})},kt=r=>{const t=$(re).gltfLoader;if(!t)throw new Error("loadDraco:GLTFLoader is not available");return new Promise((e,o)=>{const a=performance.now();t.load(r,({scene:n})=>{const s=_t(n);e({mesh:s,fetchTime:performance.now()-a,memoryOccupied:fr(s)})},void 0,n=>{console.error("Error loading geometry: ",r,n),o(`loadGLTF:Error loading geometry from ${r}: ${n.message}`)})})},hr=(r,t,e)=>{const o=$(re).gltfLoader;if(!o)throw new Error("loadKTX2:GLTFLoader is not available");const a=o.ktx2Loader;if(!a)throw new Error("loadKTX2:KTX2Loader is not available");const n=new le(1,1),s=new le(0,0);return new Promise((i,l)=>{const y=performance.now();a.load(r,p=>{p.repeat.copy(n),p.offset.copy(s),p.updateMatrix(),i({texture:p,fetchTime:performance.now()-y,memoryOccupied:cr(p)})},void 0,p=>{l(`loadKTX2:Error loading KTX2 Texture from ${r}: ${p.message}`)})})},Ye=(r,t)=>{let e=r;for(const o in t)e=e.replace(o,t[o]);return e},pr=(r,t,e,o,a)=>{const n={baseColor:{USE_MAP:"",MAP_UV:"uv"},normal:{USE_NORMALMAP:"",NORMALMAP_UV:"uv"},metallicRoughness:{USE_METALNESSMAP:"",METALNESSMAP_UV:"uv",USE_ROUGHNESSMAP:"",ROUGHNESSMAP_UV:"uv"},emissive:{USE_EMISSIVEMAP:"",EMISSIVEMAP_UV:"uv"},occlusion:{USE_AOMAP:"",AOMAP_UV:"uv"}},i=((h,m)=>{const d={};return h.forEach(v=>{n[v]&&Object.assign(d,n[v])}),m&&(d.DECODE_VIDEO_TEXTURE=""),d})(o,t),l={mixRatio:{value:0}};if(a)for(const h in a){const m=a[h];typeof m=="number"||typeof m=="boolean"?l[h]={value:m}:typeof m=="object"&&(m.x!==void 0&&m.y!==void 0?l[h]={value:new le(m.x,m.y)}:Array.isArray(m)&&m.length===2&&(l[h]={value:new le(m[0],m[1])}))}const y=e?"physical":"basic";let p=ge[y].vertexShader;const R=at.merge([ge[y].uniforms,ht.lights,l]);return r===C.Unify&&(p=Ye(ge[y].vertexShader,{"#include <clipping_planes_pars_vertex>":`#include <clipping_planes_pars_vertex>
attribute vec3 keyframeAPosition;
attribute vec3 keyframeBPosition;
attribute vec3 keyframeANormal;
attribute vec3 keyframeBNormal;
uniform float mixRatio;
uniform vec2 repeat;
uniform vec2 offset;
out vec2 custom_vUv;`,"#include <begin_vertex>":`
      vec3 transformed = vec3(position);
      transformed.x += mix(keyframeAPosition.x, keyframeBPosition.x, mixRatio); 
      transformed.y += mix(keyframeAPosition.y, keyframeBPosition.y, mixRatio);
      transformed.z += mix(keyframeAPosition.z, keyframeBPosition.z, mixRatio);
      
      #ifdef USE_ALPHAHASH
      
        vPosition = vec3( transformed );
      
      #endif`,"#include <beginnormal_vertex>":`
      vec3 objectNormal = vec3( normal );
      objectNormal.x += mix(keyframeANormal.x, keyframeBNormal.x, mixRatio);
      objectNormal.y += mix(keyframeANormal.y, keyframeBNormal.y, mixRatio);
      objectNormal.z += mix(keyframeANormal.z, keyframeBNormal.z, mixRatio);

      #ifdef USE_TANGENT

        vec3 objectTangent = vec3( tangent.xyz );

      #endif`})),new Ce({vertexShader:p,fragmentShader:ge[y].fragmentShader,uniforms:R,defines:i,lights:!0})},vr=r=>{const t=[];for(const e in r)r[e].format==="astc/ktx2"?(_e||Ne)&&t.push(e):t.push(e);return t.sort((e,o)=>{const a=r[e],n=r[o],s=a.frameRate*a.settings.resolution.width*a.settings.resolution.height,i=n.frameRate*n.settings.resolution.width*n.settings.resolution.height;return s-i}),t},ft=(r,t)=>t.startsWith("https://")||t.startsWith("http://")?t:r.substring(0,r.lastIndexOf("/")+1)+t,Bt=r=>{let t=0;for(let e=0;e<r.length;e++)r[e]==="#"&&t++;return t},Je=r=>{if(r.type==="geometry")if(r.geometryType===C.Corto){if(r.manifestPath.endsWith(".manifest"))return r.manifestPath.replace(".manifest",".drcs");if(r.manifestPath.endsWith(".mp4"))return r.manifestPath.replace(".mp4",".drcs");throw new Error("getResourceURL:Invalid manifest path for Corto geometry")}else{const t=ft(r.manifestPath,r.path),e=Bt(t),o="["+"#".repeat(e)+"]",a=r.index.toString().padStart(e,"0");return Ye(t,{"[ext]":ut[r.format],"[target]":r.target,[o]:a})}else if(r.type==="texture"){const t=ft(r.manifestPath,r.path),e=Bt(t),o="["+"#".repeat(e)+"]",a=r.index.toString().padStart(e,"0");return Ye(t,{"[ext]":ut[r.format],"[target]":r.target,"[type]":r.textureType,[o]:a})}else if(r.type==="audio"){const t=ft(r.manifestPath,r.path);return Ye(t,{"[ext]":ut[r.format]})}else throw new Error('getResourceURL:Invalid type. Must be either "geometry" or "texture"')},It=({geometryBuffer:r,currentTimeInMS:t,preferredTarget:e,geometryType:o,targets:a,...n})=>{const s=n.keyframeName;if(r.has(e)){const i=o===C.Corto?n.frameRate:n.targetData[e].frameRate;let l=t*i/1e3;o===C.Unify?l=s==="keyframeA"?Math.floor(l):Math.ceil(l):l=Math.round(l);const p=r.get(e)[l];if(p)return{geometry:p,target:e,index:l}}if(o===C.Corto)return!1;for(const i of a)if(r.has(i)){let l=t*n.targetData[i].frameRate/1e3;o===C.Unify?l=s==="keyframeA"?Math.floor(l):Math.ceil(l):l=Math.round(l);const p=r.get(i)[l];if(p)return{geometry:p,target:i,index:l}}return!1},yr=({textureBuffer:r,currentTimeInMS:t,preferredTarget:e,targets:o,targetData:a})=>{if(r.has(e)){const n=Math.round(t*a[e].frameRate/1e3),i=r.get(e)[n];if(i)return{texture:i,target:e,index:n}}for(const n of o)if(r.has(n)){const s=Math.round(t*a[n].frameRate/1e3),l=r.get(n)[s];if(l)return{texture:l,target:n,index:s}}return!1},Tr=({audioContext:r,media:t,paused:e})=>{const o=()=>{const a=he(Qe.instance.viewerEntity,et).canvas,n=()=>{t.play(),r.resume(),e.set(!1),window.removeEventListener("pointerdown",n),window.removeEventListener("keypress",n),window.removeEventListener("touchstart",n),a.removeEventListener("pointerdown",n),a.removeEventListener("touchstart",n)};window.addEventListener("pointerdown",n),window.addEventListener("keypress",n),window.addEventListener("touchstart",n),a.addEventListener("pointerdown",n),a.addEventListener("touchstart",n)};t.play().catch(a=>{a.name==="NotAllowedError"&&(o(),console.log("Ready to play Sir!"))}).then(()=>{console.log("Media playback started by handleAutoplay"),e.set(!1)})},ue={geometry:{[C.Corto]:{desktopMaxBufferDuration:36,mobileMaxBufferDuration:15,initialBufferDuration:7,minBufferDurationToPlay:4},[C.Draco]:{desktopMaxBufferDuration:4,mobileMaxBufferDuration:3,initialBufferDuration:3,minBufferDurationToPlay:2},[C.Unify]:{desktopMaxBufferDuration:10,mobileMaxBufferDuration:5,initialBufferDuration:3,minBufferDurationToPlay:.75}},texture:{ktx2:{desktopMaxBufferDuration:8,mobileMaxBufferDuration:3,initialBufferDuration:3,minBufferDurationToPlay:.75},"astc/ktx2":{desktopMaxBufferDuration:6,mobileMaxBufferDuration:3,initialBufferDuration:3,minBufferDurationToPlay:.75}}},br=({currentTimeInMS:r,bufferData:t,target:e,manifest:o,geometryType:a,manifestPath:n,geometryBuffer:s,mesh:i,initialBufferLoaded:l,startTimeInMS:y,repeat:p,offset:R})=>{if(Object.keys(o).length===0)return;const E=r*(F/1e3),h=t.getNextMissing(E),m=a===C.Corto?o.frameRate:o.geometry.targets[e].frameRate,d=a===C.Corto?o.frameData.length:o.geometry.targets[e].frameCount,v=a===C.Corto?d/m:o.duration,c=Math.floor(h*m/F),A=Math.max(0,Math.min(_e||Ne?ue.geometry[a].mobileMaxBufferDuration:ue.geometry[a].desktopMaxBufferDuration,v-r/1e3));if(c>=d||h-E>=A*F)return;const D=Math.min(d-1,Math.floor((E+A*F)*m/F));if(D<c)return;s.has(e)||s.set(e,[]);const N=s.get(e);for(let L=c;L<=D;){const U=L;if(a===C.Corto){const M=U*F/m,O=(U+1)*F/m;if(t.getIntersectionDuration(M,O).missingDuration===0){L++;continue}t.addPendingRange(M,O);const K=Je({type:"geometry",geometryType:C.Corto,manifestPath:n}),Y=o.frameData[U].startBytePosition,H=Y+o.frameData[U].meshLength;mr(K,Y,H).then(J=>{const Z=J.geometry;if(N[U]=Z,t.addBufferedRange(M,O,-1),!l.value){const q=y*F/1e3,me=q+ue.geometry[a].initialBufferDuration*F,pe=t.getIntersectionDuration(q,me);pe.missingDuration===0&&pe.pendingDuration===0&&l.set(!0)}}).catch(J=>{console.warn("Error in loading corto frame: ",J)}),L++}else if(a===C.Draco){const M=U*F/m,O=(U+1)*F/m;if(t.getIntersectionDuration(M,O).missingDuration===0){L++;continue}t.addPendingRange(M,O);const K=Je({type:"geometry",geometryType:a,manifestPath:n,target:e,index:L,path:o.geometry.path,format:o.geometry.targets[e].format});(a===C.Draco?gr:kt)(K).then(H=>{const J=a===C.Draco?H.geometry:H.mesh;if(N[L]=J,t.addBufferedRange(M,O,-1),!l.value){const Z=y*F/1e3,q=Z+ue.geometry[a].initialBufferDuration*F,me=t.getIntersectionDuration(Z,q);me.missingDuration===0&&me.pendingDuration===0&&l.set(!0)}}).catch(H=>{console.warn("Error in loading draco frame: ",H)}),L++}else if(a===C.Unify){const M=o.geometry.targets[e],O=M.segmentFrameCount,j=Math.floor(U/O),K=j*O,Y=j*M.settings.segmentSize*F,H=(j+1)*M.settings.segmentSize*F;if(t.getIntersectionDuration(Y,H).missingDuration===0){L+=O;continue}t.addPendingRange(Y,H);const Z=Je({type:"geometry",geometryType:C.Unify,manifestPath:n,target:e,index:j,path:o.geometry.path,format:"uniform-solve"});kt(Z).then(q=>{const me=q.mesh.geometry.morphAttributes.position,pe=q.mesh.geometry.morphAttributes.normal;if(me.map((fe,Q)=>{N[K+Q]={position:fe,normal:pe?pe[Q]:void 0}}),i.geometry.attributes.position.count!==q.mesh.geometry.attributes.position.count){if(q.mesh.material.map){const Q=q.mesh.material.map;Q&&(p.current.copy(Q.repeat),R.current.copy(Q.offset))}console.log("Initiailizing Unify Geometry");const fe=i.material;i.copy(q.mesh),i.material=fe,i.material.needsUpdate=!0;for(const Q in q.mesh.geometry.attributes)i.geometry.attributes[Q]=q.mesh.geometry.attributes[Q],i.geometry.attributes[Q].needsUpdate=!0;q.mesh.geometry.index&&(i.geometry.index=q.mesh.geometry.index,i.geometry.index.needsUpdate=!0),i.geometry.morphAttributes={},i.morphTargetDictionary=void 0,i.morphTargetInfluences=void 0}if(t.addBufferedRange(Y,H,q.fetchTime),!l.value){const fe=y*F/1e3,Q=fe+ue.geometry[a].initialBufferDuration*F,Oe=t.getIntersectionDuration(fe,Q);Oe.missingDuration===0&&Oe.pendingDuration===0&&l.set(!0)}}).catch(q=>{console.warn("Error in loading unify frame: ",q)}),L+=O}}},Ft=({currentTimeInMS:r,bufferData:t,geometryType:e,geometryBuffer:o,targetData:a,frameRate:n,mesh:s,clearAll:i=!1})=>{if(e===C.Corto||e===C.Draco){let l=n||1;for(const[y,p]of o){if(!o.has(y)||!p||!a||!a[y])continue;e===C.Draco&&(l=a?a[y].frameRate:1);const R=[];p.every((E,h)=>{const m=h*1e3/l,d=(h+1)*1e3/l;return!i&&d>=r?!1:(E.dispose(),R.push(h),!i&&t&&t.removeBufferedRange(m*(F/1e3),d*(F/1e3)),!0)}),R.forEach(E=>{delete p[E]})}}else if(e===C.Unify){const l=s.geometry,y=s.geometry.index,p=new Pe;p.setIndex(y);for(const R in s.geometry.attributes)p.setAttribute(R,s.geometry.attributes[R]),l.deleteAttribute(R);p.boundingSphere=s.geometry.boundingSphere,p.boundingBox=s.geometry.boundingBox,s.geometry=p;for(const[R,E]of o){if(!o.has(R)||!E||!a||!a[R])continue;const h=[],m=a?a[R].frameRate:1;E.every((d,v)=>{const c=v*1e3/m,A=(v+1)*1e3/m;if(!i&&A>=r)return!1;const D=d;return l.setAttribute(`position_${v}`,D.position),D.normal&&l.setAttribute(`normal_${v}`,D.normal),h.push(v),!i&&t&&t.removeBufferedRange(c*(F/1e3),A*(F/1e3)),!0}),h.forEach(d=>{delete E[d]}),l.dispose()}}},xr=({currentTimeInMS:r,bufferData:t,target:e,manifest:o,textureType:a,manifestPath:n,textureBuffer:s,textureFormat:i,initialBufferLoaded:l,startTimeInMS:y})=>{var A,D,N;const p=r*(F/1e3),R=t.getNextMissing(p),E=(A=o.texture[a])==null?void 0:A.targets[e].frameRate,h=(D=o.texture[a])==null?void 0:D.targets[e].frameCount,m=Math.floor(R*E/F),d=Math.max(0,Math.min(_e||Ne?ue.texture[i].mobileMaxBufferDuration:ue.texture[i].desktopMaxBufferDuration,o.duration-r/1e3));if(m>=h||R-p>=d*F)return;const v=Math.min(h-1,Math.floor((p+d*F)*E/F));if(v<m)return;s.has(e)||s.set(e,[]);const c=s.get(e);for(let L=m;L<=v;L++){const U=L,M=E>0?U*F/E:0,O=E>0?(U+1)*F/E:o.duration*F;if(t.getIntersectionDuration(M,O).missingDuration===0)continue;t.addPendingRange(M,O);const K=Je({type:"texture",textureType:a,format:(N=o.texture[a])==null?void 0:N.targets[e].format,index:U,target:e,path:o.texture.baseColor.path,manifestPath:n});hr(K).then(Y=>{if(c[U]=Y.texture,t.addBufferedRange(M,O,Y.fetchTime),!l.value){const H=y*F/1e3,J=H+ue.texture[i].initialBufferDuration*F,Z=t.getIntersectionDuration(H,J);Z.missingDuration===0&&Z.pendingDuration===0&&l.set(!0)}}).catch(Y=>{console.warn("Error in loading ktx2 frame: ",Y)})}},Ot=({currentTimeInMS:r,bufferData:t,textureBuffer:e,textureType:o,targetData:a,clearAll:n=!1})=>{for(const[s,i]of e){if(!i||!a||!a[s])continue;const l=a?a[s].frameRate:1;if(l===0)continue;const y=[];i.every((p,R)=>{const E=R*1e3/l,h=(R+1)*1e3/l;return l===0?(n&&(p.dispose(),y.push(R),t&&(t==null||t.removeBufferedRange(0,1/0))),!1):!n&&h>=r?!1:(p.dispose(),y.push(R),!n&&t&&t.removeBufferedRange(E*(F/1e3),h*(F/1e3)),!0)}),y.forEach(p=>{delete i[p]})}},Be=Ae({name:"PlaylistComponent",jsonID:"EE_playlist",schema:f.Object({tracks:f.Array(f.Object({uuid:f.String(),src:f.String()})),currentTrackUUID:f.String(""),currentTrackIndex:f.Number(-1),paused:f.Bool(!0),playMode:f.Enum(de,de.loop),autoplay:f.Bool(!0)}),toJSON:r=>({tracks:r.tracks,playMode:r.playMode,autoplay:r.autoplay}),playNextTrack:(r,t=1)=>{const e=oe(r,Be),o=e.tracks.value.length;if(o!==0){if(o===1||e.playMode.value===de.singleloop){const a=e.currentTrackUUID.value;e.currentTrackUUID.set(""),e.currentTrackUUID.set(a);return}if(e.playMode.value===de.loop){const a=(e.currentTrackIndex.value+t+o)%o;e.currentTrackUUID.set(e.tracks[a].uuid.value)}else if(e.playMode.value===de.random){let a=(Math.floor(Math.random()*o)+o)%o;for(;a===e.currentTrackIndex.value;)a=(Math.floor(Math.random()*o)+o)%o;e.currentTrackUUID.set(e.tracks[a].uuid.value)}}},reactor:()=>{const r=Fe(),t=be(r,Be),e=o=>{for(let a=0;a<t.tracks.length;a++)if(t.tracks[a].uuid.value===o)return{track:t.tracks[a].get(ne),index:a};return{track:void 0,index:-1}};return _.useEffect(()=>{const o=e(t.currentTrackUUID.value).index;t.currentTrackIndex.set(o)},[t.currentTrackUUID,t.tracks]),_.useEffect(()=>{if(t.tracks.length===0){t.merge({currentTrackUUID:"",currentTrackIndex:-1});return}},[t.tracks]),_.useEffect(()=>{if(t.autoplay.value&&t.tracks.length>0){let o=-1;for(let a=0;a<t.tracks.length;a++)if(t.tracks[a].src.value!==""){o=a;break}if(o===-1)return;t.currentTrackUUID.value===""&&(t.merge({currentTrackUUID:t.tracks[o].uuid.value,currentTrackIndex:o}),t.paused.set(!1))}},[t.autoplay,t.tracks]),null}}),P={},Er={useVideoTextureForBaseColor:!1,useLoadingEffect:!0,volume:1,checkForEnoughBuffers:!0,notEnoughBuffers:!0,time:{start:0,checkpointAbsolute:-1,checkpointRelative:0,currentTime:0,bufferedUntil:0,duration:0},geometry:{targets:[],initialBufferLoaded:!1,firstFrameLoaded:!1,currentTarget:0,userTarget:-1},geometryType:void 0,textureBuffer:void 0,setIntervalId:-1,texture:{},textureInfo:{textureTypes:[],initialBufferLoaded:{},firstFrameLoaded:{}},paused:!0,preTrackBufferingCallback:void 0},Rr={useVideoTextureForBaseColor:!1,checkForEnoughBuffers:!0,notEnoughBuffers:!0,time:{start:0,checkpointAbsolute:-1,checkpointRelative:0,currentTime:0,bufferedUntil:0,duration:0},geometry:{targets:[],initialBufferLoaded:!1,firstFrameLoaded:!1,currentTarget:0,userTarget:-1},geometryType:void 0,textureBuffer:void 0,setIntervalId:-1,texture:{},textureInfo:{textureTypes:[],initialBufferLoaded:{},firstFrameLoaded:{}},paused:!0},Ue=f.LiteralUnion(["normal","metallicRoughness","emissive","occlusion","baseColor"]);f.Optional(f.Func([f.Type()],f.Void()));const X=Ae({name:"NewVolumetricComponent",jsonID:"EE_NewVolumetric",schema:f.Object({useVideoTextureForBaseColor:f.Bool(!1),useLoadingEffect:f.Bool(!0),volume:f.Number(1),checkForEnoughBuffers:f.Bool(!0),notEnoughBuffers:f.Bool(!0),time:f.Object({start:f.Number(0),checkpointAbsolute:f.Number(-1),checkpointRelative:f.Number(0),currentTime:f.Number(0),bufferedUntil:f.Number(0),duration:f.Number(0)}),geometry:f.Object({targets:f.Array(f.String()),initialBufferLoaded:f.Bool(!1),firstFrameLoaded:f.Bool(!1),currentTarget:f.Number(0),userTarget:f.Number(-1)}),geometryType:f.Enum(C),textureBuffer:f.Type(new Map),setIntervalId:f.Number(-1),texture:f.Record(Ue,f.Object({initialBufferLoaded:f.Bool(),firstFrameLoaded:f.Bool(),targets:f.Array(f.String()),currentTarget:f.Number(),userTarget:f.Number()})),textureInfo:f.Object({textureTypes:f.Array(Ue),initialBufferLoaded:f.Partial(f.Record(Ue,f.Bool())),firstFrameLoaded:f.Partial(f.Record(Ue,f.Bool()))}),paused:f.Bool(!0),preTrackBufferingCallback:f.Optional(f.Func([f.Type()],f.Void()))}),onSet:(r,t,e)=>{e&&(typeof e.useLoadingEffect=="boolean"&&t.useLoadingEffect.set(e.useLoadingEffect),typeof e.volume=="number"&&t.volume.set(e.volume))},toJSON:r=>({useLoadingEffect:r.useLoadingEffect,volume:r.volume}),errors:["INVALID_TRACK","GEOMETRY_ERROR","TEXTURE_ERROR","UNKNOWN_ERROR"],canPlayWithoutPause:r=>{const t=oe(r,X),e=P[r].manifest;if(Object.keys(e).length===0)return!1;const o=t.time.currentTime.value,a=P[r].geometryBufferData;let n=-1;const s=t.geometryType.value;if(s===C.Corto){const R=e.frameData.length,E=e.frameRate;n=R*1e3/E}else if(s===C.Unify||s===C.Draco)n=e.duration*1e3;else return console.error("Invalid geometry type"),!1;if(!t.geometry.initialBufferLoaded.value)return!1;const i=o*F/1e3,l=Math.min(n*F/1e3,i+ue.geometry[s].minBufferDurationToPlay*F),y=a.getIntersectionDuration(i,l);if(y.missingDuration>0||y.pendingDuration>0)return X.adjustGeometryTarget(r,1),!1;if(t.useVideoTextureForBaseColor.value)return!0;const p=t.textureInfo.textureTypes.value;for(const R of p){const E=t.texture[R].get(ne),h=P[r].texture[R];if(!E||!h||!t.textureInfo.initialBufferLoaded.value[R])return!1;const m=h.bufferData,d=E.targets[E.currentTarget],v=e.texture[R].targets[d].format,c=Math.min(n*F/1e3,i+ue.texture[v].minBufferDurationToPlay*F),A=m.getIntersectionDuration(i,c);if(A.missingDuration>0||A.pendingDuration>0)return X.adjustTextureTarget(r,R,1),!1}return!0},adjustGeometryTarget:(r,t)=>{const e=oe(r,X);if(e.geometry.userTarget.value!==-1){e.geometry.currentTarget.value!==e.geometry.userTarget.value&&e.geometry.currentTarget.set(e.geometry.userTarget.value);return}const o=e.geometryType.value,a=P[r].geometryBufferData;if(o!==C.Corto){const{totalFetchTime:n,totalPlayTime:s}=a.getMetrics();if(t===void 0&&s<4*F)return;const i=t===void 0?n/s:t;i>=.5?e.geometry.currentTarget.value>0&&(console.log("Decreasing geometry target, from ",e.geometry.currentTarget.value),e.geometry.currentTarget.set(l=>l-1)):i<=.1&&e.geometry.currentTarget.value<e.geometry.targets.value.length-1&&(console.log("Increasing geometry target from ",e.geometry.currentTarget.value),e.geometry.currentTarget.set(l=>l+1)),t===void 0&&a.resetMetrics()}},adjustTextureTarget:(r,t,e)=>{const o=oe(r,X),a=o.texture[t].get(ne),n=P[r].texture[t];if(a&&n){if(a.userTarget!==-1){a.currentTarget!==a.userTarget&&o.texture[t].merge({currentTarget:a.userTarget});return}const s=n.bufferData,{totalFetchTime:i,totalPlayTime:l}=s.getMetrics();if(e===void 0&&l<4*F)return;const y=e===void 0?i/l:e;y>=.5?a.currentTarget>0&&o.texture[t].merge({currentTarget:a.currentTarget-1}):y<=.1&&a.currentTarget<a.targets.length-1&&o.texture[t].merge({currentTarget:a.currentTarget+1}),e===void 0&&s.resetMetrics()}},cleanupTrack:r=>{const t=oe(r,X);console.log("Cleaning up track"),clearInterval(t.setIntervalId.value),console.log("Cleared buffer loop interval: ",t.setIntervalId.value);const e=P[r].mesh;e&&P[r].group&&P[r].group.remove(e),P[r].group&&gt(r,P[r].group);const o=P[r].material,a=5*60*1e3,n=P[r].geometryBuffer;Object.keys(P[r].texture).forEach(y=>{const p=P[r].texture[y];if(p){const R=p.buffer;Ot({currentTimeInMS:a,textureBuffer:R,textureType:y,clearAll:!0}),R.clear()}});const i=o!=null&&o.vertexShader.includes("keyframeANormal")?C.Unify:C.Corto;Ft({currentTimeInMS:a,geometryBuffer:n,geometryType:i,mesh:e,clearAll:!0}),n.clear(),o&&o.dispose(),e&&e.geometry.dispose(),console.log("Setting track to initial state: ",Er),t.merge(structuredClone(Rr)),P[r].geometryBufferData=new ct;const l=jt(r,te);if(l){const y=l.element.get(ne);y.src=""}Me(r,X)&&At(r,X)},onRemove:r=>{X.cleanupTrack(r)},reactor:kr});function kr(){const r=Fe(),t=lt(r,Be),e=be(r,X),o=_.useRef(-1),a=$(Se).audioContext,n=$(Se).gainNodeMixBuses,s=_.useRef(new le(1,1)),i=_.useRef(new le(0,0));_.useEffect(()=>{if(!e.geometry.initialBufferLoaded.value)return;if(e.useVideoTextureForBaseColor.value){tt(r,P[r].group);const d=he(r,te).element;Tr({audioContext:a,media:d,paused:t.paused});return}const h=e.textureInfo.initialBufferLoaded.get(ne),m=e.textureInfo.textureTypes.value;for(const d of m)if(!h[d])return;t!=null&&t.autoplay.value&&(t!=null&&t.paused.value)?t.paused.set(!1):t!=null&&t.autoplay.value&&!(t!=null&&t.paused.value)&&(e.time.checkpointAbsolute.set(Date.now()),e.paused.set(!1)),console.log("All initial buffers loaded"),tt(r,P[r].group)},[e.geometry.initialBufferLoaded,e.textureInfo.initialBufferLoaded]);const l=()=>{var A;if(!Me(r,X)){clearInterval(o.current);return}const h=e.time.currentTime.value,m=e.geometry.targets[e.geometry.currentTarget.value].value,d=P[r].manifest,v=e.geometryType.value,c=(A=t==null?void 0:t.tracks.value.find(D=>D.uuid===t.currentTrackUUID.value))==null?void 0:A.src;c&&(br({currentTimeInMS:h,bufferData:P[r].geometryBufferData,target:m,manifest:d,geometryType:v,manifestPath:c,geometryBuffer:P[r].geometryBuffer,mesh:P[r].mesh,startTimeInMS:e.time.start.value,initialBufferLoaded:e.geometry.initialBufferLoaded,repeat:s,offset:i}),e.useVideoTextureForBaseColor.value||e.textureInfo.textureTypes.value.forEach(D=>{const N=e.texture[D].get(ne),L=P[r].texture[D];if(N&&L){const U=L.bufferData,M=L.buffer,O=N.targets[N.currentTarget],j=d.texture[D].targets[O].format;D in e.textureInfo.initialBufferLoaded.value||e.textureInfo.initialBufferLoaded.merge({[D]:!1});const K=e.textureInfo.initialBufferLoaded[D];xr({currentTimeInMS:h,bufferData:U,target:O,manifest:d,textureType:D,manifestPath:c,textureBuffer:M,textureFormat:j,startTimeInMS:e.time.start.value,initialBufferLoaded:K})}}))};_.useEffect(()=>{Me(r,te)||ye(r,te,{element:document.createElement("video")}),P[r]={material:null,mesh:null,group:new wt,manifest:{},geometryBufferData:new ct,geometryBuffer:new Map,texture:{}};const m=he(r,te).element;if(!rt.get(m)){const d=a.createMediaElementSource(m);Dt(m,d,n.soundEffects).gain.gain.setTargetAtTime(e.volume.value,a.currentTime,.1)}},[]),_.useEffect(()=>{const h=e.volume.value,m=ze(r,te);if(m){const d=m.element,v=rt.get(d);v&&v.gain.gain.setTargetAtTime(h,a.currentTime,.1)}},[e.volume]);const y=h=>{try{if(!h)return ae(r,X,"INVALID_TRACK","Manifest is empty"),!1;if(h.frameData!==void 0&&h.frameRate!==void 0){if(e.useVideoTextureForBaseColor.set(!0),e.geometryType.set(C.Corto),e.textureInfo.textureTypes.set(["baseColor"]),e.time.duration.set(h.frameData.length/h.frameRate),e.texture.set({baseColor:{targets:[],initialBufferLoaded:!1,firstFrameLoaded:!1,currentTarget:0,userTarget:-1}}),e.geometry.targets.set(["corto"]),!$(re).cortoLoader){const m=new Ct;m.setDecoderPath($(Lt).publicDomain+"/loader_decoders/"),m.preload(),St(re).cortoLoader.set(m)}}else if(h.duration!==void 0){const m=h;if(m.duration<=0||m.duration>10800)return ae(r,X,"INVALID_TRACK",`Invalid duration: ${m.duration}`),!1;e.useVideoTextureForBaseColor.set(!1),e.time.duration.set(m.duration);const d=Object.keys(m.geometry.targets);if(d.length===0)return ae(r,X,"GEOMETRY_ERROR","No geometry targets found"),!1;d.sort((A,D)=>{const N=m.geometry.targets[A],L=m.geometry.targets[D],U=N.settings.simplificationRatio??1,M=L.settings.simplificationRatio??1,O=N.frameRate*U,j=L.frameRate*M;return O-j}),d.forEach((A,D)=>{m.geometry.targets[A].priority=D}),e.geometry.targets.set(d);const v=ir[m.geometry.targets[d[0]].format];if(v===void 0)return ae(r,X,"GEOMETRY_ERROR","Invalid geometry format"),!1;e.geometryType.set(v);const c=Object.keys(m.texture);if(c.length===0)return ae(r,X,"TEXTURE_ERROR","No texture types found"),!1;if(!c.includes("baseColor"))return ae(r,X,"TEXTURE_ERROR","No baseColor texture found"),!1;e.textureInfo.textureTypes.set(c),c.forEach(A=>{var N;const D=(N=m.texture[A])==null?void 0:N.targets;if(D){if(Object.keys(D).length===0)return ae(r,X,"TEXTURE_ERROR",`No texture targets found for type: ${A}`),!1;const U=vr(D);U.forEach((M,O)=>{D[M].priority=O}),e.texture.merge({[A]:{targets:U,initialBufferLoaded:!1,firstFrameLoaded:!1,currentTarget:0,userTarget:-1}}),P[r].texture[A]={bufferData:new ct,buffer:new Map}}else return ae(r,X,"TEXTURE_ERROR",`No texture targets found for type: ${A}`),!1})}}catch(m){return ae(r,X,"UNKNOWN_ERROR","Error in reading the manifest"),console.error("Error in reading the manifest: ",m),!1}return At(r,X),console.log("Manifest read successfully"),h};_.useEffect(()=>{if(!(t!=null&&t.currentTrackUUID.value))return;X.cleanupTrack(r);const h=t.tracks.value.find(d=>d.uuid===t.currentTrackUUID.value);if(!h||!h.src){ae(r,X,"INVALID_TRACK","Track source is empty");return}let m=h.src;h.src.endsWith(".mp4")&&(m=h.src.replace(".mp4",".manifest")),fetch(m).then(d=>{if(!d.ok)throw new Error(`Unable to load the manifest: ${d.statusText}`);return d.json()}).then(d=>{const v=y(d);if(!v)return;P[r].manifest=v;const c=e.preTrackBufferingCallback.value;c&&c(e),e.time.currentTime.set(e.time.start.value);const A=e.geometryType.value!==C.Corto?e.geometry.targets[0].value:"",D=e.geometryType.value===C.Unify&&!v.geometry.targets[A].settings.excludeNormals,N=e.geometryType.value!==C.Corto?v.materialProperties:void 0;P[r].material=pr(e.geometryType.value,e.useVideoTextureForBaseColor.value,D,e.textureInfo.textureTypes.value,N),P[r].mesh=new nt(new Pt(.001,32,32),P[r].material),P[r].group.add(P[r].mesh),P[r].mesh.material=P[r].material,P[r].mesh.material.needsUpdate=!0;const L=setInterval(l,500);e.setIntervalId.set(L),o.current=L,console.log("Buffer loop started: ",L);const U=oe(r,te);if(e.useVideoTextureForBaseColor.value){const M=U.element.get(ne);if(e.useVideoTextureForBaseColor.value){M.playsInline=!0,M.preload="auto",M.crossOrigin="anonymous",M.src=h.src.replace(".manifest",".mp4"),M.currentTime=e.time.currentTime.value/1e3,M.load(),M.addEventListener("ended",()=>{t&&Be.playNextTrack(r)});const O=()=>{if(!e.textureInfo.firstFrameLoaded.get(ne).baseColor){const H=new pt(M);H.generateMipmaps=!1,H.minFilter=Le,H.magFilter=Le,H.isVideoTexture=!0,H.update=()=>{},H.colorSpace=ot,H.flipY=!0,P[r].mesh.material.uniforms.map.value=H,H.needsUpdate=!0,e.textureInfo.firstFrameLoaded.baseColor.set(!0),console.log("Video source set: ",M.src,M,H),M.removeEventListener("canplay",O)}};M.addEventListener("canplay",O);let j=-1;const K=(Y,H)=>{const J=H.mediaTime*1e3;E(J),e.time.currentTime.set(J),X.canPlayWithoutPause(r)||M.paused||(M.pause(),j=setInterval(()=>{X.canPlayWithoutPause(r)&&j!==-1&&(clearInterval(j),j=-1,!(t!=null&&t.paused.value)&&e.geometry.initialBufferLoaded.value&&M.play())},500));const Z=Math.round(H.mediaTime*v.frameRate),q=P[r].geometryBuffer.get("corto");q&&q[Z]&&(p(J),P[r].material.uniforms.map.value,P[r].material.uniforms.map.value&&(P[r].material.uniforms.map.value.needsUpdate=!0)),M.requestVideoFrameCallback(K)};M.requestVideoFrameCallback(K)}}}).catch(d=>{ae(r,X,"INVALID_TRACK","Error in loading the manifest"),console.error(`Error in loading the manifest: ${h.src}: `,d)})},[t==null?void 0:t.currentTrackUUID]),_.useEffect(()=>{console.log("Paused: ",e.paused.value);const h=Date.now(),m=ze(r,te);if(!t||t!=null&&t.paused.value){e.paused.set(!0),e.useVideoTextureForBaseColor.value&&m&&!m.element.paused&&m.element.pause();const d=e.time.checkpointAbsolute.value,v=d!==-1?e.time.checkpointRelative.value+h-d:e.time.start.value,c=h;e.time.merge({checkpointAbsolute:c,checkpointRelative:v})}else{const d=h;e.time.checkpointAbsolute.set(d),e.useVideoTextureForBaseColor.value&&m&&m.element.paused&&m.element.src&&m.element.play(),e.paused.set(!1)}},[t==null?void 0:t.paused]);const p=h=>{const m=P[r].geometryBuffer,d=P[r].mesh,v=e.geometryType.value,c=e.geometryType.value!==C.Corto?P[r].manifest.geometry.targets:void 0,A=e.geometryType.value===C.Corto?P[r].manifest.frameRate:void 0;X.adjustGeometryTarget(r);const D=e.geometry.targets[e.geometry.currentTarget.value].value;Ft({geometryBuffer:m,currentTimeInMS:h-500,geometryType:v,targetData:c,frameRate:A,mesh:d,bufferData:P[r].geometryBufferData});const N=It({geometryBuffer:m,currentTimeInMS:h,preferredTarget:D,geometryType:v,targets:e.geometry.targets.value,...v===C.Corto&&{frameRate:A},...v!==C.Corto&&{targetData:c},...v===C.Unify&&{keyframeName:"keyframeA"}});if(N){if(v===C.Corto||v===C.Draco){const L=N.geometry;d.geometry!==L&&(d.geometry=L,d.geometry.attributes.position.needsUpdate=!0)}}else if(v!==C.Unify){console.warn("Geometry frame not found at time: ",h/1e3);return}if(v===C.Unify){const L=N,U=It({geometryBuffer:m,currentTimeInMS:h,preferredTarget:D,geometryType:v,targets:e.geometry.targets.value,targetData:c,...v===C.Unify&&{keyframeName:"keyframeB"}});if(L&&(d.geometry.attributes.keyframeAPosition!==L.geometry.position&&(d.geometry.attributes.keyframeAPosition=L.geometry.position,d.geometry.attributes.keyframeAPosition.needsUpdate=!0),L.geometry.normal&&d.geometry.attributes.keyframeANormal!==L.geometry.normal&&(d.geometry.attributes.keyframeANormal=L.geometry.normal,d.geometry.attributes.keyframeANormal.needsUpdate=!0)),U&&(d.geometry.attributes.keyframeBPosition!==U.geometry.position&&(d.geometry.attributes.keyframeBPosition=U.geometry.position,d.geometry.attributes.keyframeBPosition.needsUpdate=!0),U.geometry.normal&&d.geometry.attributes.keyframeBNormal!==U.geometry.normal&&(d.geometry.attributes.keyframeBNormal=U.geometry.normal,d.geometry.attributes.keyframeBNormal.needsUpdate=!0)),!L&&!U)return;if(!L&&U)d.material.uniforms.mixRatio.value=1;else if(L&&!U)d.material.uniforms.mixRatio.value=0;else if(L&&U){const M=L.index*1e3/c[L.target].frameRate,O=U.index*1e3/c[U.target].frameRate,j=Math.abs(h-M),K=Math.abs(h-O),Y=j+K>0?j/(j+K):.5;d.material.uniforms.mixRatio.value=Y}}},R=h=>{const m=e.textureInfo.textureTypes.value,d=P[r].manifest,v=P[r].material;m.forEach(c=>{const A=e.texture[c].get(ne),D=d.texture[c].targets,N=P[r].texture[c];if(A&&N){X.adjustTextureTarget(r,c),Ot({textureBuffer:N.buffer,currentTimeInMS:h-500,bufferData:N.bufferData,textureType:c,targetData:D});const L=A.targets,U=A.targets[A.currentTarget],M=yr({textureBuffer:N.buffer,currentTimeInMS:h,preferredTarget:U,targets:L,textureType:c,targetData:D});if(!M){console.warn(`Texture frame not found at time: ${h/1e3}`),console.log(N.buffer,A);return}const O=ur[c],j=`${O}Transform`;v.uniforms[O].value!==M.texture&&(M.texture.repeat.set(s.current.x,s.current.y),M.texture.offset.set(i.current.x,i.current.y),M.texture.updateMatrix(),M.texture.matrixAutoUpdate=!1,O in v.uniforms?v.uniforms[O].value=M.texture:v.uniforms[O]={value:M.texture},v.uniforms[O].value.needsUpdate=!0,j in v.uniforms?v.uniforms[j].value.copy(M.texture.matrix):v.uniforms[j]={value:M.texture.matrix})}})},E=h=>{let m=Number.MAX_VALUE;const d=P[r].geometryBufferData;if(m=Math.min(m,d.getBufferedUntil(h*F/1e3)),!e.useVideoTextureForBaseColor.value){const v=e.textureInfo.textureTypes.value;for(const c of v){const A=e.texture[c].get(ne),D=P[r].texture[c];if(A&&D){const N=D.bufferData;m=Math.min(m,N.getBufferedUntil(h*F/1e3))}}}e.time.bufferedUntil.set(m*1e3/F)};return mt(()=>{const h=ze(r,Be);if(!h||e.geometryType.value===C.Corto&&e.useVideoTextureForBaseColor.value||h.paused||!h.currentTrackUUID)return;const m=Date.now(),d=e.paused.value||h.paused||e.notEnoughBuffers.value?e.time.checkpointRelative.value:e.time.checkpointRelative.value+m-e.time.checkpointAbsolute.value;if(d>e.time.duration.value*1e3){console.log("CurrentTime: ",d," Duration: ",e.time.duration.value*1e3),console.log("Track ended"),Be.playNextTrack(r);return}if(E(d),e.checkForEnoughBuffers.value)if(X.canPlayWithoutPause(r)){if(e.notEnoughBuffers.value){e.notEnoughBuffers.set(!1);const c=m;e.time.checkpointAbsolute.set(c)}}else{if(e.notEnoughBuffers.value)return;{e.notEnoughBuffers.set(!0);const c=e.time.checkpointAbsolute.value,A=c!==-1?e.time.checkpointRelative.value+m-c:e.time.start.value,D=m;e.time.merge({checkpointAbsolute:D,checkpointRelative:A});return}}const v=d;e.time.currentTime.set(v),p(d),e.useVideoTextureForBaseColor.value||R(d)},{with:dt}),null}const Br=r=>{const t=Object.keys(r.geometry.targets);t.sort((n,s)=>{const i=r.geometry.targets[n],l=r.geometry.targets[s],y=i.settings.simplificationRatio??1,p=l.settings.simplificationRatio??1,R=i.frameRate*y,E=l.frameRate*p;return R-E}),t.forEach((n,s)=>{r.geometry.targets[n].priority=s});const e={baseColor:[],normal:[],metallicRoughness:[],emissive:[],occlusion:[]};let o=!1;const a=Object.keys(r.texture);for(let n=0;n<a.length;n++){const s=a[n],i=Object.keys(r.texture[s].targets),l=[],y=[];i.forEach(p=>{const R=r.texture[s].targets[p];_e||Ne?R.format==="astc/ktx2"&&l.push(p):R.format==="ktx2"&&l.push(p),R.format==="video"&&y.push(p)}),l.length===0&&l.push(...i),y.length>0&&Wt&&!_e&&!Ne&&(l.length=0,o=!0,l.push(...y)),l.sort((p,R)=>{const E=r.texture[s].targets[p],h=r.texture[s].targets[R],m=E.frameRate*E.settings.resolution.width*E.settings.resolution.height,d=h.frameRate*h.settings.resolution.width*h.settings.resolution.height;return m-d}),l.forEach((p,R)=>{r.texture[s].targets[p].priority=R}),e[s]=l}return[r,t,e,o]},Ir=r=>{const t={baseColor:{USE_MAP:"",MAP_UV:"uv"},normal:{USE_NORMALMAP:"",NORMALMAP_UV:"uv"},metallicRoughness:{USE_METALNESSMAP:"",METALNESSMAP_UV:"uv",USE_ROUGHNESSMAP:"",ROUGHNESSMAP_UV:"uv"},emissive:{USE_EMISSIVEMAP:"",EMISSIVEMAP_UV:"uv"},occlusion:{USE_AOMAP:"",AOMAP_UV:"uv"}};let e={};const o=Object.keys(r.texture);for(let a=0;a<o.length;a++){const n=o[a];e={...e,...t[n]}}return e},Te=1/30,Ie=(r,t,e,o,a=Te)=>{let n=0,s=-1;if(o||(r=r.filter(i=>i.fetchTime!==-1)),r.length===0||r[0].start>t||r[r.length-1].end<e)return!1;for(const i of r)if(i.start<=t){if(i.end>=e)return!0;s=i.end}else{if(n=i.start-s,n>a)return!1;s=i.end}return!0};function Mt(r,t){const e=r.get(Ke);if(e.length===0)return[];e.sort((n,s)=>n.start-s.start);const o=[];let a=e[0];for(let n=1;n<e.length;n++){const s=e[n];s.fetchTime>-1&&a.fetchTime>-1&&(s.start<=a.end||s.start-a.end<=t)?a.end=Math.max(a.end,s.end):(o.push(a),a=s)}o.push(a),r.set(o)}const Mr=f.Object({start:f.Number(),end:f.Number(),fetchTime:f.Number()}),Ee=f.Object({targets:f.Array(f.String()),userTarget:f.Number(-1),currentTarget:f.Number(0),buffered:f.Array(Mr)}),se=Ae({name:"UVOL2Component",schema:f.Object({canPlay:f.Bool(!1),manifestPath:f.String(""),data:f.Type({}),useVideoTexture:f.Bool(!0),hasAudio:f.Bool(!1),bufferedUntil:f.Number(0),geometryInfo:Ee,textureInfo:f.Object({textureTypes:f.Array(Ue),baseColor:Ee,normal:Ee,metallicRoughness:Ee,emissive:Ee,occlusion:Ee}),initialGeometryBuffersLoaded:f.Bool(!1),initialTextureBuffersLoaded:f.Bool(!1),firstGeometryFrameLoaded:f.Bool(!1),firstTextureFrameLoaded:f.Bool(!1),loadingEffectStarted:f.Bool(!1),loadingEffectEnded:f.Bool(!1)}),onSet:(r,t,e)=>{e&&(e.manifestPath&&t.manifestPath.set(e.manifestPath),e.data&&t.data.set(e.data))},setStartAndPlaybackTime:(r,t,e)=>{oe(r,it).currentTrackInfo.merge({playbackStartDate:e,mediaStartTime:t})},canPlayThrough:(r,t,e)=>{const o=ze(r,se);if(!o||(e=Math.min(e,o.data.duration),!Ie(o.geometryInfo.buffered,t,e,!1,Te)))return!1;if(!o.useVideoTexture){for(const a of o.textureInfo.textureTypes)if(!Ie(o.textureInfo[a].buffered,t,e,!1,Te))return!1}return!0},reactor:Ur}),Sr=r=>new Promise((t,e)=>{const o=performance.now();$(re).gltfLoader.load(r,({scene:a})=>{const n=_t(a);t({mesh:n,fetchTime:performance.now()-o})},void 0,a=>{console.error("Error loading geometry: ",r,a),e(a)})}),Lr=(r,t,e)=>new Promise((o,a)=>{const n=performance.now();qt(rr.KTX2).load(r,s=>{s.repeat.copy(t),s.offset.copy(e),s.updateMatrix(),o({texture:s,fetchTime:performance.now()-n})},void 0,s=>{console.error("Error loading texture: ",r,s),a(s)})}),Ar=r=>{let t=0;for(let e=0;e<r.length;e++)r[e]==="#"&&t++;return t},We=(r,t,e,o,a,n)=>{let s=r;if(s=r.replace("[ext]",sr[e]),n&&(s=s.replace("[type]",n)),o!==void 0&&(s=s.replace("[target]",o)),a=a??0,a!==void 0){const i=Ar(s),l="["+"#".repeat(i)+"]",y=a.toString().padStart(i,"0");s=s.replace(l,y)}if(!s.startsWith("http")){const i=t.split("/");i.pop(),i.push(s),s=i.join("/")}return s},we=7,Dr=(r,t,e)=>{let o=r;return o+=t.toString().padStart(we,"0"),o};function Ur(){const r=Fe(),t=be(r,it),e=be(r,se),o=lt(r,Ze),a=$(Xe),n=oe(r,te).value,s=$(Se).audioContext,i=n.element,l=_.useMemo(()=>{const u=new pt(i);return u.generateMipmaps=!1,u.minFilter=Le,u.magFilter=Le,u.isVideoTexture=!0,u.update=()=>{},u.colorSpace=ot,u.flipY=!1,u},[]),y=_.useMemo(()=>new Map,[]),p=_.useMemo(()=>new Map,[]);let R=14;const E=2,h=_.useMemo(()=>new le(1,1),[]),m=_.useMemo(()=>new le(0,0),[]);Ht(t.currentTrackInfo.mediaStartTime);const d=_.useMemo(()=>{const u=e.data.value;let g=new Ut({color:16777215});if(u.type===Re.UNIFORM_SOLVE_WITH_COMPRESSED_TEXTURE){const T=Object.keys(u.geometry.targets)[0],b=!u.geometry.targets[T].settings.excludeNormals?"physical":"basic";let B=ge[b].vertexShader.replace("#include <clipping_planes_pars_vertex>",`#include <clipping_planes_pars_vertex>
attribute vec3 keyframeA;
attribute vec3 keyframeB;
attribute vec3 keyframeANormal;
attribute vec3 keyframeBNormal;
uniform float mixRatio;
uniform vec2 repeat;
uniform vec2 offset;
out vec2 custom_vUv;`);B=B.replace("#include <begin_vertex>",`
vec3 transformed = vec3(position);
transformed.x += mix(keyframeA.x, keyframeB.x, mixRatio); 
transformed.y += mix(keyframeA.y, keyframeB.y, mixRatio);
transformed.z += mix(keyframeA.z, keyframeB.z, mixRatio);

#ifdef USE_ALPHAHASH

  vPosition = vec3( transformed );

#endif`),B=B.replace("#include <beginnormal_vertex>",`
      vec3 objectNormal = vec3( normal );
      objectNormal.x += mix(keyframeANormal.x, keyframeBNormal.x, mixRatio);
      objectNormal.y += mix(keyframeANormal.y, keyframeBNormal.y, mixRatio);
      objectNormal.z += mix(keyframeANormal.z, keyframeBNormal.z, mixRatio);

      #ifdef USE_TANGENT

        vec3 objectTangent = vec3( tangent.xyz );

      #endif`);const w=ge[b].fragmentShader,I={mixRatio:{value:0},map:{value:null},mapTransform:{value:new Zt}},x=at.merge([ge.physical.uniforms,ht.lights,I]),S=Ir(u);if(u.materialProperties){const G=Object.keys(u.materialProperties);for(let V=0;V<G.length;V++){const W=G[V];W!=="normalScale"?x[W].value=u.materialProperties[W]:x[W].value=new le(u.materialProperties[W][0],u.materialProperties[W][1])}}g=new Ce({vertexShader:B,fragmentShader:w,uniforms:x,defines:S,lights:!0})}return g},[]),v=_.useMemo(()=>new Pt(3,32,32),[]),c=_.useMemo(()=>new nt(v,d),[]),A=_.useMemo(()=>{const u=new wt;return u.add(c),u},[]);_.useEffect(()=>{t.useLoadingEffect.value&&ye(r,ie);const[u,g,T,k]=Br(e.data.get({noproxy:!0}));e.data.set(u),e.geometryInfo.targets.set(g),e.useVideoTexture.set(k),k?t.useLoadingEffect.set(!1):t.useLoadingEffect.set(!0);const b=Object.keys(u.texture);if(e.textureInfo.textureTypes.set(b),b.forEach(x=>{e.textureInfo[x].targets.set(T[x])}),e.data.geometry.targets[g[0]].totalSize){const x=e.data.geometry.targets[g[0]].totalSize.value/e.data.duration.value,S=b.reduce((V,W)=>{const z=T[W][0],ee=e.data.value.texture[W].targets[z];return V+ee.totalSize/e.data.duration.value},0),G=x+S;G<=5*1024*1024?R=15:G<=10*1024*1024&&(R=10),$t&&(R=5)}const B=oe(r,Ze);u.type===Re.UNIFORM_SOLVE_WITH_COMPRESSED_TEXTURE?(B.cast.set(!1),B.receive.set(!1)):(B.cast.set(!0),B.receive.set(!0));const w=i;if(u.audio&&(e.hasAudio.set(!0),w.src=We(u.audio.path,e.manifestPath.value,u.audio.formats[0]),w.playbackRate=u.audio.playbackRate),k){const x=T.baseColor[0];w.src=We(e.data.texture.baseColor.value.path,e.manifestPath.value,"video",x,void 0,"baseColor"),w.preload="auto",i.addEventListener("loadeddata",()=>{e.firstTextureFrameLoaded.set(!0)}),i.addEventListener("canplaythrough",()=>{e.initialTextureBuffersLoaded.set(!0)}),d.uniforms.map.value=l,d.map=l,d.needsUpdate=!0}t.currentTrackInfo.currentTime.set(t.currentTrackInfo.mediaStartTime.value),t.currentTrackInfo.duration.set(u.duration);const I=setInterval(O,500);return O(),()=>{gt(r,A),i.pause(),clearInterval(I);for(const x in p){const S=p.get(x);if(S)for(const G in S){const V=S.get(G);if(V)for(const W in V)V[W].dispose(),delete V[W]}}for(const x in y){const S=y.get(x);if(S)for(const G in S){const V=S[G];V instanceof nt?(V.geometry.dispose(),V.material.dispose()):V instanceof Pe?V.dispose():V instanceof er&&c.geometry.setAttribute(V.name,V),delete S[G]}}c.geometry.dispose(),w.src=""}},[]),$(Xe),_.useEffect(()=>{(e.useVideoTexture.value||t.hasAudio.value)&&(i.playbackRate=t.currentTrackInfo.playbackRate.value)},[t.currentTrackInfo.playbackRate]),_.useEffect(()=>{o&&(e.data.value.type===Re.UNIFORM_SOLVE_WITH_COMPRESSED_TEXTURE?(o.cast.set(!1),o.receive.set(!1)):(o.cast.set(!0),o.receive.set(!0)))},[o]);const D=(u,g,T)=>{const k=e.data.value.geometry.targets[T],b=k.segmentFrameCount,B=Math.floor(u*k.frameRate/b),w=Math.floor(g*k.frameRate/b);for(let I=B;I<=w;I++){const x=We(e.data.value.geometry.path,e.manifestPath.value,k.format,T,I),S=I*k.segmentFrameCount,G=S/k.frameRate,V=G+k.settings.segmentSize;if(Ie(e.geometryInfo.buffered.value,G,V,!0,Te))continue;const W={start:G,end:V,fetchTime:-1};e.geometryInfo.buffered.get(Ke).push(W),Sr(x).then(({mesh:z,fetchTime:ee})=>{var yt,Tt;if(!Me(r,se))return;y.has(T)||y.set(T,[]),W.fetchTime=ee;const ce=y.get(T),Ve=z.geometry.morphAttributes.position,De=z.geometry.morphAttributes.normal;if(Ve.forEach((ve,Ge)=>{const bt=Dr(T,S+Ge);if(ve.name=bt,De){const xt=De[Ge];xt.name=bt,ce[S+Ge]={position:ve,normal:xt}}else ce[S+Ge]={position:ve}}),!c.geometry.attributes.position||!z.geometry.attributes.position||c.geometry.attributes.position.array.length!==z.geometry.attributes.position.array.length)for(const ve of Object.keys(z.geometry.attributes))c.geometry.attributes[ve]=z.geometry.attributes[ve],c.geometry.attributes[ve].needsUpdate=!0;z.geometry.morphAttributes={},e.firstGeometryFrameLoaded.value||(c.copy(z),h.copy(((yt=z.material.map)==null?void 0:yt.repeat)??h),m.copy(((Tt=z.material.map)==null?void 0:Tt.offset)??m),c.material=d,e.firstGeometryFrameLoaded.set(!0)),Ie(e.geometryInfo.buffered.value,u,u+E,!1)&&e.initialGeometryBuffersLoaded.set(!0),Mt(e.geometryInfo.buffered,Te),N()}).catch(()=>{const z=e.geometryInfo.buffered.get(Ke).indexOf(W);z!==-1&&e.geometryInfo.buffered[z].set(Xt)})}},N=()=>{const u=e.geometryInfo.userTarget.value;if(u!==-1){e.geometryInfo.currentTarget.set(u);return}const g=e.geometryInfo.buffered.value.reduce((w,I)=>w+I.fetchTime,0),T=e.geometryInfo.buffered.value.reduce((w,I)=>w+I.fetchTime>-1?I.end-I.start:0,0),k=g/T,b=e.geometryInfo.currentTarget.value,B=e.geometryInfo.targets.value.length;k>=.3?b>0&&e.geometryInfo.currentTarget.set(b-1):k<.2&&b<B-1&&e.geometryInfo.currentTarget.set(b+1)},L=u=>{const g=e.textureInfo[u].userTarget.value;if(g!==-1){e.textureInfo[u].currentTarget.set(g);return}const T=e.textureInfo[u].currentTarget.value,k=e.textureInfo[u].targets.value.length,b=e.textureInfo[u].buffered.value.reduce((I,x)=>I+x.fetchTime,0),B=e.textureInfo[u].buffered.value.reduce((I,x)=>I+(x.end-x.start),0),w=b/B;w>=.3?T>0&&e.textureInfo[u].currentTarget.set(T-1):w<.2&&T<k-1&&e.textureInfo[u].currentTarget.set(T+1)},U=()=>{const u=t.currentTrackInfo.currentTime.value,g=Math.min(u+R,e.data.duration.value),T=e.geometryInfo.targets.value[e.geometryInfo.currentTarget.value];e.data.value.geometry.targets[T].format==="uniform-solve"&&D(u,g,T)},M=u=>{var x;const g=t.currentTrackInfo.currentTime.value,T=Math.min(g+R,e.data.duration.value),k=e.textureInfo[u].currentTarget.value,b=e.textureInfo[u].targets[k].value,B=(x=e.data.texture[u].value)==null?void 0:x.targets[b];if(!B)return;const w=Math.floor(g*B.frameRate),I=Math.floor(T*B.frameRate);for(let S=w;S<=I;S++){const G=We(e.data.value.texture.baseColor.path,e.manifestPath.value,B.format,b,S,u);p.has(u)||p.set(u,new Map);const V=p.get(u);V.has(b)||V.set(b,[]);const W=V.get(b),z=S/B.frameRate,ee=(S+1)/B.frameRate,ce=e.textureInfo[u].buffered;if(Ie(ce.value,z,ee,!0,Te))continue;const Ve={start:z,end:ee,fetchTime:-1};ce.get(Ke).push(Ve),Lr(G,h,m).then(De=>{Me(r,se)&&(W[S]=De.texture,Ve.fetchTime=De.fetchTime,Mt(ce,Te),L(u),e.firstTextureFrameLoaded.value||e.firstTextureFrameLoaded.set(!0),Ie(ce.value,g,g+E,!1)&&e.initialTextureBuffersLoaded.set(!0))}).catch(()=>{})}},O=()=>{if(U(),!e.useVideoTexture.value)for(let u=0;u<e.textureInfo.textureTypes.value.length;u++)M(e.textureInfo.textureTypes[u].value)};_.useEffect(()=>{!e.initialGeometryBuffersLoaded.value||!e.initialTextureBuffersLoaded.value||t.initialBuffersLoaded.set(!0)},[e.initialGeometryBuffersLoaded,e.initialTextureBuffersLoaded]),_.useEffect(()=>{!e.firstGeometryFrameLoaded.value||!e.firstTextureFrameLoaded.value||(fe(t.currentTrackInfo.currentTime.value),e.useVideoTexture.value||Q(t.currentTrackInfo.currentTime.value),t.useLoadingEffect.value&&e.loadingEffectStarted.set(!0),tt(r,A))},[e.firstGeometryFrameLoaded,e.firstTextureFrameLoaded]),_.useEffect(()=>{if(e.loadingEffectStarted.value&&!e.loadingEffectEnded.value){let u=/\/\/\sHEADER_REPLACE_START([\s\S]*?)\/\/\sHEADER_REPLACE_END/,g=/\/\/\sMAIN_REPLACE_START([\s\S]*?)\/\/\sMAIN_REPLACE_END/;e.data.value.type,Re.UNIFORM_SOLVE_WITH_COMPRESSED_TEXTURE,u=void 0,g=void 0,c.material=ie.createDissolveMaterial(c,u,g,u,g),c.material.needsUpdate=!0;return}t.autoplay.value&&t.initialBuffersLoaded.value&&(c.material=d,c.material.needsUpdate=!0,e.hasAudio.value||e.useVideoTexture.value?st(s,i,t):t.paused.set(!1))},[t.autoplay,t.initialBuffersLoaded,e.loadingEffectStarted,e.loadingEffectEnded]),_.useEffect(()=>{if(t.paused.value){e.canPlay.set(!1),(e.hasAudio.value||e.useVideoTexture.value)&&i.pause();return}se.setStartAndPlaybackTime(r,t.currentTrackInfo.currentTime.value,a.elapsedSeconds),c.material!==d&&(c.material=d,c.material.needsUpdate=!0),(e.hasAudio.value||e.useVideoTexture.value)&&st(s,i,t),e.canPlay.set(!0)},[t.paused]);const j=(u,g,T=!0)=>{const k=u*g;return T?Math.round(k):k},K=(u,g)=>{const T=e.geometryInfo.targets[e.geometryInfo.currentTarget.value].value;let k=j(g,e.data.value.geometry.targets[T].frameRate,!1);u==="keyframeA"?k=Math.floor(k):k=Math.ceil(k);const b=y.get(T);if(!b||!b[k]){const B=e.geometryInfo.targets.value;for(let w=0;w<B.length;w++){const I=B[w],x=e.data.value.geometry.targets[I];let S=j(g,x.frameRate,!1);u==="keyframeA"?S=Math.floor(S):S=Math.ceil(S);const G=y.get(I);if(G&&G[S])return G[S]}}else return b[k];return!1},Y=(u,g)=>{H(u,g.position),g.normal&&H(u+"Normal",g.normal)},H=(u,g)=>{var w;if(c.geometry.attributes[u]===g)return;if(u==="keyframeB"||u==="keyframeBNormal"){c.geometry.attributes[u]=g,c.geometry.attributes[u].needsUpdate=!0;return}else if((u==="keyframeA"||u==="keyframeANormal")&&e.data.deletePreviousBuffers.value===!1){c.geometry.attributes[u]=g,c.geometry.attributes[u].needsUpdate=!0;return}const T=c.geometry.index,k=new Pe;k.setIndex(T);for(const I in c.geometry.attributes)I!==u&&k.setAttribute(I,c.geometry.attributes[I]);k.setAttribute(u,g),k.boundingSphere=c.geometry.boundingSphere,k.boundingBox=c.geometry.boundingBox;const b=c.geometry;c.geometry=k,b.index=null;for(const I in b.attributes)I!==u&&b.deleteAttribute(I);b.dispose();const B=(w=b.attributes[u])==null?void 0:w.name;y.delete(B)},J=(u,g)=>{const T=y.get(u),k=e.data.value.geometry.targets[u];if(!T||!T[g]){const b=k.frameRate,B=e.geometryInfo.targets.value;for(let w=0;w<B.length;w++){const I=B[w],x=e.data.value.geometry.targets[I].frameRate,S=Math.round(g*x/b),G=y.get(I);if(G&&G[S]){J(I,S);return}}}else if(k.format==="draco"){const b=T[g];if(c.geometry!==b){c.geometry=b,c.geometry.attributes.position.needsUpdate=!0;return}}else if(k.format==="glb"){const b=T[g],B=b.geometry;c.geometry!==B&&(c.geometry=B,c.geometry.attributes.position.needsUpdate=!0),b.material instanceof tr&&b.material.map&&(b.material.map.repeat&&h.copy(b.material.map.repeat),b.material.map.offset&&m.copy(b.material.map.offset));return}},Z=(u,g)=>{var T,k,b,B,w,I;if((!g.repeat.equals(h)||!g.offset.equals(m))&&(g.repeat.copy(h),g.offset.copy(m),g.updateMatrix()),c.material instanceof Ce){const x=c.material;u==="baseColor"&&x.uniforms.map.value!==g?((T=x.uniforms.map.value)==null||T.name,x.uniforms.map.value=g,x.uniforms.mapTransform.value.copy(g.matrix)):u==="emissive"&&x.uniforms.emissiveMap.value!==g?((k=x.uniforms.emissiveMap.value)==null||k.name,x.uniforms.emissiveMap.value=g,x.uniforms.emissiveMapTransform.value.copy(g.matrix)):u==="normal"&&x.uniforms.normalMap.value!==g?((b=x.uniforms.normalMap.value)==null||b.name,x.uniforms.normalMap.value=g,x.uniforms.normalMapTransform.value.copy(g.matrix)):u==="metallicRoughness"&&x.uniforms.roughnessMap.value!==g?((B=x.uniforms.roughnessMap.value)==null||B.name,x.uniforms.roughnessMap.value=g,x.uniforms.roughnessMapTransform.value.copy(g.matrix),x.uniforms.metalnessMap.value=g,x.uniforms.metalnessMapTransform.value.copy(g.matrix)):u==="occlusion"&&x.uniforms.aoMap.value!==g&&((w=x.uniforms.aoMap.value)==null||w.name,x.uniforms.aoMap.value=g,x.uniforms.aoMapTransform.value.copy(g.matrix))}else{const x=c.material;u==="baseColor"&&((I=x.map)==null||I.name,x.map=g,x.map.needsUpdate=!0)}},q=(u,g,T,k)=>{const b=p.get(u);if(!b){console.error("Texture frames not found for time: ",k);return}const B=b.get(g);if(!B||!B[T]){const w=e.textureInfo[u].targets.value;for(let I=0;I<w.length;I++){const x=e.data.value.texture[u].targets[w[I]].frameRate,S=j(k,x),V=p.get(u).get(w[I]);if(V&&V[S]){q(u,w[I],S,k);return}}console.error("Texture frames not found for time: ",k)}else{const w=B[T];Z(u,w)}},me=u=>{const g=K("keyframeA",u),T=K("keyframeB",u);if(!g&&!T){console.error("Geometry frames not found for time: ",u);return}else if(!g&&T){Y("keyframeB",T),c.material.uniforms.mixRatio.value=1;return}else if(g&&!T){Y("keyframeA",g),c.material.uniforms.mixRatio.value=0;return}else if(g&&T){const I=parseInt(g.position.name.slice(-we)),x=g.position.name.slice(0,-we),S=I/e.data.value.geometry.targets[x].frameRate,G=parseInt(T.position.name.slice(-we)),V=T.position.name.slice(0,-we),W=G/e.data.value.geometry.targets[V].frameRate,z=Math.abs(u-S),ee=Math.abs(u-W),ce=z+ee>0?z/(z+ee):.5;Y("keyframeA",g),Y("keyframeB",T),c.material.uniforms.mixRatio.value=ce}const k=c.geometry.index,b=new Pe,B=c.geometry;b.setIndex(k);for(const I in c.geometry.attributes)b.setAttribute(I,c.geometry.attributes[I]),B.deleteAttribute(I);b.boundingSphere=c.geometry.boundingSphere,b.boundingBox=c.geometry.boundingBox;let w=-1;for(const I in e.data.value.geometry.targets){const x=y.get(I),S=e.data.value.geometry.targets[I].frameRate;if(x&&x.length>0)for(const G in x){const V=parseInt(G)/S;if(V<u-.5){const W=x[G];B.setAttribute(W.position.name+".position",W.position),W.normal&&B.setAttribute(W.normal.name+".normal",W.normal),delete x[G],w=e.geometryInfo.buffered.findIndex(z=>{if(z.start.value<=V&&z.end.value>=V&&z.fetchTime.value>-1)return!0}),w!==-1&&e.geometryInfo.buffered[w].start.set((parseInt(G)+1)/S)}else break}}c.geometry=b,B.dispose()},pe=u=>{const g=e.geometryInfo.targets[e.geometryInfo.currentTarget.value].value,T=e.data.value.geometry.targets[g],k=Math.round(u*e.data.value.geometry.targets[g].frameRate);J(g,k);for(const b in e.data.value.geometry.targets){const B=y.get(b),w=e.data.value.geometry.targets[b].frameRate;if(B&&B.length>0)for(const I in B)if(parseInt(I)/w<u-.5){if(T.format==="draco")B[I].dispose();else if(T.format==="glb"){const S=B[I];S.geometry.dispose(),S.material.map&&S.material.map.dispose(),S.material.dispose()}delete B[I]}else break}},fe=u=>{e.data.value.type===Re.UNIFORM_SOLVE_WITH_COMPRESSED_TEXTURE?me(u):pe(u);for(const g in c.geometry.attributes)c.geometry.attributes[g].needsUpdate=!0},Q=u=>{e.textureInfo.textureTypes.value.forEach(g=>{Oe(g,u)})},Oe=(u,g)=>{var w,I;const T=e.textureInfo[u].targets[e.textureInfo[u].currentTarget.value].value,k=Math.round(g*e.data.value.texture[u].targets[T].frameRate);q(u,T,k,g);const b=p.get(u);if(!b){console.error("Texture frames not found for time: ",g);return}let B=-1;for(const x in(w=e.data.value.texture[u])==null?void 0:w.targets){const S=b.get(x);if(!S||S.length===0)continue;const G=(I=e.data.value.texture[u])==null?void 0:I.targets[x].frameRate;if(S&&S.length>0)for(const V in S){const W=parseInt(V)/G;if(W<g-.5)S[V].dispose(),delete S[V],B=e.textureInfo[u].buffered.findIndex(ee=>{if(ee.start.value<=W&&ee.end.value>=W&&ee.fetchTime.value>-1)return!0}),B!==-1&&e.textureInfo[u].buffered[B].start.set((parseInt(V)+1)/G);else break}}},xe=_.useRef(!1);return mt(()=>{c.updateMatrixWorld(!0);const u=$(Xe).deltaSeconds;if(e.loadingEffectStarted.value&&!e.loadingEffectEnded.value&&ie.updateDissolveEffect(r,c,u)){ke(r,ie),e.loadingEffectEnded.set(!0),c.material=d,c.material.needsUpdate=!0;return}if(!e.canPlay.value||!t.initialBuffersLoaded.value)return;if(t.autoPauseWhenBuffering.value){let T=!1;if(se.canPlayThrough(r,t.currentTrackInfo.currentTime.value,t.currentTrackInfo.currentTime.value+E)||(T=!0),(e.useVideoTexture.value||t.hasAudio.value)&&i.readyState<3&&(T=!0),!(!xe.current&&!T)){if(!xe.current&&T){xe.current=!0;return}else if(xe.current&&!T)se.setStartAndPlaybackTime(r,t.currentTrackInfo.currentTime.value,a.elapsedSeconds),xe.current=!1;else if(xe.current&&T)return}}let g=-1;if(e.data.value.audio||e.useVideoTexture.value?g=i.currentTime:(g=t.currentTrackInfo.mediaStartTime.value+(a.elapsedSeconds-t.currentTrackInfo.playbackStartDate.value),g*=t.currentTrackInfo.playbackRate.value),_.startTransition(()=>{t.currentTrackInfo.currentTime.set(g);let T=t.currentTrackInfo.duration.value,k=-1;k=e.geometryInfo.buffered.findIndex(b=>{if(b.start.value<=g&&b.end.value>=g)return!0}),k!==-1&&(T=Math.min(T,e.geometryInfo.buffered[k].end.value));for(const b of e.textureInfo.textureTypes.value)k=e.textureInfo[b].buffered.findIndex(B=>{if(B.start.value<=g&&B.end.value>=g)return!0}),k!==-1&&(T=Math.min(T,e.textureInfo[b].buffered[k].end.value));e.bufferedUntil.set(T)}),t.currentTrackInfo.currentTime.value>e.data.value.duration||i.ended)if(e.data.deletePreviousBuffers.value===!1&&t.playMode.value===de.loop)t.currentTrackInfo.currentTime.set(0),t.currentTrackInfo.playbackStartDate.set(a.elapsedSeconds);else{t.ended.set(!0);return}fe(t.currentTrackInfo.currentTime.value),e.useVideoTexture.value?(l.colorSpace=ot,(!l.repeat.equals(h)||!l.offset.equals(m))&&(l.repeat.copy(h),l.offset.copy(m),l.updateMatrix(),c.material.uniforms.mapTransform.value.copy(l.matrix))):Q(t.currentTrackInfo.currentTime.value),l.needsUpdate=!0},{with:dt}),null}function st(r,t,e){const o=()=>{const a=he(Qe.instance.viewerEntity,et).canvas,n=()=>{t.play(),r.resume(),e.paused.set(!1),window.removeEventListener("pointerdown",n),window.removeEventListener("keypress",n),window.removeEventListener("touchstart",n),a.removeEventListener("pointerdown",n),a.removeEventListener("touchstart",n)};window.addEventListener("pointerdown",n),window.addEventListener("keypress",n),window.addEventListener("touchstart",n),a.addEventListener("pointerdown",n),a.addEventListener("touchstart",n)};t.play().catch(a=>{a.name==="NotAllowedError"&&o()}).then(()=>{e.paused.set(!1)})}const it=Ae({name:"Volumetric Component",jsonID:"EE_volumetric",schema:f.Object({paths:f.Array(f.String()),useLoadingEffect:f.Bool(!0),autoPauseWhenBuffering:f.Bool(!0),autoplay:f.Bool(!0),paused:f.Bool(!0),initialBuffersLoaded:f.Bool(!1),hasAudio:f.Bool(!1),ended:f.Bool(!0),volume:f.Number(1),playMode:f.Enum(de,de.loop),track:f.Number(-1),forceChangeTrack:f.Bool(!1),currentTrackInfo:f.Object({dontReset:f.Bool(!1),mediaStartTime:f.Number(0),playbackStartDate:f.Number(0),playbackRate:f.Number(1),currentTime:f.Number(0),duration:f.Number(0)})}),toJSON:r=>({paths:r.paths,useLoadingEffect:r.useLoadingEffect,autoplay:r.autoplay,volume:r.volume,playMode:r.playMode}),reactor:wr});function wr(){const r=Fe(),t=$(Se).audioContext,e=$(Se).gainNodeMixBuses,o=be(r,it);_.useEffect(()=>{ye(r,te,{element:document.createElement("video")}),ye(r,Ze);const s=oe(r,te).element.value;if(s.playsInline=!0,s.preload="auto",s.crossOrigin="anonymous",!rt.get(s)){const i=t.createMediaElementSource(s);Dt(s,i,e.soundEffects).gain.gain.setTargetAtTime(o.volume.value,t.currentTime,.1)}return()=>{ke(r,qe),ke(r,se)}},[]),_.useEffect(()=>{var l;if(!o.ended.value)return;const n=o.paths.value.length;let s=Et(o.track.value,n,o.playMode.value);const i=["manifest","drcs","mp4","json"];for(let y=0;y<=n;y++){const p=o.paths.value[s],R=p?(l=p.split(".").pop())==null?void 0:l.split("?").shift():"";if(p&&R&&i.includes(R))break;if(s===o.track.value||(s=Et(s,n,o.playMode.value),s===-1))return}s===-1||!o.paths.value[s]||(o.currentTrackInfo.dontReset.value||a(),o.track.set(s),o.forceChangeTrack.set(!o.forceChangeTrack.value))},[o.paths,o.playMode,o.ended]);const a=()=>{ke(r,qe),ke(r,se),o.initialBuffersLoaded.set(!1),o.paused.set(!0),o.currentTrackInfo.set({dontReset:!1,mediaStartTime:0,playbackStartDate:0,playbackRate:1,currentTime:0,duration:0})};return _.useEffect(()=>{if(o.track.value===-1)return;o.ended.set(!1);let n=o.paths.value[o.track.value];n.endsWith(".mp4")?n=n.replace(".mp4",".manifest"):n.endsWith(".drcs")&&(n=n.replace(".drcs",".manifest")),fetch(n).then(s=>s.json()).then(s=>{"type"in s?ye(r,se,{manifestPath:n,data:s}):ye(r,qe,{manifestPath:n,data:s})})},[o.track,o.forceChangeTrack]),_.useEffect(()=>{const n=o.volume.value,s=he(r,te).element,i=rt.get(s);i&&i.gain.gain.setTargetAtTime(n,t.currentTime,.1)},[o.volume]),null}export{se as U,it as V,qe as a};
