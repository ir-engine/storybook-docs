var kn=Object.defineProperty;var Tn=(e,t,r)=>t in e?kn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var R=(e,t,r)=>Tn(e,typeof t!="symbol"?t+"":t,r);import{r as b,R as w}from"./index-DPzuYzxM.js";import{u as F,x as ye,H as I,W as L,a as g,R as nt,e as ee,h as st,y as Jt,D as Br,c as Ae,M as $r,z as zr,A as Vr,v as ar,w as Fr,B as ir,C as It,F as ht,p as qr,q as Tr,l as fe,V as Yt,G as gt,I as An,J as Mn,K as Un,L as On,E as _n,O as xn,P as Pn,N as Rt,Q as Qr,S as Wt,T as Rn,U as vn,X as Nn,Y as Ln,Z as jn,_ as Bn,$ as Dt,a0 as $n,a1 as zn,a2 as Vn,a3 as Fn,a4 as qn,a5 as Qn,a6 as Hn,a7 as Jn,a8 as Yn,o as Hr,a9 as Wn,aa as Jr,ab as Kn,ac as Gn,ad as Xn,ae as Zn,af as es,ag as Yr,ah as ts,b as et,k as rs,d as oe,ai as cr,aj as Wr,g as W,ak as ns,al as ss,am as ur,an as os,ao as Kr,ap as as,aq as is,i as cs,f as us,ar as ls,as as fs,at as ds,au as ps,av as ys,aw as ms,m as Ye,ax as bt,t as Kt,ay as Gr,n as xe,az as hs,r as Xr,aA as Gt,aB as gs,j as bs,aC as We,aD as Ss,aE as Zr,aF as ws,s as Es,aG as Is,aH as Ds,aI as Cs,aJ as ks,aK as Ts,aL as As,aM as Ms}from"./WebRTCTransportFunctions-mB_FREj1.js";import{v as en}from"./v4-BOvFkHkt.js";import{j as yt,Q as Ar,a as Mr,V as Ur}from"./three.module-BizNiMhn.js";class Us{constructor(){R(this,"_listeners");this._listeners={}}reset(){Object.keys(this._listeners).forEach(t=>{delete this._listeners[t]})}once(t,r,...n){const o=s=>{this.removeEventListener(t,o),r(s)};this.addEventListener(t,o)}addEventListener(t,r,...n){const o=this._listeners;o[t]===void 0&&(o[t]=[]),o[t].indexOf(r)===-1&&o[t].push(r)}hasEventListener(t,r,...n){return this._listeners[t]!==void 0&&this._listeners[t].indexOf(r)!==-1}removeEventListener(t,r,...n){const o=this._listeners[t];if(o!==void 0){const s=o.indexOf(r);s!==-1&&o.splice(s,1)}}removeAllListenersForEvent(t,r,...n){r?delete this._listeners[t]:this._listeners[t]=[]}dispatchEvent(t,...r){const n=this._listeners[t.type];if(n!==void 0){const o=n.slice(0);for(let s=0;s<o.length;s++)o[s].call(this,t,...r)}}}const Os=(e,t=[])=>{const r=b.useRef(!1);b.useEffect(()=>{let n;return r.current?n=e():r.current=!0,n},t)};function lr(){const[e,t]=b.useState(0);return()=>t(r=>r+1)}function _s(e,t){return!(Array.isArray(e)&&Array.isArray(t)&&e.length===t.length&&e.every((r,n)=>Object.is(r,t[n])))}function ot(e,t){const r=F(null),n=F(null),o=F(!1);if(b.useLayoutEffect(()=>{o.set(!0)},[]),b.useEffect(()=>{},t),o.value&&_s(n.get(ye),t)){n.set(t);const s=r.get(ye);s&&s(),r.set(()=>e())}b.useLayoutEffect(()=>()=>{const s=r.get(ye);s==null||s()},[])}const xs=e=>{const t=b.useRef(null);return b.useEffect(()=>{t.current=e.value},[e]),t.current},Ps=()=>{const e=F({current:null}),t=b.useCallback(r=>{e.current.set(r)},[]);return[e.value,t]},Rs=e=>{var u,l;const{network:t,peerID:r,peerIndex:n,userID:o,sendMessage:s}=e,a=t.id;b.useEffect(()=>{const f=new AbortController;if(I.store.peerID>r){L.poll(s,a,r);const d=setInterval(()=>{var p;f.signal.aborted||(p=g(nt)[a])!=null&&p[r]?clearInterval(d):L.poll(s,a,r)},1e3)}return()=>{f.abort(),L.close(a,r)}},[]);const i=(u=ee(nt)[a][r])==null?void 0:u.value;b.useEffect(()=>{if(!i||!i.ready||!i.dataChannels.actions)return;const f=i.dataChannels.actions;st(Jt.peerJoined({$network:a,$topic:t.topic,$to:I.store.peerID,peerID:r,peerIndex:n,userID:o}));let y=!1;const d=D=>{if(D.data===""){y=!0;return}const v=qr(D.data);t.onMessage(r,v)};f.addEventListener("message",d);const p=D=>{!f||f.readyState!=="open"||f.send(Tr(D))},h=(D,v)=>{const Ie=i.dataChannels[D];if(!Ie||Ie.readyState!=="open")return;const Le=I.store.peerID,G=t.peerIDToPeerIndex[Le];if(typeof G>"u")return console.warn("fromPeerIndex is undefined",Le,G);Ie.send(Tr([G,v]))};t.transports[r]={message:p,buffer:h};const E=setInterval(()=>{if(f.readyState==="open"&&(f.send(""),y)){clearInterval(E);const D=I.store.actions.cached.filter(v=>v.$topic===t.topic&&v.$peer===I.store.peerID);p(D)}},10);return()=>{clearInterval(E),st(Jt.peerLeft({$network:t.id,$topic:t.topic,$to:I.store.peerID,peerID:r,userID:o})),f.removeEventListener("message",d)}},[i==null?void 0:i.ready,(l=i==null?void 0:i.dataChannels)==null?void 0:l.actions]);const c=ee(Br).value;return i!=null&&i.ready?w.createElement(w.Fragment,null,t.topic===Ae.world&&Object.keys(c).map(f=>w.createElement(vs,{key:f,networkID:a,peerID:e.peerID,dataChannelType:f})),t.topic===Ae.media&&w.createElement(tn,{networkID:a,peerID:e.peerID,sendMessage:s}),Object.keys(i.incomingMediaTracks).map(f=>w.createElement(rn,{key:f,networkID:a,peerID:e.peerID,trackID:f,maxResolution:e.maxResolution,isPiP:e.isPiP,sendMessage:s}))):null},vs=e=>{var n;const t=ee(nt)[e.networkID][e.peerID].value,r=(n=t==null?void 0:t.dataChannels)==null?void 0:n[e.dataChannelType];return b.useEffect(()=>{if(I.store.peerID<e.peerID)return L.createDataChannel(e.networkID,e.peerID,e.dataChannelType),()=>{L.closeDataChannel(e.networkID,e.peerID,e.dataChannelType)}},[]),b.useEffect(()=>{if(!r)return;const o=g(fe).networks[e.networkID],s=a=>{const i=a.data,[c,u]=qr(i),l=o.peerIndexToPeerID[c],f=new Uint8Array(u).buffer;o.onBuffer(r.label,l,f)};return r.addEventListener("message",s),()=>{r.removeEventListener("message",s)}},[r]),null},tn=e=>{var u;const{sendMessage:t}=e,r=ee($r),n=r.microphoneEnabled.value,o=(u=r.microphoneDestinationNode.value)==null?void 0:u.stream,s=r.webcamEnabled.value,a=r.webcamMediaStream.value,i=r.screenshareEnabled.value,c=r.screenshareMediaStream.value;return b.useEffect(()=>(zr(e.peerID),()=>{Vr(e.peerID)}),[]),b.useEffect(()=>{if(!n||!o)return;const l=o.getAudioTracks()[0].clone(),f=L.createMediaChannel(t,e.networkID,e.peerID,l,ar);if(f)return()=>{L.closeMediaChannel(t,e.networkID,e.peerID,l,f)}},[o,n]),b.useEffect(()=>{if(!s||!a)return;const l=a.getVideoTracks()[0].clone(),f=L.createMediaChannel(t,e.networkID,e.peerID,l,Fr);if(f)return()=>{L.closeMediaChannel(t,e.networkID,e.peerID,l,f)}},[a,s]),b.useEffect(()=>{if(!i||!c)return;const l=c.getVideoTracks()[0].clone(),f=L.createMediaChannel(t,e.networkID,e.peerID,l,ir);let y;const d=c.getAudioTracks();if(d.length){const p=d[0].clone();y=L.createMediaChannel(t,e.networkID,e.peerID,p,It)}return()=>{f&&L.closeMediaChannel(t,e.networkID,e.peerID,l,f),y&&L.closeMediaChannel(t,e.networkID,e.peerID,l,y)}},[c,i]),null},Ns=540,rn=e=>{var y,d,p,h;const{maxResolution:t,sendMessage:r}=e,n=ee(nt)[e.networkID][e.peerID].value,o=(y=n==null?void 0:n.incomingMediaTracks)==null?void 0:y[e.trackID],s=o==null?void 0:o.mediaTag,a=s?s===It||s===ir?"screen":"cam":null,i=s===ar||s===It,c=o==null?void 0:o.stream,u=ee(ht)[e.peerID],l=s?u==null?void 0:u[s]:null;b.useEffect(()=>{if(!(!s||!c||!(l!=null&&l.value)))return i?(l.stream.set(c),()=>{var E;s&&!((E=g(ht)[e.peerID])!=null&&E[s])||l.stream.set(null)}):(l.stream.set(c),()=>{var E;s&&!((E=g(ht)[e.peerID])!=null&&E[s])||l.stream.set(null)})},[s,c,!!(l!=null&&l.value)]),b.useEffect(()=>{if(!s||!c||!l)return;const E=l.paused.value;L.pauseMediaChannel(r,e.networkID,e.peerID,c,E)},[i?(d=l==null?void 0:l.paused)==null?void 0:d.value:(p=l==null?void 0:l.paused)==null?void 0:p.value]);const f=e.isPiP||((h=l==null?void 0:l.value)==null?void 0:h.quality)==="largest";return b.useEffect(()=>{if(!c||i)return;const E=a==="screen",{scale:D,maxBitrate:v}=Ls({isScreen:E,maxResolution:t,isPiP:f});L.requestVideoQuality(r,e.networkID,e.peerID,c,D,v)},[c,t,f]),null},Ls=e=>{const{isScreen:t,maxResolution:r,isPiP:n}=e,o=Yt[r]||Yt.hd,s=n?o.height.ideal>Ns?gt.length-1:gt.length-2:0,a=gt[s],i=t?1:a.scaleResolutionDownBy,c=a.maxBitrate;return{scale:i,maxBitrate:c}},js=Object.freeze(Object.defineProperty({__proto__:null,ActionDefinitions:An,CAM_AUDIO_CODEC_OPTIONS:Mn,CAM_VIDEO_SIMULCAST_CODEC_OPTIONS:Un,CAM_VIDEO_SIMULCAST_ENCODINGS:gt,CAM_VIDEO_SVC_CODEC_OPTIONS:On,DataChannelRegistryState:Br,ErrorBoundary:_n,EventDispatcher:Us,H264_CODEC:xn,HyperFlux:I,MediaChannelState:ht,MediaReceiveChannelReactor:rn,MediaSendChannelReactor:tn,MediaStreamService:Pn,MediaStreamState:$r,NO_PROXY:Rt,NO_PROXY_STEALTH:ye,NetworkActionFunctions:Qr,NetworkActions:Jt,NetworkPeerState:Wt,NetworkState:fe,NetworkTopics:Ae,OPUS_STEREO_CODEC:Rn,RTCPeerConnectionState:nt,ReactorErrorBoundary:vn,ReactorReconciler:Nn,ReactorRenderCounterState:Ln,SCREEN_SHARE_SIMULCAST_ENCODINGS:jn,ScenePeer:Bn,SceneUser:Dt,StateDefinitions:$n,StateFragment:zn,StunServerState:Vn,VIDEO_CONSTRAINTS:Yt,VP8_CODEC:Fn,VP9_CODEC:qn,Validator:Qn,VideoConstants:Hn,WebRTCPeerConnection:Rs,WebRTCTransportFunctions:L,WorldUserState:Jn,__state:Yn,addDataChannelHandler:Hr,addOutgoingTopicIfNecessary:Wn,applyIncomingActions:Jr,clearOutgoingActions:Kn,configure:Gn,createActionQueue:Xn,createErrorBoundary:Zn,createHookableFunction:es,createHyperStore:Yr,createPeerMediaChannels:zr,deepEqual:ts,defineAction:et,defineActionQueue:rs,defineState:oe,destroy:cr,dispatchAction:st,extend:Wr,getMutableState:W,getNestedObject:ns,getState:g,hasSuspendedOrTimeoutInTree:ss,hookstate:ur,hookstateMemo:os,identifiable:Kr,isActionReceptor:as,isBrowser:is,isClient:cs,isDev:us,isHookstate:ls,isHookstateValue:fs,isTest:ds,isWebWorker:ps,joinNetwork:ys,leaveNetwork:ms,matches:Ye,matchesPeerID:bt,matchesUserID:Kt,matchesWithDefault:Gr,none:xe,removeActionQueue:hs,removeDataChannelHandler:Xr,removePeerMediaChannels:Vr,resolveObject:Gt,screenshareAudioMediaChannelType:It,screenshareVideoMediaChannelType:ir,setInitialState:gs,setNestedObject:bs,startReactor:We,stateNamespaceKey:Ss,stopAllReactors:Zr,suspend:ws,syncStateWithLocalStorage:Es,useDidMount:Os,useForceUpdate:lr,useHookstate:F,useHookstateCallback:Is,useHookstateEffect:Ds,useHookstateImperativeHandle:Cs,useHookstateInsertionEffect:ks,useHookstateLayoutEffect:Ts,useHookstateMemo:As,useImmediateEffect:ot,useMutableState:ee,usePrevious:xs,useReactiveRef:Ps,useReactorRootContext:Ms,useState:F,webcamAudioMediaChannelType:ar,webcamVideoMediaChannelType:Fr},Symbol.toStringTag,{value:"Module"}));var tt=(e,t,r)=>Object.defineProperty(e,t,{value:r,enumerable:!1,writable:!0,configurable:!0}),Bs=(e,t)=>t&e.entityMask,$s=(e,t)=>t>>>e.versionShift&(1<<e.versionBits)-1,zs=(e,t)=>{let r=$s(e,t)+1&(1<<e.versionBits)-1;return t&e.entityMask|r<<e.versionShift},Vs=e=>{let t={versioning:!1,versionBits:8},r=t.versionBits??8,n=t.versioning??!1,o=32-r,s=(1<<o)-1,a=o,i=(1<<r)-1<<a;return{aliveCount:0,dense:[],sparse:[],maxId:0,versioning:n,versionBits:r,entityMask:s,versionShift:a,versionMask:i}},Fs=e=>{if(e.aliveCount<e.dense.length){let r=e.dense[e.aliveCount],n=r;return e.sparse[n]=e.aliveCount,e.aliveCount++,r}let t=++e.maxId;return e.dense.push(t),e.sparse[t]=e.aliveCount,e.aliveCount++,t},qs=(e,t)=>{let r=e.sparse[t];if(r===void 0||r>=e.aliveCount)return;let n=e.aliveCount-1,o=e.dense[n];if(e.sparse[o]=r,e.dense[r]=o,e.sparse[t]=n,e.dense[n]=t,e.versioning){let s=zs(e,t);e.dense[n]=s}e.aliveCount--},fr=(e,t)=>{let r=Bs(e,t),n=e.sparse[r];return n!==void 0&&n<e.aliveCount&&e.dense[n]===t},U=Symbol.for("bitecs_internal"),Qs=(e,t)=>tt(e||{},U,{entityIndex:t||Vs(),entityMasks:[[]],entityComponents:new Map,bitflag:1,componentMap:new Map,componentCount:0,queries:new Set,queriesHashMap:new Map,notQueries:new Set,dirtyQueries:new Set,entitiesWithRelations:new Set});function Hs(...e){let t,r;return e.forEach(n=>{typeof n=="object"&&"add"in n&&"remove"in n?t=n:typeof n=="object"&&(r=n)}),Qs(r,t)}var Js=e=>{delete e[U]},Ys=e=>Array.from(e[U].entityComponents.keys()),Or=()=>{let e=[],t=[],r=n=>e[t[n]]===n;return{add:n=>{r(n)||(t[n]=e.push(n)-1)},remove:n=>{if(!r(n))return;let o=t[n],s=e.pop();s!==n&&(e[o]=s,t[s]=o)},has:r,sparse:t,dense:e,reset:()=>{e.length=0,t.length=0}}},_r=typeof SharedArrayBuffer<"u"?SharedArrayBuffer:ArrayBuffer,Ws=(e=1e3)=>{let t=[],r=0,n=new Uint32Array(new _r(e*4)),o=s=>s<t.length&&t[s]<r&&n[t[s]]===s;return{add:s=>{if(!o(s)){if(r>=n.length){let a=new Uint32Array(new _r(n.length*2*4));a.set(n),n=a}n[r]=s,t[s]=r,r++}},remove:s=>{if(!o(s))return;r--;let a=t[s],i=n[r];n[a]=i,t[i]=a},has:o,sparse:t,get dense(){return new Uint32Array(n.buffer,0,r)},reset:()=>{r=0,t.length=0}}},Ct=()=>{let e=new Set;return{subscribe:t=>(e.add(t),()=>{e.delete(t)}),notify:(t,...r)=>Array.from(e).reduce((n,o)=>{let s=o(t,...r);return s&&typeof s=="object"?{...n,...s}:n},{})}},me=Symbol.for("bitecs-opType"),Pe=Symbol.for("bitecs-opTerms"),ci=(...e)=>({[me]:"Not",[Pe]:e}),nn=(...e)=>({[me]:"add",[Pe]:e}),sn=(...e)=>({[me]:"remove",[Pe]:e});function kt(e,t,r){let n=e[U],{[me]:o,[Pe]:s}=t;if(o==="add"||o==="remove"){let a=vt(e,s),i=n.queriesHashMap.get(a);return i||(i=Xt(e,s)),i[o==="add"?"addObservable":"removeObservable"].subscribe(r)}else if(o==="set"||o==="get"){if(s.length!==1)throw new Error("Set and Get hooks can only observe a single component");let a=s[0],i=n.componentMap.get(a);return i||(i=at(e,a)),i[o==="set"?"setObservable":"getObservable"].subscribe(r)}throw new Error(`Invalid hook type: ${o}`)}var vt=(e,t)=>{let r=e[U],n=s=>(r.componentMap.has(s)||at(e,s),r.componentMap.get(s).id),o=s=>{if(me in s){let a=s[Pe].map(n).sort((i,c)=>i-c);return`${s[me].toLowerCase()}(${a.join(",")})`}else return n(s).toString()};return t.map(o).sort().join("-")},Xt=(e,t,r={})=>{let n=e[U],o=vt(e,t),s=[],a=[],i=[],c=(C,Q)=>{C.forEach(qt=>{n.componentMap.has(qt)||at(e,qt),Q.push(qt)})};t.forEach(C=>{me in C?C[me]==="Not"?c(C[Pe],a):C[me]==="Or"&&c(C[Pe],i):(n.componentMap.has(C)||at(e,C),s.push(C))});let u=C=>n.componentMap.get(C),l=s.concat(a.flat()).concat(i.flat()).map(u),f=r.buffered?Ws():Or(),y=Or(),d=l.map(C=>C.generationId).reduce((C,Q)=>(C.includes(Q)||C.push(Q),C),[]),p=(C,Q)=>(C[Q.generationId]||(C[Q.generationId]=0),C[Q.generationId]|=Q.bitflag,C),h=s.map(u).reduce(p,{}),E=a.map(u).reduce(p,{}),D=i.map(u).reduce(p,{}),v=l.reduce(p,{}),Ie=Ct(),Le=Ct(),G=Object.assign(f,{components:s,notComponents:a,orComponents:i,allComponents:l,masks:h,notMasks:E,orMasks:D,hasMasks:v,generations:d,toRemove:y,addObservable:Ie,removeObservable:Le,queues:{}});n.queries.add(G),n.queriesHashMap.set(o,G),l.forEach(C=>{C.queries.add(G)}),a.length&&n.notQueries.add(G);let kr=n.entityIndex;for(let C=0;C<kr.aliveCount;C++){let Q=kr.dense[C];ge(e,Q,yr)||Nt(e,G,Q)&&Lt(G,Q)}return G};function on(e,t,r={}){let n=e[U],o=vt(e,t),s=n.queriesHashMap.get(o);return s?r.buffered&&!("buffer"in s.dense)&&(s=Xt(e,t,{buffered:!0})):s=Xt(e,t,r),s.dense}function dr(e,t){return Gs(e),on(e,t)}function Nt(e,t,r){let n=e[U],{masks:o,notMasks:s,orMasks:a,generations:i}=t;for(let c=0;c<i.length;c++){let u=i[c],l=o[u],f=s[u],y=a[u],d=n.entityMasks[u][r];if(f&&d&f||l&&(d&l)!==l||y&&!(d&y))return!1}return!0}var Lt=(e,t)=>{e.toRemove.remove(t),e.addObservable.notify(t),e.add(t)},Ks=e=>{for(let t=0;t<e.toRemove.dense.length;t++){let r=e.toRemove.dense[t];e.remove(r)}e.toRemove.reset()},Gs=e=>{let t=e[U];t.dirtyQueries.size&&(t.dirtyQueries.forEach(Ks),t.dirtyQueries.clear())},pr=(e,t,r)=>{let n=e[U];!t.has(r)||t.toRemove.has(r)||(t.toRemove.add(r),n.dirtyQueries.add(t),t.removeObservable.notify(r))},Xs=(e,t)=>{let r=e[U],n=vt(e,t),o=r.queriesHashMap.get(n);o&&(r.queries.delete(o),r.queriesHashMap.delete(n))},ut=Symbol.for("bitecs-relation"),Oe=Symbol.for("bitecs-pairTarget"),jt=Symbol.for("bitecs-isPairComponent"),Bt=Symbol.for("bitecs-relationData"),an=()=>{let e={pairsMap:new Map,initStore:void 0,exclusiveRelation:!1,autoRemoveSubject:!1,onTargetRemoved:void 0},t=r=>{if(r===void 0)throw Error("Relation target is undefined");let n=r==="*"?X:r;if(!e.pairsMap.has(n)){let o={};tt(o,ut,t),tt(o,Oe,n),tt(o,jt,!0),e.pairsMap.set(n,o)}return e.pairsMap.get(n)};return tt(t,Bt,e),t},Me=(e,t)=>{if(e===void 0)throw Error("Relation is undefined");return e(t)},Tt=(e,t,r)=>{let n=lt(e,t),o=[];for(let s of n)s[ut]===r&&s[Oe]!==X&&!so(s[Oe])&&o.push(s[Oe]);return o},Zs=Symbol.for("bitecs-wildcard");function eo(){let e=an();return Object.defineProperty(e,Zs,{value:!0,enumerable:!1,writable:!1,configurable:!1}),e}function to(){let e=Symbol.for("bitecs-global-wildcard");return globalThis[e]||(globalThis[e]=eo()),globalThis[e]}var X=to();function ro(){return an()}function no(){let e=Symbol.for("bitecs-global-isa");return globalThis[e]||(globalThis[e]=ro()),globalThis[e]}var At=no();function so(e){return e?Object.getOwnPropertySymbols(e).includes(Bt):!1}var at=(e,t)=>{if(!t)throw new Error("bitECS - Cannot register null or undefined component");let r=e[U],n=new Set,o={id:r.componentCount++,generationId:r.entityMasks.length-1,bitflag:r.bitflag,ref:t,queries:n,setObservable:Ct(),getObservable:Ct()};return r.componentMap.set(t,o),r.bitflag*=2,r.bitflag>=2**31&&(r.bitflag=1,r.entityMasks.push([])),o},ge=(e,t,r)=>{let n=e[U],o=n.componentMap.get(r);if(!o)return!1;let{generationId:s,bitflag:a}=o;return(n.entityMasks[s][t]&a)===a},oo=(e,t,r)=>{let n=e[U].componentMap.get(r);if(n&&ge(e,t,r))return n.getObservable.notify(t)},cn=(e,t,r,n,o=new Set)=>{if(!o.has(n)){o.add(n),de(t,r,At(n));for(let s of lt(t,n))if(s!==yr&&!ge(t,r,s)){de(t,r,s);let a=e.componentMap.get(s);if(a!=null&&a.setObservable){let i=oo(t,n,s);a.setObservable.notify(r,i)}}for(let s of Tt(t,n,At))cn(e,t,r,s,o)}},de=(e,t,...r)=>{if(!mr(e,t))throw new Error(`Cannot add component - entity ${t} does not exist in the world.`);let n=e[U];r.forEach(o=>{let s="component"in o?o.component:o,a="data"in o?o.data:void 0;n.componentMap.has(s)||at(e,s);let i=n.componentMap.get(s);if(a!==void 0&&i.setObservable.notify(t,a),ge(e,t,s))return;let{generationId:c,bitflag:u,queries:l}=i;if(n.entityMasks[c][t]|=u,ge(e,t,yr)||l.forEach(f=>{f.toRemove.remove(t),Nt(e,f,t)?Lt(f,t):pr(e,f,t)}),n.entityComponents.get(t).add(s),s[jt]){let f=s[ut],y=s[Oe];if(de(e,t,Me(f,X)),de(e,t,Me(X,y)),typeof y=="number"&&(de(e,y,Me(X,t)),de(e,y,Me(X,f)),n.entitiesWithRelations.add(y),n.entitiesWithRelations.add(t)),n.entitiesWithRelations.add(y),f[Bt].exclusiveRelation===!0&&y!==X){let d=Tt(e,t,f)[0];d!=null&&d!==y&&Re(e,t,f(d))}if(f===At){let d=Tt(e,t,At);for(let p of d)cn(n,e,t,p)}}})},Re=(e,t,...r)=>{let n=e[U];if(!mr(e,t))throw new Error(`Cannot remove component - entity ${t} does not exist in the world.`);r.forEach(o=>{if(!ge(e,t,o))return;let s=n.componentMap.get(o),{generationId:a,bitflag:i,queries:c}=s;if(n.entityMasks[a][t]&=~i,c.forEach(u=>{u.toRemove.remove(t),Nt(e,u,t)?Lt(u,t):pr(e,u,t)}),n.entityComponents.get(t).delete(o),o[jt]){let u=o[Oe];Re(e,t,Me(X,u));let l=o[ut];Tt(e,t,l).length===0&&Re(e,t,Me(l,X))}})},yr={},un=e=>{let t=e[U],r=Fs(t.entityIndex);return t.notQueries.forEach(n=>{Nt(e,n,r)&&Lt(n,r)}),t.entityComponents.set(r,new Set),r},ln=(e,t)=>{let r=e[U];if(!fr(r.entityIndex,t))return;let n=[t],o=new Set;for(;n.length>0;){let s=n.shift();if(o.has(s))continue;o.add(s);let a=[];if(r.entitiesWithRelations.has(s)){for(let i of on(e,[X(s)]))if(mr(e,i))for(let c of r.entityComponents.get(i)){if(!c[jt])continue;let u=c[ut][Bt];a.push(()=>Re(e,i,Me(X,s))),c[Oe]===s&&(a.push(()=>Re(e,i,c)),u.autoRemoveSubject&&n.push(i),u.onTargetRemoved&&a.push(()=>u.onTargetRemoved(e,i,s)))}r.entitiesWithRelations.delete(s)}for(let i of a)i();for(let i of n)ln(e,i);for(let i of r.queries)pr(e,i,s);qs(r.entityIndex,s),r.entityComponents.delete(s);for(let i=0;i<r.entityMasks.length;i++)r.entityMasks[i][s]=0}},lt=(e,t)=>{let r=e[U];if(t===void 0)throw new Error("getEntityComponents: entity id is undefined.");if(!fr(r.entityIndex,t))throw new Error(`getEntityComponents: entity ${t} does not exist in the world.`);return Array.from(r.entityComponents.get(t))},mr=(e,t)=>fr(e[U].entityIndex,t);const se=oe({name:"ECSState",initial:{timer:null,periodicUpdateFrequency:5*1e3,simulationTimestep:1e3/60,frameTime:Date.now(),simulationTime:Date.now(),deltaSeconds:0,maxDeltaSeconds:.1,elapsedSeconds:0,lastSystemExecutionDuration:0}});class H{constructor(t,r,n=!1){this.fn=t,this.path=r,this.isFinal=n}static create(t,r){const n=new H(t,r);return{in:n.createIn(),out:n.createOut(),inOut:n.createInOut()}}createIn(){return Object.assign(r=>this.fn(r),{path:`${this.path}.in`})}createOut(){return Object.assign(r=>1-this.fn(1-r),{path:`${this.path}.out`})}createInOut(){return Object.assign(r=>r<.5?this.fn(r*2)/2:1-this.fn((1-r)*2)/2,{path:`${this.path}.inOut`})}}const Mt={linear:H.create(e=>e,"linear"),quadratic:H.create(e=>e*e,"quadratic"),cubic:H.create(e=>e*e*e,"cubic"),quartic:H.create(e=>e*e*e*e,"quartic"),quintic:H.create(e=>e*e*e*e*e,"quintic"),sine:H.create(e=>1-Math.cos(e*Math.PI/2),"sine"),exponential:H.create(e=>Math.pow(2,10*(e-1)),"exponential"),circle:H.create(e=>1-Math.sqrt(1-e*e),"circle"),back:H.create(e=>e*e*((1.70158+1)*e-1.70158),"back"),elastic:H.create(e=>1-Math.pow(Math.cos(e*Math.PI/2),3)*Math.cos(e*Math.PI),"elastic"),bounce:H.create(e=>{if(e<1/2.75)return 7.5625*e*e;if(e<2/2.75){const r=e-.5454545454545454;return 7.5625*r*r+.75}if(e<2.5/2.75){const r=e-.8181818181818182;return 7.5625*r*r+.9375}const t=e-2.625/2.75;return 7.5625*t*t+.984375},"bounce"),fromPath:e=>{const[t,r]=e.split("."),n=Mt[t];if(!n)throw new Error(`Invalid easing function path: ${e}`);return n[r]}},ui=Object.values(Mt).reduce((e,t)=>(typeof t=="object"&&e.push(t.in.path,t.out.path,t.inOut.path),e),[]),_=0,li=Ye.number,mt=Ye.string,fi=Ye.object,ao=Ye.string,io=Ye.string;function co(e){const t=r=>dr(r,e);return t.components=e,t}function uo(e){const t=[],r=new WeakSet,n=o=>{if(!r.has(o)){r.add(o),t.push(...e(o));const s=kt(o,nn(...e.components),a=>t.push(a));n.unsubscribe=()=>{s(),t.length=0}}if(t.length){const s=t.slice();return t.length=0,s}else return t};return n.unsubscribe=()=>{},n}function lo(e){const t=[],r=new WeakSet,n=o=>{if(!r.has(o)){r.add(o);const s=kt(o,sn(...e.components),a=>t.push(a));n.unsubscribe=()=>{s(),t.length=0}}if(t.length){const s=t.slice();return t.length=0,s}else return t};return n.unsubscribe=()=>{},n}function hr(e){const t=new ArrayBuffer(0,{maxByteLength:Math.pow(2,20)});return new e(t)}const fo=Symbol.for("bitecs-opType"),po=Symbol.for("bitecs-opTerms"),fn=[];function ft(e,t=T.Simulation){const r=co([...e,O[t]]),n=uo(r),o=lo(r),s=()=>r(I.store);return s.enter=()=>n(I.store),s.exit=()=>o(I.store),s._query=r,s._enterQuery=n,s._exitQuery=o,fn.push(s),s}function $t(e){try{Xs(I.store,Array.isArray(e)?e:e._query.components),"_enterQuery"in e&&e._enterQuery.unsubscribe(),"_exitQuery"in e&&e._exitQuery.unsubscribe()}catch{}}const xr=e=>dr(I.store,e),Ze={},Pr={},yo=e=>e.map(t=>t.name).sort().join();function mo(e,t=T.Simulation){const r=F(()=>[...xr([...e,O[t]])]);b.useEffect(()=>{const o=[...e,O[t]],s=yo(o),a=!!Ze[s];Ze[s]||(Ze[s]=new Set);const i=Ze[s];if(i.add(r),!a){const c=We(()=>{const u=lr(),l=xr(o);return b.useEffect(()=>{for(const f of i)f.set([...l])},[JSON.stringify(l)]),b.useLayoutEffect(()=>{const f=[...e,O[t]],y=kt(I.store,nn(...f),u),d=kt(I.store,sn(...f),u),p=()=>{y(),d()};return()=>{p(),$t(f)}},[]),null});Pr[s]=c}return()=>{i.delete(r),i.size===0&&(Pr[s].stop(),delete Ze[s])}},[]);const n=r.get(Rt);return b.useMemo(()=>[...n],[JSON.stringify(n)])}const ho=oe({name:"ir.ecs.SuspendedQueryChildState",initial:[]}),dn=e=>(b.useEffect(()=>{const t=W(ho);return t.merge([e]),()=>{t.set(r=>r.filter(n=>n!==e))}},[]),null),di=b.memo(e=>{const t=b.useMemo(()=>b.memo(e.ChildEntityReactor),[e.ChildEntityReactor]);return w.createElement(w.Fragment,null,e.entities.map(r=>{var s;const n=k.get(r),o=(s=O[n].stateMap[r])==null?void 0:s.identifier;return w.createElement(pn,{key:o},w.createElement(b.Suspense,{fallback:w.createElement(dn,{...e})},w.createElement(Dr.Provider,{value:r},w.createElement(t,{key:o,...e.props,entity:r}))))}))}),go=b.memo(e=>{var o;const t=[];for(const s of e.Components)if(s.isComponent)t.push(s);else{const a=s(),i=a[fo];(i==="Or"||i==="And")&&t.push(...a[po])}const r=[];for(const s of t){const a=(o=Ne(e.entity,s))==null?void 0:o.identifier;a&&r.push(a)}const n=r.join("_");return w.createElement(w.Fragment,null,w.createElement(pn,null,w.createElement(b.Suspense,{fallback:w.createElement(dn,{...e})},w.createElement(Dr.Provider,{value:e.entity},w.createElement(e.ChildEntityReactor,{key:n,...e.props,entity:e.entity})))))}),bo=b.memo(e=>{const t=mo(e.Components,e.layer),r=b.useMemo(()=>b.memo(e.ChildEntityReactor),[e.ChildEntityReactor]);return w.createElement(w.Fragment,null,t.map(n=>w.createElement(go,{key:n,entity:n,Components:e.Components,ChildEntityReactor:r,props:e.props})))});class pn extends w.Component{constructor(){super(...arguments);R(this,"state",{error:null})}static getDerivedStateFromError(r){return{error:r}}componentDidCatch(r,n){console.error("Uncaught error:",r,n)}render(){return this.state.error?null:this.props.children}}const ue=oe({name:"ee.meta.SystemState",initial:()=>({performanceProfilingEnabled:!1,activeSystemReactors:new Map,currentSystemUUID:"__null__",reactiveQueryStates:new Set})}),Rr=window.performance,K=Rr.now.bind(Rr),So=1e4;function pi(){const e=K();return()=>K()-e}function yi(e,t=60){const r="requestAnimationFrame"in self?Io():Eo(t);r.setContext(self);function n(){K(),K(),K()+So}function o(){r.setAnimationLoop(e),r.start(),n()}function s(){r.setAnimationLoop(null),r.stop()}function a(){s()}return{animation:r,start:o,stop:s,clear:a}}class wo{constructor(t=()=>{},r=10,n){R(this,"_update");R(this,"_lastFrameTime");R(this,"_running");R(this,"_step");R(this,"_deltas");this._times=r,this._option=n,this._update=t,this._running=!1,this._step=1e3/this._times,this._lastFrameTime=this._time(),this._deltas=Array()}_nano(){const t=globalThis.process.hrtime();return+t[0]*1e9+ +t[1]}_ConvertSecondsToNano(t){return t*1e9}_ConvertNanoToSeconds(t){return t*(1/1e9)}_ConvertNanoToMs(t){return this._ConvertNanoToSeconds(t)*1e3}_ConvertMsToNano(t){return t*1e6}now_ms(){return this._ConvertNanoToMs(this._time())}_time(){var t,r;return((r=(t=this._option)==null?void 0:t.time_fn)==null?void 0:r.call(t))??this._nano()}start(){this._running=!0,this._lastFrameTime=this._time(),this._deltas=Array();const t=this._ConvertMsToNano(this._step),r=Math.max(Math.floor(this._step-1),16),n=3,o=Math.ceil(1/this._step*1e3/2)+1,s=this;let a=this._time();function i(){var y,d,p,h;if(!s._running)return;const c=s._time(),u=c-s._lastFrameTime;if(c<=a)return setImmediate(i);s._deltas.length>=o&&s._deltas.shift(),s._deltas.push(u);const l=s._deltas.reduce((E,D)=>E+D,0)/(s._deltas.length||1);return s._lastFrameTime=c,a=c+t,s._ConvertNanoToMs(Math.abs(t-l))>=n&&(((y=s._option)!=null&&y.logs||(d=s._option)!=null&&d.dif_log)&&console.log(s._ConvertNanoToMs(t-l)),a+=t-l),s._update(s._ConvertNanoToMs(u)/1e3),((p=s._option)!=null&&p.logs||(h=s._option)!=null&&h.delta_log)&&console.log(`${s._ConvertNanoToMs(u)} ms`),a-s._time()>t?setTimeout(i,r):setImmediate(i)}return setTimeout(i,r),this}stop(){return this._running=!1,this}}function Eo(e){let t=null,r=null;return{start:function(){const n=()=>{r&&r(K(),null)};t=new wo(n,e).start()},stop:function(){t==null||t.stop()},setAnimationLoop:function(n){r=n},setContext:function(){}}}function Io(){let e=null,t=!1,r=null,n=null;function o(s,a){n=e.requestAnimationFrame(o),r(s,a)}return{start:function(){t!==!0&&r!==null&&(n=e.requestAnimationFrame(o),t=!0)},stop:function(){e.cancelAnimationFrame(n),t=!1},setAnimationLoop:function(s){r=s},setContext:function(s){e=s}}}const mi=(e=0)=>[...$.values()].filter(n=>n.avgSystemDuration>e).sort((n,o)=>o.avgSystemDuration-n.avgSystemDuration),hi=()=>[...$.values()].sort((r,n)=>n.avgSystemDuration-r.avgSystemDuration),Do="__null__",$=new Map;globalThis.SystemDefinitions=$;const vr=new Map,Co=1e3*10;function _e(e){const t=$.get(e);if(!t){console.warn(`System ${e} does not exist.`);return}for(let s=0;s<t.preSystems.length;s++)_e(t.preSystems[s]);if(t.reactor&&!g(ue).activeSystemReactors.has(t.uuid)){t.reactor.__name=t.uuid;const s=We(t.reactor);g(ue).activeSystemReactors.set(t.uuid,s)}const r=K();try{g(ue).currentSystemUUID=e,t.execute()}catch(s){const a=I.store.logger("ecs:SystemFunctions");a.error(`Failed to execute system ${t.uuid}`),a.error(s)}finally{g(ue).currentSystemUUID=Do}const n=K(),o=n-r;t.systemDuration=o,t.systemDuration!=0&&(t.avgSystemDuration=(o+t.avgSystemDuration)*.5),g(ue).performanceProfilingEnabled&&o>50&&(vr.get(e)??0)<n-Co&&(vr.set(e,n),I.store.logger("ecs:SystemFunctions").warn(`Long system execution detected. System: ${t.uuid} 
 Duration: ${o}`));for(let s=0;s<t.subSystems.length;s++)_e(t.subSystems[s]);for(let s=0;s<t.postSystems.length;s++)_e(t.postSystems[s])}function te(e){if($.has(e.uuid))throw new Error(`System ${e.uuid} already exists.`);const t={preSystems:[],subSystems:[],postSystems:[],sceneSystem:!1,execute:()=>{},...e,uuid:e.uuid,enabled:!1,systemDuration:0,avgSystemDuration:0};$.set(t.uuid,t);const r=t.insert;if("before"in r&&typeof r.before>"u")throw console.log(t),new Error("System insert.before is undefined");if("with"in r&&typeof r.with>"u")throw console.log(t),new Error("System insert.with is undefined");if("after"in r&&typeof r.after>"u")throw console.log(t),new Error("System insert.after is undefined");if(r!=null&&r.before){const n=$.get(r.before);if(!n)throw new Error(`System ${r.before} does not exist.`);n.preSystems.push(t.uuid)}if(r!=null&&r.with){const n=$.get(r.with);if(!n)throw new Error(`System ${r.with} does not exist.`);n.subSystems.push(t.uuid)}if(r!=null&&r.after){const n=$.get(r.after);if(!n)throw new Error(`System ${r.after} does not exist.`);n.postSystems.push(t.uuid)}return e.uuid}const gi=(e,t)=>{const r=F(()=>t.uuid??en());ot(()=>{const n=te({uuid:r.value,execute:e,insert:t});return()=>{St(n)}})},St=e=>{const t=$.get(e);if(!t)throw new Error(`System ${e} does not exist.`);for(const o of t.subSystems)St(o);const r=g(ue).activeSystemReactors.get(t.uuid);r&&(g(ue).activeSystemReactors.delete(t.uuid),r.stop());for(const o of t.postSystems)St(o);for(const o of t.preSystems)St(o);const n=t.insert;if(n!=null&&n.before){const o=$.get(n.before);o.preSystems.splice(o.preSystems.indexOf(t.uuid),1)}if(n!=null&&n.with){const o=$.get(n.with);o.subSystems.splice(o.subSystems.indexOf(t.uuid),1)}if(n!=null&&n.after){const o=$.get(n.after);o.postSystems.splice(o.postSystems.indexOf(t.uuid),1)}$.delete(e)},yn=te({uuid:"ee.engine.input-group",insert:{}}),Ke=te({uuid:"ee.engine.simulation-group",insert:{}}),gr=te({uuid:"ee.engine.animation-group",insert:{}}),br=te({uuid:"ee.engine.presentation-group",insert:{}}),ko=[yn,Ke,gr,br],Zt={number:{interpolate:(e,t,r)=>e+(t-e)*r,isType:e=>typeof e=="number"},vector2:{interpolate:(e,t,r,n)=>(n=n||new Ur,n.x=e.x+(t.x-e.x)*r,n.y=e.y+(t.y-e.y)*r,n),isType:e=>e instanceof Ur},vector3:{interpolate:(e,t,r,n)=>(n=n||new Mr,n.x=e.x+(t.x-e.x)*r,n.y=e.y+(t.y-e.y)*r,n.z=e.z+(t.z-e.z)*r,n),isType:e=>e instanceof Mr},quaternion:{interpolate:(e,t,r,n)=>(n=n||new Ar,n.slerpQuaternions(e,t,r)),isType:e=>e instanceof Ar},color:{interpolate:(e,t,r,n)=>(n=n||new yt,n.lerpColors(e,t,r),n),isType:e=>e instanceof yt},colorHSL:{interpolate:(e,t,r,n)=>(n=n||new yt,n.copy(e).lerpHSL(t,r),n),isType:e=>e instanceof yt}};function To(e){var t;return(t=Object.entries(Zt).find(([r,n])=>n.isType(e)))==null?void 0:t[0]}const P=Symbol("Kind"),Qt=Symbol("NonSerializable"),bi=Symbol("Required"),Ao=(e,t)=>typeof t=="function"?t(e):structuredClone(t),Mo=(e,t)=>{const r={};for(const n in t){const o=t[n];if(o[P]==="Proxy"){const a=o.options.create(e,n,r);r[n]=a}else r[n]=Je(e,o)}return r},B=e=>e!=null,He=(e,t)=>{if(t(e))return!0;switch(e[P]){case"Object":case"Class":{const r=e.properties,n=Object.keys(r);for(const o of n)if(He(r[o],t))return!0;return!1}case"Partial":case"Proxy":{const r=e.properties;return He(r,t)}default:return!1}},Si=e=>He(e,t=>{var r;return!!((r=t.options)!=null&&r.deserialize)}),ke=(e,t,r,n)=>{var o;if(B(n)&&((o=t.options)!=null&&o.deserialize))return t.options.deserialize(r,n);switch(t[P]){case"Number":return B(n)?typeof n=="number"?n:void 0:n;case"Bool":return B(n)?typeof n=="boolean"?n:void 0:n;case"String":return B(n)&&(typeof n!="string"||n==="__proto__")?void 0:n;case"Literal":return B(n)?t.properties===n?n:void 0:n;case"Array":{if(!B(n))return n;if(!Array.isArray(n))return;const s=t.properties,a=r,i=a.length;if(i<n.length)for(let c=i;c<n.length;c++)a.push(Je(e,s));try{return n.map((c,u)=>ke(e,s,r[u],c)).filter(c=>B(c))}catch(c){return console.log(c),r}}case"Tuple":{if(!B(n))return n;if(!Array.isArray(n))return;const s=t.properties;return n.map((a,i)=>ke(e,s[i],r[i],a)??r[i])}case"Union":{if(!B(n))return n;const s=t.properties;for(const a of s){const i=ke(e,a,r,n);if(B(i))return i}return}case"Object":{if(!B(n))return n;if(typeof n!="object")return;const s={},a=Object.keys(n),i=t.properties??{};for(const c of a)if(i[c]&&(s[c]=r[c],B(n[c]))){const u=ke(e,i[c],r[c],n[c]);typeof u<"u"&&(s[c]=u)}return s}case"Class":{if(!B(n))return n;const s=t.properties??{},a=Object.keys(s);for(const i of a)B(n[i])?n[i]=ke(e,s[i],r[i],n[i]):n[i]=r[i];break}case"Proxy":case"Partial":{const s=t.properties;return ke(e,s,r,n)}}return n},er=e=>He(e,t=>{var r;return!!((r=t.options)!=null&&r.required)}),it=(e,t,r="")=>{var n;if((n=e.options)!=null&&n.required)return[B(t),r];switch(e[P]){case"Object":case"Class":{const o=e.properties,s=Object.keys(o);for(const a of s){const[i,c]=it(o[a],t==null?void 0:t[a],a);if(!i)return[i,c]}return[!0,""]}case"Proxy":case"Partial":{const o=e.properties;return it(o,t)}default:return[!0,""]}},Uo=e=>He(e,t=>{var r;return!!((r=t.options)!=null&&r.validate)}),tr=(e,t,r,n,o="")=>{var s;if((s=e.options)!=null&&s.validate&&!e.options.validate(t,r,n))return[!1,o];switch(e[P]){case"Object":case"Class":{const a=e.properties,i=Object.keys(a);for(const c of i){const[u,l]=tr(a[c],t==null?void 0:t[c],r==null?void 0:r[c],n,c);if(!u)return[u,l]}return[!0,""]}case"Proxy":case"Partial":{const a=e.properties;return tr(a,t,r,n)}default:return[!0,""]}},wi=e=>He(e,t=>{var r;return!!((r=t.options)!=null&&r.deserialize)}),rr=e=>{if(!e||!e[P])return!1;switch(e[P]){case"Null":case"Undefined":case"Void":case"Number":case"Bool":case"String":case"Literal":case"Class":case"Array":case"Tuple":case"Func":return!0;case"Any":case"Object":case"Record":case"Partial":return!1;case"Union":{const t=e.properties;if(!t.length)return!1;for(const r of t)if(!rr(r))return!1;return!0}case"Proxy":{const t=e.properties;return rr(t)}default:return!1}},Je=(e,t)=>{if(t.options&&"default"in t.options)return Ao(e,t.options.default);switch(t[P]){case"Null":return null;case"Undefined":return;case"Void":return;case"Number":return 0;case"Bool":return!1;case"String":return"";case"Literal":return t.properties;case"Object":case"Class":{const r=t.properties;return Mo(e,r)}case"Any":case"Record":case"Partial":return{};case"Array":case"Tuple":return[];case"Union":{const r=t.properties;return r.length?Je(e,r[0]):null}case"Func":{const r=t.properties;return()=>Je(e,r.return)}default:return}},Oo=e=>ArrayBuffer.isView(e),_o=e=>e instanceof Set,xo=e=>e instanceof Map,Po=e=>e==="bigint"||e==="boolean"||e==="number"||e==="string"||e==="symbol"||e==="undefined",rt=e=>{var r;const t=typeof e;if(typeof e>"u")return null;if(Po(t)||e===null)return e;if(Oo(e))return e.slice(0);if(Array.isArray(e))return(r=e.map(n=>rt(n)))==null?void 0:r.filter(n=>n!==Qt);if(_o(e))return new Set(rt([...e.values()]));if(xo(e))return new Map(rt([...e.entries()]));if(t==="object"){const n={};for(const o in e){const s=rt(e[o]);s!==Qt&&(n[o]=s)}return n}return Qt},le=e=>{var t;return!!((t=e==null?void 0:e.options)!=null&&t.serialized)},we=(e,t)=>{switch(e[P]){case"Null":return t===null;case"Undefined":return t===void 0;case"Number":return typeof t=="number";case"Bool":return typeof t=="boolean";case"String":return typeof t=="string";case"Literal":return t===e.properties;case"Object":case"Class":{const r=e.properties;for(const n in r)if(le(r[n])&&!we(r[n],t[n]))return!1;return!0}case"Any":return!0;case"Record":{const r=e.properties,n=r.key,o=r.value;if(!le(o))return!0;if(t&&typeof t=="object")for(const[s,a]of Object.entries(t)){const i=we(n,s),c=we(o,a);if(!i||!c)return!1}return!0}case"Partial":return!0;case"Array":{const r=e.properties;if(!le(r))return!0;if(Array.isArray(t)){if(t.length===0)return!0;for(const n of t)if(!we(r,n))return!1;return!0}else return!1}case"Tuple":{const r=e.properties;if(!Array.isArray(t))return!1;for(let n=0;n<r.length;n++)if(!we(r[n],t[n]))return!1;return!0}case"Union":{const r=e.properties;if(r.length){let n=!0;for(const o of r){if(le(o))n=!1;else continue;if(we(o,t))return!0}return n}else return!1}case"Proxy":{const r=e.properties;return we(r,t)}case"Func":return!0;default:return!1}},ie=(e,t)=>{var r,n;if(le(e)){if((r=e.options)!=null&&r.serialize)return(n=e.options)==null?void 0:n.serialize(t);switch(e[P]){case"Null":case"Undefined":case"Void":case"Number":case"Bool":case"String":case"Literal":case"Any":return t;case"Object":case"Class":{const o=e.properties,s=Object.keys(o);return s.length&&t&&typeof t=="object"?Object.entries(t).reduce((a,[i,c])=>(s.includes(i)&&le(o[i])&&(a[i]=ie(o[i],c)),a),{}):e[P]==="Class"?null:t}case"Record":{const o=e.properties,s=o.key,a=o.value;return le(a)?t&&typeof t=="object"?Object.entries(t).reduce((i,[c,u])=>{const l=ie(s,c),f=ie(a,u);return l!=null&&(i[l]=f),i},{}):t:null}case"Array":{const o=e.properties;return le(o)?Array.isArray(t)?t.map(s=>ie(o,s)):t:null}case"Tuple":{const o=e.properties;return Array.isArray(t)?t.map((s,a)=>ie(o[a],s)):t}case"Union":{const o=e.properties;if(!o.length)return null;for(const s of o){if(!le(s))continue;const a=ie(s,t);if(we(s,a))return a}return null}case"Partial":case"Proxy":{const o=e.properties;return ie(o,t)}default:return null}}},De=e=>{var r,n,o,s,a,i;if(((r=e.options)==null?void 0:r.serialized)===!1)return;const t={};switch(e[P]){case"Number":{const c=e.options;t.type="number",(c==null?void 0:c.maximum)!==void 0&&(t.maximum=c.maximum),(c==null?void 0:c.minimum)!==void 0&&(t.minimum=c.minimum);break}case"Bool":t.type="boolean";break;case"String":t.type="string";break;case"Literal":t.const=e.properties;break;case"Object":{t.type="object";const c=e.properties;t.required=[];for(const[u,l]of Object.entries(c)){const f=De(l);!f||f.type==="null"||(t.properties||(t.properties={}),t.properties[u]=f,(n=l.options)!=null&&n.required&&t.required.push(u))}break}case"Record":{const c=e.properties;t.type="object",t.additionalProperties=De(c.value);break}case"Partial":{const c=e.properties;t.type="object";const u=De(c);t.properties=u==null?void 0:u.properties,t.required=[];break}case"Array":{const c=e.properties,u=e.options;t.type="array",t.items=De(c),(u==null?void 0:u.minItems)!==void 0&&(t.minItems=u.minItems),(u==null?void 0:u.maxItems)!==void 0&&(t.maxItems=u.maxItems);break}case"Tuple":{const c=e.properties;t.type="array",t.items=c.map(u=>De(u)),t.minItems=c.length,t.maxItems=c.length;break}case"Union":{const c=e.properties;if(c.every(l=>l[P]==="Literal")){const l=Object.values(e.properties).map(f=>f.properties);t.enum=l,(s=(o=e.options)==null?void 0:o.metadata)!=null&&s.objectRef&&(t.metadata??(t.metadata={}),t.metadata.enumKeys=Object.keys(e.options.metadata.objectRef));break}t.oneOf=c.map(l=>De(l));break}case"Proxy":{const c=e.properties;return De(c)}case"Null":case"Undefined":case"Void":case"Func":case"Class":case"Any":default:return}return(a=e.options)!=null&&a.id&&(t.$id=e.options.id),(i=e.options)!=null&&i.$comment&&(t.$comment=e.options.$comment),t},Ro=(e,t)=>{const r=ie(e,t);return rt(r)},Ei={ConvertToSchema:ie},vo=(e,t)=>({...{serialized:!0},...t}),x=(e,t)=>({[P]:e,options:vo(e,t)}),m={Null:e=>({...x("Null",e)}),Undefined:e=>({...x("Undefined",e)}),Void:e=>({...x("Void",e)}),Number:e=>({...x("Number",e)}),Bool:e=>({...x("Bool",e)}),String:e=>({...x("String",e)}),Enum:(e,t)=>{const r=Object.values(e)[0];let n;return typeof r=="string"&&(n=(o,s)=>typeof s=="number"?Object.values(e)[s]:s),m.LiteralUnion(Object.values(e),{default:r,deserialize:n,...t,metadata:{objectRef:e,...t==null?void 0:t.metadata}})},Literal:(e,t)=>({...x("Literal",t),properties:e}),Object:(e,t)=>({...x("Object",t),properties:e}),Record:(e,t,r)=>({...x("Record",r),properties:{key:e,value:t}}),Partial:(e,t)=>({...x("Partial",t),properties:e}),Array:(e,t)=>({...x("Array",t),properties:e}),Tuple:(e,t)=>({...x("Tuple",t),properties:e}),Union:(e,t)=>({...x("Union",t),properties:e}),LiteralUnion:(e,t)=>m.Union([...e.map(r=>m.Literal(r))],t),Class:(e,t)=>({...x("Class",{default:e,...t}),properties:{}}),SerializedClass:(e,t,r)=>({...x("Class",{serialized:!0,id:"SerializedClass",default:e,...r}),properties:t}),Func:(e,t,r)=>({...x("Func",r),properties:{params:e,return:t}}),Call:e=>m.Func([],m.Void(),e),Optional:(e,t)=>m.Union([m.Undefined(),e],t),Type:(e,t)=>m.SerializedClass(e==null?void 0:e.default,t??{},e),Any:()=>({...x("Any")}),Entity:e=>m.Number({serialized:!0,id:"Entity",...e}),EntityUUID:e=>m.String({serialized:!0,...e,id:"EntityUUID"}),EntityID:e=>m.String({serialized:!0,...e,id:"EntityID"}),EntityUUIDPair:e=>m.Object({entitySourceID:m.String(),entityID:m.EntityID()}),UserID:e=>m.String({serialized:!0,...e,id:"UserUUID"}),PeerID:e=>m.String({serialized:!0,...e,id:"PeerUUID"}),Proxy:(e,t)=>({...x("Proxy",{create:t,serialized:!0}),properties:e})},mn=new Map,Sr=new Map;globalThis.ComponentMap=mn;globalThis.ComponentJSONIDMap=Sr;const ae=e=>{const t={};t.isComponent=!0,e.schema?rr(e.schema)?er(e.schema)?t.onSet=(n,o,s)=>{const[a,i]=it(e.schema,s);if(!a)throw new Error(`${e.name}:OnSet Missing required value for key ${i}`);o.set(s)}:t.onSet=(n,o,s)=>{s&&o.set(s)}:er(e.schema)?t.onSet=(n,o,s)=>{const[a,i]=it(e.schema,s);if(!a)throw new Error(`${e.name}:OnSet Missing required value for key ${i}`);Array.isArray(s)||typeof s!="object"?o.set(s):o.merge(s)}:t.onSet=(n,o,s)=>{s&&(Array.isArray(s)||typeof s!="object"?o.set(s):o.merge(s))}:t.onSet=()=>{},t.onRemove=()=>{},t.toJSON=n=>$o(e,n),t.errors=[],Object.assign(t,e),e.storage&&Object.assign(t,e.storage),t.reactor&&Object.defineProperty(t.reactor,"name",{value:`Internal${t.name}Reactor`}),t.valueMap={},t.stateMap={},t.jsonID?Sr.set(t.jsonID,t):e.toJSON&&console.warn(`Component ${t.name} has toJson defined, but no jsonID defined. This will cause serialization issues.`),mn.set(t.name,t);function r(n,o,s,a){ce.setTarget(n,{componentJsonID:t.jsonID,propertyPath:o,value:s,duration:a.duration,easing:a.easing})}return t.setTransition=r,t.storageSize=0,t},hn=(e,t)=>ge(I.store,e,t)?t.stateMap[e]:void 0,nr=(e,t)=>{const r=hn(e,t);if(r===void 0){console.warn(`[getMutableComponent]: entity ${e} does not have ${t.name}. This will be an error in the future. Use getOptionalMutableComponent if there is uncertainty over whether or not an entity has the specified component.`);return}return r},be=(e,t)=>t.valueMap[e],A=(e,t)=>{const r=t.valueMap[e];return r===void 0&&console.warn(`[getComponent]: entity ${e} does not have ${t.name}. This will be an error in the future. Use getOptionalComponent if there is uncertainty over whether or not an entity has the specified component.`),r},wr=(e,t)=>{if(!t.schema)return t.onInit?t.onInit(void 0):!0;const r=Je(e,t.schema);return t.onInit?t.onInit(r):r};function No(e){return 1<<31-Math.clz32(e)}function Er(e){return No((e-1)*2)}const Lo=Object.getPrototypeOf(Uint8Array),gn=(e,t)=>{if(e instanceof Lo){const r=t*e.constructor.BYTES_PER_ELEMENT;e.buffer.resize(r)}else for(const r in e)gn(e[r],t)},zt=(e,t)=>{const r=e.storage;for(const n in r)gn(e[n],t);e.storageSize=t};let jo=0;const Vt=(e,t)=>{if(!t.stateMap[e]){const r=`${t.name}_${e}_${jo++}`;t.stateMap[e]=ur(xe,Wr(Kr(r),()=>({onSet:(n,o)=>{const s=t.stateMap[e];t.valueMap[e]=s.promised?void 0:s.get(ye),Y.propagateLayer(e,t)}})))}return t.stateMap[e]},J=(e,t,r=void 0)=>{if(!e)throw new Error("[setComponent]: entity is undefined");if(!he(e))throw new Error("[setComponent]: entity does not exist");if(t.storage){const s=Er(e+1);t.storageSize<s&&zt(t,s)}const n=Vt(e,t);if(j(e,t)?t.onSet(e,n,r):(n.set(wr(e,t)),t.onSet(e,n,r),de(I.store,e,t)),Y.propagateLayer(e,t),t.reactor&&!t.reactorRoot){const s=We(()=>w.createElement(bo,{Components:[t],ChildEntityReactor:t.reactor}));s.cleanupFunctions.add(()=>{t.reactorRoot=void 0}),s.component=t.name,t.reactorRoot=s}},j=(e,t)=>{if(!t)throw new Error("[hasComponent]: component is undefined");return e?ge(I.store,e,t):!1};function sr(e,t){if(!t)throw new Error("[hasComponent]: component is undefined");if(t.length<1||!e)return!1;for(const r of t)if(!j(e,r))return!1;return!0}function bn(e,t){var n;let r=!0;for(const o of t)(n=Ne(e,o))==null||n.value,j(e,o)||(r=!1);return r}const ve=(e,t)=>{var n;if(!j(e,t))return;const r=Y.getLayerRelationsEntities(e);if(r){const o=k.get(e);for(const[s,a]of r)Y.shouldPropagate(o,s)&&ve(a,t)}Re(I.store,e,t),t.onRemove(e,t.stateMap[e]),(n=t.stateMap[e])==null||n.set(xe),cr(t.stateMap[e]),delete t.stateMap[e],delete t.valueMap[e]},Ii=e=>{const t=wr(_,e);return e.toJSON(t)},Bo=e=>he(e)?lt(I.store,e):[],Di=e=>Object.fromEntries(Bo(e).map(t=>[t.name,A(e,t)])),Ci=e=>{if(he(e))try{for(const t of lt(I.store,e))try{ve(e,t)}catch(r){console.error(r)}}catch(t){console.error(t)}},ki=(e,t,r=void 0)=>{if(t.schema&&er(t.schema)){const[s,a]=it(t.schema,r);if(!s)throw new Error(`${t.name}:deserializeComponent Missing required value for key ${a}`)}if(!j(e,t)){if(!e)throw new Error("[deserializeComponent]: entity is undefined");if(!he(e))throw new Error("[deserializeComponent]: entity does not exist");if(t.storage){const a=Er(e+1);t.storageSize<a&&zt(t,a)}Vt(e,t).set(wr(e,t)),de(I.store,e,t)}if(r==null)return;const n=A(e,t),o=t.schema?ke(e,t.schema,n,r):r;if(t.schema&&Uo(t.schema)){const[s,a]=tr(t.schema,o,n,e);if(!s)throw new Error(`${n.name}:deserializeComponent Invalid value for key ${a} ${JSON.stringify(o)}`)}J(e,t,o)},Ti=(e,t)=>{const r=A(e,t);return JSON.parse(JSON.stringify(t.toJSON(r)))},$o=(e,t)=>e.schema?Ro(e.schema,t):t;function zo(e){if(e.status==="fulfilled")return e.value;throw e.status==="rejected"?e.reason:(e.status==="pending"||(e.status="pending",e.then(t=>{e.status="fulfilled",e.value=t},t=>{e.status="rejected",e.reason=t})),e)}function wt(e,t){if(e===_)throw new Error("InvalidUsage: useComponent called with UndefinedEntity");const r=Vt(e,t);return r.promise&&(w.use??zo)(r.promise),F(r)}function Ai(e,t){var r;return(r=Ne(e,t))==null||r.value,j(e,t)}function Ne(e,t){const r=F(Vt(e,t));return r.promised?void 0:r}const Mi=e=>{const t=ft([e]),r=t().length;return $t(t),r},Ui=e=>{const t=ft([e]),r=t();return $t(t),r.map(n=>A(n,e))};function Vo(e){const t=Y.getLayerComponent(e);if(!t)return;const r=be(e,t);if(r)return Object.entries(r.relations).map(([n,o])=>[Number(n),o])}function Fo(e){return Object.entries(Sn[e]).map(([t,r])=>[Number(t),r])}function qo(e){return O[k.get(e)]}function Qo(e,t){return Sn[e][t]===Ut.Propagate}function Ho(e,t,r,n,o,s,a){var i;if(r===_)return r;if(e[P]==="Number"&&((i=e==null?void 0:e.options)==null?void 0:i.id)==="Entity"){const c=r;return k.get(c)===o?c:A(c,O[n]).relations[o]}else return r}function Jo(e,t,r,n,o,s,a){if(r)return typeof r=="object"&&"clone"in r&&typeof r.clone=="function"?r.clone():Array.isArray(r)?[...r]:structuredClone(r)}function Yo(e,t,r,n,o,s,a){if(r){if(typeof r=="object"&&"clone"in r&&typeof r.clone=="function")return r.clone();try{return structuredClone(r)}catch(i){return console.warn(`[propagateSchema]: ${s} ${a.name} ${t} is not a cloneable class. `+i.message),r}}}function Wo(e,t,r,n,o,s,a){if(!r||typeof r!="object")return;const i=e.properties,c={};for(const u in i){const l=N.Inner(i[u],u,r,n,o,s,a);typeof l>"u"||(c[u]=l)}return c}function Ko(e,t,r,n,o,s,a){if(!r)return;const{key:i,value:c}=e.properties,u={};for(const l in r){const f=N.Inner(c,l,r,n,o,s,a);typeof f>"u"||(u[l]=f)}return u}function Go(e,t,r,n,o,s,a){if(!r)return;const i=e.properties,c=[];for(let u=0;u<r.length;u++){const l=N.Inner(i,u,r,n,o,s,a);c[u]=l}return c}function Xo(e,t,r,n,o,s,a){if(!r)return;const i=e.properties,c=[];for(let u=0;u<i.length;u++){const l=N.Inner(i[u],u,r,n,o,s,a);c[u]=l}return c}function Zo(e,t,r,n,o,s,a){const i=e.properties;for(const c of i){const u=N.Inner(c,"",r,n,o,s,a);if(typeof u<"u")return u}return null}function ea(e,t,r,n,o,s,a){let i=e.properties;if(!i){if(typeof r=="object")i={properties:Object.fromEntries(Object.keys(e).map(c=>[c,{[P]:"Any"}])),[P]:"Object"};else if(typeof r=="number")return r}return N.Inner(i,"",r,n,o,s,a)}function ta(e,t,r,n,o,s,a){var c;const i=t===""?r:r[t];if(!(typeof i>"u"||!((c=e.options)!=null&&c.serialized)))switch(e[P]){case"Null":case"Undefined":case"Void":case"Bool":case"String":case"Literal":return i;case"Number":return N.Number(e,t,i,n,o,s,a);case"Any":return N.Any(e,t,i,n,o,s,a);case"Class":return N.Class(e,t,i,n,o,s,a);case"Object":return N.Object(e,t,i,n,o,s,a);case"Record":return N.Record(e,t,i,n,o,s,a);case"Array":return N.Array(e,t,i,n,o,s,a);case"Tuple":return N.Tuple(e,t,i,n,o,s,a);case"Union":return N.Union(e,t,i,n,o,s,a);case"Partial":case"Proxy":default:return N.Default(e,t,i,n,o,s,a)}}const N={Inner:ta,Number:Ho,Any:Jo,Class:Yo,Object:Wo,Record:Ko,Array:Go,Tuple:Xo,Union:Zo,Default:ea};function ra(e,t,r){if(!r.schema)return;const n=r.schema,o=N.Inner(n,"",A(e,r),k.get(e),t,e,r);for(const s in o)typeof o[s]>"u"&&delete o[s];return o}function na(e,t){if(!ge(I.store,e,t)||t===k||O.includes(t))return;const r=Y.getLayerRelationsEntities(e);if(!r)return;const n=k.get(e);for(const[o,s]of r){if(!Y.shouldPropagate(n,o))continue;const a=Y.createLayerPropagationArgs(e,o,t);J(s,t,a)}}const Y={getLayerRelationsEntities:Vo,getLayerRelationsTypes:Fo,getLayerComponent:qo,getAuthoringCounterpart:sa,shouldPropagate:Qo,propagateLayer:na,createLayerPropagationArgs:ra},T={Simulation:0,Authoring:1},Ut={Propagate:"propagate"},Sn={[T.Simulation]:{},[T.Authoring]:{[T.Simulation]:Ut.Propagate}},O=Object.entries(T).map(([e,t])=>ae({name:`${e}LayerComponent`,schema:m.Object({relations:m.Record(m.Enum(T,{$comment:"A numeric enum, ie. the value of one of the following key-value pairs: 'Simulation': 0, 'Authoring': 1"}),m.Entity())}),refs:{},onSet:(r,n)=>{for(const[o,s]of Y.getLayerRelationsTypes(t))if(s===Ut.Propagate){const a=Ir(o);n.relations[o].set(a),O[o].refs[a]=r}},onRemove(r,n){for(const[o,s]of Y.getLayerRelationsTypes(t))if(s===Ut.Propagate){const a=A(r,O[t]).relations[o];dt(a),delete O[o].refs[a]}O[t].refs[r]=_}})),Oi=O[T.Simulation],k=ae({name:"LayerComponent",storage:{layer:hr(Uint8Array)},onSet(e,t,r){k.layer[e]=r,J(e,O[r])},get:e=>k.layer[e],onRemove(e,t){const r=k.layer[e];ve(e,O[r]),k.layer[e]=0},hasUpstreamEntity(e){if(k.get(e)===T.Simulation){const r=O[T.Simulation].refs[e];if(r!==void 0&&r!==_&&he(r))return!0}return!1}});function sa(e){return k.get(e)===T.Authoring?e:O[T.Simulation].refs[e]??_}function _i(e){if(k.get(e)===T.Simulation)return e;const r=Y.getLayerRelationsEntities(e);if(!r)return _;k.get(e);for(const[n,o]of r)if(n===T.Simulation)return o;return _}const ce=ae({name:"TransitionComponent",jsonID:"IR_transition",schema:m.Array(m.Object({componentJsonID:m.String(),propertyPath:m.String(),transitionableType:m.String(),duration:m.Number({default:500}),easing:m.String({default:Mt.exponential.inOut.path}),initialValue:m.Type({serialized:!1}),events:m.Array(m.Object({age:m.Number(),toValue:m.Type(),duration:m.Number(),easing:m.String()}),{serialized:!1})})),setTarget:function(e,t){if(!t.componentJsonID)throw new Error("[setTransition]: componentJsonID is required");const r=t.type??To(t.value);if(!r)throw new Error(`[setTransition]: Unknown transitionable type for ${t.componentJsonID} - ${t.propertyPath}`);if(!Zt[r].isType(t.value))throw new Error(`[setTransition]: Invalid transitionable type for ${t.componentJsonID} - ${t.propertyPath}`);j(e,ce)||J(e,ce);const o=A(e,ce);let s=o.find(a=>a.componentJsonID===t.componentJsonID&&a.propertyPath===t.propertyPath);if(!s){const a=Je(e,ce.schema.properties);o.push(a),s=o[o.length-1],s.componentJsonID=t.componentJsonID,s.propertyPath=t.propertyPath,s.transitionableType=r}t.duration&&s.duration!==t.duration&&(s.duration=t.duration),t.easing&&s.easing!==t.easing.path&&(s.easing=t.easing.path),t.type&&s.transitionableType!==r&&(s.transitionableType=r),s.events.push({age:0,duration:s.duration,easing:s.easing,toValue:t.value})},updateTransition(e,t,r,n=!0){if(t.events.length===0)return;const o=Sr.get(t.componentJsonID);if(!o)return;const s=A(e,o);if(!s)return;const a=Gt(s,t.propertyPath);if(a===void 0)return;t.initialValue===void 0&&(t.initialValue=typeof a=="number"?a:a.clone());const i=Zt[t.transitionableType];let c=t.initialValue,u=t.initialValue;for(const l of t.events){l.age+=r;const f=l.age;if(f>=0&&f<=l.duration){const y=f/l.duration,p=Mt.fromPath(l.easing)(y);c=i.interpolate(u,l.toValue,p)}else f>l.duration&&(c=l.toValue);u=l.toValue}if(t.events=t.events.filter(l=>l.age>=l.duration?(t.initialValue=l.toValue,!1):!0),t.events.length===0&&(t.initialValue=void 0),n)if(typeof c=="number"){const l=nr(e,o);Gt(l,t.propertyPath).set(c)}else"copy"in a&&a.copy(c)},update(e){const r=g(se).deltaSeconds*1e3,n=A(e,ce);for(const o of n)ce.updateTransition(e,o,r)}}),Z=ae({name:"$RemovedComponent",storage:{exists:hr(Uint8Array)}});zt(Z,Math.pow(2,8));let wn=0;const oa=100,aa=e=>{de(I.store,e,Z),Z.exists[e]=0,wn=Date.now()},ia=e=>{Re(I.store,e,Z),ln(I.store,e)},ca=()=>{if(!(Date.now()-wn>oa))for(const t of dr(I.store,[Z]))ia(t)},xi=te({uuid:"$EntityRemovalSystem",insert:{after:br},execute:ca}),Ir=(e=T.Simulation)=>{if(!O[e])throw new Error("createEntity: argument layerID must be a valid LayerID value");const t=un(I.store);if(Z.exists.length<=t){const r=Er(t+1);Z.storageSize<r&&zt(Z,r)}return Z.exists[t]=1,J(t,k,e),t},dt=e=>{if(!e||!he(e))return;const t=Y.getLayerRelationsEntities(e),r=k.get(e);if(t)for(const[n,o]of t)Y.shouldPropagate(r,n)&&dt(o);for(const n of lt(I.store,e))n===k||O.includes(n)||ve(e,n);ve(e,k),aa(e)},he=e=>Z.exists[e]===1,Dr=w.createContext(_),ua=()=>w.useContext(Dr),Ft=oe({name:"EngineState",initial:()=>({userID:"",isEditor:!1,isEditing:!1})}),je=class je{constructor(){R(this,"store")}get userID(){return g(Ft).userID}get localFloorEntity(){return je.instance.store.stateMap.ReferenceSpaceState.get(ye).localFloorEntity}get originEntity(){return je.instance.store.stateMap.ReferenceSpaceState.get(ye).originEntity}get viewerEntity(){return je.instance.store.stateMap.ReferenceSpaceState.get(ye).viewerEntity}get cameraEntity(){return this.viewerEntity}};R(je,"instance");let q=je;globalThis.Engine=q;globalThis.Hyperflux=js;function Pi(e=Yr()){if(q.instance)throw new Error("Store already exists");q.instance=new q,e.getCurrentReactorRoot=()=>g(ue).activeSystemReactors.get(g(ue).currentSystemUUID),e.getDispatchTime=()=>g(se).simulationTime,e.getAgentID=()=>g(Ft).userID,q.instance.store=Hs(e),un(e)}function Ri(){var e;(e=g(se).timer)==null||e.clear();try{const t=Ys(I.store);for(const r of t)dt(r)}catch{}Z.exists.fill(0);for(const t of fn)$t(t);Zr(),Js(I.store),I.store=null,q.instance=null}const vi=e=>{const t=g(se);t.frameTime=performance.timeOrigin+e;const r=K(),n=e/1e3;t.deltaSeconds=Math.max(.001,Math.min(t.maxDeltaSeconds,n-t.elapsedSeconds)),t.elapsedSeconds=n,_e(yn),la(Ke),_e(gr),_e(br);const s=K()-r;s>150&&I.store.logger("ecs:execute").warn(`Long frame execution detected. Duration: ${s}`),t.lastSystemExecutionDuration=s},la=e=>{const t=K();let r=0;const n=W(se),{frameTime:o,simulationTime:s,simulationTimestep:a}=g(se);let i=o-s;const c=8,u=5e3;if(i<a){n.simulationTime.set(Math.floor(o/a)*a);return}let l=r>c;for(;i>a&&!l;)if(n.simulationTime.set(f=>Math.floor((f+a)/a)*a),_e(e),i-=a,r=K()-t,l=r>c,i>=u){n.simulationTime.set(f=>Math.floor(o/a)*a);break}},Et=(e=ko,t=0,r=[])=>{for(const n of e){const o=$.get(n);if(!o)return;r.push(o.uuid);for(const s of o.preSystems)Et([s],t+1,r);console.log("-".repeat(t),o.uuid.split(".").pop());for(const s of o.subSystems)Et([s],t+1,r);for(const s of o.postSystems)Et([s],t+1,r)}};globalThis.getDAG=Et;const M=ae({name:"EntityTreeComponent",jsonID:"IR_hierarchy",schema:m.Object({parentEntity:m.Entity({validate:(e,t,r)=>r===e?(console.error("Entity cannot be its own parent: "+r),!1):!0}),childIndex:m.Optional(m.Number()),children:m.Array(m.Entity(),{serialized:!1})}),onSet:(e,t,r)=>{if(!r)return;if(e===r.parentEntity)throw new Error("Entity cannot be its own parent: "+e);const n=t.parentEntity.value;if(n&&n!==r.parentEntity&&he(n)){const s=hn(n,M);if(s){const a=s.children.value.findIndex(c=>c===e),i=s.children.get(Rt);s.children.set([...i.slice(0,a),...i.slice(a+1)])}}typeof r.parentEntity<"u"&&t.parentEntity.set(r.parentEntity);const o=t.parentEntity.value;if(o&&he(o)){j(o,M)||J(o,M);const s=nr(o,M),a=A(o,M),i=a.children.indexOf(e),c=typeof r.childIndex=="number"?i!==r.childIndex:!1;if(c&&i!==-1&&s.children.set(u=>[...u.slice(0,i),...u.slice(i+1)]),c||i===-1)if(typeof r.childIndex<"u"){const u=s.children.length>r.childIndex?r.childIndex:s.children.length;s.children.set(l=>[...l.slice(0,u),e,...l.slice(u)])}else s.children.set([...a.children,e]);t.childIndex.set(a.children.indexOf(e))}},onRemove:(e,t)=>{const r=t.parentEntity.value;if(r&&he(r)&&j(r,M)){const n=nr(r,M),s=A(r,M).children.findIndex(a=>a===e);s>-1&&n.children[s].set(xe)}}});function fa(e){En(e,t=>{dt(t)})}const Ni=fa;function da(e,t,r=0){const n=A(e,M);if(n&&(t(e,r),!!n.children.length))for(let o=0;o<n.children.length;o++){const s=n.children[o];da(s,t,o)}}function En(e,t,r=0){const n=be(e,M);if(n){const o=[...n.children];for(let s=0;s<o.length;s++){const a=o[s];En(a,t,s)}}t(e,r)}function pa(e,t,r=s=>!0,n=!1,o=!1){var i,c,u,l;const s=[[e]],a=[];for(;s.length>0;){const f=s.pop();let y=0;for(let d=0;d<f.length;d++){const p=f[d];if(r(p)){if(a.push(t(p,y)),o)return a;y+=1,n&&s.push(((c=(i=be(p,M))==null?void 0:i.children)==null?void 0:c.filter(h=>j(h,M)))??[])}!n&&s.push(((l=(u=be(p,M))==null?void 0:u.children)==null?void 0:l.filter(h=>j(h,M)))??[])}}return a}function ct(e,t){const r=be(e,M);if(r!=null&&r.parentEntity){if(t(r.parentEntity)===!0)return;ct(r.parentEntity,t)}}function ya(e,t,r=!0,n=!0){let o=sr(e,t)?e:_;return n&&r&&o||(n||(o=_),ct(e,s=>{if(!(s===e&&!n)&&sr(s,t)&&(o=s,r))return!0})),o}function Li(e,t,r=_){if(t.push(e),r===e)return!0;let n=!1;return ct(e,o=>{if(r!==_&&o===r)return n=!0,t.push(o),!0;t.push(o)}),n}function ma(e,t){for(let r=0;r<e.length;++r)if(t===e[r])return r;return-1}function ha(e,t){const r=be(e,M);return r?r.parentEntity===t?!0:ha(r.parentEntity,t):!1}function ji(e,t){const r=[];return pa(e,n=>{r.push(n)},t,!0),r}function Bi(e,t,r=!0,n=!0){var c;const o=ya(e,t,r,n),s=lr(),a=(c=Ne(e,M))==null?void 0:c.parentEntity,i=t.map(u=>u.name).join();return ot(()=>{let u=!1;const l=w.memo(d=>{var E,D;const p=Ne(d.entity,M),h=bn(d.entity,t);return ot(()=>{u||s()},[(E=p==null?void 0:p.parentEntity)==null?void 0:E.value,h]),h&&r||!((D=p==null?void 0:p.parentEntity)!=null&&D.value)?null:w.createElement(l,{key:p.parentEntity.value,entity:p.parentEntity.value})}),f=n?e:(a==null?void 0:a.value)??_,y=f?We(function(){return w.createElement(l,{entity:f,key:f})}):null;return()=>{u=!0,y==null||y.stop()}},[e,i,n,a==null?void 0:a.value]),o}const ga=(e,t)=>{let r=!1;for(const n of t)Ne(e,n)&&(r=!0);return r};function $i(e,t,r=[]){const n=F([]),o=t.map(a=>a.name).join(),s=r.map(a=>a.name).join();return ot(()=>{let a=!1;const i=u=>{var d;const l=Ne(u.entity,M),f=bn(u.entity,t),y=ga(u.entity,r);return b.useLayoutEffect(()=>{if(!(!f||y))return n.set(p=>(p.indexOf(u.entity)<0&&p.push(u.entity),p)),()=>{a||n.set(p=>{const h=p.indexOf(u.entity);return p.splice(h,1),p})}},[f,y]),(d=l==null?void 0:l.children)!=null&&d.value?w.createElement(w.Fragment,null,l.children.value.map(p=>w.createElement(i,{key:p,entity:p}))):null},c=We(function(){return w.createElement(i,{entity:e,key:e})});return()=>{a=!0,c.stop()}},[e,o,s]),n.get(Rt)}function ba(e,t,r=[]){const n=be(e,M);if(!(n!=null&&n.children))return r;r.push(...n.children.filter(o=>sr(o,t)));for(const o of n.children)ba(o,t,r);return r}function zi(e,t){const r=[],n=[];ct(e,o=>{r.push(o)}),ct(t,o=>{n.push(o)});for(const o of r)if(n.includes(o))return!0;return!1}function Vi(e,t=[]){for(const r of e)t.push(r);for(const r of e){let n=!0;for(const o of t)if(Sa(o,r)){n=!1;break}if(!n){const o=ma(t,r);if(o===-1)throw new Error("Object not found");t.splice(o,1)}}return t}function Sa(e,t,r=!1){return!t||!e||!r&&e===t?!1:In(e,n=>n===t)}function In(e,t){let r=t(e);if(r)return r;const n=be(e,M),o=n==null?void 0:n.children;if(!o)return r;for(let s=0;s<o.length;++s){const a=o[s];if(a&&(r=In(a,t),r))break}return r}const wa=e=>(t,r,n)=>{const o=e();return Object.defineProperty(n,r,{get(){return o[t]},set(s){return o[t]=s},enumerable:!0,configurable:!0})[r]};let Ea=0;const Ia={NetworkID:e=>m.Number({...e,id:"NetworkID"})},Da=wa(()=>z.networkId),z=ae({name:"NetworkObjectComponent",schema:m.Object({ownerId:m.UserID(),ownerPeer:m.PeerID(),authorityPeerID:m.PeerID(),networkId:m.Proxy(Ia.NetworkID(),Da)}),storage:{networkId:hr(Uint32Array)},reactor:function(){const e=ua(),t=wt(e,z);return b.useLayoutEffect(()=>{t.authorityPeerID.value===q.instance.store.peerID?J(e,Ot):ve(e,Ot)},[t.authorityPeerID]),b.useLayoutEffect(()=>{t.ownerId.value===q.instance.userID?J(e,Lr):ve(e,Lr)},[t.ownerId]),null},getOwnedNetworkObjects(e){return Nr().filter(t=>A(t,z).ownerId===e)},getNetworkObject(e,t){return Nr().find(r=>{const n=A(r,z);return n.networkId===t&&n.ownerPeer===e})||_},getOwnedNetworkObjectWithComponent(e,t){return z.getOwnedNetworkObjects(e).find(r=>j(r,t))||_},getOwnedNetworkObjectsWithComponent(e,t){return z.getOwnedNetworkObjects(e).filter(r=>j(r,t))},createNetworkId(){return++Ea}}),Nr=ft([z]),Ot=ae({name:"NetworkObjectAuthorityTag"}),Lr=ae({name:"NetworkObjectOwnedTag"}),Ca=ae({name:"NetworkObjectSendPeriodicUpdatesTag"}),_t=oe({name:"NetworkSchemaState",initial:{},get orderedNetworkSchema(){return Object.keys(g(_t)).sort().map(e=>g(_t)[e])}}),ka=e=>{const t=new Map;return r=>{if(t.has(r))return t.get(r);{const n=e(r);return t.set(r,n),n}}},Cr=ka(e=>Object.keys(e).filter(t=>!t.includes("_")).flatMap(t=>ArrayBuffer.isView(e[t])?e[t]:Cr(e[t])).flat()),Ta=(e,t,r)=>{switch(r){case 0:return e.x[t];case 1:return e.y[t];case 2:return e.z[t];case 3:return e.w[t];default:console.error("Vector4SOA tried to read with out of bounds index");break}},Be=1e3,$e=1e3,ze=1/Math.sqrt(2),Ve=1/32,Fe=(e,t)=>{const r=Math.pow(2,t-1),n=r-1;let o=0;return e<0&&(o=1,e=Math.abs(e)),e&=n,o&&(e|=r),e},qe=(e,t)=>{const r=Math.pow(2,t-1),n=r-1;let o=e&n;return e&r&&(o*=-1),o},Dn=(e=new ArrayBuffer(1e5))=>{const t=new DataView(e);return t.cursor=0,t.shadowMap=new Map,t},Aa=e=>{const t=e.buffer.slice(0,e.cursor);return e.cursor=0,t},Fi=(e,t)=>(e.cursor+=t,e),qi=(e,t)=>(e.cursor=t,e),Ee=e=>{const t=e.cursor;return()=>{e.cursor=t}},Ma=(e,t,r)=>(e[`set${t.constructor.name.replace("Array","")}`](e.cursor,t[r]),e.cursor+=t.BYTES_PER_ELEMENT,e),V=(e,t,r,n,o=1e-4)=>{const{shadowMap:s}=e,a=s.get(t)||s.set(t,t.slice().fill(0))&&s.get(t),i=Math.abs(a[r]-t[r])>o||n;return a[r]=t[r],i?(Ma(e,t,r),!0):!1},Ua=(e,t)=>(e.setFloat64(e.cursor,t),e.cursor+=Float64Array.BYTES_PER_ELEMENT,e),Qi=(e,t)=>(e.setFloat32(e.cursor,t),e.cursor+=Float32Array.BYTES_PER_ELEMENT,e),Hi=(e,t)=>(e.setUint32(e.cursor,t),e.cursor+=BigUint64Array.BYTES_PER_ELEMENT,e),pt=(e,t)=>(e.setUint32(e.cursor,t),e.cursor+=Uint32Array.BYTES_PER_ELEMENT,e),Ji=(e,t)=>(e.setInt16(e.cursor,t),e.cursor+=Int16Array.BYTES_PER_ELEMENT,e),Yi=(e,t)=>(e.setUint16(e.cursor,t),e.cursor+=Uint16Array.BYTES_PER_ELEMENT,e),Wi=(e,t)=>(e.setUint8(e.cursor,t),e.cursor+=Uint8Array.BYTES_PER_ELEMENT,e),Oa=e=>{const t=e.cursor;return e.cursor+=BigUint64Array.BYTES_PER_ELEMENT,r=>(e.setUint32(t,r),e)},xt=e=>{const t=e.cursor;return e.cursor+=Uint32Array.BYTES_PER_ELEMENT,r=>(e.setUint32(t,r),e)},_a=e=>{const t=e.cursor;return e.cursor+=Uint16Array.BYTES_PER_ELEMENT,r=>(e.setUint16(t,r),e)},Ge=e=>{const t=e.cursor;return e.cursor+=Uint8Array.BYTES_PER_ELEMENT,r=>(e.setUint8(t,r),e)},Ki=pt,Gi=(e,t)=>pt(e,z.networkId[t]),or=(e,t)=>{const r=e[`get${t.constructor.name.replace("Array","")}`](e.cursor);return e.cursor+=t.BYTES_PER_ELEMENT,r},xa=e=>{const t=e.getFloat64(e.cursor);return e.cursor+=Float64Array.BYTES_PER_ELEMENT,t},Xi=e=>{const t=e.getFloat32(e.cursor);return e.cursor+=Float32Array.BYTES_PER_ELEMENT,t},Pa=e=>{const t=e.getBigUint64(e.cursor);return e.cursor+=BigUint64Array.BYTES_PER_ELEMENT,t},Se=e=>{const t=e.getUint32(e.cursor);return e.cursor+=Uint32Array.BYTES_PER_ELEMENT,t},Zi=e=>{const t=e.getInt16(e.cursor);return e.cursor+=Int16Array.BYTES_PER_ELEMENT,t},Ra=e=>{const t=e.getUint16(e.cursor);return e.cursor+=Uint16Array.BYTES_PER_ELEMENT,t},Xe=e=>{const t=e.getUint8(e.cursor);return e.cursor+=Uint8Array.BYTES_PER_ELEMENT,t},ec=Se,tc=Se,pe=(e,t)=>(e&t)===t,rc=e=>{const t=Cr(e),r=t.length<=8?Xe:t.length<=16?Ra:t.length<=32?Se:Pa;return(n,o)=>{const s=r(n);for(let a=0;a<t.length;a++){if(!pe(s,2**a))continue;const i=t[a],c=or(n,i);i[o]=c}}},Ue=(e,t,r)=>{r?t[r]=or(e,t):or(e,t)},nc=e=>(t,r)=>{const n=Xe(t);let o=0;pe(n,1<<o++)&&Ue(t,e.x,r),pe(n,1<<o++)&&Ue(t,e.y,r),pe(n,1<<o++)&&Ue(t,e.z,r)},sc=(e,t=1)=>(r,n)=>{if(Xe(r)<=0)return;let s=Se(r),a=qe(s,10);s=s>>>10;let i=qe(s,10);s=s>>>10;let c=qe(s,10);s=s>>>10,c/=Ve*$e*t,i/=Ve*$e*t,a/=Ve*$e*t,n&&(e.x[n]=c,e.y[n]=i,e.z[n]=a)},oc=e=>(t,r)=>{const n=Xe(t);let o=0;pe(n,1<<o++)&&Ue(t,e.x,r),pe(n,1<<o++)&&Ue(t,e.y,r),pe(n,1<<o++)&&Ue(t,e.z,r),pe(n,1<<o++)&&Ue(t,e.w,r)},ac=e=>(t,r)=>{if(Xe(t)<=0)return;let o=Se(t),s=qe(o,10);o=o>>>10;let a=qe(o,10);o=o>>>10;let i=qe(o,10);o=o>>>10;let u=o&3;i/=ze*Be,a/=ze*Be,s/=ze*Be;let l=Math.sqrt(1-(i*i+a*a+s*s)),f,y,d,p;u===0?(f=l,y=i,d=a,p=s):u===1?(f=i,y=l,d=a,p=s):u===2?(f=i,y=a,d=l,p=s):(f=i,y=a,d=s,p=l),r&&(e.x[r]=f,e.y[r]=y,e.z[r]=d,e.w[r]=p)},va=(e,t,r,n)=>{const o=Se(e),s=Se(e),a=Xe(e),i=t.peerIndexToPeerID[s];let c=z.getNetworkObject(i,o);(c&&A(c,z).authorityPeerID!==r||j(c,Ot))&&(c=_);let u=0;for(const l of n)pe(a,1<<u++)&&l.read(e,c)},Na=(e,t,r,n)=>{const o=_t.orderedNetworkSchema;for(;e.cursor<r;){const s=Se(e);for(let a=0;a<s;a++)va(e,t,n,o)}},La=e=>{const t=Se(e),r=xa(e);return{peerIndex:t,simulationTime:r}},ja=(e,t,r)=>{const n=Dn(t),{peerIndex:o,simulationTime:s}=La(n),a=e.peerIndexToPeerID[o];a&&a===q.instance.store.peerID||r.push({simulationTime:s,read:()=>{Na(n,e,t.byteLength,a)}})},ic=e=>{const t=Cr(e),r=t.length<=8?Ge:t.length<=16?_a:t.length<=32?xt:Oa;return(n,o,s=!1)=>{const a=Ee(n),i=r(n);let c=0;for(let u=0;u<t.length;u++)c|=V(n,t[u],o,s)?2**u:0;return i(c),c>0||a()}},cc=e=>(t,r,n=!1)=>{const o=Ee(t),s=Ge(t);let a=0,i=0;return a|=V(t,e.x,r,n)?1<<i++:i++&&0,a|=V(t,e.y,r,n)?1<<i++:i++&&0,a|=V(t,e.z,r,n)?1<<i++:i++&&0,a>0&&s(a)||o()},uc=(e,t=1)=>(r,n)=>{const o=Ee(r),s=Ge(r),a=Ee(r);let i=0,c=0;const u=j(n,Ca)&&Math.round(g(se).simulationTime%g(se).periodicUpdateFrequency)===0;if(i|=V(r,e.x,n,u)?1<<c++:c++&&0,i|=V(r,e.y,n,u)?1<<c++:c++&&0,i|=V(r,e.z,n,u)?1<<c++:c++&&0,i>0){a();let[l,f,y]=[e.x[n],e.y[n],e.z[n]];l*=Ve*$e*t,f*=Ve*$e*t,y*=Ve*$e*t,l=Fe(l,10),f=Fe(f,10),y=Fe(y,10);let d=0;d=d|l,d=d<<10,d=d|f,d=d<<10,d=d|y,pt(r,d)}return i>0&&s(i)||o()},lc=e=>(t,r,n=!1)=>{const o=Ee(t),s=Ge(t);let a=0,i=0;return a|=V(t,e.x,r,n)?1<<i++:i++&&0,a|=V(t,e.y,r,n)?1<<i++:i++&&0,a|=V(t,e.z,r,n)?1<<i++:i++&&0,a|=V(t,e.w,r,n)?1<<i++:i++&&0,a>0&&s(a)||o()},fc=e=>(t,r,n=!1)=>{const o=Ee(t),s=Ge(t),a=Ee(t);let i=0,c=0;if(i|=V(t,e.x,r,n)?1<<c++:c++&&0,i|=V(t,e.y,r,n)?1<<c++:c++&&0,i|=V(t,e.z,r,n)?1<<c++:c++&&0,i|=V(t,e.w,r,n)?1<<c++:c++&&0,i>0){a();let u=0,l=Number.MIN_VALUE,f=1;for(let E=0;E<4;E++){let D=Ta(e,r,E),v=Math.abs(D);v>l&&(f=D<0?-1:1,u=E,l=v)}let y=0,d=0,p=0;u===0?(y=e.y[r],d=e.z[r],p=e.w[r]):u===1?(y=e.x[r],d=e.z[r],p=e.w[r]):u===2?(y=e.x[r],d=e.y[r],p=e.w[r]):(y=e.x[r],d=e.y[r],p=e.z[r]),y*=f*ze*Be,d*=f*ze*Be,p*=f*ze*Be,u=u|0,y=Fe(y,10),d=Fe(d,10),p=Fe(p,10);let h=u;h=h<<10,h=h|y,h=h<<10,h=h|d,h=h<<10,h=h|p,pt(t,h)}return i>0&&s(i)||o()},Ba=(e,t,r,n,o)=>{const s=Ee(e),a=xt(e),i=xt(e),c=Ge(e);let u=0,l=0;for(const f of o)u|=f.write(e,n)?1<<l++:l++&&0;return u>0&&a(t)&&i(r)&&c(u)||s()},$a=(e,t,r)=>{const n=_t.orderedNetworkSchema,o=xt(e);let s=0;for(let a=0,i=r.length;a<i;a++){const c=r[a],u=z.networkId[c],l=A(c,z).ownerPeer,f=t.peerIDToPeerIndex[l];s+=Ba(e,u,f,c,n)?1:0}s>0?o(s):e.cursor=0},za=(e,t,r)=>{pt(e,t.peerIDToPeerIndex[r]),Ua(e,g(se).simulationTime)},Va=(e=1e5)=>{const t=Dn(new ArrayBuffer(e));return(r,n,o)=>(za(t,r,n),$a(t,r,o),Aa(t))};class ne{}R(ne,"spawnEntity",et({type:"ee.network.SPAWN_ENTITY",entityID:ao,entitySourceID:io,parentUUID:mt,ownerID:Gr(Kt,()=>g(Ft).userID),authorityPeerId:bt.optional(),$cache:!0,$topic:Ae.world})),R(ne,"destroyEntity",et({type:"ee.network.DESTROY_ENTITY",entityUUID:mt,$cache:!0,$topic:Ae.world})),R(ne,"requestAuthorityOverObject",et({type:"ee.engine.world.REQUEST_AUTHORITY_OVER_ENTITY",entityUUID:mt,newAuthority:bt,$topic:Ae.world})),R(ne,"transferAuthorityOfObject",et({type:"ee.engine.world.TRANSFER_AUTHORITY_OF_ENTITY",ownerID:Kt,entityUUID:mt,newAuthority:bt,$topic:Ae.world,$cache:!0}));const re=oe({name:"ee.EntityNetworkState",initial:{},receptors:{onSpawnObject:ne.spawnEntity.receive(e=>{const t={entityID:e.entityID,entitySourceID:e.entitySourceID};W(re)[S.join(t)].merge({parentUUID:e.parentUUID,ownerId:e.ownerID,authorityPeerId:e.authorityPeerId??e.$peer,ownerPeer:e.$peer,entityID:e.entityID,entitySourceID:e.entitySourceID})}).validate(e=>e.ownerID===e.$user),onRequestAuthorityOverObject:ne.requestAuthorityOverObject.receive(e=>{W(re)[e.entityUUID].requestingPeerId.set(e.newAuthority)}),onTransferAuthorityOfObject:ne.transferAuthorityOfObject.receive(e=>{const t=W(re);t[e.entityUUID].authorityPeerId.set(e.newAuthority),t[e.entityUUID].requestingPeerId.set(xe)}).validate(e=>{const t=e.ownerID,r=g(re)[e.entityUUID].ownerId;return!(r!==e.$user&&r!==Dt||r!==t)}),onDestroyObject:ne.destroyEntity.receive(e=>{W(re)[e.entityUUID].set(xe)}).validate(e=>{var r;const t=(r=g(re)[e.entityUUID])==null?void 0:r.ownerId;return!(t&&t!==e.$user)})},reactor:()=>{const e=ee(re);return w.createElement(w.Fragment,null,e.keys.map(t=>w.createElement(Fa,{uuid:t,key:t})))}}),Fa=e=>{var y,d,p;const t=F(W(re)[e.uuid]),r=t.ownerId.value,n=ee(Ft).userID.value,o=r===Dt||r===n,s=F(fe.worldNetworkState).value,a=ee(Wt).value,c=!!(s&&((d=(y=a[s.id])==null?void 0:y.users)!=null&&d[r]))||o,u=qa(e.uuid);b.useLayoutEffect(()=>{if(!c)return;const h={entityID:t.entityID.value,entitySourceID:t.entitySourceID.value},E=S.join(h);let D=S.getEntityByUUID(E);return D||(D=Ir(),J(D,S,h)),()=>{dt(D)}},[c]),b.useLayoutEffect(()=>{if(!c)return;const h=S.getEntityByUUID(e.uuid),E=S.getEntityByUUID(t.parentUUID.value);!E||!h||J(h,M,{parentEntity:E})},[c,t.parentUUID]),b.useLayoutEffect(()=>{if(!c)return;const h=S.getEntityByUUID(e.uuid);h&&J(h,z,{ownerId:r,ownerPeer:t.ownerPeer.value,authorityPeerID:t.authorityPeerId.value,networkId:u})},[!!s,c,t.ownerId.value,t.authorityPeerId.value,u]),b.useLayoutEffect(()=>{var D;if(!c||!t.requestingPeerId.value)return;const h=S.getEntityByUUID(e.uuid);if(!h)return;const E=(D=be(h,z))==null?void 0:D.ownerId;(!E||E!==n)&&E!==Dt||st(ne.transferAuthorityOfObject({ownerID:t.ownerId.value,entityUUID:e.uuid,newAuthority:t.requestingPeerId.value}))},[c,t.requestingPeerId.value]);const l=t.authorityPeerId.value??t.ownerPeer.value,f=!!(s&&((p=a[s.id])!=null&&p.peers[l]));return b.useLayoutEffect(()=>{if(!(!o||!f))return()=>{var E,D,v;!fe.worldNetwork||!g(re)[e.uuid]||!((v=(D=(E=g(Wt)[fe.worldNetwork.id])==null?void 0:E.users)==null?void 0:D[n])!=null&&v.length)||[...fe.worldNetwork.users[n]].sort((Ie,Le)=>Ie>Le?1:-1)[0]!==q.instance.store.peerID||st(ne.transferAuthorityOfObject({ownerID:t.ownerId.value,entityUUID:e.uuid,newAuthority:q.instance.store.peerID}))}},[o,f]),null},qa=e=>{const t=ee(re),r=t[e].ownerPeer.value;return t.keys.filter(o=>t[o].ownerPeer.value===r).sort().indexOf(e)},Qa=()=>{Jr()},dc=te({uuid:"ee.engine.IncomingActionSystem",insert:{before:Ke},execute:Qa});class Qe{constructor(t){R(this,"buffer",[]);R(this,"size");R(this,"pos",0);if(t<0)throw new RangeError("The size does not allow negative values.");this.size=t}static fromArray(t,r=0){const n=new Qe(r);return n.fromArray(t,r===0),n}copy(){const t=new Qe(this.getBufferLength());return t.buffer=this.buffer,t}clone(){const t=new Qe(this.getBufferLength());return t.buffer=this.buffer,t}getSize(){return this.size}getPos(){return this.pos}getBufferLength(){return this.buffer.length}add(...t){t.forEach(r=>{this.buffer[this.pos]=r,this.pos=(this.pos+1)%this.size})}get(t){if(t<0&&(t+=this.buffer.length),!(t<0||t>this.buffer.length))return this.buffer.length<this.size?this.buffer[t]:this.buffer[(this.pos+t)%this.size]}getFirst(){return this.get(0)}getLast(){return this.get(-1)}remove(t,r=1){if(t<0&&(t+=this.buffer.length),t<0||t>this.buffer.length)return[];const n=this.toArray(),o=n.splice(t,r);return this.fromArray(n),o}pop(){return this.remove(0)[0]}popLast(){return this.remove(-1)[0]}toArray(){return this.buffer.slice(this.pos).concat(this.buffer.slice(0,this.pos))}fromArray(t,r=!1){if(!Array.isArray(t))throw new TypeError("Input value is not an array.");r&&this.resize(t.length),this.size!==0&&(this.buffer=t.slice(-this.size),this.pos=this.buffer.length%this.size)}clear(){this.buffer=[],this.pos=0}resize(t){if(t<0)throw new RangeError("The size does not allow negative values.");if(t===0)this.clear();else if(t!==this.size){const r=this.toArray();this.fromArray(r.slice(-t)),this.pos=this.buffer.length%t}this.size=t}full(){return this.buffer.length===this.size}empty(){return this.buffer.length===0}}const Ha=e=>{const t=new ArrayBuffer(e.length),r=new Uint8Array(t);for(let n=0;n<e.length;++n)r[n]=e[n];return t},Cn=oe({name:"ee.core.network.IncomingNetworkState",initial:()=>({jitterBufferTaskList:[],jitterBufferDelay:100,incomingMessageQueueUnreliableIDs:new Qe(100),incomingMessageQueueUnreliable:new Qe(100)})}),Pt="ee.core.ecs.dataChannel",jr=(e,t,r,n)=>{const{incomingMessageQueueUnreliable:o,incomingMessageQueueUnreliableIDs:s}=g(Cn);e.isHosting?(o.add(Ha(n)),s.add(r),e.bufferToAll(Pt,r,n)):(o.add(n),s.add(r))};function Ja(e,t){return t.simulationTime-e.simulationTime}const Ya=()=>{const e=g(se),{jitterBufferTaskList:t,jitterBufferDelay:r,incomingMessageQueueUnreliable:n,incomingMessageQueueUnreliableIDs:o}=g(Cn),s=fe.worldNetwork;if(!s)return;for(;n.getBufferLength()>0;){o.pop();const i=n.pop();ja(s,i,t)}t.sort(Ja);const a=e.simulationTime+r;for(;t.length>0&&t[0].simulationTime<=a;){const i=t.shift().read;i()}},Wa=()=>(b.useEffect(()=>(Hr(Pt,jr),()=>{Xr(Pt,jr)}),[]),null),pc=te({uuid:"ee.engine.IncomingNetworkSystem",insert:{before:Ke},execute:Ya,reactor:Wa}),Ka=()=>{Qr.sendOutgoingActions()},yc=te({uuid:"ee.engine.OutgoingActionSystem",insert:{after:Ke},execute:Ka}),Ga=ft([z,Ot]),Xa=e=>{const t=Ga();if(t.length>0){const r=fe.worldNetwork;if(!r.peers)return;const n=q.instance.store.peerID,o=e(r,n,t);o.byteLength>0&&Promise.resolve().then(()=>r.bufferToAll(Pt,n,o))}},Za=Va(),ei=()=>{fe.worldNetwork&&Xa(Za)},mc=te({uuid:"ee.engine.OutgoingNetworkSystem",insert:{after:Ke},execute:ei}),ti=ft([ce]),hc=te({uuid:"TransitionSystem",execute:()=>{const e=ti();for(const t of e)ce.update(t)},insert:{before:gr}}),Ce=oe({name:"ir.world.EntitiesBySourceState",initial:{}}),Te=oe({name:"ir.ecs.EntitiesByUUIDState",initial:{}}),S=ae({name:"UUIDComponent",jsonID:"EE_uuid",schema:m.EntityUUIDPair({validate:(e,t,r)=>{var a;if(e===t)return!0;if(!e.entitySourceID)return console.error("UUID context cannot be empty"),!1;if(!e.entityID)return console.error("UUID id cannot be empty"),!1;const n=S.join(e),o=k.get(r);if(!g(Te)[o])return g(Te)[o]={},!0;const s=(a=g(Te)[o][n])==null?void 0:a.value;return s&&s!==r?(console.error(`UUID ${n} is already in use`,s,r),!1):!0},required:!0}),toJSON(e){return{entityID:e.entityID}},onSet(e,t,r){if(!r.entitySourceID)throw new Error("UUID context cannot be empty");if(!r.entityID)throw new Error("UUID id cannot be empty");const n=k.get(e);(t.value.entityID&&t.value.entitySourceID?S.join(t.value):void 0)&&S.onRemove(e,t),Ht._getUUIDState(S.join(r),n).set(e),t.set(r),g(Ce)[n]||W(Ce)[n].set({});const a=W(Ce)[n][r.entitySourceID];a.value?a.value.includes(e)||a.merge([e]):a.set([e])},onRemove:(e,t)=>{const r=S.join(t.value),n=k.get(e);cr(g(Te)[n][r]),delete g(Te)[n][r];const o=t.value.entitySourceID.toString(),s=g(Ce)[n][o].filter(i=>i!==e),a=W(Ce)[n];s.length===0?a[o].set(xe):a[o].set(s)},entitiesByUUIDState:{},create:(e,t=S.generate(),r=T.Simulation)=>{const n=Ir(r);return J(n,S,{entitySourceID:S.getAsSourceID(e),entityID:t}),n},useEntityByUUID(e,t=T.Simulation){return F(Ht._getUUIDState(e,t)).value},getEntityByUUID(e,t=T.Simulation){return Ht._getUUIDState(e,t).get(ye)},getEntityFromSameSourceByID(e,t,r=T.Simulation){const n=A(e,S).entitySourceID;return S.getEntityByUUID(S.join({entitySourceID:n,entityID:t}),r)},useEntityFromSameSourceByID(e,t,r=T.Simulation){const n=wt(e,S).entitySourceID.value;return S.useEntityByUUID(S.join({entitySourceID:n,entityID:t}),r)},setSourceEntity(e,t){const r=A(t,S).entitySourceID,n=A(e,S).entityID;J(e,S,{entitySourceID:r,entityID:n})},getSourceEntity(e){const t=k.get(e),r=A(e,S).entitySourceID;return S.getEntityByUUID(r,t)},useSourceEntity(e){const t=k.get(e),r=wt(e,S).entitySourceID.value;return S.useEntityByUUID(r,t)},useEntitiesBySource:(e,t=T.Simulation)=>{const r=F(W(Ce)[t]).value;return(r==null?void 0:r[e])||[]},getEntitiesBySource:(e,t=T.Simulation)=>{var r;return((r=g(Ce)[t])==null?void 0:r[e])||[]},getRootSource:e=>{if(!j(e,S))return _;const t=S.getSourceEntity(e);return!t||t===e?e:S.getRootSource(t)},getAsSourceID:e=>S.join(A(e,S)),get:e=>S.join(A(e,S)),use:e=>S.join(wt(e,S).value),join:e=>`${e.entitySourceID}${e.entityID}`,generateUUID(){return S.generate()},generate(){return en()}});function ri(e,t=T.Simulation){let r=g(Te)[t];r||(r={},g(Te)[t]=r);let n=r[e];return n||(n=ur(_),r[e]=n),n}const Ht={_getUUIDState:ri};export{_i as $,pa as A,q as B,Os as C,k as D,M as E,ci as F,gr as G,di as H,Ai as I,Bo as J,Ti as K,O as L,ba as M,ki as N,Vi as O,br as P,bo as Q,Ii as R,m as S,Sr as T,S as U,z as V,ne as W,da as X,hr as Y,Qe as Z,Dr as _,wt as a,wr as a$,xi as a0,Z as a1,po as a2,fo as a3,we as a4,rt as a5,mn as a6,N as a7,Je as a8,ko as a9,_t as aA,Qt as aB,yc as aC,mc as aD,ze as aE,Be as aF,bi as aG,Ro as aH,wo as aI,Oi as aJ,Ke as aK,ho as aL,$ as aM,yi as aN,ce as aO,hc as aP,Ht as aQ,Ve as aR,$e as aS,ca as aT,ia as aU,zo as aV,pe as aW,Fe as aX,Io as aY,Va as aZ,Pi as a_,ke as aa,Mt as ab,ui as ac,Ce as ad,Te as ae,re as af,De as ag,er as ah,it as ai,Si as aj,Uo as ak,tr as al,dc as am,Cn as an,pc as ao,yn as ap,rr as aq,Ei as ar,P as as,Y as at,Ut as au,Sn as av,Ot as aw,Lr as ax,Ca as ay,Ia as az,dt as b,Fi as b$,Eo as b0,Dn as b1,Ri as b2,Ni as b3,St as b4,Pt as b5,la as b6,_e as b7,vi as b8,qe as b9,fn as bA,xr as bB,rc as bC,Ue as bD,ac as bE,sc as bF,ja as bG,Na as bH,va as bI,ec as bJ,Xi as bK,xa as bL,Zi as bM,La as bN,tc as bO,or as bP,Ra as bQ,Se as bR,Pa as bS,Xe as bT,nc as bU,oc as bV,Ci as bW,fa as bX,$t as bY,wi as bZ,Ee as b_,mi as ba,ma as bb,Cr as bc,Di as bd,Ui as be,Ys as bf,sa as bg,Mi as bh,Et as bi,lt as bj,ji as bk,Li as bl,Ta as bm,sr as bn,zi as bo,Sa as bp,ha as bq,li as br,ao as bs,io as bt,fi as bu,qi as bv,Ga as bw,K as bx,pi as by,wa as bz,Ir as c,Aa as c0,hi as c1,_a as c2,xt as c3,Oa as c4,Ge as c5,In as c6,En as c7,ct as c8,$i as c9,bn as ca,$o as cb,ic as cc,fc as cd,uc as ce,$a as cf,Ba as cg,Ki as ch,Qi as ci,Ua as cj,Ji as ck,za as cl,Gi as cm,Ma as cn,V as co,Yi as cp,pt as cq,Hi as cr,Wi as cs,cc as ct,lc as cu,xs as cv,ae as d,he as e,Ft as f,A as g,j as h,_ as i,ot as j,gi as k,se as l,mt as m,be as n,mo as o,T as p,Ne as q,ve as r,J as s,Bi as t,ua as u,ya as v,te as w,nr as x,hn as y,ft as z};
