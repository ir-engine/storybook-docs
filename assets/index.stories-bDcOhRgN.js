import{u as p}from"./WebRTCTransportFunctions-mB_FREj1.js";import{r as d,R as c}from"./index-DPzuYzxM.js";import{F as ye,a as Ee,b as be,c as xe}from"./index-F9cJFHuF.js";import{B as Q}from"./index-Dls6AtJn.js";import{I as we}from"./index-dk6FhMkf.js";import{S as oe}from"./index-D9Z-cq-f.js";import{t as Me}from"./tw-merge-Ds6tgvmq.js";import"./_commonjsHelpers-C4iS2aBk.js";import"./index-DYLXRpC5.js";import"./v4-BOvFkHkt.js";import"./iconBase-qHBVS_PM.js";import"./index-YWE9xQ_z.js";import"./index-Bs5DOUC-.js";import"./index-DNUDjAZy.js";import"./index-BmZLy_Eh.js";function ue({audioSrc:W,value:V,className:G,onChange:$,isPlaying:k,currentTrackTime:o,scaleSettings:y,showCurrentTime:Y=!1}){const w=p(V),L=p([]),T=p([]),D=p(-100),S=p(!1),H=p(!1),z=p(0),C=p(0),O=10,J=.8,s=(y==null?void 0:y.transitionPoint)??O,g=(y==null?void 0:y.lowerRangePortion)??J,h=1-g,M=d.useRef(null),F=d.useRef(null),N=d.useRef(),Z=d.useRef(0),ee=d.useRef(0),B=d.useRef(null),u=d.useRef(null),U=d.useRef(null),E=d.useRef(null),te=p("-∞"),I=d.useRef(null),f=d.useRef(null),n=p(null);d.useEffect(()=>{if(W){const t=new Audio;t.src=W,t.crossOrigin="anonymous",n.set(t)}},[W]),d.useEffect(()=>(I.current&&clearInterval(I.current),I.current=setInterval(()=>{te.set(me())},3e3),()=>{I.current&&clearInterval(I.current)}),[]),d.useEffect(()=>{var a;if(w.set(V),!f.current)return;const t=V<=0?-60:Math.min(20,20*Math.log10(V)),e=t<=-60?0:Math.pow(10,t/20);f.current.gain.setValueAtTime(e,((a=B.current)==null?void 0:a.currentTime)||0),$&&$(t)},[V]),d.useEffect(()=>{n.value&&k!==void 0&&(k&&n.value.paused?(console.log("External play command received"),n.value.play().then(()=>{S.set(!0),console.log("Audio playback started successfully")}).catch(t=>console.error("Error playing audio:",t))):!k&&!n.value.paused&&(console.log("External pause command received"),n.value.pause(),S.set(!1)))},[k]),d.useEffect(()=>{if(!n.value)return;const t=()=>{const e=Array(150).fill(0).map(()=>Math.random()*.8+.2);L.set(e);const a=e.map(r=>20*Math.log10(r)*2);T.set(a)};t();try{B.current||(B.current=new(window.AudioContext||window.webkitAudioContext));const e=B.current;f.current||(f.current=e.createGain()),u.current||(u.current=e.createAnalyser(),u.current.fftSize=2048,u.current.smoothingTimeConstant=.7,u.current.minDecibels=-80,u.current.maxDecibels=20);const a=()=>{try{E.current&&E.current.disconnect(),u.current&&u.current.disconnect(),(!E.current||E.current.mediaElement!==n.value)&&(E.current=e.createMediaElementSource(n.value)),f.current||(f.current=e.createGain()),E.current.connect(f.current),f.current.connect(u.current),u.current.connect(B.current.destination);const l=V<=0?-60:Math.min(20,20*Math.log10(V)),m=l<=-60?0:Math.pow(10,l/20);f.current.gain.value=m,console.log("Audio chain connected with gain:",m,"dB:",l),console.log("Audio successfully connected to analyzer")}catch(l){console.error("Error connecting audio to analyzer:",l)}},r=()=>{var l,m;a(),C.set(((l=n.value)==null?void 0:l.duration)||0),console.log("Audio duration:",(m=n.value)==null?void 0:m.duration)};return n.value.addEventListener("canplay",r),n.value.readyState>=2&&r(),()=>{var l;(l=n.value)==null||l.removeEventListener("canplay",r)}}catch(e){console.error("Error initializing audio context:",e),t()}return()=>{E.current&&E.current.disconnect(),u.current&&u.current.disconnect(),f.current&&f.current.disconnect()}},[n.value]),d.useEffect(()=>{if(n.value){try{B.current||(B.current=new(window.AudioContext||window.webkitAudioContext));const t=B.current;if(E.current&&E.current.disconnect(),u.current&&u.current.disconnect(),f.current&&f.current.disconnect(),u.current||(u.current=t.createAnalyser(),u.current.fftSize=2048,u.current.smoothingTimeConstant=.7,u.current.minDecibels=-80,u.current.maxDecibels=20),!E.current||E.current.mediaElement!==n.value)try{E.current=t.createMediaElementSource(n.value)}catch{console.warn("Audio element already connected, skipping source creation");return}f.current||(f.current=t.createGain()),E.current.connect(u.current),u.current.connect(f.current),f.current.connect(t.destination),console.log("Audio successfully connected to analyzer")}catch(t){console.error("Error initializing audio context:",t)}return()=>{E.current&&E.current.disconnect(),u.current&&u.current.disconnect(),f.current&&f.current.disconnect()}}},[n.value]),d.useEffect(()=>{if(!u.current||!n.value)return;const t=u.current,e=t.frequencyBinCount,a=new Float32Array(e),r=new Uint8Array(e),l=()=>{if(!n.value||n.value.paused){N.current=requestAnimationFrame(l);return}t.getFloatFrequencyData(a),t.getByteFrequencyData(r);const m=Array.from(r).slice(0,150).map(P=>P/255),b=Array.from(a).slice(0,150).map(P=>{const q=P+20;return Math.max(-60,Math.min(20,q))}),i=Math.max(...b);i>D.value&&(D.set(i),U.current&&clearTimeout(U.current),U.current=setTimeout(()=>{D.set(-100)},2e3)),L.set(m),T.set(b),N.current=requestAnimationFrame(l)};return l(),()=>{N.current&&cancelAnimationFrame(N.current),U.current&&clearTimeout(U.current)}},[n.value]),d.useEffect(()=>{if(!n.value)return;const t=()=>{var e,a;z.set((e=n.value)==null?void 0:e.currentTime),C.set(((a=n.value)==null?void 0:a.duration)||0)};return n.value.addEventListener("timeupdate",t),n.value.addEventListener("durationchange",t),()=>{var e,a;(e=n.value)==null||e.removeEventListener("timeupdate",t),(a=n.value)==null||a.removeEventListener("durationchange",t)}},[n.value]),d.useEffect(()=>{if(!(!n.value||o===void 0))try{Math.abs(n.value.currentTime-o)>.5&&(console.log("Updating track time from external source:",o),n.value instanceof HTMLAudioElement&&(n.value.currentTime=o,z.set(o)))}catch(t){console.error("Error updating audio current time:",t)}},[o]),d.useEffect(()=>{if(!n.value)return;const t=()=>{var i;z.set(((i=n.value)==null?void 0:i.currentTime)||0)},e=setInterval(()=>{var i;(i=n.value)!=null&&i.paused||t()},100),a=()=>{console.log("Audio play event triggered"),S.set(!0),t()},r=()=>{console.log("Audio pause event triggered"),S.set(!1)},l=()=>{console.log("Audio ended event triggered"),S.set(!1),z.set(0)},m=()=>{t()},b=()=>{var i,P;C.set(((i=n.value)==null?void 0:i.duration)||0),console.log("Duration changed:",(P=n.value)==null?void 0:P.duration)};return n.value.addEventListener("play",a),n.value.addEventListener("pause",r),n.value.addEventListener("ended",l),n.value.addEventListener("timeupdate",m),n.value.addEventListener("durationchange",b),()=>{var i,P,q,j,v;clearInterval(e),(i=n.value)==null||i.removeEventListener("play",a),(P=n.value)==null||P.removeEventListener("pause",r),(q=n.value)==null||q.removeEventListener("ended",l),(j=n.value)==null||j.removeEventListener("timeupdate",m),(v=n.value)==null||v.removeEventListener("durationchange",b)}},[]);const K=(t,e,a,r)=>{const m=s,b=20;let i=0;return t<=m?i=(Math.max(-60,t)- -60)/(m- -60)*g:i=g+(Math.min(b,t)-m)/(b-m)*h,e.height-i*a-r-2};d.useEffect(()=>{const t=M.current;if(!t||L.value.length===0)return;const e=t.getContext("2d");if(!e)return;const a=window.devicePixelRatio||1,r=t.getBoundingClientRect();t.width=r.width*a,t.height=r.height*a,e.scale(a,a),e.clearRect(0,0,r.width,r.height);const l=r.width/L.value.length,m=1,b=r.height*.8,i=5;if(e.fillStyle="#1a1a2e",e.fillRect(0,0,r.width,r.height),(()=>{const v=[];v.push(-60,0,20),v.push(s);const R=(s+60)/4;for(let x=-60+R;x<s;x+=R)v.push(Math.round(x));const A=(20-s)/4;for(let x=s+A;x<20;x+=A)v.push(Math.round(x));return[...new Set(v)].sort((x,ae)=>x-ae)})().forEach(v=>{const R=K(v,r,b,i),A=v===s;e.strokeStyle=A?"#ffffff40":"#ffffff20",e.lineWidth=A?1.5:1,e.beginPath(),e.moveTo(0,R),e.lineTo(r.width,R),e.stroke(),e.fillStyle=A?"#ffffff":"#ffffff90";let x=10;v>-40&&(x=Math.max(7,10-Math.floor((v+40)/10))),e.font=A?"bold 12px sans-serif":`${x}px sans-serif`,e.textAlign="right",e.fillText(`${v} dB`,r.width-5,R-2)}),L.value.forEach((v,R)=>{const A=T.value[R]||-100,x=K(A,r,b,i),ve=r.height-i-2-x,he=R*l;let _=120;A>-10?_=0:A>-20?_=60:A>s&&(_=90);const ge=80,pe=50;e.fillStyle=`hsl(${_}, ${ge}%, ${pe}%)`,e.fillRect(he,x,l-m,ve)}),D.value>-100){const v=K(D.value,r,b,i);e.strokeStyle="#ff0000",e.lineWidth=2,e.beginPath(),e.moveTo(0,v),e.lineTo(r.width,v),e.stroke(),e.fillStyle="#ff0000";let R=10;D.value>-40&&(R=Math.max(7,10-Math.floor((D.value+40)/10))),e.font=`${R}px sans-serif`,e.fillText(`Peak: ${D.value.toFixed(1)} dB`,r.width-5,v-5)}if(C.value>0){const v=z.value/C.value*r.width;e.fillStyle="#ffffff",e.fillRect(v,0,2,r.height)}e.fillStyle="#4a4a6a",e.fillRect(0,r.height-i,r.width,i),e.fillStyle="#38b2ff";const j=Math.min(1,(20*Math.log10(V)+60)/80);e.fillRect(0,r.height-i,r.width*j,i),e.textAlign="start"},[V,L.value,T.value,w.value,z.value,C.value,D.value,s,g,h]);const ce=t=>{F.current&&(H.set(!0),Z.current=t.clientY,ee.current=w.value)},de=t=>{if(!H.value||!F.current)return;const e=Z.current-t.clientY,a=F.current.clientHeight,r=w.value<=0?-60:20*Math.log10(ee.current),l=e/a*80,m=Math.max(-60,Math.min(20,r+l)),b=m<=-60?0:Math.pow(10,m/20);w.set(b),f.current&&(f.current.gain.value=b),$&&$(m)},ne=()=>{H.set(!1)},re=t=>{const e=Math.floor(t/60),a=Math.floor(t%60);return`${e}:${a.toString().padStart(2,"0")}`},fe=()=>w.value<=0?"-∞":`${(20*Math.log10(w.value)).toFixed(1)} dB`,me=()=>{if(T.value.length===0)return"-∞";const t=T.value.map(r=>Math.pow(10,r/20)),e=t.reduce((r,l)=>r+l*l,0)/t.length;return`${(20*Math.log10(Math.sqrt(e))).toFixed(1)} dBFS`};return c.createElement("div",{ref:F,className:Me("relative h-32 w-full select-none overflow-hidden rounded-md",G),onMouseDown:ce,onMouseMove:de,onMouseUp:ne,onMouseLeave:ne},c.createElement("canvas",{ref:M,className:"h-full w-full cursor-ns-resize"}),Y&&c.createElement("div",{className:"absolute left-2 top-2 rounded bg-black/50 px-2 py-1 text-xs text-white"},re(z.value)," / ",re(C.value)),c.createElement("div",{className:"absolute bottom-2 left-2 rounded bg-black/50 px-2 py-1 text-xs text-white"},"Level: ",te.value),H.value&&c.createElement("div",{className:"absolute inset-0 flex items-center justify-center bg-black/20"},c.createElement("div",{className:"rounded-md bg-black/70 px-3 py-2 text-sm text-white"},"Volume: ",fe())))}const Re={min:{control:"number"},max:{control:"number"},step:{control:"number"},startingValue:{control:"number"},label:{control:"text"}},Ue={title:"Components/Editor/AudioVolumeVisualizer",component:ue,parameters:{componentSubtitle:"AudioVolumeVisualizer",design:{type:"figma",url:"https://www.figma.com/design/ln2VDACenFEkjVeHkowxyi/iR-Engine-Design-Library-File?node-id=3968-12405&node-type=frame&t=XAGvEGVnphLHTwP3-0"}},argTypes:Re,args:{startingValue:0,min:0,max:100,step:1,label:"Label"}},Ae=W=>{const G=p(0),$=Math.pow(10,0/20),k=p($),o=p(null),y=p(!1),Y=p(null),w=p(0),L=p(0),T=d.useRef(null),D=()=>{T.current&&T.current.click()},S=s=>{const g=Math.max(-60,Math.min(20,s));G.set(Math.round(g));const h=Math.pow(10,g/20);if(k.set(h),o.value)try{o.value instanceof HTMLAudioElement&&(o.value.volume=Math.max(0,Math.min(1,h)))}catch(M){console.error("Error setting audio volume:",M)}console.log(`Volume changed: ${g} dB (gain: ${h.toFixed(4)})`)};console.log(`Initial volume: 0 dB (gain: ${$.toFixed(4)})`);const H=s=>{const g=s.target.files;if(g&&g.length>0){const h=g[0];if(h.type.startsWith("audio/")&&h.size>0&&h.size<=10*1024*1024){o.value&&(o.value.pause(),o.value.remove(),y.set(!1));const M=new Audio;let F;try{F=URL.createObjectURL(h),M.src=F,Y.set(F),M.crossOrigin="anonymous",o.set(M)}catch(N){console.error("Error creating object URL for file:",N),alert("Failed to load the audio file. Please try again.");return}try{M.volume=Math.max(0,Math.min(1,k.value)),console.log("Set initial audio volume: gain =",k.value.toFixed(2),"dB =",G.value),M.addEventListener("loadedmetadata",()=>{L.set(M.duration),console.log("Audio duration:",M.duration)})}catch(N){console.error("Error setting initial audio volume:",N)}console.log("Audio element created:",h.name)}else h.type.startsWith("audio/")?h.size<=0?alert("The selected file appears to be empty. Please select a valid audio file."):h.size>10*1024*1024?alert("The selected file exceeds the maximum size limit of 10MB. Please select a smaller file."):alert("Please select a valid audio file."):alert("Please select a valid audio file. Supported formats include MP3, WAV, OGG, etc.")}},z=()=>{if(o.value)try{o.value instanceof HTMLAudioElement&&(o.value.currentTime=0,w.set(0)),y.value||o.value.play().then(()=>{y.set(!0)}).catch(s=>{console.error("Error playing audio:",s)})}catch(s){console.error("Error resetting audio:",s)}},C=s=>{if(o.value)try{o.value instanceof HTMLAudioElement&&(o.value.currentTime=s,w.set(s))}catch(g){console.error("Error setting audio time:",g)}},O=s=>{const g=Math.floor(s/60),h=Math.floor(s%60);return`${g}:${h.toString().padStart(2,"0")}`},J=()=>{var s,g;o&&(console.log("Toggle playback. Current state:",y),y.value?((s=o.value)==null||s.pause(),y.set(!1)):(g=o.value)==null||g.play().then(()=>{console.log("Audio playing successfully"),y.set(!0)}).catch(h=>{console.error("Error playing audio:",h),alert("Could not play audio. Error: "+h.message)}))};return c.createElement(we,{name:"Volume",label:"Volume",info:"Volume"},c.createElement("input",{type:"file",ref:T,onChange:H,accept:"audio/mp3,audio/*",className:"hidden"}),c.createElement(Q,{onClick:D,size:"sm",className:"mb-1 flex items-center gap-2"},c.createElement(ye,{size:16}),c.createElement("span",null,"Load MP3")),o.value&&c.createElement("div",{className:"flex items-center gap-4"},c.createElement(Q,{size:"sm",onClick:z,className:"rounded-full",disabled:!o.value},c.createElement(Ee,{className:"h-4 w-4"})),c.createElement(Q,{variant:"secondary",size:"sm",onClick:J,className:"rounded-full",disabled:!o.value},y.value?c.createElement(be,{className:"h-4 w-4"}):c.createElement(xe,{className:"h-4 w-4"}))),o.value&&L.value>0&&c.createElement("div",{className:"flex items-center gap-2"},c.createElement("span",{className:"text-xs"},O(w.value)),c.createElement(oe,{value:w.value,max:L.value,min:0,step:.1,onChange:C,className:"flex-1","aria-label":"Track Position"}),c.createElement("span",{className:"text-xs"},O(L.value))),c.createElement(ue,{audioSrc:Y.value,value:k.value,onChange:S,isPlaying:y.value,currentTrackTime:w.value,scaleSettings:{transitionPoint:0,lowerRangePortion:.4},showCurrentTime:!0,className:o.value?"my-4":"mb-0 h-0 overflow-hidden"}),c.createElement("div",{className:"mb-4 flex"},c.createElement(oe,{value:G.value,units:"dB",max:20,min:-60,step:1,onChange:S,className:"flex-1","aria-label":"Volume"})))},X={name:"Default",render:Ae};var le,ie,se;X.parameters={...X.parameters,docs:{...(le=X.parameters)==null?void 0:le.docs,source:{originalSource:`{
  name: 'Default',
  render: AudioVolumeVisualizerRenderer
}`,...(se=(ie=X.parameters)==null?void 0:ie.docs)==null?void 0:se.source}}};const Ie=["Default"];export{X as Default,Ie as __namedExportsOrder,Ue as default};
