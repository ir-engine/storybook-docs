function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = []
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
import{_ as W}from"./iframe-BwaUBtZe.js";import{r as f}from"./index-CBqU2yxZ.js";import{V as F,i as J,v as j,t as K}from"./three.module-D2RMN07C.js";import{c as k,S as u,e as G,f as D,v as X,h as I,i as q,s as C,b as w,p as Q,r as T,o as R,g as P}from"./index-_wFD3GG2.js";import{a as H,s as Y,b as N,g as L,u as Z,i as B,c as $}from"./ActionFunctions-CxzuxLxN.js";import{au as O,av as V,as as U,A,ar as h,R as ee,a6 as te,aw as _,ax as ne,L as oe}from"./EditorServices-BJKHmurs.js";const z=H({name:"MediaSettingsState",initial:{immersiveMedia:!1,refDistance:20,rolloffFactor:1,maxDistance:1e4,distanceModel:"linear",coneInnerAngle:360,coneOuterAngle:0,coneOuterGain:0}}),g=H({name:"AudioState",initial:()=>({audioContext:null,cameraGainNode:null,gainNodeMixBuses:{mediaStreams:null,notifications:null,music:null,soundEffects:null},masterVolume:.5,microphoneGain:.5,positionalMedia:!1,usePositionalMedia:"auto",mediaStreamVolume:1,notificationVolume:1,soundEffectsVolume:1,backgroundMusicVolume:.5}),extension:Y(["masterVolume","microphoneGain","positionalMedia","mediaStreamVolume","notificationVolume","soundEffectsVolume","backgroundMusicVolume"]),onCreate:()=>{setTimeout(()=>{N(z).immersiveMedia.set(L(g).positionalMedia)},1e3)}}),Me=()=>{const e=Z(g);f.useEffect(()=>{const t=globalThis.AudioContext||globalThis.webkitAudioContext;if(!t)return;const o=new t;o.resume();const n=N(g);n.audioContext.set(o);const s=o.createGain();n.cameraGainNode.set(s),s.connect(o.destination);const l=n.audioContext.currentTime.value;return n.cameraGainNode.gain.value.setTargetAtTime(n.masterVolume.value,l,.01),n.gainNodeMixBuses.mediaStreams.set(o.createGain()),n.gainNodeMixBuses.mediaStreams.value.connect(n.cameraGainNode.value),n.gainNodeMixBuses.mediaStreams.value.gain.setTargetAtTime(n.mediaStreamVolume.value,l,.01),n.gainNodeMixBuses.notifications.set(o.createGain()),n.gainNodeMixBuses.notifications.value.connect(n.cameraGainNode.value),n.gainNodeMixBuses.notifications.value.gain.setTargetAtTime(n.notificationVolume.value,l,.01),n.gainNodeMixBuses.music.set(o.createGain()),n.gainNodeMixBuses.music.value.connect(n.cameraGainNode.value),n.gainNodeMixBuses.music.value.gain.setTargetAtTime(n.backgroundMusicVolume.value,l,.01),n.gainNodeMixBuses.soundEffects.set(o.createGain()),n.gainNodeMixBuses.soundEffects.value.connect(n.cameraGainNode.value),n.gainNodeMixBuses.soundEffects.value.gain.setTargetAtTime(n.soundEffectsVolume.value,l,.01),()=>{n.gainNodeMixBuses.mediaStreams.value.disconnect(),n.gainNodeMixBuses.mediaStreams.set(null),n.gainNodeMixBuses.notifications.value.disconnect(),n.gainNodeMixBuses.notifications.set(null),n.gainNodeMixBuses.music.value.disconnect(),n.gainNodeMixBuses.music.set(null),n.gainNodeMixBuses.soundEffects.value.disconnect(),n.gainNodeMixBuses.soundEffects.set(null)}},[]),f.useEffect(()=>{e.audioContext.value&&e.cameraGainNode.value.gain.setTargetAtTime(e.masterVolume.value,e.audioContext.value.currentTime,.01)},[e.audioContext,e.masterVolume]),f.useEffect(()=>{e.audioContext.value&&e.gainNodeMixBuses.value.mediaStreams.gain.setTargetAtTime(e.mediaStreamVolume.value,e.audioContext.value.currentTime,.01)},[e.audioContext,e.mediaStreamVolume]),f.useEffect(()=>{e.audioContext.value&&e.gainNodeMixBuses.value.notifications.gain.setTargetAtTime(e.notificationVolume.value,e.audioContext.value.currentTime,.01)},[e.audioContext,e.notificationVolume]),f.useEffect(()=>{e.audioContext.value&&e.gainNodeMixBuses.value.soundEffects.gain.setTargetAtTime(e.soundEffectsVolume.value,e.audioContext.value.currentTime,.01)},[e.audioContext,e.soundEffectsVolume]),f.useEffect(()=>{e.audioContext.value&&e.gainNodeMixBuses.value.music.gain.setTargetAtTime(e.backgroundMusicVolume.value,e.audioContext.value.currentTime,.01)},[e.audioContext,e.backgroundMusicVolume]),f.useEffect(()=>{e.positionalMedia.value&&N(z).immersiveMedia.set(e.positionalMedia.value)},[e.audioContext,e.positionalMedia])};new F;const ae=e=>{var t;e.source.disconnect(),e.source.connect(e.gain),(t=e.panner)==null||t.disconnect(),e.panner=void 0};var E=(e=>(e.single="single",e.random="random",e.loop="loop",e.singleloop="singleloop",e))(E||{});function se(e,t){return!!(e&&e.toLowerCase().indexOf(".m3u8")>0)}const ie="/static/editor/audio-icon.png",y=new WeakMap,re=(e,t,o)=>{const n=L(g).audioContext,s=n.createGain();t.connect(s),s.connect(o);const l=n.createPanner(),p={source:t,gain:s,mixbus:o,panner:l};return y.set(e,p),p},m=k({name:"MediaElement",schema:u.Object({element:u.Type(),hls:u.Optional(u.Type()),abortController:u.Class(()=>new AbortController)}),toJSON:()=>null,onSet:(e,t,o)=>{o&&typeof o.element=="object"&&o.element!==t.element.get({noproxy:!0})&&t.element.set(o.element)},reactor:()=>{const e=G(),t=D(e,m);f.useLayoutEffect(()=>{const o=t.get({noproxy:!0});return()=>{var n;if(!X(e)||!I(e,m)){const s=o.element;(n=o.hls)==null||n.destroy();const l=y.get(s);l&&l.panner&&ae(l),y.delete(s),s.pause(),s.removeAttribute("src"),s.load(),s.remove(),o.abortController.abort()}}},[t])},errors:["MEDIA_ERROR","HLS_ERROR"]}),S=k({name:"MediaComponent",jsonID:"EE_media",schema:u.Object({controls:u.Bool(!1),synchronize:u.Bool(!0),autoplay:u.Bool(!0),uiOffset:u.Vec3(),xruiEntity:u.Entity(),volume:u.Number(1),resources:u.Array(u.String()),playMode:u.Enum(E,E.loop),isMusic:u.Bool(!1),seekTime:u.Number(0),paths:u.Array(u.String()),paused:u.Bool(!0),ended:u.Bool(!0),waiting:u.Bool(!1),track:u.Number(-1),trackDurations:u.Array(u.Number())}),toJSON:e=>({controls:e.controls,autoplay:e.autoplay,resources:[...e.resources].filter(Boolean),volume:e.volume,uiOffset:e.uiOffset,synchronize:e.synchronize,playMode:e.playMode,isMusic:e.isMusic,seekTime:e.seekTime}),reactor:ue,errors:["LOADING_ERROR","UNSUPPORTED_ASSET_CLASS","INVALID_URL"]});function ue(){const e=G(),t=D(e,S),o=q(e,m),n=L(g).audioContext,s=L(g).gainNodeMixBuses;if(!B)return null;f.useEffect(()=>{C(e,O),C(e,V,{highlight:!1,grow:!1});const i=w(Q.instance.viewerEntity,oe).renderer,a=()=>{const r=w(e,m);!t.autoplay.value&&!t.paused.value&&(r==null||r.element.play()),t.autoplay.value&&t.paused.value&&t.paused.set(!1),t.autoplay.value&&!t.paused.value&&(r!=null&&r.element.paused)&&r.element.play(),window.removeEventListener("pointerup",a),window.removeEventListener("keypress",a),window.removeEventListener("touchend",a),document.body.removeEventListener("pointerup",a),document.body.removeEventListener("touchend",a),i.domElement.removeEventListener("pointerup",a),i.domElement.removeEventListener("touchend",a)};return window.addEventListener("pointerup",a),window.addEventListener("keypress",a),window.addEventListener("touchend",a),document.body.addEventListener("pointerup",a),document.body.addEventListener("touchend",a),i.domElement.addEventListener("pointerup",a),i.domElement.addEventListener("touchend",a),()=>{window.removeEventListener("pointerup",a),window.removeEventListener("keypress",a),window.removeEventListener("touchend",a),document.body.removeEventListener("pointerup",a),document.body.removeEventListener("touchend",a),i.domElement.removeEventListener("pointerup",a),i.domElement.removeEventListener("touchend",a),T(e,O),T(e,V),T(e,m)}},[]),f.useEffect(function(){if(o)if(t.paused.value)o.element.value.pause();else{const a=o.element.value.play();a&&a.catch(r=>{console.error(r)})}},[t.paused,o]),f.useEffect(()=>{o&&!o.element.paused.value&&o.element.value.play()},[o]),f.useEffect(function(){U(e,S);const a=t.resources.value;if(I(e,m)){const d=w(e,m).element;(a.length===0||!a.includes(d.src))&&(d.pause(),T(e,m),t.ended.set(!0))}for(const d of a){const c=A.getAssetClass(d).toLowerCase();if(d!==""&&c!=="audio"&&c!=="video")return h(e,S,"UNSUPPORTED_ASSET_CLASS")}const r=[];for(const[d,c]of a.entries()){if(c==="")continue;const M=A.getAssetClass(c).toLowerCase(),v=document.createElement(M),x=()=>t.trackDurations[d].set(v.duration);r.push({tempElement:v,listener:x}),v.addEventListener("loadedmetadata",x),v.crossOrigin="anonymous",v.preload="metadata",v.src=c}return()=>{for(const{tempElement:d,listener:c}of r)d.removeEventListener("loadedmetadata",c),d.src="",d.load()}},[t.resources]),f.useEffect(function(){var x;if(!t.ended.value||!B||t.resources.value.every(b=>!b))return;const a=R(e,m),r=t.track.value;let d=ce(r,t.resources.length,t.playMode.value);if(d===-1)return;let c=t.resources.value[d];for(;!c;)d=(d+1)%t.resources.length,c=t.resources[d].value;const M=A.getAssetClass(c).toLowerCase();if(M!=="audio"&&M!=="video"){h(e,S,"UNSUPPORTED_ASSET_CLASS");return}t.ended.set(!1),t.track.set(d),(!a||a.element.nodeName.toLowerCase()!==M)&&le(e,c,t,n,s),C(e,m);const v=P(e,m);(x=v.hls.value)==null||x.destroy(),v.hls.set(void 0),v.element.value.crossOrigin="anonymous",se(c)?de(e,c).then(b=>{v.hls.set(b),v.hls.value.attachMedia(v.element.value)}):v.element.src.set(c),t.paused.value||v.value.element.play()},[t.resources,t.ended,t.playMode]),f.useEffect(function(){var c;const a=t.volume.value,r=(c=R(e,m))==null?void 0:c.element;if(!r)return;const d=y.get(r);d&&d.gain.gain.setTargetAtTime(a,n.currentTime,.1)},[t.volume]),f.useEffect(function(){if(o==null||o.promised||o.value==null)return;const a=o.element.get({noproxy:!0}),r=y.get(a);r&&(r.gain.disconnect(r.mixbus),r.mixbus=t.isMusic.value?s.music:s.soundEffects,r.gain.connect(r.mixbus))},[o,t.isMusic]);const l=$(N(ee).nodeHelperVisibility),[p]=te(l.value?ie:"",e);return f.useEffect(()=>{if(l.value&&p){const i=new J({transparent:!0,side:j});i.map=p,C(e,_,{name:"audio-helper",geometry:new K,material:i})}return()=>{T(e,_)}},[l,p]),null}const le=(e,t,o,n,s)=>{const l=A.getAssetClass(t).toLowerCase();C(e,m,{element:document.createElement(l)});const p=P(e,m),i=p.element.value;i.crossOrigin="anonymous",i.preload="auto",i.muted=!1,i.setAttribute("playsinline","true");const a=p.abortController.signal.value;i.addEventListener("playing",()=>{o.waiting.set(!1),U(e,m)},{signal:a}),i.addEventListener("waiting",()=>o.waiting.set(!0),{signal:a}),i.addEventListener("error",d=>{h(e,m,"MEDIA_ERROR",d.message),o.ended.set(!0),o.waiting.set(!1)},{signal:a}),i.addEventListener("ended",()=>{o.ended.set(!0),o.waiting.set(!1)},{signal:a}),re(i,n.createMediaElementSource(i),o.isMusic.value?s.music:s.soundEffects).gain.gain.setTargetAtTime(o.volume.value,n.currentTime,.1)},de=async(e,t)=>{const o=await W(()=>import("./hls-BetFl4u4.js"),__vite__mapDeps([]),import.meta.url),n=new o.default;return n.on(o.Events.ERROR,function(s,l){if(l.fatal){switch(l.type){case o.ErrorTypes.NETWORK_ERROR:console.error("fatal network error encountered, try to recover",s,l),n.startLoad();break;case o.ErrorTypes.MEDIA_ERROR:console.error("fatal media error encountered, try to recover",s,l),n.recoverMediaError();break;default:console.error("HLS fatal error encountered, destroying video...",s,l),n.destroy();break}h(e,m,"HLS_ERROR")}}),n.on(o.Events.MEDIA_ATTACHED,()=>{n.loadSource(t),n.on(o.Events.MANIFEST_PARSED,(s,l)=>{ne(e,m,"HLS_ERROR")})}),n};function xe(e,t){!e.value||t<0||e.value.currentTime===t||e.currentTime.set(t)}function ce(e,t,o){if(t===0)return-1;let n=0;if(o==E.single){if(n=e+1,n>=t)return-1}else o==E.random?n=Math.floor(Math.random()*t):o==E.singleloop?n=e:n=(e+1)%t;return n}export{g as A,S as M,E as P,y as a,m as b,re as c,ce as g,xe as s,Me as u};
