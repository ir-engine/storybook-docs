var xe=Object.defineProperty;var Te=(n,e,t)=>e in n?xe(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var P=(n,e,t)=>(Te(n,typeof e!="symbol"?e+"":e,t),t);import{i as Fe}from"./i18next-ntfi3Ha_.js";import{m as Ce,c as se,s as ne,f as ae}from"./NotificationService-BtHCxsFA.js";import{a as M,s as re,b as U,n as Me,u as oe,c as T,N as g,g as Ae,h as de}from"./ActionFunctions-CxzuxLxN.js";import{R as _,r as b}from"./index-CBqU2yxZ.js";import{v as Pe}from"./v4-Dz_GI0CC.js";import{p as Ue}from"./miscUtils-D11F-TOL.js";import{k as C,i as J,l as q,s as h,U as $e,b as R,m as B}from"./index-_wFD3GG2.js";import{aW as me,a6 as Re,N as W,q as z,ab as Ie,au as Le,z as Oe,Z as he,a as K,bg as De,bd as fe,ad as Q,aI as V,L as X,bh as je,bi as Je,bj as qe,ak as Be,al as ze,ai as Ke,bc as Qe,az as Ne,n as _e,M as Ge,bk as pe}from"./EditorServices-BJKHmurs.js";import{M as He,Q as We,E as Ve,F as Xe,g as Ze,h as Ye}from"./three.module-D2RMN07C.js";import{g as Z}from"./utils-DTErvVTk.js";Object.defineProperty(BigInt.prototype,"toJSON",{get(){return()=>String(this)}});const G={instance:null},et={id:"",token:"",accountIdentifier:"",oauthToken:"",oauthRefreshToken:"",type:"guest",userId:"",createdAt:"",updatedAt:""},tt={accessToken:"",authentication:{strategy:""},identityProvider:et};class nt{constructor(e,t){P(this,"iframe");P(this,"iframeId");P(this,"targetOrigin");P(this,"messageQueue",new Map);P(this,"destroyed",!1);this.iframeId=e,this.targetOrigin=t,this.iframe=document.getElementById(e),window.addEventListener("message",this.handleMessage.bind(this))}handleMessage(e){if(e.origin!==this.targetOrigin||e.source!==this.iframe.contentWindow)return;const t=e.data;if(t&&t.id){const[a,s]=this.messageQueue.get(t.id)||[];t.success?a&&(a(t),this.messageQueue.delete(t.id)):s&&(s(t),this.messageQueue.delete(t.id))}}sendMessage(e,t){if(this.destroyed)throw"ParentCommunicator has been destroyed already.";return new Promise((a,s)=>{var o,r;const i=Pe(),c={id:i,method:e,payload:t};this.messageQueue.set(i,[a,s]),(r=(o=this.iframe)==null?void 0:o.contentWindow)==null||r.postMessage(c,this.targetOrigin)})}destroy(){this.destroyed=!0,window.removeEventListener("message",this.handleMessage.bind(this))}}Ce.child({component:"client-core:AuthService"});document.getElementById("root-cookie-accessor");new nt("root-cookie-accessor",se.client.clientUrl);const st={id:"",name:"",isGuest:!0,avatarId:"",avatar:{id:"",name:"",isPublic:!0,userId:"",modelResourceId:"",thumbnailResourceId:"",identifierName:"",project:"",createdAt:"",updatedAt:""},apiKey:{id:"",token:"",userId:"",createdAt:"",updatedAt:""},acceptedTOS:!1,userSetting:{id:"",themeModes:{},userId:"",createdAt:"",updatedAt:""},scopes:[],identityProviders:[],locationAdmins:[],locationBans:[],instanceAttendance:[],lastLogin:{id:"",ipAddress:"",userAgent:"",identityProviderId:"",userId:"",createdAt:""},createdAt:"",updatedAt:""},at=M({name:"AuthState",initial:()=>({isLoggedIn:!1,isProcessing:!1,error:"",authUser:tt,user:st}),extension:re(["authUser"])});function rt(n){if(!n)return"";if(n.message)return n.message;const e=n.target;return e?n.target.error&&n.target.error.message?e.error.message:n.target.src?`Failed to load "${e.src}"`:e instanceof XMLHttpRequest?`Network Error: ${e.status||"Unknown Status."} ${e.statusText||"Unknown Error. Possibly a CORS error."}`:`Unknown error on ${e}.`:`Unknown error: "${JSON.stringify(n)}"`}class ot extends Error{constructor(e){super(e),this.name=this.constructor.name,this.message=e,typeof Error.captureStackTrace=="function"?Error.captureStackTrace(this,this.constructor):this.stack=new Error(e).stack}}class it extends ot{constructor(t,a){super(`${t}:
  Cause:
    ${rt(a).replace(/\n/g,`
    `)}`);P(this,"originalError");this.originalError=a,this.stack+=`
`+a.stack}}const Y=n=>{const e=[];return Array.isArray(n)?n.forEach(t=>{e.push(t.name)}):e.push(n.name),e},I=M({name:"FileUploadState",initial:{},startFileUpload:n=>{const t=Y(n).reduce((a,s)=>({...a,[s]:0}),{});U(I).merge(t)},updateFileUpload:(n,e)=>{const t=Y(n);e=Math.min(e,.9);const a=t.reduce((s,i)=>({...s,[i]:e}),{});U(I).merge(a)},endFileUpload:n=>{const t=Y(n).reduce((a,s)=>({...a,[s]:Me}),{});U(I).merge(t)}}),ie=(n,e,t,a)=>{const s=U(at).authUser.accessToken.value,i=new XMLHttpRequest;i.timeout=10*60*1e3;let c=!1;return I.startFileUpload(e),{cancel:()=>{c=!0,i.abort()},promise:new Promise((o,r)=>{i.upload.addEventListener("progress",f=>{if(c)return;const d=f.loaded/f.total;I.updateFileUpload(e,d),a&&a(d)}),i.upload.addEventListener("error",f=>{c||r(new it(Fe.t("editor:errors.uploadFailed"),f))}),i.addEventListener("readystatechange",f=>{if(i.readyState===XMLHttpRequest.DONE){I.endFileUpload(e);const d=i.status;if(d===0||d>=200&&d<400)o(JSON.parse(i.responseText));else{if(c)return;if(console.error("Oh no! There has been an error with the request!",i,f),d===403){const v=JSON.parse(i.responseText);r(new Error(v.message))}else r()}}});const u=new FormData;Object.entries(t).forEach(([f,d])=>{u.set(f,typeof d=="object"?JSON.stringify(d):d)}),Array.isArray(e)?e.forEach(f=>{u.append("media[]",f)}):u.set("media",e),i.open("post",`${se.client.serverUrl}/${n}`,!0),i.setRequestHeader("Authorization",`Bearer ${s}`),i.send(u)})}},ce=M({name:"ee.engine.FeathersState",initial:()=>({}),reactor:()=>{const n=oe(ce);return _.createElement(_.Fragment,null,n.keys.map(e=>_.createElement(ct,{key:e,serviceName:e})))}}),ct=n=>{const e=()=>{const t=Ae(ce);for(const a in t[n.serviceName])t[n.serviceName][a].fetch()};return mt(n.serviceName,e),null},lt=(n,e,...t)=>{var S,w;const a=G.instance.service(n),s=oe(ce),i={serviceName:n,method:e,args:t},c=`${e.substring(0,1)}:${dt(i)}`,o=()=>(s[n][c].merge({status:"pending",error:""}),a[e](...t).then(E=>{s[n][c].merge({response:E,status:"success",error:""})}).catch(E=>{console.error(`Error in service: ${n}, method: ${e}, args: ${JSON.stringify(t)}`,E),s[n][c].merge({status:"error",error:E.message})}));b.useLayoutEffect(()=>{s.get(g)[n]||s[n].set({}),s.get(g)[n][c]||(s[n].merge({[c]:{fetch:o,query:i,response:null,status:"pending",error:""}}),o())},[n,e,...t]);const r=(S=s[n])==null?void 0:S[c],u=(w=s.get(g)[n])==null?void 0:w[c],f=u==null?void 0:u.response,d=u==null?void 0:u.error,v=u==null?void 0:u.status;return b.useMemo(()=>({data:f,status:v,error:d,refetch:o}),[f,r==null?void 0:r.response,r==null?void 0:r.status,r==null?void 0:r.error])},ut=(n,e={})=>{var o,r;const t=ht(e.query);let a;((o=e.query)==null?void 0:o.paginate)===!1||((r=e.query)==null?void 0:r.$paginate)===!1?a={...e,query:{...e.query}}:a={...e,query:{...e.query,...t.query}};const s=lt(n,"find",a),i=s!=null&&s.data?Array.isArray(s.data)?s.data:s.data.data?s.data.data:s.data:[],c=s!=null&&s.data&&!Array.isArray(s.data)?s.data.total:0;return{...s,total:c,setSort:t.setSort,setLimit:t.setLimit,setPage:t.setPage,search:t.search,page:t.page,skip:t.query.$skip,limit:t.query.$limit,sort:t.query.$sort,data:i}};function dt(n){let e=0;const t=JSON.stringify(n);for(let a=0;a<t.length;a++){const s=t.charCodeAt(a);e=(e<<5)-e+s,e=e&e}return e}function mt(n,e){b.useLayoutEffect(()=>{const t=G.instance.service(n),a=o=>e(o,"created"),s=o=>e(o,"updated"),i=o=>e(o,"patched"),c=o=>e(o,"removed");return t.on("created",a),t.on("updated",s),t.on("patched",i),t.on("removed",c),()=>{t.off("created",a),t.off("updated",s),t.off("patched",i),t.off("removed",c)}},[n])}function ge(n){return{$skip:n.$skip??0,$limit:n.$limit??10,$sort:n.$sort??{}}}function ht(n={}){const e=T(ge(n)),t=e.get(g),a=T({stored:!1,query:t}),s=d=>{e.$sort.set(d)},i=d=>{e.$limit.set(d)},c=d=>{e.$skip.set(d*e.$limit.value)},o=()=>{e.set(ge(n))},r=()=>{a.stored.value||(a.set({stored:!0,query:structuredClone(t)}),o())},u=()=>{a.stored.value&&(e.set(structuredClone(a.get(g).query)),a.merge({stored:!1}))},f=d=>{d?(r(),e.merge(d)):u()};return{query:t,page:Math.floor(e.$skip.value/e.$limit.value),setSort:s,setLimit:i,setPage:c,search:f}}const ft=n=>{let e=n;try{const t=e.split(".");if(t.length===1)return e;const a=t.pop();a&&(t.push(a.toLowerCase()),e=t.join("."))}catch{return e}return e};function pt(n,e){return`${decodeURI(be(n).replace(/^.*?\/projects\//,"")).replace(e+"/","").replaceAll(/[^a-zA-Z0-9\.\-_\s]/g,"_").replaceAll(/\s/g,"-")}-thumbnail.png`}const gt=(n,e)=>new Promise((t,a)=>{n.currentTime=e,n.onerror=a,n.onseeked=()=>{n.onerror=null,n.onseeked=null,t()}}),ee=n=>{const e=document.createElement("canvas");e.width=90,e.height=90;const t=e.getContext("2d");return t==null?Promise.reject():(t.drawImage(n,0,0,90,90),Promise.resolve(e))},N=async(n,e,t,a)=>{if(!a)return;const s="automatic",i=pt(n,e),c=new File([a],i),o=new URL(await ie(ae,[c],{args:[{fileName:c.name,project:e,path:"public/thumbnails/"+c.name,contentType:c.type,type:"thumbnail",thumbnailKey:i,thumbnailMode:s}]}).promise);o.search="",o.hash="";const r=o.href.replace(se.client.fileServer+"/","");await G.instance.service(ne).patch(t,{thumbnailKey:r,thumbnailMode:s})},te=new Set,ye=M({name:"FileThumbnailJobState",initial:[],reactor:()=>_.createElement(Et,null),useGenerateThumbnails:async n=>{const e=ut(ne,{query:{key:{$in:n.map(t=>t.key).filter(t=>!te.has(t))},thumbnailKey:"null"}});b.useEffect(()=>{for(const t of e.data)if(!te.has(t.key)){if(te.add(t.key),t.type==="thumbnail"){G.instance.service(ne).patch(t.id,{thumbnailKey:t.key});continue}t.thumbnailKey!=null||!bt(t.key.split(".").pop()??"")||U(ye).merge([{key:t.url,project:t.project,id:t.id}])}e.total>e.data.length&&e.refetch()},[e.data])}}),yt=[{extensions:["material.gltf"],thumbnailType:"material"},{extensions:["lookdev.gltf"],thumbnailType:"lookDev"},{extensions:["gltf","glb","vrm","usdz","fbx"],thumbnailType:"model"},{extensions:["png","jpeg","jpg"],thumbnailType:"image"},{extensions:["ktx2"],thumbnailType:"texture"},{extensions:["mp4","m3u8"],thumbnailType:"video"}],le=new Map;for(const{extensions:n,thumbnailType:e}of yt)for(const t of n)le.set(t,e);const be=n=>{if(!n.includes("?"))return n;const e=new URL(n);return e.search="",e.href},bt=n=>le.has(n),Et=()=>{const n=T(U(ye)),e=T(null),{key:t,project:a,id:s}=e.value??{key:"",project:"",id:""},i=be(t);let c=i;i.endsWith(".material.gltf")?c="material.gltf":i.endsWith(".lookdev.gltf")?c="lookdev.gltf":c=i.split(".").pop()??"";const o=le.get(c),r=T({cameraEntity:C,modelEntity:C,lightEntity:C,skyboxEntity:C,thumbnailCanvas:null}),u=T(null),f=T(U(me)),[d]=Re(o==="texture"?t:""),v=J(r.lightEntity.value,he),S=J(r.modelEntity.value,Qe),w=T(!1),E=T(!1),$=l=>{try{l()}catch(y){console.error("failed to generate thumbnail for",t),console.error(y),n.set(n.get(g).slice(1))}};function ue(){var l;r.cameraEntity.value&&(B(r.cameraEntity.value),r.cameraEntity.set(C)),r.modelEntity.value&&(B(r.modelEntity.value),r.modelEntity.set(C)),r.lightEntity.value&&(B(r.lightEntity.value),r.lightEntity.set(C)),r.skyboxEntity.value&&(B(r.skyboxEntity.value),r.skyboxEntity.set(C)),r.thumbnailCanvas.get(g)&&((l=r.thumbnailCanvas.get(g))==null||l.remove(),r.thumbnailCanvas.set(null))}return b.useEffect(()=>{if(n.length>0){const l=n[0].get(g);e.set(JSON.parse(JSON.stringify(l)))}else ue()},[n.length]),b.useEffect(()=>{t!==""&&o==="image"&&(u.promised||u.value!=null||$(()=>{const l=new Image;l.crossOrigin="anonymous",l.src=t,u.set(l.decode().then(()=>ee(l)).then(Z).then(y=>$(()=>N(t,a,s,y))).then(()=>n.set(n.get(g).slice(1))))}))},[o,s]),b.useEffect(()=>{t!==""&&o==="video"&&u.value==null&&$(()=>{const l=document.createElement("video");l.src=t,l.crossOrigin="anonymous",u.set(gt(l,1).then(()=>ee(l)).then(Z).then(y=>$(()=>N(t,a,s,y))).then(()=>l.remove()).then(()=>n.set(n.get(g).slice(1))))})},[o,s]),b.useEffect(()=>{t!==""&&o==="texture"&&u.value==null&&d&&$(()=>{const l=new Image;l.crossOrigin="anonymous",u.set(Ne(d,{url:!0}).then(y=>(l.src=y,l.decode())).then(()=>ee(l)).then(Z).then(y=>$(()=>N(t,a,s,y))).then(()=>l.remove()).then(()=>n.set(n.get(g).slice(1))))})},[o,d,s]),b.useEffect(()=>{if(t===""||o!=="model"&&o!=="material"&&o!=="lookDev"){ue();return}const l=q();h(l,W,"thumbnail job asset "+t);const y=He.generateUUID();h(l,$e,y),h(l,z),h(l,Ie,{cast:!0,receive:!0}),h(l,Le);const A=q();h(A,Oe,{rotation:new We().setFromEuler(new Ve(-4,-.5,0))}),h(A,W,"thumbnail job light for "+t),h(A,z),h(A,he,{intensity:1,color:new Xe(16777215)});const k=q();if(h(k,W,"thumbnail job skybox for "+t),h(k,z),o==="model")h(l,K,{src:t,cameraOcclusion:!1});else if(o==="material")w.value&&w.set(!1),De(t,p=>{if(!p)console.error("Failed to load material for thumbnail",t);else{const m=new Ze(new Ye(1),p);Object.hasOwn(m.material,"flatShading")&&(m.material.flatShading=!1),_e(l,m),h(l,Ge,m),w.set(!0)}});else if(o==="lookDev"){h(l,K,{src:t,cameraOcclusion:!1}),E.value&&E.set(!1);const p=de(()=>{const m=J(l,K),x=oe(me),O=fe(l);return b.useEffect(()=>{if(!x[O].value||!(m!=null&&m.scene.value))return;m.scene.value.children[0].userData.componentJson.forEach(L=>{var j;if(L.name==Q.jsonID){h(k,Q,L.props),R(k,Q),(j=Q.reactorMap.get(k))==null||j.run();const H=de(()=>{const F=J(k,pe);return b.useEffect(()=>{F!=null&&F.value&&(R(k,pe),E.set(!0),H.stop(),p.stop())},[F==null?void 0:F.value]),null})}}),p.stop()},[x[O]]),null})}if(!r.cameraEntity.value){let p=document.getElementById("thumbnail-camera-container");p||(p=document.createElement("div"),p.id="thumbnail-camera-container",p.style.width="256px",p.style.height="256px",document.body.append(p));const m=document.createElement("canvas");m.width=256,m.height=256,p.appendChild(m),r.thumbnailCanvas.set(m);const x=q();h(x,V),h(x,X,{canvas:m}),je(x),h(x,z,!0),r.cameraEntity.set(x)}r.modelEntity.set(l),r.lightEntity.set(A),r.skyboxEntity.set(k)},[o,s]),b.useEffect(()=>{if(S!=null&&S.keys.includes(K.name)){console.error("failed to load model for thumbnail",t),n.set(n.get(g).slice(1));return}if(t===""||o!=="model"&&o!=="material"&&o!=="lookDev"||!r.cameraEntity.value||!r.modelEntity.value||!(v!=null&&v.light.value)||o==="material"&&!w.value||o==="lookDev"&&!E.value)return;const l=r.modelEntity.value,y=r.lightEntity.value,A=r.skyboxEntity.value,k=fe(l);if(f.value[k])try{let p=function(){n.set(n.get(g).slice(1)),w.set(!1),E.set(!1)};const m=r.cameraEntity.value;Je(l,m);const O=R(m,V).cameras[0];O.layers.mask=R(m,qe),h(m,X,{scenes:[l,y,A]});const D=R(m,X),{scene:L,canvas:j,scenes:H}=D,F=H.map(Be).flat(),{background:ve,children:ke}=ze(F);L.children=ke,L.background=ve,Ke(D,D.scene,R(m,V),0,!1),j.toBlob(Se=>{try{N(t,a,s,Se).then(p)}catch(we){console.error("failed to upload model thumbnail for",t),console.error(we),p()}})}catch(p){console.error("failed to generate model thumbnail for",t),console.error(p),n.set(n.get(g).slice(1))}},[r.cameraEntity,r.modelEntity,r.skyboxEntity,v==null?void 0:v.light,f.keys,S==null?void 0:S.keys,w,E]),null};M({name:"FilesViewModeState",initial:{viewMode:"icons"},extension:re(["viewMode"])});M({name:"FilesViewModeSettings",initial:{icons:{iconSize:90},list:{fontSize:15,selectedTableColumns:{name:!0,type:!0,dateModified:!0,size:!0}}},extension:re(["icons","list"])});M({name:"FilesState",initial:()=>({selectedDirectory:"",projectName:"",clipboardFile:null,searchText:""})});M({name:"FilesSelectedFilesState",initial:[]});b.createContext({filesQuery:null,files:[],changeDirectoryByPath:n=>{},backDirectory:()=>{},refreshDirectory:async()=>{},createNewFolder:()=>{}});const Rt=(n,e,t,a)=>{const s=[];for(let i=0;i<e.length;i++){const c=e[i],o=t[i].replace("projects/"+n+"/",""),r=o?Ue(o,c.name):c.name,u={};s.push(ie(ae,[c],{args:[{contentType:"",...u,project:n,path:r}]}))}return{cancel:()=>s.forEach(i=>i.cancel()),promises:s.map(i=>i.promise)}},It=async(n,e,t=(...a)=>{})=>{const a=[];for(let s=0;s<e.length;s++)await Ee(e[s],n,"",a,i=>t(s+1,e.length,i));return{cancel:()=>a.forEach(s=>s.cancel()),promises:a.map(s=>s.promise)}},Ee=async(n,e,t,a,s)=>{if(n.isDirectory){const i=n.createReader(),c=await kt(i);for(let o=0;o<c.length;o++)await Ee(c[o],e,n.fullPath,a,s)}if(n.isFile){const i=await vt(n),c=ft(i.name),o=`assets${t}/`+c;a.push(ie(ae,[i],{args:[{project:e,path:o,contentType:i.type}]},s))}},vt=async n=>{try{return await new Promise((e,t)=>n.file(e,t))}catch(e){return console.log(e),null}},kt=async n=>{try{return await new Promise((e,t)=>n.readEntries(e,t))}catch(e){return console.log(e),null}};export{It as a,kt as g,Rt as u};
