import{_ as Q}from"./iframe-DiWilCzr.js";import{d as F,s as Z,e as j,g as U,a as N,i as _,N as H}from"./WebRTCTransportFunctions-mB_FREj1.js";import{r as c}from"./index-DPzuYzxM.js";import{d as K,S as r,u as X,a as $,e as ee,h as I,q as te,f as W,s as G,g as w,r as L,n as b,x as D,y as ne}from"./UUIDComponent-GqVY2Xw8.js";import{b as ae,u as oe,B as Y,I as q,q as se,s as O,r as C,t as P,d as J,v as R,e as B,w as ie}from"./resourceLoaderHooks-CRL4d032.js";import{a as re}from"./three.module-BizNiMhn.js";const ue=F({name:"MediaSettingsState",initial:{immersiveMedia:!1,refDistance:1,rolloffFactor:1,maxDistance:1e4,distanceModel:"linear",coneInnerAngle:360,coneOuterAngle:360,coneOuterGain:0}}),y=F({name:"AudioState",initial:()=>({audioContext:null,cameraGainNode:null,gainNodeMixBuses:{mediaStreams:null,notifications:null,music:null,soundEffects:null},masterVolume:.5,microphoneGain:.5,positionalMedia:!1,usePositionalMedia:"auto",mediaStreamVolume:1,notificationVolume:1,soundEffectsVolume:1,backgroundMusicVolume:.5}),extension:Z(["masterVolume","microphoneGain","positionalMedia","mediaStreamVolume","notificationVolume","soundEffectsVolume","backgroundMusicVolume"])}),Ae=()=>{const e=j(y);c.useEffect(()=>{const t=globalThis.AudioContext||globalThis.webkitAudioContext;if(!t)return;const n=new t;n.resume();const a=U(y);a.audioContext.set(n);const u=n.createGain();a.cameraGainNode.set(u),u.connect(n.destination);const l=a.audioContext.currentTime.value;return a.cameraGainNode.gain.value.setTargetAtTime(a.masterVolume.value,l,.01),a.gainNodeMixBuses.mediaStreams.set(n.createGain()),a.gainNodeMixBuses.mediaStreams.value.connect(a.cameraGainNode.value),a.gainNodeMixBuses.mediaStreams.value.gain.setTargetAtTime(a.mediaStreamVolume.value,l,.01),a.gainNodeMixBuses.notifications.set(n.createGain()),a.gainNodeMixBuses.notifications.value.connect(a.cameraGainNode.value),a.gainNodeMixBuses.notifications.value.gain.setTargetAtTime(a.notificationVolume.value,l,.01),a.gainNodeMixBuses.music.set(n.createGain()),a.gainNodeMixBuses.music.value.connect(a.cameraGainNode.value),a.gainNodeMixBuses.music.value.gain.setTargetAtTime(a.backgroundMusicVolume.value,l,.01),a.gainNodeMixBuses.soundEffects.set(n.createGain()),a.gainNodeMixBuses.soundEffects.value.connect(a.cameraGainNode.value),a.gainNodeMixBuses.soundEffects.value.gain.setTargetAtTime(a.soundEffectsVolume.value,l,.01),()=>{a.gainNodeMixBuses.mediaStreams.value.disconnect(),a.gainNodeMixBuses.mediaStreams.set(null),a.gainNodeMixBuses.notifications.value.disconnect(),a.gainNodeMixBuses.notifications.set(null),a.gainNodeMixBuses.music.value.disconnect(),a.gainNodeMixBuses.music.set(null),a.gainNodeMixBuses.soundEffects.value.disconnect(),a.gainNodeMixBuses.soundEffects.set(null)}},[]),c.useEffect(()=>{e.audioContext.value&&e.cameraGainNode.value.gain.setTargetAtTime(e.masterVolume.value,e.audioContext.value.currentTime,.01)},[e.audioContext,e.masterVolume]),c.useEffect(()=>{e.audioContext.value&&e.gainNodeMixBuses.value.mediaStreams.gain.setTargetAtTime(e.mediaStreamVolume.value,e.audioContext.value.currentTime,.01)},[e.audioContext,e.mediaStreamVolume]),c.useEffect(()=>{e.audioContext.value&&e.gainNodeMixBuses.value.notifications.gain.setTargetAtTime(e.notificationVolume.value,e.audioContext.value.currentTime,.01)},[e.audioContext,e.notificationVolume]),c.useEffect(()=>{e.audioContext.value&&e.gainNodeMixBuses.value.soundEffects.gain.setTargetAtTime(e.soundEffectsVolume.value,e.audioContext.value.currentTime,.01)},[e.audioContext,e.soundEffectsVolume]),c.useEffect(()=>{e.audioContext.value&&e.gainNodeMixBuses.value.music.gain.setTargetAtTime(e.backgroundMusicVolume.value,e.audioContext.value.currentTime,.01)},[e.audioContext,e.backgroundMusicVolume]),c.useEffect(()=>{e.positionalMedia.value&&U(ue).immersiveMedia.set(le())},[e.audioContext,e.positionalMedia,e.usePositionalMedia])},le=()=>{const e=N(y);return e.usePositionalMedia==="auto"?e.positionalMedia:e.usePositionalMedia==="on"};new re;const de=e=>{var t;e.source.disconnect(),e.source.connect(e.gain),(t=e.panner)==null||t.disconnect(),e.panner=void 0},h={single:"single",random:"random",loop:"loop",singleloop:"singleloop"};function ce(e,t){return!!(e&&e.toLowerCase().indexOf(".m3u8")>0)}const k=new WeakMap,me=(e,t,n)=>{const a=N(y).audioContext,u=a.createGain();t.connect(u),u.connect(n);const l=a.createPanner(),M={source:t,gain:u,mixbus:n,panner:l};return k.set(e,M),M},d=K({name:"MediaElement",schema:r.Object({element:r.Type(),hls:r.Type(),abortController:r.Class(()=>new AbortController)}),onSet:(e,t,n)=>{n&&typeof n.element=="object"&&n.element!==t.element.get({noproxy:!0})&&t.element.set(n.element)},onRemove:(e,t)=>{t.element&&t.element.value.remove()},reactor:()=>{const e=X(),t=$(e,d);c.useLayoutEffect(()=>{const n=t.get({noproxy:!0});return()=>{var a;if(!ee(e)||!I(e,d)){const u=n.element;(a=n.hls)==null||a.destroy();const l=k.get(u);l&&l.panner&&de(l),k.delete(u),u.pause(),u.removeAttribute("src"),u.load(),u.remove(),n.abortController.abort()}}},[t])},errors:["MEDIA_ERROR","HLS_ERROR"]}),S=K({name:"MediaComponent",jsonID:"EE_media",schema:r.Object({controls:r.Bool({default:!1}),synchronize:r.Bool({default:!0}),autoplay:r.Bool({default:!1}),muteEditor:r.Bool({default:!1}),uiOffset:ae.Vec3(),volume:r.Number({default:1}),resources:r.Array(r.String()),playMode:r.Enum(h,{$comment:"A string enum, ie. one of the following values: 'single', 'random', 'loop', 'singleloop'",default:h.loop}),isMusic:r.Bool({default:!1}),seekTime:r.Number({default:0,serialized:!1}),paths:r.Array(r.String()),xruiEntity:r.Entity({serialized:!1}),paused:r.Bool({default:!0,serialized:!1}),muted:r.Bool({default:!1,serialized:!1}),ended:r.Bool({default:!0,serialized:!1}),waiting:r.Bool({default:!1,serialized:!1}),track:r.Number({default:-1,serialized:!1}),currentTrackTime:r.Number({default:0,serialized:!1}),currentTrackDuration:r.Number({default:0,serialized:!1}),isCurrentTrackLoaded:r.Bool({default:!1,serialized:!1}),externalMediaNodeID:r.EntityID()}),reactor:fe,errors:["LOADING_ERROR","UNSUPPORTED_ASSET_CLASS","INVALID_URL"]});function fe(){if(!_)return null;const e=X(),t=$(e,S),n=te(e,d),a=N(y).audioContext,u=N(y).gainNodeMixBuses,l=oe(e),M=j(W);function f(){if(!n)return;const i=n.element.value;let o=t.seekTime.value;o>i.duration&&(o=i.duration),o<0&&(o=0),ge(n.element,o)}const E=()=>M.isEditing.value?!1:t.autoplay.value,p=()=>{var z;let i=t.track.value;const o=i===-1?"":t.resources.value[i];if(i!==-1&&i>=t.resources.length){i=(i+1)%t.resources.length,t.track.set(i);return}if(o===""){t.isCurrentTrackLoaded.set(!1),t.currentTrackTime.set(0),t.currentTrackDuration.set(0),L(e,d);return}const s=encodeURI(R.getAbsolutePath(o)),m=b(e,d);if(m&&s===m.element.src)return;const g=R.getAssetClass(s).toLowerCase();if(g!=="audio"&&g!=="video"){B(e,S,"UNSUPPORTED_ASSET_CLASS");return}t.ended.set(!1),(!m||!m.element||m.element.nodeName.toLowerCase()!==g)&&ve(e,s,t,a,u);const v=D(e,d);if(v.element.src.value===s&&t.isCurrentTrackLoaded.value){const A=v.element.duration.value;t.currentTrackDuration.set(A);return}(z=v.hls.value)==null||z.destroy(),v.hls.set(void 0),v.element.value.crossOrigin="anonymous",v.element.value.ontimeupdate=A=>{const x=ne(e,S);if(!x)return;const T=b(e,d);if(!T||!T.element)return;const V=T.element.currentTime;x.currentTrackTime.set(V)},t.isCurrentTrackLoaded.set(!1),v.element.value.onloadeddata=A=>{const x=D(e,S),T=w(e,d);if(!x||!T||!T.element)return;const V=T.element.duration;x.currentTrackDuration.set(V),x.isCurrentTrackLoaded.set(!0)},ce(s)?Ee(e,s).then(A=>{v.hls.set(A),v.hls.value.attachMedia(v.element.value)}):v.element.src.set(s),t.paused.value||v.value.element.play(),f()};return c.useEffect(()=>{t.resources.length>0&&t.track.value<0&&(t.track.set(0),E()&&(t.paused.set(!1),p()))},[t.resources.length]),c.useEffect(()=>{if(!n)return;const i=E();t.paused.set(!i),f()},[t.autoplay,!!n,M.isEditing]),c.useEffect(()=>{if(!l)return;G(e,Y),G(e,q,{highlight:!1,grow:!1});const i=w(l,se).renderer,o=()=>{const s=b(e,d);if(!E()&&!t.paused.value&&(s==null||s.element.play()),E()&&t.paused.value&&t.paused.set(!1),E()&&!t.paused.value&&(s!=null&&s.element.paused)){s.element.play();const m=E();t.paused.set(!m)}window.removeEventListener("pointerup",o),window.removeEventListener("keypress",o),window.removeEventListener("touchend",o),document.body.removeEventListener("pointerup",o),document.body.removeEventListener("touchend",o),i.domElement.removeEventListener("pointerup",o),i.domElement.removeEventListener("touchend",o)};return window.addEventListener("pointerup",o),window.addEventListener("keypress",o),window.addEventListener("touchend",o),document.body.addEventListener("pointerup",o),document.body.addEventListener("touchend",o),i.domElement.addEventListener("pointerup",o),i.domElement.addEventListener("touchend",o),O(e,C.PLAY,()=>t.paused.set(!1)),O(e,C.PAUSE,()=>t.paused.set(!0)),O(e,C.RESET,()=>{const s=E();t.paused.set(!s);let m=t.seekTime.value;m==0?m=1e-6:m=0,t.seekTime.set(m)}),()=>{window.removeEventListener("pointerup",o),window.removeEventListener("keypress",o),window.removeEventListener("touchend",o),document.body.removeEventListener("pointerup",o),document.body.removeEventListener("touchend",o),i.domElement.removeEventListener("pointerup",o),i.domElement.removeEventListener("touchend",o),L(e,Y),L(e,q),L(e,d),P(e,C.PLAY),P(e,C.PAUSE),P(e,C.RESET)}},[l]),c.useEffect(()=>{if(!n)return;const i=n.element.value,o=()=>{i.muted=!1,document.removeEventListener("pointerdown",o)};return t.paused.value?i.pause():i.play().catch(s=>{s.name==="NotAllowedError"?(i.muted=!0,i.play(),document.addEventListener("pointerdown",o)):console.error(s)}),()=>{document.removeEventListener("pointerdown",o)}},[t.paused,!!n]),c.useEffect(()=>{if(!n)return;const o=N(W).isEditing?t.muteEditor.value:!1,s=n.element.get(H);s.muted=o},[t.muteEditor,n]),c.useEffect(()=>{n&&!n.element.paused.value&&n.element.value.play()},[n]),c.useEffect(function(){J(e,S);const o=t.resources.value;let s;if(I(e,d)&&(s=w(e,d).element),s&&(o.length===0||t.track.value>=o.length))s.pause(),s.src="",s.load(),L(e,d),t.track.set(-1);else{const m=o[t.track.value];(!s||m!==s.src)&&p()}for(const m of o){const g=R.getAssetClass(m).toLowerCase();if(m!==""&&g!=="audio"&&g!=="video")return B(e,S,"UNSUPPORTED_ASSET_CLASS")}},[t.resources,t.resources[t.track.value]]),c.useEffect(()=>{if(!t.ended.value||!_||t.resources.value.every(s=>!s))return;const i=t.track.value,o=pe(i,t.resources.length,t.playMode.value);if(o===-1){t.paused.set(!0);return}t.ended.set(!1),t.track.value===o?t.paused.value||n==null||n.element.value.play():t.track.set(o)},[t.ended,t.playMode]),c.useEffect(()=>{_&&p()},[t.track]),c.useEffect(function(){var g;const o=t.volume.value,s=(g=b(e,d))==null?void 0:g.element;if(!s)return;const m=k.get(s);m&&m.gain.gain.setTargetAtTime(o,a.currentTime,.1)},[t.volume]),c.useEffect(()=>{if(!n)return;const i=n.element.get(H);i.muted=t.muted.value},[t.muted,n]),c.useEffect(function(){if(n==null||n.promised||n.value==null)return;const o=n.element.get({noproxy:!0}),s=k.get(o);s&&(s.gain.disconnect(s.mixbus),s.mixbus=t.isMusic.value?u.music:u.soundEffects,s.gain.connect(s.mixbus))},[n,t.isMusic]),c.useEffect(()=>{f()},[t.seekTime]),null}const ve=(e,t,n,a,u)=>{const l=R.getAssetClass(t).toLowerCase(),M=I(e,d);let f=null;M?f=w(e,d).element:f=document.createElement(l),G(e,d,{element:f});const E=D(e,d);f.crossOrigin="anonymous",f.preload="auto",f.muted=!1,f.setAttribute("playsinline","true");const p=E.abortController.signal.value;f.addEventListener("playing",()=>{n.waiting.set(!1),J(e,d)},{signal:p}),f.addEventListener("waiting",()=>n.waiting.set(!0),{signal:p}),f.addEventListener("error",o=>{B(e,d,"MEDIA_ERROR",o.message),n.ended.set(!0),n.waiting.set(!1)},{signal:p}),f.addEventListener("ended",()=>{n.ended.set(!0),n.waiting.set(!1)},{signal:p}),me(f,a.createMediaElementSource(f),n.isMusic.value?u.music:u.soundEffects).gain.gain.setTargetAtTime(n.volume.value,a.currentTime,.1)},Ee=async(e,t)=>{const n=await Q(()=>import("./hls-Dr6RjylE.js"),[],import.meta.url),a=new n.default;return a.on(n.Events.ERROR,function(u,l){if(l.fatal){switch(l.type){case n.ErrorTypes.NETWORK_ERROR:console.error("fatal network error encountered, try to recover",u,l),a.startLoad();break;case n.ErrorTypes.MEDIA_ERROR:console.error("fatal media error encountered, try to recover",u,l),a.recoverMediaError();break;default:console.error("HLS fatal error encountered, destroying video...",u,l),a.destroy();break}B(e,d,"HLS_ERROR")}}),a.on(n.Events.MEDIA_ATTACHED,()=>{a.loadSource(t),a.on(n.Events.MANIFEST_PARSED,(u,l)=>{ie(e,d,"HLS_ERROR")})}),a};function ge(e,t){!e.value||t<0||e.value.currentTime===t||t>e.value.duration||e.currentTime.set(t)}function pe(e,t,n){if(t===0)return-1;let a=0;if(n==h.single){if(a=e+1,a>=t)return-1}else n==h.random?(a=Math.floor(Math.random()*(t-1)),a>=e&&e>=0&&(a+=1),a>=t&&(a=t-1)):n==h.singleloop?a=e:a=(e+1)%t;return a}export{y as A,d as M,h as P,k as a,S as b,me as c,pe as g,Ae as u};
